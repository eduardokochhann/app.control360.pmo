{% extends "base.html" %}

{% block title %}Quadro Kanban - {{ current_project.projeto if current_project else 'Backlog' }}{% endblock %}

{% block extra_css %}
<style>
    .kanban-column {
        background-color: #f8f9fa;
        border-radius: 8px;
        min-height: 500px;
        padding: 1rem;
    }
    
    .kanban-header {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: #dee2e6;
        border-radius: 6px;
        text-align: center;
    }
    
    .task-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        cursor: grab;
        transition: box-shadow 0.2s, transform 0.2s;
        position: relative;
    }
    
    .task-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .task-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }
    
    .task-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        font-size: 0.95em;
    }
    
    .task-description {
        color: #666;
        font-size: 0.85em;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .task-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8em;
        color: #888;
    }
    
    .task-specialist {
        background-color: #17a2b8;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
    }
    
    .task-priority {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
        font-weight: bold;
    }
    
    .priority-alta { background-color: #dc3545; color: white; }
    .priority-media { background-color: #ffc107; color: black; }
    .priority-baixa { background-color: #28a745; color: white; }
    
    .column-count {
        background-color: #6c757d;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8em;
        margin-left: 0.5rem;
    }
    
    .project-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .add-task-btn {
        width: 100%;
        border: 2px dashed #dee2e6;
        background: transparent;
        color: #6c757d;
        padding: 1rem;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .add-task-btn:hover {
        border-color: #007bff;
        color: #007bff;
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .dropzone-active {
        background-color: rgba(0, 123, 255, 0.1);
        border: 2px dashed #007bff;
    }
    
    .task-estimated-hours {
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- CABEÇALHO DO PROJETO COM AÇÕES -->
    <div class="card mb-4" id="projectHeader" style="display: none;">
        <div class="card-body p-3">
            <div class="row align-items-center">
                <!-- Coluna Esquerda: Nome e Especialista -->
                <div class="col-md-5">
                    <h4 class="mb-1" id="headerProjectName" style="font-size: 1.2rem;">Carregando...</h4>
                    <p class="text-muted mb-0" id="headerSpecialist" style="font-size: 0.9rem;">Especialista: -</p>
                </div>

                <!-- Coluna Direita: Ações do Usuário -->
                <div class="col-md-7 d-flex justify-content-end align-items-center gap-2">
                    <button class="btn btn-light btn-sm" onclick="location.href='/backlog/projetos'">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="openTaskModal()">
                        <i class="bi bi-plus-circle"></i> Nova Tarefa
                    </button>
                    <button class="btn btn-info btn-sm" onclick="location.href='/backlog/agenda'">
                        <i class="bi bi-calendar3"></i> Agenda
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownTools" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-tools"></i> Ferramentas
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownTools">
                            <li><a class="dropdown-item" href="#" onclick="toggleProjectTools()"><i class="bi bi-kanban"></i> Ferramentas do Projeto</a></li>
                            <li><a class="dropdown-item" href="#" onclick="importTasks()"><i class="bi bi-file-earmark-excel"></i> Importar Excel</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportTasks()"><i class="bi bi-download"></i> Exportar</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Linha para Status e Métricas (aparece depois de carregar) -->
            <hr class="my-2" id="headerMetricsSeparator" style="display: none;">
            <div class="row text-center" id="headerMetrics" style="display: none;">
                 <div class="col">
                    <small class="text-muted">Status</small>
                    <p class="fw-bold mb-0" id="headerProjectStatus">-</p>
                </div>
                <div class="col">
                    <small class="text-muted">Horas Estimadas</small>
                    <p class="fw-bold mb-0" id="headerTotalHours">-</p>
                </div>
                <div class="col">
                    <small class="text-muted">Horas Restantes</small>
                    <p class="fw-bold mb-0" id="headerRemainingHours">-</p>
                </div>
                <div class="col">
                    <small class="text-muted">Account Manager</small>
                    <p class="fw-bold mb-0" id="headerAccountManager">-</p>
                </div>
            </div>
        </div>
    </div>
    <!-- FIM DO CABEÇALHO -->

    <!-- Informações do Backlog -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-list-task"></i> 
                    {{ current_backlog_name if current_backlog_name else 'Backlog não criado' }}
                </h4>
                {% if current_backlog_id %}
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="importTasks()">
                        <i class="bi bi-file-earmark-excel"></i> Importar Excel
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="exportTasks()">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                </div>
                {% else %}
                <button class="btn btn-primary" onclick="createBacklog()">
                    <i class="bi bi-plus-circle"></i> Criar Backlog
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Input oculto para importação de arquivos -->
    <input type="file" id="import-file-input" accept=".xlsx,.xls" style="display: none;">

    <!-- Quadro Kanban -->
    <div class="row" id="kanbanBoard">
        {% for column in columns %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="kanban-column" data-column-id="{{ column.id }}">
                <div class="kanban-header">
                    {{ column.name }}
                    <span class="column-count" id="count-{{ column.id }}">0</span>
                </div>
                <div class="task-list" id="column-{{ column.id }}">
                    <!-- Tarefas serão inseridas aqui via JavaScript -->
                    <!-- DEBUG: Coluna ID {{ column.id }} - {{ column.name }} -->
                </div>
                {% if current_backlog_id %}
                <button class="add-task-btn" onclick="openTaskModal({{ column.id }})">
                    <i class="bi bi-plus"></i> Adicionar Tarefa
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para Nova/Editar Tarefa -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">Nova Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId" value="">
                    <input type="hidden" id="taskColumnId" value="">
                    
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Título*</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskPriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="taskPriority">
                                <option value="Baixa">Baixa</option>
                                <option value="Média" selected>Média</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taskEstimatedEffort" class="form-label">Horas Estimadas</label>
                            <input type="number" class="form-control" id="taskEstimatedEffort" step="0.5" min="0">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskSpecialistId" class="form-label">Especialista</label>
                            <select class="form-select" id="taskSpecialistId">
                                <option value="">Não atribuído</option>
                                <!-- Opções serão preenchidas via JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taskStatus" class="form-label">Status</label>
                            <select class="form-select" id="taskStatus">
                                <!-- Opções serão preenchidas via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Campos Adicionais -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskStartDate" class="form-label">Data de Início</label>
                            <input type="date" class="form-control" id="taskStartDate">
                        </div>
                        <div class="col-md-6">
                            <label for="taskDueDate" class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="taskDueDate">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskLoggedTime" class="form-label">Tempo Apontado (horas)</label>
                            <input type="number" class="form-control" id="taskLoggedTime" step="0.5" min="0" value="0">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="taskIsUnplanned">
                                <label class="form-check-label" for="taskIsUnplanned">
                                    Tarefa não Planejada
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteTaskBtn" onclick="deleteTask()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Ferramentas do Projeto -->
<div class="container-fluid mt-4" id="projectToolsSection" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-tools text-primary"></i> Ferramentas do Projeto
                <button class="btn btn-sm btn-outline-secondary float-end" onclick="toggleProjectTools()">
                    <i class="bi bi-x-lg"></i> Fechar
                </button>
            </h5>
        </div>
        <div class="card-body">
            <!-- Nav tabs -->
            <ul class="nav nav-pills" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-risks-tab" data-bs-toggle="pill" data-bs-target="#pills-risks" type="button" role="tab" aria-controls="pills-risks" aria-selected="true">
                        <i class="bi bi-exclamation-triangle text-warning"></i> Riscos
                        <span class="badge bg-danger ms-1">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-milestones-tab" data-bs-toggle="pill" data-bs-target="#pills-milestones" type="button" role="tab" aria-controls="pills-milestones" aria-selected="false">
                        <i class="bi bi-flag text-success"></i> Marcos
                        <span class="badge bg-primary ms-1">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-timeline-tab" data-bs-toggle="pill" data-bs-target="#pills-timeline" type="button" role="tab" aria-controls="pills-timeline" aria-selected="false">
                        <i class="bi bi-clock-history text-info"></i> Timeline
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-notes-tab" data-bs-toggle="pill" data-bs-target="#pills-notes" type="button" role="tab" aria-controls="pills-notes" aria-selected="false">
                        <i class="bi bi-sticky text-primary"></i> Notas
                        <span class="badge bg-info ms-1">0</span>
                    </button>
                </li>
            </ul>

            <!-- Tab content -->
            <div class="tab-content" id="pills-tabContent">
                <!-- Painel de Riscos -->
                <div class="tab-pane fade show active" id="pills-risks" role="tabpanel" aria-labelledby="pills-risks-tab">
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-warning" onclick="openRiskModal()">
                                <i class="bi bi-plus-circle"></i> Novo Risco
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadRisks()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="risksContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-exclamation-triangle fs-1"></i>
                                    <p>Carregando riscos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Marcos -->
                <div class="tab-pane fade" id="pills-milestones" role="tabpanel" aria-labelledby="pills-milestones-tab">
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-success" onclick="openMilestoneModal()">
                                <i class="bi bi-plus-circle"></i> Novo Marco
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadMilestones()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="milestonesContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-flag fs-1"></i>
                                    <p>Carregando marcos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Timeline -->
                <div class="tab-pane fade" id="pills-timeline" role="tabpanel" aria-labelledby="pills-timeline-tab">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="timelineDaysBack" class="form-label">Dias para trás:</label>
                            <input type="number" class="form-control" id="timelineDaysBack" value="7" min="1" max="30">
                        </div>
                        <div class="col-md-3">
                            <label for="timelineDaysForward" class="form-label">Dias para frente:</label>
                            <input type="number" class="form-control" id="timelineDaysForward" value="7" min="1" max="30">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-info" onclick="loadTimeline()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar Timeline
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="timelineContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-clock-history fs-1"></i>
                                    <p>Carregando timeline...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Notas -->
                <div class="tab-pane fade" id="pills-notes" role="tabpanel" aria-labelledby="pills-notes-tab">
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-primary" onclick="openNoteModal()">
                                <i class="bi bi-plus-circle"></i> Nova Nota
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadNotes()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="notesContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-sticky fs-1"></i>
                                    <p>Carregando notas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Risco -->
<div class="modal fade" id="riskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="riskModalTitle">Novo Risco</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="riskForm">
                    <input type="hidden" id="riskId" value="">
                    
                    <div class="mb-3">
                        <label for="riskTitle" class="form-label">Título*</label>
                        <input type="text" class="form-control" id="riskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="riskDescription" class="form-label">Descrição*</label>
                        <textarea class="form-control" id="riskDescription" rows="3" required></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="riskProbability" class="form-label">Probabilidade</label>
                            <select class="form-select" id="riskProbability">
                                <option value="LOW">Baixa</option>
                                <option value="MEDIUM" selected>Média</option>
                                <option value="HIGH">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="riskImpact" class="form-label">Impacto</label>
                            <select class="form-select" id="riskImpact">
                                <option value="LOW">Baixo</option>
                                <option value="MEDIUM" selected>Médio</option>
                                <option value="HIGH">Alto</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="riskStatus" class="form-label">Status</label>
                            <select class="form-select" id="riskStatus">
                                <option value="IDENTIFIED" selected>Identificado</option>
                                <option value="MITIGATED">Mitigado</option>
                                <option value="RESOLVED">Resolvido</option>
                                <option value="ACCEPTED">Aceito</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="riskMitigationPlan" class="form-label">Plano de Mitigação</label>
                        <textarea class="form-control" id="riskMitigationPlan" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteRiskBtn" onclick="deleteRisk()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveRisk()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Marco -->
<div class="modal fade" id="milestoneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="milestoneModalTitle">Novo Marco</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="milestoneForm">
                    <input type="hidden" id="milestoneId" value="">
                    
                    <div class="mb-3">
                        <label for="milestoneName" class="form-label">Nome*</label>
                        <input type="text" class="form-control" id="milestoneName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="milestoneDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="milestoneDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="milestonePlannedDate" class="form-label">Data Planejada*</label>
                            <input type="date" class="form-control" id="milestonePlannedDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="milestoneActualDate" class="form-label">Data Real</label>
                            <input type="date" class="form-control" id="milestoneActualDate">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="milestoneStatus" class="form-label">Status</label>
                            <select class="form-select" id="milestoneStatus">
                                <option value="PENDING" selected>Pendente</option>
                                <option value="IN_PROGRESS">Em Progresso</option>
                                <option value="COMPLETED">Concluído</option>
                                <option value="DELAYED">Atrasado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="milestoneCriticality" class="form-label">Criticidade</label>
                            <select class="form-select" id="milestoneCriticality">
                                <option value="LOW">Baixa</option>
                                <option value="MEDIUM" selected>Média</option>
                                <option value="HIGH">Alta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="milestoneIsCheckpoint">
                            <label class="form-check-label" for="milestoneIsCheckpoint">
                                É um checkpoint crítico
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteMilestoneBtn" onclick="deleteMilestone()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-success" onclick="saveMilestone()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Nota -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalTitle">Nova Nota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteId" value="">
                    
                    <div class="mb-3">
                        <label for="noteContent" class="form-label">Conteúdo*</label>
                        <textarea class="form-control" id="noteContent" rows="4" required></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="noteCategory" class="form-label">Categoria</label>
                            <select class="form-select" id="noteCategory">
                                <option value="general" selected>Geral</option>
                                <option value="progress">Progresso</option>
                                <option value="issue">Problema</option>
                                <option value="decision">Decisão</option>
                                <option value="meeting">Reunião</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="notePriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="notePriority">
                                <option value="low">Baixa</option>
                                <option value="medium" selected>Média</option>
                                <option value="high">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="noteEventDate" class="form-label">Data do Evento</label>
                            <input type="date" class="form-control" id="noteEventDate">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="noteIncludeInReport" checked>
                            <label class="form-check-label" for="noteIncludeInReport">
                                Incluir no relatório de status
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="noteTags" class="form-label">Tags (separadas por vírgula)</label>
                        <input type="text" class="form-control" id="noteTags" placeholder="tag1, tag2, tag3">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteNoteBtn" onclick="deleteNote()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Passa dados do Flask para o JavaScript
    window.boardData = {
        projectId: '{{ current_project.id if current_project else "" }}',
        backlogId: {{ current_backlog_id if current_backlog_id else 'null' }},
        tasks: {{ tasks_json|safe if tasks_json else '[]' }},
        columns: {{ columns|tojson if columns else '[]' }},
        specialists: [] // Será preenchido via API se necessário
    };
</script>

<script src="{{ url_for('static', filename='js/board.js') }}"></script>
<script src="{{ url_for('static', filename='js/backlog_features.js') }}"></script>
<script src="{{ url_for('static', filename='js/board_dnd.js') }}"></script>

<script>
    // Inicialização unificada
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM totalmente carregado. Iniciando todos os scripts...");
        console.log("Dados disponíveis:", window.boardData);
        
        // Verifica se os dados estão disponíveis
        if (!window.boardData) {
            console.error("window.boardData não está disponível!");
            return;
        }
        
        // Inicializa o drag-and-drop do quadro
        if (typeof initializeSortable === 'function') {
            console.log("Inicializando o quadro drag-and-drop...");
            initializeSortable();
        } else {
            console.error("Função initializeSortable não encontrada!");
        }
        
        // Inicializa as ferramentas do projeto (Riscos, Marcos, etc.)
        if (typeof initializeProjectTools === 'function') {
            console.log("Inicializando as ferramentas do projeto...");
            initializeProjectTools();
        } else {
            console.error("Função initializeProjectTools não encontrada!");
        }
    });
</script>
{% endblock %} 