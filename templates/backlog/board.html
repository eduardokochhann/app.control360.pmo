{% extends "base.html" %}

{% block title %}Quadro Kanban - {{ current_project.projeto if current_project else 'Backlog' }}{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/complexity_form.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/pmo_command_center.css') }}" rel="stylesheet">
<style>
    .kanban-column {
        background-color: #f8f9fa;
        border-radius: 8px;
        min-height: 500px;
        padding: 1rem;
    }
    
    .kanban-header {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: #dee2e6;
        border-radius: 6px;
        text-align: center;
    }
    
    .task-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        cursor: grab;
        transition: box-shadow 0.2s, transform 0.2s;
        position: relative;
    }
    
    .task-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .task-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }
    
    .task-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        font-size: 0.95em;
    }
    
    .task-description {
        color: #666;
        font-size: 0.85em;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .task-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8em;
        color: #888;
    }
    
    .task-specialist {
        background-color: #17a2b8;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
    }
    
    .task-priority {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
        font-weight: bold;
    }
    
    .priority-alta { background-color: #dc3545; color: white; }
    .priority-media { background-color: #ffc107; color: black; }
    .priority-baixa { background-color: #28a745; color: white; }
    
    .column-count {
        background-color: #6c757d;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8em;
        margin-left: 0.5rem;
    }
    
    .project-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .add-task-btn {
        width: 100%;
        border: 2px dashed #dee2e6;
        background: transparent;
        color: #6c757d;
        padding: 1rem;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .add-task-btn:hover {
        border-color: #007bff;
        color: #007bff;
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .dropzone-active {
        background-color: rgba(0, 123, 255, 0.1);
        border: 2px dashed #007bff;
    }
    
    .task-estimated-hours {
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- CABEÇALHO DO PROJETO COM AÇÕES -->
    <div class="card mb-4" id="projectHeader" style="display: none;">
        <div class="card-body p-3">
            <div class="row align-items-center">
                <!-- Coluna Esquerda: Nome e Especialista -->
                <div class="col-md-5">
                    <h4 class="mb-1" id="headerProjectName" style="font-size: 1.2rem;">Carregando...</h4>
                    <p class="text-muted mb-0" id="headerSpecialist" style="font-size: 0.9rem;">Especialista: -</p>
                </div>

                <!-- Coluna Direita: Ações do Usuário -->
                <div class="col-md-7 d-flex justify-content-end align-items-center gap-2">
                    <!-- Toggle de Visibilidade no Módulo Sprints -->
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="sprintVisibilityToggle" onchange="toggleSprintVisibility()">
                        <label class="form-check-label" for="sprintVisibilityToggle" style="font-size: 0.85rem;">
                            <i class="bi bi-calendar3-week"></i> Visível em Sprints
                        </label>
                    </div>
                    
                    <div class="vr"></div>
                    
                    <button class="btn btn-light btn-sm" onclick="location.href='/backlog/projetos'">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="openTaskModal()">
                        <i class="bi bi-plus-circle"></i> Nova Tarefa
                    </button>
                    <button class="btn btn-info btn-sm" onclick="location.href='/backlog/agenda'">
                        <i class="bi bi-calendar3"></i> Agenda
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownTools" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-tools"></i> Ferramentas
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownTools">
                            <li><a class="dropdown-item" href="#" onclick="toggleProjectTools()"><i class="bi bi-kanban"></i> Ferramentas do Projeto</a></li>
                            <li><a class="dropdown-item" href="#" onclick="importTasks()"><i class="bi bi-file-earmark-excel"></i> Importar Excel</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportTasks()"><i class="bi bi-download"></i> Exportar</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Linha para Status e Métricas (aparece depois de carregar) -->
            <hr class="my-2" id="headerMetricsSeparator" style="display: none;">
            <div class="row text-center" id="headerMetrics" style="display: none;">
                 <div class="col">
                    <small class="text-muted">Status</small>
                    <p class="fw-bold mb-0" id="headerProjectStatus">-</p>
                </div>
                <div class="col">
                    <small class="text-muted">Horas Estimadas</small>
                    <p class="fw-bold mb-0" id="headerTotalHours">-</p>
                </div>
                <div class="col">
                    <small class="text-muted">Horas Restantes</small>
                    <p class="fw-bold mb-0" id="headerRemainingHours">-</p>
                </div>
                <div class="col">
                    <small class="text-muted">Account Manager</small>
                    <p class="fw-bold mb-0" id="headerAccountManager">-</p>
                </div>
                <div class="col">
                    <small class="text-muted">Complexidade</small>
                    <p class="fw-bold mb-0" id="headerComplexity">-</p>
                </div>
            </div>
        </div>
    </div>
    <!-- FIM DO CABEÇALHO -->

    <!-- Informações do Backlog -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-list-task"></i> 
                    {{ current_backlog_name if current_backlog_name else 'Backlog não criado' }}
                </h4>
                {% if current_backlog_id %}
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="importTasks()">
                        <i class="bi bi-file-earmark-excel"></i> Importar Excel
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="exportTasks()">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                </div>
                {% else %}
                <button class="btn btn-primary" onclick="createBacklog()">
                    <i class="bi bi-plus-circle"></i> Criar Backlog
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Input oculto para importação de arquivos -->
    <input type="file" id="import-file-input" accept=".xlsx,.xls" style="display: none;">

    <!-- Quadro Kanban -->
    <div class="row" id="kanbanBoard">
        {% for column in columns %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="kanban-column" data-column-id="{{ column.id }}">
                <div class="kanban-header">
                    {{ column.name }}
                    <span class="column-count" id="count-{{ column.id }}">0</span>
                </div>
                <div class="task-list" id="column-{{ column.id }}">
                    <!-- Tarefas serão inseridas aqui via JavaScript -->
                    <!-- DEBUG: Coluna ID {{ column.id }} - {{ column.name }} -->
                </div>
                {% if current_backlog_id %}
                <button class="add-task-btn" onclick="openTaskModal({{ column.id }})">
                    <i class="bi bi-plus"></i> Adicionar Tarefa
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para Nova/Editar Tarefa -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">Nova Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId" value="">
                    <input type="hidden" id="taskColumnId" value="">
                    
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Título*</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskPriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="taskPriority">
                                <option value="Baixa">Baixa</option>
                                <option value="Média" selected>Média</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taskEstimatedEffort" class="form-label">Horas Estimadas</label>
                            <input type="number" class="form-control" id="taskEstimatedEffort" step="0.5" min="0">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskSpecialistId" class="form-label">Especialista</label>
                            <select class="form-select" id="taskSpecialistId">
                                <option value="">Não atribuído</option>
                                <!-- Opções serão preenchidas via JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taskStatus" class="form-label">Status</label>
                            <select class="form-select" id="taskStatus">
                                <!-- Opções serão preenchidas via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- Campos Adicionais -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskStartDate" class="form-label">Data de Início</label>
                            <input type="date" class="form-control" id="taskStartDate">
                        </div>
                        <div class="col-md-6">
                            <label for="taskDueDate" class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="taskDueDate">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskLoggedTime" class="form-label">Tempo Apontado (horas)</label>
                            <input type="number" class="form-control" id="taskLoggedTime" step="0.5" min="0" value="0">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="taskIsUnplanned">
                                <label class="form-check-label" for="taskIsUnplanned">
                                    Tarefa não Planejada
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteTaskBtn" onclick="deleteTask()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Central de Comando PMO -->
<div class="container-fluid mt-4" id="projectToolsSection" style="display: none;">
    <div class="card border-0 shadow-lg command-center">
        <div class="card-header border-0 text-white p-4" style="background-color: #07304F;">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="command-center-icon me-3">
                        <i class="bi bi-command fs-1"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold">Central de Comando PMO</h4>
                        <p class="mb-0 text-white-50">Gestão Completa do Projeto</p>
                    </div>
                </div>
                <button class="btn btn-outline-light btn-lg" onclick="toggleProjectTools()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-4" style="background-color: #ffffff;">

            <!-- Nav tabs -->
            <ul class="nav nav-pills pmo-tabs" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-risks-tab" data-bs-toggle="pill" data-bs-target="#pills-risks" type="button" role="tab" aria-controls="pills-risks" aria-selected="true">
                        <div class="tab-content-wrapper">
                            <i class="bi bi-shield-exclamation fs-5"></i>
                            <span class="tab-label">Gestão de Riscos</span>
                            <span class="badge bg-danger ms-1">0</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-milestones-tab" data-bs-toggle="pill" data-bs-target="#pills-milestones" type="button" role="tab" aria-controls="pills-milestones" aria-selected="false">
                        <div class="tab-content-wrapper">
                            <i class="bi bi-flag-fill fs-5"></i>
                            <span class="tab-label">Marcos do Projeto</span>
                            <span class="badge bg-primary ms-1">0</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-timeline-tab" data-bs-toggle="pill" data-bs-target="#pills-timeline" type="button" role="tab" aria-controls="pills-timeline" aria-selected="false">
                        <div class="tab-content-wrapper">
                            <i class="bi bi-clock-history fs-5"></i>
                            <span class="tab-label">Timeline</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-notes-tab" data-bs-toggle="pill" data-bs-target="#pills-notes" type="button" role="tab" aria-controls="pills-notes" aria-selected="false">
                        <div class="tab-content-wrapper">
                            <i class="bi bi-chat-square-text-fill fs-5"></i>
                            <span class="tab-label">Centro de Notas</span>
                            <span class="badge bg-info ms-1">0</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-complexity-tab" data-bs-toggle="pill" data-bs-target="#pills-complexity" type="button" role="tab" aria-controls="pills-complexity" aria-selected="false">
                        <div class="tab-content-wrapper">
                            <i class="bi bi-graph-up-arrow fs-5"></i>
                            <span class="tab-label">Análise de Complexidade</span>
                            <span class="badge bg-warning ms-1" id="complexity-badge" style="display: none;">-</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-sprints-tab" data-bs-toggle="pill" data-bs-target="#pills-sprints" type="button" role="tab" aria-controls="pills-sprints" aria-selected="false">
                        <div class="tab-content-wrapper">
                            <i class="bi bi-lightning-charge-fill fs-5"></i>
                            <span class="tab-label">Sprints & Especialistas</span>
                            <span class="badge bg-primary ms-1" id="sprints-badge" style="display: none;">0</span>
                        </div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-wbs-tab" data-bs-toggle="pill" data-bs-target="#pills-wbs" type="button" role="tab" aria-controls="pills-wbs" aria-selected="false">
                        <div class="tab-content-wrapper">
                            <i class="bi bi-diagram-3-fill fs-5"></i>
                            <span class="tab-label">WBS - Estrutura Analítica</span>
                            <span class="badge bg-success ms-1" id="wbs-badge" style="display: none;">0</span>
                        </div>
                    </button>
                </li>
            </ul>

            <!-- Tab content -->
            <div class="tab-content" id="pills-tabContent">
                <!-- Painel de Riscos -->
                <div class="tab-pane fade show active" id="pills-risks" role="tabpanel" aria-labelledby="pills-risks-tab">
                    <div class="row mb-4">
                        <div class="col-12 d-flex gap-2 flex-wrap">
                            <button class="btn pmo-action-btn risk-btn" onclick="openRiskModal()">
                                <i class="bi bi-shield-plus"></i> Novo Risco
                            </button>
                            <button class="btn pmo-action-btn" onclick="loadRisks()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                            <button class="btn pmo-action-btn" onclick="exportRisks()">
                                <i class="bi bi-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="risksContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-exclamation-triangle fs-1"></i>
                                    <p>Carregando riscos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Marcos -->
                <div class="tab-pane fade" id="pills-milestones" role="tabpanel" aria-labelledby="pills-milestones-tab">
                    <div class="row mb-4">
                        <div class="col-12 d-flex gap-2 flex-wrap">
                            <button class="btn pmo-action-btn milestone-btn" onclick="openMilestoneModal()">
                                <i class="bi bi-flag-fill"></i> Novo Marco
                            </button>
                            <button class="btn pmo-action-btn" onclick="loadMilestones()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                            <button class="btn pmo-action-btn" onclick="exportMilestones()">
                                <i class="bi bi-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="milestonesContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-flag fs-1"></i>
                                    <p>Carregando marcos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Timeline -->
                <div class="tab-pane fade" id="pills-timeline" role="tabpanel" aria-labelledby="pills-timeline-tab">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="timelineDaysBack" class="form-label fw-bold">Dias para trás:</label>
                            <input type="number" class="form-control" id="timelineDaysBack" value="7" min="1" max="30">
                        </div>
                        <div class="col-md-3">
                            <label for="timelineDaysForward" class="form-label fw-bold">Dias para frente:</label>
                            <input type="number" class="form-control" id="timelineDaysForward" value="7" min="1" max="30">
                        </div>
                        <div class="col-md-6 d-flex align-items-end gap-2">
                            <button class="btn pmo-action-btn" onclick="loadTimeline()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar Timeline
                            </button>
                            <button class="btn pmo-action-btn" onclick="exportTimeline()">
                                <i class="bi bi-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="timelineContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-clock-history fs-1"></i>
                                    <p>Carregando timeline...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Notas -->
                <div class="tab-pane fade" id="pills-notes" role="tabpanel" aria-labelledby="pills-notes-tab">
                    <div class="row mb-4">
                        <div class="col-12 d-flex gap-2 flex-wrap">
                            <button class="btn pmo-action-btn note-btn" onclick="openNoteModal()">
                                <i class="bi bi-chat-square-text"></i> Nova Nota
                            </button>
                            <button class="btn pmo-action-btn" onclick="loadNotes()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                            <button class="btn pmo-action-btn" onclick="exportNotes()">
                                <i class="bi bi-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="notesContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-sticky fs-1"></i>
                                    <p>Carregando notas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Complexidade -->
                <div class="tab-pane fade" id="pills-complexity" role="tabpanel" aria-labelledby="pills-complexity-tab">
                    <div class="row mb-4">
                        <div class="col-12 d-flex gap-2 flex-wrap">
                            <button class="btn pmo-action-btn complexity-btn" onclick="openComplexityModal()">
                                <i class="bi bi-graph-up-arrow"></i> Avaliar Complexidade
                            </button>
                            <button class="btn pmo-action-btn" onclick="openComplexityHistoryModal()">
                                <i class="bi bi-clock-history"></i> Histórico
                            </button>
                            <button class="btn pmo-action-btn" onclick="loadComplexityInfo()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="complexityContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-bar-chart fs-1"></i>
                                    <p>Carregando informações de complexidade...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Sprints & Especialistas -->
                <div class="tab-pane fade" id="pills-sprints" role="tabpanel" aria-labelledby="pills-sprints-tab">
                    <div class="row mb-4">
                        <div class="col-12 d-flex gap-2 flex-wrap">
                            <button class="btn pmo-action-btn" onclick="loadProjectSprints()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar Sprints
                            </button>
                            <a href="javascript:void(0)" class="btn pmo-action-btn" onclick="openSprintsWithProjectFilter(event)">
                                <i class="bi bi-box-arrow-up-right"></i> Gerenciar Sprints
                            </a>
                            <button class="btn pmo-action-btn" onclick="exportSprintData()">
                                <i class="bi bi-download"></i> Exportar Dados
                            </button>
                        </div>
                    </div>
                    
                    <!-- Resumo do Projeto -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title d-flex align-items-center mb-3">
                                        <i class="bi bi-info-circle-fill me-2 text-primary"></i>
                                        Resumo do Projeto
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="stat-item text-center">
                                                <h4 class="text-primary mb-1" id="project-total-tasks">-</h4>
                                                <small class="text-muted">Total de Tarefas</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item text-center">
                                                <h4 class="text-success mb-1" id="project-active-sprints">-</h4>
                                                <small class="text-muted">Sprints Ativas</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item text-center">
                                                <h4 class="text-warning mb-1" id="project-specialists-count">-</h4>
                                                <small class="text-muted">Especialistas</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="stat-item text-center">
                                                <h4 class="text-info mb-1" id="project-total-hours">-</h4>
                                                <small class="text-muted">Horas Estimadas</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Sprints -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="bi bi-lightning-charge-fill me-2"></i>
                                        Sprints do Projeto
                                        <span class="badge bg-light text-primary ms-2" id="sprints-count">0</span>
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div id="sprintsContainer">
                                        <div class="text-center text-muted py-4">
                                            <i class="bi bi-lightning-charge fs-1"></i>
                                            <p>Carregando sprints do projeto...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Especialistas -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="bi bi-people-fill me-2"></i>
                                        Especialistas Envolvidos
                                        <span class="badge bg-light text-info ms-2" id="specialists-count">0</span>
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div id="specialistsContainer">
                                        <div class="text-center text-muted py-4">
                                            <i class="bi bi-people fs-1"></i>
                                            <p>Carregando especialistas...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel WBS - Estrutura Analítica do Projeto -->
                <div class="tab-pane fade" id="pills-wbs" role="tabpanel" aria-labelledby="pills-wbs-tab">
                    <div class="row mb-4">
                        <div class="col-12 d-flex gap-2 flex-wrap">
                            <button class="btn pmo-action-btn" onclick="generateWBS()">
                                <i class="bi bi-diagram-3-fill"></i> Gerar WBS
                            </button>
                            <button class="btn pmo-action-btn" onclick="exportWBSToExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
                            </button>
                            <button class="btn pmo-action-btn" onclick="copyWBSToClipboard()">
                                <i class="bi bi-clipboard"></i> Copiar p/ PPT
                            </button>
                            <button class="btn pmo-action-btn" onclick="refreshWBS()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                            <button class="btn pmo-action-btn" onclick="previewWBS()">
                                <i class="bi bi-eye"></i> Visualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Configurações da WBS -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Data de Início do Projeto:</label>
                            <input type="date" class="form-control" id="wbs-start-date" value="">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Incluir Marcos:</label>
                            <select class="form-select" id="wbs-include-milestones">
                                <option value="true" selected>Sim, incluir marcos</option>
                                <option value="false">Não incluir marcos</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ordenação:</label>
                            <select class="form-select" id="wbs-sort-order">
                                <option value="priority" selected>Por Prioridade</option>
                                <option value="date">Por Data</option>
                                <option value="specialist">Por Especialista</option>
                                <option value="column">Por Coluna</option>
                            </select>
                        </div>
                    </div>

                    <!-- Prévia da WBS -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="bi bi-diagram-3-fill me-2"></i>
                                        Estrutura Analítica do Projeto (WBS)
                                        <span class="badge bg-success ms-2" id="wbs-total-items">0 itens</span>
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div id="wbsContainer">
                                        <div class="text-center text-muted py-5">
                                            <i class="bi bi-diagram-3 fs-1"></i>
                                            <h5 class="mt-3">WBS - Work Breakdown Structure</h5>
                                            <p class="mb-3">Clique em "Gerar WBS" para criar a estrutura analítica do projeto</p>
                                            <p class="text-sm text-muted">
                                                A WBS incluirá todas as tarefas do quadro com:<br>
                                                • ID da Tarefa • Descrição • Datas • Intervalos • Especialista • Marcos
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Risco -->
<div class="modal fade" id="riskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="riskModalTitle">Novo Risco</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="riskForm">
                    <input type="hidden" id="riskId" value="">
                    
                    <div class="mb-3">
                        <label for="riskTitle" class="form-label">Título*</label>
                        <input type="text" class="form-control" id="riskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="riskDescription" class="form-label">Descrição*</label>
                        <textarea class="form-control" id="riskDescription" rows="3" required></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="riskProbability" class="form-label">Probabilidade</label>
                            <select class="form-select" id="riskProbability">
                                <option value="LOW">Baixa</option>
                                <option value="MEDIUM" selected>Média</option>
                                <option value="HIGH">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="riskImpact" class="form-label">Impacto</label>
                            <select class="form-select" id="riskImpact">
                                <option value="LOW">Baixo</option>
                                <option value="MEDIUM" selected>Médio</option>
                                <option value="HIGH">Alto</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="riskStatus" class="form-label">Status</label>
                            <select class="form-select" id="riskStatus">
                                <option value="IDENTIFIED" selected>Identificado</option>
                                <option value="MITIGATED">Mitigado</option>
                                <option value="RESOLVED">Resolvido</option>
                                <option value="ACCEPTED">Aceito</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="riskMitigationPlan" class="form-label">Plano de Mitigação</label>
                        <textarea class="form-control" id="riskMitigationPlan" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteRiskBtn" onclick="deleteRisk()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveRisk()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Marco -->
<div class="modal fade" id="milestoneModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="milestoneModalTitle">Novo Marco</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="milestoneForm">
                    <input type="hidden" id="milestoneId" value="">
                    
                    <div class="mb-3">
                        <label for="milestoneName" class="form-label">Nome*</label>
                        <input type="text" class="form-control" id="milestoneName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="milestoneDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="milestoneDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="milestonePlannedDate" class="form-label">Data Planejada*</label>
                            <input type="date" class="form-control" id="milestonePlannedDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="milestoneActualDate" class="form-label">Data Real</label>
                            <input type="date" class="form-control" id="milestoneActualDate">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="milestoneStatus" class="form-label">Status</label>
                            <select class="form-select" id="milestoneStatus">
                                <option value="PENDING" selected>Pendente</option>
                                <option value="IN_PROGRESS">Em Progresso</option>
                                <option value="COMPLETED">Concluído</option>
                                <option value="DELAYED">Atrasado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="milestoneCriticality" class="form-label">Criticidade</label>
                            <select class="form-select" id="milestoneCriticality">
                                <option value="LOW">Baixa</option>
                                <option value="MEDIUM" selected>Média</option>
                                <option value="HIGH">Alta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="milestoneIsCheckpoint">
                            <label class="form-check-label" for="milestoneIsCheckpoint">
                                É um checkpoint crítico
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteMilestoneBtn" onclick="deleteMilestone()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-success" onclick="saveMilestone()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Nota -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalTitle">Nova Nota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteId" value="">
                    
                    <div class="mb-3">
                        <label for="noteContent" class="form-label">Conteúdo*</label>
                        <textarea class="form-control" id="noteContent" rows="4" required></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="noteCategory" class="form-label">Categoria</label>
                            <select class="form-select" id="noteCategory">
                                <option value="general" selected>Geral</option>
                                <option value="status_update">Atualização de Status</option>
                                <option value="decision">Decisão</option>
                                <option value="risk">Risco</option>
                                <option value="impediment">Impedimento</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="notePriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="notePriority">
                                <option value="low">Baixa</option>
                                <option value="medium" selected>Média</option>
                                <option value="high">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="noteEventDate" class="form-label">Data do Evento</label>
                            <input type="date" class="form-control" id="noteEventDate">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="noteIncludeInReport" checked>
                            <label class="form-check-label" for="noteIncludeInReport">
                                Incluir no relatório de status
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="noteTags" class="form-label">Tags (separadas por vírgula)</label>
                        <input type="text" class="form-control" id="noteTags" placeholder="tag1, tag2, tag3">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteNoteBtn" onclick="deleteNote()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Avaliação de Complexidade -->
<div class="modal fade" id="complexityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h5 class="modal-title text-white fw-bold">
                    <i class="bi bi-graph-up-arrow me-2"></i> Avaliação de Complexidade do Projeto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4" style="background: linear-gradient(to bottom, #f8f9fa, #ffffff);">
                <form id="complexityForm">
                    <!-- Info Header -->
                    <div class="alert alert-primary border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-lightbulb-fill text-primary fs-3"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading fw-bold mb-1">Como funciona a avaliação</h6>
                                <p class="mb-0 small">Avalie cada critério selecionando a opção que melhor descreve o projeto. O sistema calculará automaticamente o score total e determinará a categoria de complexidade.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Critérios Container -->
                    <div id="complexityCriteriaContainer" class="mb-4">
                        <!-- Critérios serão carregados aqui via JavaScript -->
                    </div>
                    
                    <!-- Score Total e Observações -->
                    <div class="row g-4">
                        <div class="col-md-8">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-light border-0">
                                    <h6 class="mb-0 text-muted">
                                        <i class="bi bi-chat-text me-2"></i>Observações da Avaliação
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <textarea class="form-control border-0 bg-light" id="complexityNotes" rows="4" 
                                              placeholder="💡 Adicione observações, justificativas ou detalhes específicos sobre esta avaliação..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 shadow-lg h-100" id="scoreCard">
                                <div class="card-body text-center p-4" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe);">
                                    <div class="text-white">
                                        <i class="bi bi-calculator fs-1 mb-3"></i>
                                        <h6 class="text-white-50 mb-2">SCORE TOTAL</h6>
                                        <h1 class="display-3 fw-bold mb-2" id="totalScoreDisplay">0</h1>
                                        <div class="badge bg-light text-dark fs-6 px-3 py-2" id="categoryDisplay">
                                            Baixa Complexidade
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light border-0 p-4">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success px-4 shadow-sm" onclick="saveComplexityAssessment()">
                    <i class="bi bi-check-circle me-2"></i>Salvar Avaliação
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Histórico de Complexidade -->
<div class="modal fade" id="complexityHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history text-info me-2"></i> Histórico de Avaliações
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="complexityHistoryContainer">
                    <!-- Histórico será carregado aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Passa dados do Flask para o JavaScript
    window.boardData = {
        projectId: '{{ current_project.id if current_project else "" }}',
        backlogId: {{ current_backlog_id if current_backlog_id else 'null' }},
        tasks: {{ tasks_json|safe if tasks_json else '[]' }},
        columns: {{ columns|tojson if columns else '[]' }},
        specialists: [] // Será preenchido via API se necessário
    };
</script>

<script src="{{ url_for('static', filename='js/board.js') }}"></script>
<script src="{{ url_for('static', filename='js/backlog_features.js') }}"></script>
<script src="{{ url_for('static', filename='js/board_dnd.js') }}"></script>

<script>
    // Função para gerenciar visibilidade no módulo Sprints
    async function toggleSprintVisibility() {
        const toggle = document.getElementById('sprintVisibilityToggle');
        const backlogId = window.boardData.backlogId;
        
        if (!backlogId) {
            alert('Erro: Backlog não identificado');
            return;
        }
        
        try {
            const response = await fetch(`/backlog/api/backlogs/${backlogId}/sprint-availability`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    available_for_sprint: toggle.checked
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || `Erro ${response.status}`);
            }
            
            const result = await response.json();
            
            // Mostra feedback visual
            const status = toggle.checked ? 'habilitado' : 'desabilitado';
            const alertClass = toggle.checked ? 'alert-success' : 'alert-warning';
            
            // Cria toast de feedback
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${toggle.checked ? 'success' : 'warning'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-calendar3-week"></i> 
                            Projeto ${status} para o módulo Sprints
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            // Adiciona toast ao container
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove o toast após ser ocultado
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
            
        } catch (error) {
            console.error('Erro ao atualizar visibilidade:', error);
            alert(`Erro ao atualizar visibilidade: ${error.message}`);
            
            // Reverte o toggle em caso de erro
            toggle.checked = !toggle.checked;
        }
    }
    
    // Função para carregar o estado atual do toggle
    async function loadSprintVisibilityState() {
        const backlogId = window.boardData.backlogId;
        const toggle = document.getElementById('sprintVisibilityToggle');
        
        if (!backlogId || !toggle) return;
        
        try {
            const response = await fetch(`/backlog/api/projects/${window.boardData.projectId}/details`);
            if (response.ok) {
                const data = await response.json();
                if (data.backlog && typeof data.backlog.available_for_sprint === 'boolean') {
                    toggle.checked = data.backlog.available_for_sprint;
                }
            }
        } catch (error) {
            console.warn('Não foi possível carregar estado do toggle:', error);
        }
    }

    // === FUNÇÕES PARA A ABA DE SPRINTS & ESPECIALISTAS ===
    
    /**
     * Carrega informações das Sprints relacionadas ao projeto atual
     */
    async function loadProjectSprints() {
        const projectId = window.boardData.projectId;
        
        if (!projectId) {
            console.warn('Project ID não disponível para carregar sprints');
            return;
        }
        
        try {
            console.log(`🔄 Carregando sprints para projeto ${projectId}...`);
            
            // Busca todas as sprints
            const sprintsResponse = await fetch('/sprints/api/sprints');
            if (!sprintsResponse.ok) {
                throw new Error(`Erro ao buscar sprints: ${sprintsResponse.status}`);
            }
            
            const allSprints = await sprintsResponse.json();
            
            // Filtra sprints que contêm tarefas deste projeto
            const projectSprints = allSprints.filter(sprint => {
                return sprint.tasks && sprint.tasks.some(task => 
                    task.project_id === projectId || task.backlog_id == window.boardData.backlogId
                );
            });
            
            // Coleta especialistas únicos
            const specialists = new Set();
            let totalTasks = 0;
            let totalHours = 0;
            
            projectSprints.forEach(sprint => {
                if (sprint.tasks) {
                    sprint.tasks.forEach(task => {
                        if (task.project_id === projectId || task.backlog_id == window.boardData.backlogId) {
                            totalTasks++;
                            totalHours += task.estimated_effort || 0;
                            if (task.specialist_name && task.specialist_name !== 'Não atribuído') {
                                specialists.add(task.specialist_name);
                            }
                        }
                    });
                }
            });
            
            // Atualiza estatísticas do resumo
            updateProjectSummary({
                totalTasks,
                activeSprints: projectSprints.filter(s => !s.is_archived).length,
                specialistsCount: specialists.size,
                totalHours
            });
            
            // Renderiza sprints
            renderProjectSprints(projectSprints);
            
            // Renderiza especialistas
            renderProjectSpecialists(Array.from(specialists), projectSprints);
            
            // Atualiza badge da aba
            const sprintsBadge = document.getElementById('sprints-badge');
            if (sprintsBadge) {
                sprintsBadge.textContent = projectSprints.length;
                sprintsBadge.style.display = projectSprints.length > 0 ? 'inline-block' : 'none';
            }
            
            console.log(`✅ Carregadas ${projectSprints.length} sprints com tarefas do projeto`);
            
        } catch (error) {
            console.error('❌ Erro ao carregar sprints do projeto:', error);
            
            // Mostra erro na interface
            const sprintsContainer = document.getElementById('sprintsContainer');
            if (sprintsContainer) {
                sprintsContainer.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                        <p>Erro ao carregar sprints: ${error.message}</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadProjectSprints()">
                            <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
    }
    
    /**
     * Atualiza o resumo do projeto
     */
    function updateProjectSummary(stats) {
        const elements = {
            'project-total-tasks': stats.totalTasks,
            'project-active-sprints': stats.activeSprints,
            'project-specialists-count': stats.specialistsCount,
            'project-total-hours': `${stats.totalHours}h`
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        });
    }
    
    /**
     * Renderiza a lista de sprints do projeto
     */
    function renderProjectSprints(sprints) {
        const container = document.getElementById('sprintsContainer');
        const countElement = document.getElementById('sprints-count');
        
        if (!container) return;
        
        if (countElement) {
            countElement.textContent = sprints.length;
        }
        
        if (sprints.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-lightning-charge fs-1"></i>
                    <p>Nenhuma sprint encontrada com tarefas deste projeto</p>
                    <a href="javascript:void(0)" class="btn btn-primary btn-sm" onclick="openSprintsWithProjectFilter(event)">
                        <i class="bi bi-plus-circle"></i> Criar Nova Sprint
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = sprints.map(sprint => {
            const projectTasks = sprint.tasks ? sprint.tasks.filter(task => 
                task.project_id === window.boardData.projectId || task.backlog_id == window.boardData.backlogId
            ) : [];
            
            const totalHours = projectTasks.reduce((sum, task) => sum + (task.estimated_effort || 0), 0);
            const isActive = !sprint.is_archived;
            const statusClass = isActive ? 'success' : 'secondary';
            const statusText = isActive ? 'Ativa' : 'Arquivada';
            
            return `
                <div class="border-bottom p-3 sprint-item" data-sprint-id="${sprint.id}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h6 class="mb-0 me-3">${escapeHtml(sprint.name)}</h6>
                                <span class="badge bg-${statusClass}">${statusText}</span>
                                ${sprint.criticality && sprint.criticality !== 'Normal' ? 
                                    `<span class="badge bg-warning ms-2">${sprint.criticality}</span>` : ''
                                }
                            </div>
                            <div class="row text-muted small">
                                <div class="col-md-3">
                                    <i class="bi bi-calendar3"></i> ${formatDate(sprint.start_date)} - ${formatDate(sprint.end_date)}
                                </div>
                                <div class="col-md-3">
                                    <i class="bi bi-list-task"></i> ${projectTasks.length} tarefas
                                </div>
                                <div class="col-md-3">
                                    <i class="bi bi-clock"></i> ${totalHours}h estimadas
                                </div>
                                <div class="col-md-3">
                                    <i class="bi bi-people"></i> ${getUniqueSpecialists(projectTasks).length} especialistas
                                </div>
                            </div>
                            ${sprint.goal ? `<p class="text-muted small mt-2 mb-0">${escapeHtml(sprint.goal)}</p>` : ''}
                        </div>
                        <div class="d-flex gap-2">
                            <a href="javascript:void(0)" class="btn btn-outline-primary btn-sm" onclick="openSprintsWithProjectFilter(event)" title="Abrir Gerenciamento de Sprints">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    /**
     * Renderiza a lista de especialistas do projeto
     */
    function renderProjectSpecialists(specialists, sprints) {
        const container = document.getElementById('specialistsContainer');
        const countElement = document.getElementById('specialists-count');
        
        if (!container) return;
        
        if (countElement) {
            countElement.textContent = specialists.length;
        }
        
        if (specialists.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-people fs-1"></i>
                    <p>Nenhum especialista atribuído às tarefas</p>
                </div>
            `;
            return;
        }
        
        // Calcula estatísticas por especialista
        const specialistStats = specialists.map(specialist => {
            let totalTasks = 0;
            let totalHours = 0;
            let activeSprintsCount = 0;
            const sprintsInvolved = new Set();
            
            sprints.forEach(sprint => {
                if (sprint.tasks) {
                    const specialistTasks = sprint.tasks.filter(task => 
                        task.specialist_name === specialist && 
                        (task.project_id === window.boardData.projectId || task.backlog_id == window.boardData.backlogId)
                    );
                    
                    if (specialistTasks.length > 0) {
                        totalTasks += specialistTasks.length;
                        totalHours += specialistTasks.reduce((sum, task) => sum + (task.estimated_effort || 0), 0);
                        sprintsInvolved.add(sprint.id);
                        
                        if (!sprint.is_archived) {
                            activeSprintsCount++;
                        }
                    }
                }
            });
            
            return {
                name: specialist,
                totalTasks,
                totalHours,
                sprintsCount: sprintsInvolved.size,
                activeSprintsCount
            };
        });
        
        // Ordena por quantidade de tarefas (decrescente)
        specialistStats.sort((a, b) => b.totalTasks - a.totalTasks);
        
        container.innerHTML = specialistStats.map(specialist => `
            <div class="border-bottom p-3 specialist-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="specialist-avatar me-3">
                            <i class="bi bi-person-circle fs-2 text-primary"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">${escapeHtml(specialist.name)}</h6>
                            <div class="text-muted small">
                                ${specialist.totalTasks} tarefas • ${specialist.totalHours}h estimadas
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-info mb-1">${specialist.sprintsCount} sprints</div>
                        ${specialist.activeSprintsCount > 0 ? 
                            `<div class="badge bg-success">${specialist.activeSprintsCount} ativas</div>` : 
                            '<div class="badge bg-secondary">Sem sprints ativas</div>'
                        }
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    /**
     * Obtém especialistas únicos de uma lista de tarefas
     */
    function getUniqueSpecialists(tasks) {
        const specialists = new Set();
        tasks.forEach(task => {
            if (task.specialist_name && task.specialist_name !== 'Não atribuído') {
                specialists.add(task.specialist_name);
            }
        });
        return Array.from(specialists);
    }
    
    /**
     * Formata data para exibição
     */
    function formatDate(dateString) {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        } catch {
            return '-';
        }
    }
    
    /**
     * Escapa HTML para evitar XSS
     */
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    /**
     * Exporta dados das sprints para Excel
     */
    async function exportSprintData() {
        try {
            const data = await prepareSprintExportData();
            downloadExcel(data, `sprints_projeto_${window.boardData.projectId}.xlsx`);
        } catch (error) {
            console.error('Erro ao exportar dados:', error);
            alert('Erro ao exportar dados: ' + error.message);
        }
    }
    
    /**
     * Prepara dados para exportação
     */
    async function prepareSprintExportData() {
        // Por simplicidade, retorna dados básicos
        // Em uma implementação completa, criaria um arquivo Excel real
        return {
            projectId: window.boardData.projectId,
            exportDate: new Date().toISOString(),
            message: 'Funcionalidade de exportação será implementada conforme necessidade'
        };
    }
    
    /**
     * Download simulado (implementação completa seria feita conforme necessidade)
     */
    function downloadExcel(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename.replace('.xlsx', '.json');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    /**
     * Abre o Sprint Manager com filtro automático pelo projeto atual
     */
    function openSprintsWithProjectFilter(event) {
        // Previne comportamento padrão do link
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const projectId = window.boardData.projectId;
        
        if (!projectId) {
            console.warn('Project ID não disponível, abrindo Sprint Manager sem filtro');
            window.open('/sprints/', '_blank', 'noopener,noreferrer');
            return;
        }
        
        // Busca o nome do projeto atual
        const currentProject = getCurrentProjectInfo();
        
        console.log(`🎯 Abrindo Sprint Manager com filtro para projeto: ${projectId} - ${currentProject.name}`);
        
        // Constrói URL com parâmetros de filtro
        const url = new URL('/sprints/', window.location.origin);
        url.searchParams.set('auto_filter_project', projectId);
        url.searchParams.set('auto_filter_project_name', encodeURIComponent(currentProject.name || ''));
        
        // Abre em nova aba com configurações específicas
        window.open(url.toString(), '_blank', 'noopener,noreferrer');
    }
    
    /**
     * Obtém informações do projeto atual
     */
    function getCurrentProjectInfo() {
        // Primeiro tenta obter do seletor de projeto no topo da página
        const projectSelector = document.querySelector('#projectSelect option:checked, #currentProjectTitle, .project-title');
        
        if (projectSelector) {
            return {
                name: projectSelector.textContent.trim()
            };
        }
        
        // Fallback: busca informações nas tarefas
        const firstTask = document.querySelector('[data-project-id]');
        if (firstTask && firstTask.dataset.projectName) {
            return {
                name: firstTask.dataset.projectName
            };
        }
        
        // Último fallback: busca no título da página ou breadcrumb
        const pageTitle = document.querySelector('h1, .page-title, .breadcrumb-item.active');
        if (pageTitle) {
            return {
                name: pageTitle.textContent.trim()
            };
        }
        
        return {
            name: `Projeto ${window.boardData.projectId}`
        };
    }
    
    // Função para carregar sprints quando a aba for ativada
    document.addEventListener('shown.bs.tab', function(e) {
        if (e.target.id === 'pills-sprints-tab') {
            loadProjectSprints();
        }
    });

    // Inicialização unificada
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM totalmente carregado. Iniciando todos os scripts...");
        console.log("Dados disponíveis:", window.boardData);
        
        // Verifica se os dados estão disponíveis
        if (!window.boardData) {
            console.error("window.boardData não está disponível!");
            return;
        }
        
        // Carrega estado do toggle de visibilidade
        loadSprintVisibilityState();
        
        // Inicializa a data de hoje no campo de data de início da WBS
        const today = new Date().toISOString().split('T')[0];
        const wbsStartDate = document.getElementById('wbs-start-date');
        if (wbsStartDate) {
            wbsStartDate.value = today;
        }
        
        // Inicializa o drag-and-drop do quadro
        if (typeof initializeSortable === 'function') {
            console.log("Inicializando o quadro drag-and-drop...");
            initializeSortable();
        } else {
            console.error("Função initializeSortable não encontrada!");
        }
        
        // Inicializa as ferramentas do projeto (Riscos, Marcos, etc.)
        if (typeof initializeProjectTools === 'function') {
            console.log("Inicializando as ferramentas do projeto...");
            initializeProjectTools();
        } else {
            console.error("Função initializeProjectTools não encontrada!");
        }
    });
</script>
{% endblock %} 