{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/bootstrap-table.min.css" rel="stylesheet">
<style>
    /* ===== DESIGN PROFISSIONAL SOU.CLOUD - RELATÓRIO EXECUTIVO ===== */
    
    /* Importa fonte elegante do Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    /* Classes para controlar visibilidade */
    .screen-only {
        display: block;
    }
    
    /* Ocultar navbar/header do sistema para layout clean */
    .navbar,
    .navbar-brand,
    .navbar-nav,
    .topbar,
    .sidebar,
    nav,
    header,
    .main-header,
    .top-nav,
    .navigation,
    #topbar,
    #navbar,
    #header,
    .header,
    .nav-header,
    .app-header {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        overflow: hidden !important;
    }
    
    /* Resetar body para layout clean */
    body {
        padding-top: 0 !important;
        margin-top: 0 !important;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        background-attachment: fixed;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: #2d3748;
    }
    
    /* Garantir que o conteúdo ocupe toda a tela */
    .content-wrapper,
    .main-content,
    .page-content,
    .wrapper {
        margin-left: 0 !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
    }

    /* Variáveis de design SOU.Cloud corretas */
    :root {
        --sou-rosa: #FF2D5F;
        --sou-azul: #07304F;
        --sou-rosa-light: #ff4d7a;
        --sou-azul-light: #0a4a78;
        --sou-rosa-gradient: linear-gradient(135deg, #FF2D5F 0%, #ff4d7a 100%);
        --sou-azul-gradient: linear-gradient(135deg, #07304F 0%, #0a4a78 100%);
        --light-shadow: 0 2px 12px rgba(7, 48, 79, 0.1);
        --premium-shadow: 0 4px 24px rgba(7, 48, 79, 0.15);
        --text-primary: #2d3748;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --bg-light: #f8fafc;
        --bg-white: #ffffff;
        --border-light: #e2e8f0;
    }

    /* Container principal otimizado */
    .container-fluid {
        background: var(--bg-white);
        border-radius: 12px;
        box-shadow: var(--light-shadow);
        margin: 1rem auto;
        max-width: 98%;
        padding: 0;
        overflow: hidden;
        position: relative;
        width: calc(100% - 2rem);
    }
    
    /* Card principal com design executivo */
    .card {
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: 12px;
        box-shadow: var(--light-shadow);
        overflow: visible;
        margin-bottom: 2rem;
    }
    
    /* Cabeçalho executivo com gradiente */
    .card-header.bg-primary {
        background: var(--sou-azul-gradient) !important;
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 1.5rem 2rem;
        position: relative;
        border: none;
    }
    
    .card-header h5 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .card-header small {
        color: rgba(255, 255, 255, 0.85) !important;
        font-size: 0.875rem;
        font-weight: 400;
        margin-top: 0.25rem;
        display: block;
    }
    
    /* Botões do cabeçalho */
    .card-header .btn-custom {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
    }
    
    .card-header .btn-custom:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Container da tabela premium */
    .card-body {
        padding: 2rem;
        background: var(--bg-white);
    }
    
    /* Toolbar executivo */
    #toolbar {
        margin-bottom: 1.5rem;
        padding: 1rem 1.25rem;
        background: var(--bg-light);
        border-radius: 8px;
        border: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    #report-summary {
        font-weight: 500;
        color: var(--text-secondary);
        flex: 1;
    }
    
    /* Botões modernos */
    .btn {
        font-family: 'Inter', sans-serif;
        font-weight: 500;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    /* Tabela executiva e limpa */
    .table {
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        color: var(--text-primary);
        margin-bottom: 0;
        width: 100%;
        table-layout: fixed;
    }
    
    /* Cabeçalho da tabela executivo */
    .table thead th {
        background: var(--sou-azul) !important;
        color: white !important;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        padding: 1rem 0.75rem;
        border: none;
        text-align: center;
        position: relative;
    }
    
    /* Linhas da tabela */
    .table tbody td {
        padding: 0.875rem 0.75rem;
        border-color: var(--border-light);
        vertical-align: middle;
        font-weight: 400;
        text-align: center;
    }
    
    /* Alinhamentos específicos à esquerda */
    .table tbody td:nth-child(2), /* Cliente */
    .table tbody td:nth-child(4), /* Serviço */
    .table tbody td:nth-child(5), /* Categoria */
    .table tbody td:nth-child(15) /* Account Manager */ {
        text-align: left !important;
    }
    
    .table tbody tr:hover {
        background: var(--bg-light);
        transition: background-color 0.15s ease;
    }
    
    .table tbody tr:nth-child(even) {
        background: #fafbfc;
    }

    /* Status badges executivos */
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        border: none;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .bg-primary {
        background: var(--sou-azul) !important;
        color: white;
    }
    
    .bg-success {
        background: #28a745 !important;
        color: white;
    }
    
    .bg-warning {
        background: #ffc107 !important;
        color: #212529;
    }
    
    .bg-danger {
        background: #dc3545 !important;
        color: white;
    }
    
    .bg-info {
        background: var(--sou-rosa) !important;
        color: white;
    }
    
    .bg-secondary {
        background: #6c757d !important;
        color: white;
    }
    
    /* Badges de squad mais sutis */
    .bg-light {
        background: #f8f9fa !important;
        color: var(--text-secondary) !important;
        border: 1px solid var(--border-light) !important;
    }

    /* Barras de progresso elegantes */
    .progress-thin {
        height: 6px;
        margin-top: 4px;
        background-color: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .progress-thin .progress-bar {
        border-radius: 3px;
        height: 100%;
        transition: width 0.3s ease;
    }
    
    .progress-value {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 3px;
        color: var(--text-primary);
    }
    
    .progress-value-text {
        font-family: 'Inter', monospace;
        font-weight: 600;
    }
    
    /* Gradientes sofisticados para barras */
    .progress-danger .progress-bar { 
        background: linear-gradient(90deg, #dc3545 0%, #c82333 100%) !important; 
    }
    .progress-warning .progress-bar { 
        background: linear-gradient(90deg, #ffc107 0%, #e0a800 100%) !important; 
    }
    .progress-success .progress-bar { 
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%) !important; 
    }
    .progress-info .progress-bar { 
        background: linear-gradient(90deg, var(--sou-rosa) 0%, var(--sou-rosa-light) 100%) !important; 
    }

    /* Texto cortado elegante */
    .truncate-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        max-width: 100%;
        margin: 0 auto;
    }
    
    /* Texto que quebra para colunas alinhadas à esquerda */
    .text-wrap {
        word-wrap: break-word;
        white-space: normal;
        overflow: hidden;
        display: block;
    }
    
    /* Texto de horas negativas destacado */
    .text-danger-bold {
        color: #dc3545 !important;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(220, 53, 69, 0.2);
    }
    
    /* Links executivos */
    .text-primary {
        color: var(--sou-azul) !important;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .text-primary:hover {
        color: var(--sou-azul-light) !important;
        text-decoration: underline;
    }
    
    /* Campos de busca executivos */
    .fixed-table-toolbar .search-input {
        min-width: 300px;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-light);
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        background: var(--bg-white);
        color: var(--text-primary);
        box-shadow: var(--light-shadow);
        transition: all 0.2s ease;
    }
    
    .fixed-table-toolbar .search-input:focus {
        outline: none;
        border-color: var(--sou-azul);
        box-shadow: 0 0 0 0.2rem rgba(7, 48, 79, 0.15);
    }

    /* Botões do Bootstrap Table executivos */
    .fixed-table-toolbar .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        border-radius: 8px;
        border: 1px solid var(--border-light);
        background: var(--bg-white);
        color: var(--text-primary);
        transition: all 0.2s ease;
        font-weight: 500;
    }
    
    .fixed-table-toolbar .btn:hover {
        background: var(--sou-azul);
        color: white;
        border-color: var(--sou-azul);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(7, 48, 79, 0.2);
    }

    /* Loading elegante */
    .loading-template {
        font-style: italic;
        color: var(--text-muted);
    }
    
    /* Responsivo */
    .table-responsive {
        border-radius: 8px;
        box-shadow: var(--light-shadow);
        overflow: visible;
        width: 100%;
        min-height: 400px;
    }

    /* Estilos para impressão executiva */
    @media print {
        .screen-only, .navbar, .sidebar, #toolbar .btn-group {
            display: none !important;
        }
        .card {
            box-shadow: none;
            border: 1px solid #dee2e6;
        }
        body, .container-fluid {
            margin: 0;
            padding: 0;
        }
        .progress-thin, .progress-value {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }
        .table thead th {
            background: var(--sou-azul) !important;
            color: white !important;
        }
    }

    /* Customização específica para apresentação executiva */
    .fw-monospace {
        font-family: 'Inter', monospace !important;
        font-weight: 500;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.35rem 0.65rem;
        font-weight: 600;
    }
    
    /* Melhorias no espaçamento para leitura executiva */
    th[data-field="Nº"] { width: 55px; }
    th[data-field="Cliente"] { width: 165px; text-align: left !important; }
    th[data-field="Squad"] { width: 75px; }
    th[data-field="Serviço"] { width: 125px; text-align: left !important; }
    th[data-field="Categoria"] { width: 120px; text-align: left !important; }
    th[data-field="Status"] { width: 85px; }
    th[data-field="Esforço"] { width: 65px; }
    th[data-field="H. Trab."] { width: 65px; }
    th[data-field="H. Rest."] { width: 80px; }
    th[data-field="Conclusão"] { width: 75px; }
    th[data-field="Faturamento"] { width: 80px; }
    th[data-field="Abertura"] { width: 75px; }
    th[data-field="Vencimento"] { width: 80px; }
    th[data-field="Resolvido"] { width: 75px; }
    th[data-field="Account Manager"] { width: 115px; text-align: left !important; }
    th[data-field="Dias"] { width: 55px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">
                    <i class="bi bi-table"></i>{{ title }}
                </h5>
                <small id="report-description">Relatório consolidado com os dados mais recentes dos períodos selecionados.</small>
            </div>
            <div class="screen-only">
                <a href="{{ url_for('macro.relatorio_geral') }}" class="btn btn-custom me-2">
                    <i class="bi bi-arrow-left"></i> Nova Seleção
                </a>
                <button onclick="window.print();" class="btn btn-custom">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if categoria_filtrada %}
                <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                    <i class="bi bi-funnel-fill me-2"></i>
                    <div>
                        <strong>Filtro por Categoria Ativo:</strong> {{ categoria_filtrada }}
                        <br><small class="text-muted">Os serviços exibidos pertencem à categoria selecionada</small>
                    </div>
                </div>
            {% endif %}
            
            <div id="toolbar">
                <span id="report-summary" class="text-muted">Carregando dados...</span>
                <button id="export-excel" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel me-1"></i> Exportar para Excel
                </button>
            </div>
            
            <div class="table-responsive">
                <table id="table"
                       data-toggle="table"
                       data-url="{{ url_for('macro.api_relatorio_geral_dados', meses=meses_selecionados, filtros=filtros_aplicados) }}"
                       data-pagination="false"
                       data-search="true"
                       data-show-refresh="true"
                       data-show-columns="true"
                       data-show-columns-toggle-all="true"
                       data-toolbar="#toolbar"
                       data-locale="pt-BR"
                       data-show-export="false" 
                       data-loading-template="loadingTemplate"
                       data-classes="table table-hover"
                       data-search-highlight="true"
                       data-sort-name="Nº"
                       data-sort-order="asc">
                    <thead>
                        <tr>
                            <th data-field="Nº" data-sortable="true" data-formatter="numeroFormatter">Nº</th>
                            <th data-field="Cliente" data-sortable="true" data-formatter="textoLeftFormatter">Cliente</th>
                            <th data-field="Squad" data-sortable="true" data-formatter="squadFormatter">Squad</th>
                            <th data-field="Serviço" data-sortable="true" data-formatter="servicoLeftFormatter">Serviço</th>
                            <th data-field="Categoria" data-sortable="true" data-formatter="categoriaFormatter">Categoria</th>
                            <th data-field="Status" data-sortable="true" data-formatter="statusFormatter">Status</th>
                            <th data-field="Esforço" data-sortable="true" data-formatter="horasSimpleFormatter">Esforço</th>
                            <th data-field="H. Trab." data-sortable="true" data-formatter="horasSimpleFormatter">H. Trab.</th>
                            <th data-field="H. Rest." data-sortable="true" data-formatter="horasRestantesFormatter">H. Rest.</th>
                            <th data-field="Conclusão" data-sortable="true" data-formatter="conclusaoFormatter">Conclusão</th>
                            <th data-field="Faturamento" data-sortable="true" data-formatter="faturamentoFormatter">Faturamento</th>
                            <th data-field="Abertura" data-sortable="true" data-formatter="dataFormatter">Abertura</th>
                            <th data-field="Vencimento" data-sortable="true" data-formatter="dataFormatter">Vencimento</th>
                            <th data-field="Resolvido" data-sortable="true" data-formatter="dataFormatter">Resolvido</th>
                            <th data-field="Account Manager" data-sortable="true" data-formatter="textoLeftFormatter">Account Manager</th>
                            <th data-field="Dias" data-sortable="true" data-formatter="diasFormatter">Dias</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/locale/bootstrap-table-pt-BR.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.28.0/tableExport.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/extensions/export/bootstrap-table-export.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-table@1.22.1/dist/extensions/search-highlight/bootstrap-table-search-highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    // Loading template executivo
    function loadingTemplate(message) {
        return `
            <div class="text-center p-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem; border-color: #07304F; border-right-color: transparent;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted fw-medium">Carregando dados do relatório...</p>
                <small class="text-muted">Processando informações dos períodos selecionados</small>
            </div>
        `;
    }

    // Função auxiliar para escape de HTML
    function escapeHtml(unsafe) {
        if (unsafe === null || typeof unsafe === 'undefined') return '';
        return String(unsafe)
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    // Função para obter cor do status
    function getStatusColor(status) {
        const cores = {
            'NOVO': 'info',
            'EM ATENDIMENTO': 'primary',
            'AGUARDANDO': 'warning',
            'BLOQUEADO': 'danger',
            'FECHADO': 'success',
            'ENCERRADO': 'success',
            'RESOLVIDO': 'success',
            'CANCELADO': 'secondary'
        };
        return cores[status?.toUpperCase()] || 'secondary';
    }

    // === FORMATADORES EXECUTIVOS ===

    // Formatador para números (com link para o SOU Cloud)
    function numeroFormatter(value, row) {
        if (!value) return '<span class="text-muted">-</span>';
        return `<a href="https://atendimento.sou.cloud/Ticket/Edit/${value}" target="_blank" 
                   class="text-primary fw-bold" 
                   title="Abrir no SOU Cloud">${value}</a>`;
    }

    // Formatador de texto executivo
    function textoFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        const texto = escapeHtml(value);
        return `<span class="fw-medium" title="${texto}">${texto}</span>`;
    }
    
    // Formatador para texto alinhado à esquerda (com quebra)
    function textoLeftFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        const texto = escapeHtml(value);
        return `<span class="fw-medium text-wrap" title="${texto}">${texto}</span>`;
    }

    // Formatador para Squad executivo
    function squadFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        const squad = escapeHtml(value);
        return `<span class="badge bg-light text-dark truncate-text" title="${squad}">${squad}</span>`;
    }

    // Formatador para Serviço executivo
    function servicoFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        const servico = escapeHtml(value);
        return `<small class="text-muted fw-medium" title="${servico}">${servico}</small>`;
    }
    
    // Formatador para Serviço alinhado à esquerda
    function servicoLeftFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        const servico = escapeHtml(value);
        return `<small class="text-muted fw-medium text-wrap" title="${servico}">${servico}</small>`;
    }

    // Formatador para Categoria
    function categoriaFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        const categoria = escapeHtml(value);
        
        // Cores específicas para algumas categorias conhecidas
        const coresCategorias = {
            'Azure Migrate': 'primary',
            'Microsoft 365 Migration': 'warning',
            'Azure Active Directory': 'info',
            'Azure Backup': 'success',
            'Microsoft Power BI': 'danger',
            'SharePoint Online': 'secondary'
        };
        
        const cor = coresCategorias[categoria] || 'dark';
        return `<span class="badge bg-${cor} text-white" style="font-size: 0.7em;" title="${categoria}">${categoria}</span>`;
    }

    // Formatador para Status executivo
    function statusFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        const status = escapeHtml(value);
        const cor = getStatusColor(status);
        return `<span class="badge status-badge bg-${cor}">${status}</span>`;
    }

    // Formatador simples para horas executivo
    function horasSimpleFormatter(value, row) {
        if (!value || isNaN(parseFloat(value))) return '<span class="text-muted">0h</span>';
        
        const horas = parseFloat(value);
        const horasInteiras = Math.floor(Math.abs(horas));
        const minutos = Math.round((Math.abs(horas) - horasInteiras) * 60);
        const sinal = horas < 0 ? '-' : '';
        
        return `<span class="fw-monospace fw-medium">${sinal}${horasInteiras}h${String(minutos).padStart(2, '0')}m</span>`;
    }

    // Formatador executivo para Horas Restantes
    function horasRestantesFormatter(value, row) {
        const horasRestantes = !isNaN(parseFloat(value)) ? parseFloat(value) : 0;
        const esforco = !isNaN(parseFloat(row.Esforço)) ? parseFloat(row.Esforço) : 0;

        // Formatação executiva do valor
        const sinal = horasRestantes < 0 ? "-" : "";
        const horasAbs = Math.abs(horasRestantes);
        const horasInteiras = Math.floor(horasAbs);
        const minutosDecimais = (horasAbs - horasInteiras) * 60;
        const minutosInteiros = Math.round(minutosDecimais);

        const displayValue = `${sinal}${horasInteiras}h${String(minutosInteiros).padStart(2, '0')}m`;

        // Lógica de cores executiva
        let horasClass = 'progress-success';
        let percentualHoras = 0;

        if (horasRestantes < 0) {
            horasClass = 'progress-danger';
            percentualHoras = 100;
        } else if (horasRestantes < 10 && esforco > 0) {
            horasClass = 'progress-warning';
            percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
        } else if (esforco > 0) {
            percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
        }

        return `
            <div class="progress-value">
                <span class="progress-value-text ${horasRestantes < 0 ? 'text-danger-bold' : ''}">${displayValue}</span>
            </div>
            <div class="progress-thin ${horasClass}">
                <div class="progress-bar" style="width: ${percentualHoras.toFixed(1)}%;"></div>
            </div>
        `;
    }

    // Formatador executivo para Conclusão
    function conclusaoFormatter(value, row) {
        const conclusao = !isNaN(parseFloat(value)) ? parseFloat(value) : 0;
        
        // Lógica de cores executiva
        let progressClass = 'progress-info';
        if (conclusao < 30) {
            progressClass = 'progress-danger';
        } else if (conclusao < 70) {
            progressClass = 'progress-warning';
        } else if (conclusao >= 70) {
            progressClass = 'progress-success';
        }

        return `
            <div class="progress-value">
                <span class="progress-value-text">${conclusao.toFixed(1)}%</span>
            </div>
            <div class="progress-thin ${progressClass}">
                <div class="progress-bar" style="width: ${conclusao}%;"></div>
            </div>
        `;
    }

    // Formatador executivo para Faturamento
    function faturamentoFormatter(value, row) {
        if (!value || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        
        const faturamento = escapeHtml(value);
        const cores = {
            'PRIME': 'primary',
            'PLUS': 'success', 
            'INICIO': 'info',
            'TERMINO': 'warning',
            'ENGAJAMENTO': 'secondary'
        };
        
        const cor = cores[faturamento.toUpperCase()] || 'light';
        return `<span class="badge bg-${cor} ${cor === 'light' ? 'text-dark' : ''}">${faturamento}</span>`;
    }

    // Formatador executivo para datas
    function dataFormatter(value, row) {
        if (!value || value === 'N/A' || value === '' || String(value).toUpperCase() === 'N/A') {
            return '<span class="text-muted">-</span>';
        }
        
        try {
            let data;
            if (value.includes('T')) {
                data = new Date(value);
            } else if (value.includes('/')) {
                const [dia, mes, ano] = value.split('/');
                data = new Date(ano, mes - 1, dia);
            } else {
                data = new Date(value);
            }
            
            if (isNaN(data.getTime())) {
                return `<span class="fw-medium">${escapeHtml(value)}</span>`;
            }
            
            return `<span class="fw-medium">${data.toLocaleDateString('pt-BR')}</span>`;
        } catch (e) {
            return `<span class="fw-medium">${escapeHtml(value)}</span>`;
        }
    }

    // Formatador executivo para dias
    function diasFormatter(value, row) {
        if (!value || isNaN(parseInt(value))) return '<span class="text-muted">-</span>';
        
        const dias = parseInt(value);
        let badgeClass = 'bg-success';
        let icone = 'bi-check-circle';
        
        if (dias > 365) {
            badgeClass = 'bg-danger';
            icone = 'bi-exclamation-triangle';
        } else if (dias > 180) {
            badgeClass = 'bg-warning text-dark';
            icone = 'bi-clock';
        } else if (dias > 90) {
            badgeClass = 'bg-info';
            icone = 'bi-info-circle';
        }
        
        return `
            <span class="badge status-badge ${badgeClass}">
                <i class="${icone} me-1"></i>${dias}d
            </span>
        `;
    }

    // === EVENTOS E INICIALIZAÇÃO EXECUTIVA ===
    $(document).ready(function() {
        var $table = $('#table');

        // Evento de sucesso executivo
        $table.on('load-success.bs.table', function (e, data) {
            $('#report-summary').html(`
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong>Relatório Consolidado</strong>: ${data.length} projetos únicos encontrados (todos exibidos).
            `);
        });

        // Evento de erro executivo
        $table.on('load-error.bs.table', function (e, status, jqXHR) {
            $('#report-summary').html(`
                <i class="bi bi-x-circle-fill text-danger me-2"></i>
                Erro ao carregar os dados. Tente atualizar a página.
            `);
        });
        
        // Exportação executiva para Excel
        $('#export-excel').on('click', function() {
            $table.bootstrapTable('exportTable', {
                type: 'excel',
                fileName: 'Relatorio_Executivo_Control360_' + new Date().toISOString().split('T')[0]
            });
        });

        // Responsividade executiva
        $(window).resize(function() {
            $table.bootstrapTable('resetView');
        });
    });
</script>
{% endblock %}
