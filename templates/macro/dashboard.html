<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Macro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery (necessário para Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle com Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Inter', sans-serif; 
        }
        .card { 
            margin-bottom: 1.5rem; 
        }
        .graficos-container { 
            display: flex; 
            gap: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .card-grafico { 
            flex: 1; 
            min-width: 0; 
        }
        .spin { 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }
        
        #statusChart { 
            height: 400px !important; 
            max-height: 400px !important; 
        }
        
        .bg-purple { 
            background-color: #6f42c1; 
        }
        .bg-purple-light { 
            background-color: rgba(111, 66, 193, 0.15); 
        }
        .text-purple { 
            color: #6f42c1; 
        }
        .border-left-purple { 
            border-left: 0.25rem solid #6f42c1 !important; 
        }
        
        .bg-danger-light { 
            background-color: rgba(220, 53, 69, 0.15); 
        }
        .text-danger { 
            color: #dc3545; 
        }
        .border-left-danger { 
            border-left: 0.25rem solid #dc3545 !important; 
        }
        
        .border-left-primary { 
            border-left: 0.25rem solid #4e73df !important; 
        }
        .border-left-success { 
            border-left: 0.25rem solid #1cc88a !important; 
        }
        .border-left-info { 
            border-left: 0.25rem solid #36b9cc !important; 
        }
        .border-left-warning { 
            border-left: 0.25rem solid #f6c23e !important; 
        }
        
        .card.shadow { 
            height: 100%; 
        }
        .card-body { 
            height: calc(100% - 48px); 
        }
        .card-grafico canvas { 
            max-height: 100%; 
        }
        
        .kpi-action-card { 
            cursor: pointer; 
            transition: transform 0.2s ease-in-out; 
        }
        .kpi-action-card:hover { 
            transform: translateY(-5px); 
        }
        
        .btn-purple { 
            background-color: #6f42c1; 
            color: white; 
        }
        .btn-purple:hover { 
            background-color: #5a32a3; 
            color: white; 
        }
        
        .modal-content { 
            border-radius: 0.5rem; 
            border: none; 
            max-height: 90vh;
            width: 100%;
        }
        .modal-header { 
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 0.75rem 1.25rem;
        }
        .modal-footer { 
            border-radius: 0 0 0.5rem 0.5rem;
            padding: 0.75rem;
        }
        .modal-xl {
            max-width: 95%;
            max-height: 90vh;
        }
        .modal-body {
            max-height: calc(90vh - 120px);
            min-height: 600px; /* Adicionado para altura mínima consistente */
            overflow-y: auto;
        }
        
        .modal .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        
        .modal .table thead th {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .modal .table tbody td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .modal .table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .modal .table tbody tr:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .table-responsive {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .progress-thin {
            height: 6px;
            margin-top: 4px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-thin .progress-bar {
            border-radius: 3px;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0,0,0,0.02);
        }

        /* <<< INÍCIO: Estilos Tabela Gerencial (Barras de Progresso, etc.) >>> */
        .progress-thin {
            height: 6px;
            margin-top: 4px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-thin .progress-bar {
            border-radius: 3px;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .progress-value-text {
            font-family: 'Inter', monospace;
        }

        /* Cores para diferentes níveis de progresso (Conclusão E Horas Restantes) - FORÇADO */
        .progress-danger .progress-bar {
            background-color: #dc3545 !important; /* Vermelho */
        }
        .progress-warning .progress-bar {
            background-color: #ffc107 !important; /* Amarelo */
        }
        .progress-success .progress-bar {
            background-color: #198754 !important; /* Verde */
        }
        .progress-info .progress-bar {
            background-color: #0dcaf0 !important; /* Azul Info (caso usado) */
        }

        /* Cores/Estilos específicos para Horas Restantes - REMOVIDO (usando padrão acima) */
        /* .horas-restantes-positivo .progress-bar { background-color: #198754 !important; } */
        /* .horas-restantes-negativo .progress-bar { background-color: #dc3545 !important; } */
        /* .horas-restantes-zerado .progress-bar { background-color: #ffc107 !important; } */

        /* Estilos para limitar tamanho das colunas e texto */
        .modal .table td.projeto-col {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal .table td.squad-col {
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal .table td.status-col {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        /* <<< FIM: Estilos Tabela Gerencial >>> */

        .modal-sprint-custom {
            max-width: 98%;
            max-height: 95vh;
        }
        
        .modal-sprint-custom .modal-content {
            height: 90vh;
        }
        
        .modal-sprint-custom .modal-body {
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }
        
        #sprintContainer {
            min-height: 500px;
        }
        
        #sprintContainer .card {
            min-width: 280px;
        }
        
        /* <<< FIM: Estilos Tabela Gerencial >>> */
        
        /* === NOVOS ESTILOS PARA VISUALIZAÇÕES === */
        .visualization-view {
            min-height: 400px;
        }
        
        .progress-thin {
            height: 6px;
            margin-top: 4px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-thin .progress-bar {
            border-radius: 3px;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .categoria-item {
            transition: transform 0.2s ease;
        }
        
        .categoria-item:hover {
            transform: translateY(-2px);
        }
        
        .btn-group .btn {
            font-size: 0.875rem;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }
        
        .table th.sticky-top {
            z-index: 1020;
        }
        
        .table tbody tr:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .input-group-sm .form-control {
            font-size: 0.875rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        @media (max-width: 768px) {
            .btn-group .btn span {
                display: none !important;
            }
            
            .visualization-view {
                min-height: 300px;
            }
            
            .chart-container {
                height: 250px;
            }
        }
        /* === FIM NOVOS ESTILOS === */
        
        /* === CONTROLE DE ALTURA DOS GRÁFICOS === */
        #viewCharts .card-body div[style*="height: 350px"] {
            height: 350px !important;
            max-height: 350px !important;
            overflow: hidden;
        }
        
        #chartTopCategorias, #chartDistribuicaoHoras {
            max-height: 350px !important;
            height: auto !important;
        }
        
        /* Força altura máxima para os containers dos gráficos */
        #viewCharts .card {
            max-height: 450px;
        }
        
        #viewCharts .card-body {
            max-height: 400px;
            overflow: hidden;
        }
        
        /* Reduz espaçamento para melhor aproveitamento */
        #viewCharts .card-header {
            padding: 0.5rem 1rem;
        }
        
        #viewCharts .card-body {
            padding: 0.75rem !important;
        }
        /* === FIM CONTROLE GRÁFICOS === */
    </style>
</head>
<body style="padding-top: 70px;">
    <!-- Barra de Navegação Principal Fixa (Colada) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('macro.dashboard') }}">
                <i class="bi bi-speedometer2"></i> Control360
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'gerencial.dashboard' else '' }}" href="{{ url_for('gerencial.dashboard') }}">
                            <i class="bi bi-kanban"></i>
                            <span>Gerencial</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'macro.dashboard' else '' }}" href="{{ url_for('macro.dashboard') }}">
                            <i class="bi bi-speedometer2"></i>
                            <span>Macro</span>
                        </a>
                    </li>
                    <!-- Item 'Performance' removido -->
                    
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'macro.apresentacao' else '' }}" href="{{ url_for('macro.apresentacao') }}">
                            <i class="bi bi-file-earmark-slides"></i>
                            <span>Status Report</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav> 
    
    <!-- Container Principal (Conteúdo Mantido) -->
    <div class="container-fluid mt-4">
    
        <!-- NOVO TITULO E DATA -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800"><i class="bi bi-speedometer2 me-2"></i>Visão Macro</h1>
            <span class="text-muted small">
                 {% if hora_atualizacao %}
                    Atualizado em: {{ hora_atualizacao.strftime('%d/%m/%Y %H:%M:%S') }}
                 {% endif %}
            </span>
        </div>
        <!-- FIM NOVO TITULO E DATA -->

        <!-- Modal Projetos do Especialista -->
        <div class="modal fade" id="modalEspecialistaProjetos" tabindex="-1" aria-labelledby="modalEspecialistaProjetosLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="modalEspecialistaProjetosLabel">
                            <i class="bi bi-person"></i> Projetos Ativos - Especialista
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Conteúdo será preenchido dinamicamente pelo JavaScript -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-info" onclick="abrirSprintSemanal()" id="btnSprintSemanal">
                            <i class="bi bi-calendar-week"></i> Sprint Semanal
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Projetos do Account Manager -->
        <div class="modal fade" id="modalAccountProjetos" tabindex="-1" aria-labelledby="modalAccountProjetosLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="modalAccountProjetosLabel">
                            <i class="bi bi-person-badge"></i> Projetos Ativos - Account Manager
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Conteúdo será preenchido dinamicamente pelo JavaScript -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Projetos por Status -->
        <div class="modal fade" id="modalProjetosPorStatus" tabindex="-1" aria-labelledby="modalProjetosPorStatusLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="modalProjetosPorStatusLabel">
                            <i class="bi bi-clipboard-check"></i> Projetos por Status
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Conteúdo será preenchido dinamicamente pelo JavaScript -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid py-4">
            <!-- Cabeçalho (REMOVENDO TITULO ANTIGO) -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <!-- REMOVENDO H1 ANTIGO -->
                <!-- 
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="bi bi-speedometer2 me-2"></i> Visão Macro
                </h1>
                -->
            </div>

            <!-- GRID 1: Cards principais -->
            <div class="row mb-4">
                <!-- Card Projetos Ativos -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-success shadow h-100 py-2 kpi-action-card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modalProjetosAtivos">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Projetos Ativos</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.projetos_ativos }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-calendar fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Projetos Críticos -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-danger shadow h-100 py-2 kpi-action-card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modalProjetosCriticos">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                        Projetos Críticos</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.projetos_criticos }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Eficiência de Entrega -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Eficiência de Entrega</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.eficiencia_entrega }}%</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-speedometer2 fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Projetos Concluídos -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-success shadow h-100 py-2 kpi-action-card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modalProjetosConcluidos">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Projetos Concluídos</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.projetos_concluidos }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-check-circle-fill fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRID 2: Cards secundários -->
            <div class="row mb-4">
                <!-- Card Tempo Médio de Vida -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tempo Médio de Vida
                            </div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div class="h2 mb-0 font-weight-bold text-gray-800">{{ kpis.tempo_medio_vida }} dias</div>
                            </div>
                            <div class="col-auto" style="position: absolute; top: 1rem; right: 1.5rem;">
                                <i class="bi bi-hourglass-split fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Média de Horas -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Média de Horas por Projeto
                            </div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div class="h2 mb-0 font-weight-bold text-gray-800">{{ kpis.media_horas }}h</div>
                            </div>
                            <div class="col-auto" style="position: absolute; top: 1rem; right: 1.5rem;">
                                <i class="bi bi-clock-history fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card de Ocupação por Squad -->
                <div class="col-xl-6 col-md-12">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-3">
                                Ocupação por Squad
                            </div>
                            <div class="squad-list">
                                {% for squad in ocupacao_squads %}
                                <div class="squad-info mb-2" data-bs-toggle="modal" data-bs-target="#modalSquad{{ loop.index }}" style="cursor: pointer;">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="fw-bold">{{ squad.nome }}</span>
                                        <span class="badge {% if squad.tem_horas_negativas %}bg-warning{% else %}bg-primary{% endif %}">
                                            {{ "%.1f"|format(squad.horas_restantes) }}h
                                        </span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar {% if squad.tem_horas_negativas %}bg-warning{% else %}bg-primary{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ "%.1f"|format(squad.percentual_ocupacao) }}%">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

           

            <!-- Conteúdo das Abas (Estrutura Mantida) -->
            <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button">
                        <i class="bi bi-clipboard-check me-1"></i> Por Status
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="especialistas-tab" data-bs-toggle="tab" data-bs-target="#especialistas" type="button">
                        <i class="bi bi-people me-1"></i> Especialistas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button">
                        <i class="bi bi-briefcase me-1"></i> Account Managers
                    </button>
                </li>
                 <!-- Nova Aba para Projetos em Risco -->
                 <li class="nav-item" role="presentation">
                    <button class="nav-link" id="risco-tab" data-bs-toggle="tab" data-bs-target="#risco" type="button">
                        <i class="bi bi-exclamation-triangle me-1"></i> Projetos em Risco
                    </button>
                </li>
                <!-- Nova Aba para Tipos de Serviço -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tipos-servico-tab" data-bs-toggle="tab" data-bs-target="#tipos-servico" type="button">
                        <i class="bi bi-diagram-3 me-1"></i> Tipos de Serviço
                    </button>
                </li>
                <!-- Nova Aba para Relatórios -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios" type="button">
                        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Relatórios
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="dashboardTabsContent">
                <!-- Aba Status (Gráfico e Tabela Resumo) -->
                <div class="tab-pane fade show active" id="status" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6" style="height: 400px;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="card-title">Resumo por Status</h5>
                                    
                                    <!-- Tabela 1: Projetos Ativos -->
                                    <h6 class="card-subtitle mb-2 text-muted">Projetos Ativos</h6>
                                    <div class="table-responsive mb-4">
                                        <table class="table table-hover table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Status</th>
                                                    <th class="text-end">Quantidade</th>
                                                    <th class="text-end">Horas Totais</th>
                                                    <th class="text-end">Conclusão Média</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for status, data in por_status.items() %}
                                                    {% if status in ['EM ATENDIMENTO', 'AGUARDANDO', 'BLOQUEADO'] %}
                                                    <tr class="clickable-row" data-status="{{ status }}" style="cursor: pointer;" title="Clique para ver os projetos com status {{ status }}">
                                                        <td>
                                                            <span class="badge bg-{{ data.cor|default('light') }}">
                                                                {{ status }}
                                                            </span>
                                                        </td>
                                                        <td class="text-end">{{ data.quantidade }}</td>
                                                        <td class="text-end">{{ data.horas_totais|default(0)|round(1) }}h</td>
                                                        <td class="text-end">{{ data.conclusao_media|default(0)|round(1) }}%</td>
                                                    </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Tabela 2: Novo e Fechado -->
                                    <h6 class="card-subtitle mb-2 text-muted">Novo e Fechado</h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Status</th>
                                                    <th class="text-end">Quantidade</th>
                                                    <th class="text-end">Horas Totais</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for status, data in por_status.items() %}
                                                    {% if status in ['NOVO', 'FECHADO'] %}
                                                    <tr class="clickable-row" data-status="{{ status }}" style="cursor: pointer;" title="Clique para ver os projetos com status {{ status }}">
                                                        <td>
                                                            <span class="badge bg-{{ data.cor|default('light') }}">
                                                                {{ status }}
                                                            </span>
                                                        </td>
                                                        <td class="text-end">{{ data.quantidade }}</td>
                                                        <td class="text-end">{{ data.horas_totais|default(0)|round(1) }}h</td>
                                                    </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Especialistas -->
                <div class="tab-pane fade" id="especialistas" role="tabpanel">
                    <!-- Header com botão para modal de resumo -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div></div> <!-- Espaço vazio para alinhamento -->
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="carregarEExibirResumoEspecialistas()" title="Visualizar resumo dos especialistas em cards">
                            <i class="bi bi-collection"></i> Resumo em Cards
                        </button>
                    </div>
                    <!-- Removido o card que envolvia o conteúdo -->
                    {% include 'macro/partials/tabela_especialistas.html' %}
                </div>

                <!-- Aba Account Managers -->
                <div class="tab-pane fade" id="accounts" role="tabpanel">
                    <div class="card">
                        <!-- Aplicando as mesmas classes do header de Especialistas para padronização visual -->
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            Projetos por Account Manager
                            <!-- Sem campo de busca aqui -->
                        </div>
                        <div class="card-body">
                            {% if dados_accounts is defined and dados_accounts %}
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;"> <!-- Removido table-striped -->
                                    <thead>
                                        <tr>
                                            <th>Account Manager</th>
                                            <th class="text-end">Projetos</th>
                                            <th class="text-end">Horas Totais</th>
                                            <th class="text-end">Horas Restantes</th>
                                            <th class="text-end">Conclusão Média</th>
                                            <th class="text-end">Bloqueados</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in dados_accounts %}
                                        <tr class="clickable-row" data-account="{{ item['Account Manager'] }}" style="cursor: pointer;" title="Clique para ver os projetos de {{ item['Account Manager'] }}">
                                            <td>{{ item['Account Manager'] }}</td>
                                            <td class="text-end">{{ item.total_projetos }}</td>
                                            <td class="text-end">{{ item.horas_totais|round(1) }}h</td>
                                            <td class="text-end {% if item.horas_restantes < 0 %}text-danger fw-bold{% endif %}">
                                                {% if item.horas_restantes < 0 %}
                                                    <i class="bi bi-exclamation-triangle-fill me-1" title="Saldo de horas negativo!"></i>
                                                {% endif %}
                                                {{ "%.1f"|format(item.horas_restantes) }}h
                                            </td>
                                            <td class="text-end">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ get_conclusao_color(item.conclusao_media) }}" 
                                                         role="progressbar" 
                                                         style="width: {{ item.conclusao_media }}%"
                                                         aria-valuenow="{{ item.conclusao_media }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(item.conclusao_media) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                                <span class="badge bg-{{ 'danger' if item.projetos_bloqueados > 0 else 'secondary' }}">
                                                    {{ item.projetos_bloqueados }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Dados de Account Managers não disponíveis ou coluna não encontrada no CSV.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                 <!-- Aba Projetos em Risco (Nova Aba) -->
                <div class="tab-pane fade" id="risco" role="tabpanel">
                     <div class="card">
                         <!-- Aplicando as mesmas classes do header das outras abas -->
                         <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            Projetos em Risco (Preventivo)
                        </div>
                        <div class="card-body">
                            {% if projetos_risco %}
                            <div class="table-responsive">
                                <!-- Removido table-striped -->
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th style="white-space: nowrap;">Projeto</th>
                                            <th style="white-space: nowrap;">Status</th>
                                            <th style="white-space: nowrap;">Squad</th>
                                            <th style="white-space: nowrap;">Hrs Rest.</th> <!-- Abreviado -->
                                            <th style="white-space: nowrap;">Término</th>   <!-- Abreviado -->
                                            <th style="white-space: nowrap;">Concl. (%)</th><!-- Abreviado -->
                                            <th style="white-space: nowrap;">Motivo</th>    <!-- Abreviado -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for projeto in projetos_risco %}
                                        <tr>
                                            <td>{{ projeto.Projeto }}</td>
                                            <td>
                                                <span class="badge bg-{{ get_status_color(projeto.Status) }}">
                                                    {{ projeto.Status }}
                                                </span>
                                            </td>
                                            <td>{{ projeto.Squad }}</td>
                                            <td>{{ "%.1f"|format(projeto.HorasRestantes) }}h</td>
                                            <td>{{ projeto.DataTermino }}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ get_conclusao_color(projeto.Conclusao) }}" 
                                                         role="progressbar" 
                                                         style="width: {{ projeto.Conclusao }}%"
                                                         aria-valuenow="{{ projeto.Conclusao }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(projeto.Conclusao) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="text-warning">
                                                    <i class="bi bi-info-circle"></i>
                                                    {{ projeto.motivo_risco }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                             {% else %}
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle"></i> Nenhum projeto em risco identificado.
                            </div>
                            {% endif %}
                        </div>
                     </div>
                </div>

                <!-- Aba Tipos de Serviço (Nova) -->
                <div class="tab-pane fade" id="tipos-servico" role="tabpanel">
                    <div class="card border-0 shadow">
                        <div class="card-header border-0 py-4 bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                        <i class="bi bi-diagram-3-fill fs-4 text-primary"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1 fw-bold text-dark">Análise por Tipos de Serviço</h5>
                                        <p class="mb-0 text-muted small">Categorização e insights dos serviços executados</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-light btn-sm px-3" onclick="forcarRefreshCSV()" title="Forçar recarga do CSV (limpa cache)" style="display: none;">
                                        <i class="bi bi-arrow-repeat me-1"></i>
                                        <span class="d-none d-lg-inline">Refresh CSV</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Loading inicial -->
                            <div id="loadingTiposServico" class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2 text-muted">Carregando tipos de serviço...</p>
                            </div>

                            <!-- Container dos cards de categorias -->
                            <div id="containerTiposServico" style="display: none;">
                                <!-- Cabeçalho melhorado com métricas principais -->
                                <div class="row mb-4">
                                    <!-- Métricas principais em destaque -->
                                    <div class="col-xl-9 col-lg-8">
                                        <div class="row g-3">
                                            <div class="col-lg-3 col-md-6">
                                                <div class="card border-left-primary shadow h-100 py-2">
                                                    <div class="card-body">
                                                        <div class="row no-gutters align-items-center">
                                                            <div class="col mr-2">
                                                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Categorias Ativas</div>
                                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalCategorias">0</div>
                                                            </div>
                                                            <div class="col-auto">
                                                                <i class="bi bi-diagram-3-fill fa-2x text-gray-300"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6">
                                                <div class="card border-left-success shadow h-100 py-2">
                                                    <div class="card-body">
                                                        <div class="row no-gutters align-items-center">
                                                            <div class="col mr-2">
                                                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Tipos de Serviço</div>
                                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalTipos">0</div>
                                                            </div>
                                                            <div class="col-auto">
                                                                <i class="bi bi-tags-fill fa-2x text-gray-300"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6">
                                                <div class="card border-left-info shadow h-100 py-2">
                                                    <div class="card-body">
                                                        <div class="row no-gutters align-items-center">
                                                            <div class="col mr-2">
                                                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Projetos Analisados</div>
                                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalProjetos">0</div>
                                                            </div>
                                                            <div class="col-auto">
                                                                <i class="bi bi-folder-fill fa-2x text-gray-300"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-3 col-md-6">
                                                <div class="card border-left-warning shadow h-100 py-2">
                                                    <div class="card-body">
                                                        <div class="row no-gutters align-items-center">
                                                            <div class="col mr-2">
                                                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Horas Trabalhadas</div>
                                                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalHoras">0h</div>
                                                            </div>
                                                            <div class="col-auto">
                                                                <i class="bi bi-clock-fill fa-2x text-gray-300"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Painel de informações do período -->
                                    <div class="col-xl-3 col-lg-4">
                                        <div class="card border-left-info shadow h-100 py-2">
                                            <div class="card-body">
                                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Período de Análise</div>
                                                <div class="row no-gutters align-items-center">
                                                    <div class="col mr-2">
                                                        <div class="text-gray-800" style="font-size: 0.9rem;">
                                                            <div class="mb-1">
                                                                <i class="bi bi-calendar3 me-1"></i>
                                                                <span id="periodoAnalise" class="font-weight-bold">Carregando...</span>
                                                            </div>
                                                            <div class="text-muted small">
                                                                <i class="bi bi-clock me-1"></i>
                                                                <span id="dataAtualizacao">Atualizado em: --</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-auto">
                                                        <i class="bi bi-calendar-check-fill fa-2x text-gray-300"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Controles de Visualização e Ações -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body p-3">
                                                <div class="row align-items-center">
                                                    <!-- Toggles de Visualização -->
                                                    <div class="col-lg-6 col-md-12 mb-2 mb-lg-0">
                                                        <div class="d-flex align-items-center">
                                                            <span class="text-muted me-3 small fw-bold">VISUALIZAÇÃO:</span>
                                                            <div class="btn-group" role="group" aria-label="Modos de visualização">
                                                                <button type="button" class="btn btn-primary btn-sm" id="btnViewCharts" onclick="alterarVisualizacao('charts')">
                                                                    <i class="bi bi-bar-chart-fill me-1"></i>
                                                                    <span class="d-none d-md-inline">Gráficos</span>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-primary btn-sm" id="btnViewTable" onclick="alterarVisualizacao('table')">
                                                                    <i class="bi bi-table me-1"></i>
                                                                    <span class="d-none d-md-inline">Tabela</span>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-primary btn-sm" id="btnViewCompact" onclick="alterarVisualizacao('compact')">
                                                                    <i class="bi bi-list-ul me-1"></i>
                                                                    <span class="d-none d-md-inline">Lista</span>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Botões de Ação -->
                                                    <div class="col-lg-6 col-md-12">
                                                        <div class="d-flex gap-2 justify-content-lg-end">
                                                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="mostrarMapeamentoDexPra()">
                                                                <i class="bi bi-arrow-left-right me-1"></i>
                                                                <span class="d-none d-lg-inline">DexPra</span>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="carregarTiposServico()" title="Recarregar dados">
                                                                <i class="bi bi-arrow-clockwise me-1"></i>
                                                                <span class="d-none d-lg-inline">Atualizar</span>
                                                            </button>
                                                            <!-- Botões ocultos mantidos para funcionalidade -->
                                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="debugNormalizacao()" title="Debug da normalização" style="display: none;">
                                                                <i class="bi bi-bug"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Container de Visualizações -->
                                <div id="visualizacaoContainer">
                                    
                                    <!-- 1. Visão Gráfica (Padrão) -->
                                    <div id="viewCharts" class="visualization-view">
                                        <!-- Resumo Executivo no topo -->
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <div class="card border-0 shadow-sm">
                                                    <div class="card-header bg-light py-2">
                                                        <h6 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Resumo Executivo</h6>
                                                    </div>
                                                    <div class="card-body py-3">
                                                        <div id="resumoExecutivo" class="row">
                                                            <!-- Resumo será preenchido via JS -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Gráficos Compactos -->
                                        <div class="row">
                                            <!-- Gráfico Principal -->
                                            <div class="col-lg-8 mb-4">
                                                <div class="card border-0 shadow-sm">
                                                    <div class="card-header bg-light py-2">
                                                        <h6 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Top 10 Categorias por Volume</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <div style="height: 350px; position: relative;">
                                                            <canvas id="chartTopCategorias"></canvas>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Gráfico de Distribuição -->
                                            <div class="col-lg-4 mb-4">
                                                <div class="card border-0 shadow-sm">
                                                    <div class="card-header bg-light py-2">
                                                        <h6 class="mb-0"><i class="bi bi-pie-chart-fill me-2"></i>Distribuição de Horas</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <div style="height: 350px; position: relative;">
                                                            <canvas id="chartDistribuicaoHoras"></canvas>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 2. Visão Tabular -->
                                    <div id="viewTable" class="visualization-view" style="display: none;">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-light">
                                                <div class="row align-items-center">
                                                    <div class="col-md-6">
                                                        <h6 class="mb-0"><i class="bi bi-table me-2"></i>Categorias de Serviços - Visão Detalhada</h6>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                                                            <input type="text" class="form-control" id="searchTable" placeholder="Buscar categoria...">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover table-sm mb-0" id="tableDetalhada">
                                                        <thead class="table-dark sticky-top">
                                                            <tr>
                                                                <th style="cursor: pointer;" onclick="ordenarTabela('categoria')">
                                                                    Categoria <i class="bi bi-arrow-down-up ms-1"></i>
                                                                </th>
                                                                <th class="text-center" style="cursor: pointer;" onclick="ordenarTabela('total')">
                                                                    Total <i class="bi bi-arrow-down-up ms-1"></i>
                                                                </th>
                                                                <th class="text-center" style="cursor: pointer;" onclick="ordenarTabela('ativos')">
                                                                    Ativos <i class="bi bi-arrow-down-up ms-1"></i>
                                                                </th>
                                                                <th class="text-center" style="cursor: pointer;" onclick="ordenarTabela('concluidos')">
                                                                    Concluídos <i class="bi bi-arrow-down-up ms-1"></i>
                                                                </th>
                                                                <th class="text-center" style="cursor: pointer;" onclick="ordenarTabela('horas')">
                                                                    Horas <i class="bi bi-arrow-down-up ms-1"></i>
                                                                </th>
                                                                <th class="text-center" style="cursor: pointer;" onclick="ordenarTabela('percentual')">
                                                                    % Ativo <i class="bi bi-arrow-down-up ms-1"></i>
                                                                </th>
                                                                <th class="text-center">Tipos</th>
                                                                <th class="text-center">Ação</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="tabelaDetalhada">
                                                            <!-- Preenchido via JavaScript -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 3. Visão Compacta -->
                                    <div id="viewCompact" class="visualization-view" style="display: none;">
                                        <div class="row">
                                            <!-- Filtros Rápidos -->
                                            <div class="col-12 mb-3">
                                                <div class="card border-0 shadow-sm">
                                                    <div class="card-body py-2">
                                                        <div class="row align-items-center">
                                                            <div class="col-md-6">
                                                                <div class="btn-group btn-group-sm" role="group">
                                                                    <button type="button" class="btn btn-primary" id="filterAll" onclick="filtrarLista('all')">
                                                                        Todas (28)
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-success" id="filterTop" onclick="filtrarLista('top')">
                                                                        Top 10
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-warning" id="filterActive" onclick="filtrarLista('active')">
                                                                        + Ativos
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="input-group input-group-sm">
                                                                    <span class="input-group-text"><i class="bi bi-funnel"></i></span>
                                                                    <input type="text" class="form-control" id="searchCompact" placeholder="Filtrar lista...">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Lista Compacta -->
                                            <div class="col-12">
                                                <div id="listaCompacta" class="row">
                                                    <!-- Lista será preenchida via JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Estado de erro -->
                            <div id="erroTiposServico" class="alert alert-warning" style="display: none;">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <span id="textoErroTiposServico">Erro ao carregar dados</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Relatórios -->
                <div class="tab-pane fade" id="relatorios" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-file-earmark-spreadsheet fs-4 text-primary"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1 fw-bold text-dark">Relatórios Macro</h5>
                                    <p class="mb-0 text-muted small">Central de relatórios gerenciais e operacionais</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <!-- Card 1: Relatório Geral -->
                                <div class="col-xl-3 col-lg-6 col-md-6">
                                    <div class="card shadow border-0 h-100 hover-card">
                                        <div class="card-body text-center p-4">
                                            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                <i class="bi bi-graph-up-arrow fs-3 text-primary"></i>
                                            </div>
                                            <h5 class="card-title fw-bold">Relatório Geral</h5>
                                            <p class="card-text text-muted small mb-3">Relatório completo com seleção de períodos e todas as métricas de projetos</p>
                                            <a href="{{ url_for('macro.relatorio_geral') }}" class="btn btn-primary btn-sm w-100">
                                                <i class="bi bi-calendar-range me-1"></i> Gerar Relatório
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card 2: Projetos Ativos -->
                                <div class="col-xl-3 col-lg-6 col-md-6">
                                    <div class="card shadow border-0 h-100 hover-card">
                                        <div class="card-body text-center p-4">
                                            <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                <i class="bi bi-play-circle fs-3 text-success"></i>
                                            </div>
                                            <h5 class="card-title fw-bold">Projetos Ativos</h5>
                                            <p class="card-text text-muted small mb-3">Visualização dos projetos em andamento com tipo de faturamento e serviço</p>
                                            <a href="{{ url_for('macro.relatorio_projetos_ativos') }}" class="btn btn-success btn-sm w-100">
                                                <i class="bi bi-eye me-1"></i> Visualizar
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card 3: Projetos Críticos -->
                                <div class="col-xl-3 col-lg-6 col-md-6">
                                    <div class="card shadow border-0 h-100 hover-card">
                                        <div class="card-body text-center p-4">
                                            <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                <i class="bi bi-exclamation-triangle fs-3 text-warning"></i>
                                            </div>
                                            <h5 class="card-title fw-bold">Projetos Críticos</h5>
                                            <p class="card-text text-muted small mb-3">Projetos que requerem atenção especial e monitoramento</p>
                                            <a href="{{ url_for('macro.relatorio_projetos_criticos') }}" class="btn btn-warning btn-sm w-100">
                                                <i class="bi bi-exclamation-triangle me-1"></i> Visualizar
                                            </a>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card 4: Projetos Entregues -->
                                <div class="col-xl-3 col-lg-6 col-md-6">
                                    <div class="card shadow border-0 h-100 hover-card">
                                        <div class="card-body text-center p-4">
                                            <div class="bg-info bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                <i class="bi bi-check-circle fs-3 text-info"></i>
                                            </div>
                                            <h5 class="card-title fw-bold">Projetos Entregues</h5>
                                            <p class="card-text text-muted small mb-3">Relatório de projetos concluídos e entregues aos clientes</p>
                                            <a href="{{ url_for('macro.relatorio_projetos_entregues') }}" class="btn btn-info btn-sm w-100">
                                                <i class="bi bi-check-square me-1"></i> Visualizar
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Informações Adicionais -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info border-0 shadow-sm">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-info-circle fs-4 me-3"></i>
                                            <div>
                                                <h6 class="alert-heading mb-1">Sobre os Relatórios</h6>
                                                <p class="mb-0 small">
                                                    <strong>Relatório Geral:</strong> Permite seleção de múltiplos períodos e contém todas as métricas disponíveis.
                                                    <br>
                                                    <strong>Projetos Ativos/Críticos/Entregues:</strong> Relatórios específicos com filtros avançados e exportação.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- Fim tab-content -->

            <!-- Modal Detalhes Categoria -->
            <div class="modal fade" id="modalDetalhesCategoria" tabindex="-1" aria-labelledby="modalDetalhesCategoriaLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header modal-header-sou text-white">
                            <h5 class="modal-title" id="modalDetalhesCategoriaLabel">
                                <i class="bi bi-folder2-open"></i> <span id="modalCategoriaNome">Detalhes da Categoria</span>
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Métricas da categoria -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white text-center">
                                        <div class="card-body p-2">
                                            <h5 id="modalTotalProjetos">0</h5>
                                            <small>Total Projetos</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white text-center">
                                        <div class="card-body p-2">
                                            <h5 id="modalCategoriaTotalAtivos">0</h5>
                                            <small>Projetos Ativos</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-info text-white text-center">
                                        <div class="card-body p-2">
                                            <h5 id="modalCategoriaTotalConcluidos">0</h5>
                                            <small>Concluídos</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-warning text-white text-center">
                                        <div class="card-body p-2">
                                            <h5 id="modalHorasTotais">0h</h5>
                                            <small>Horas Totais</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Lista dos tipos de serviço -->
                            <h6><i class="bi bi-list-ul me-2"></i>Tipos de Serviço nesta Categoria:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Tipo de Serviço</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modalTiposLista">
                                        <!-- Tipos serão inseridos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal DexPra - Mapeamento -->
            <div class="modal fade" id="modalMapeamentoDexPra" tabindex="-1" aria-labelledby="modalMapeamentoDexPraLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header modal-header-sou text-white">
                            <h5 class="modal-title" id="modalMapeamentoDexPraLabel">
                                <i class="bi bi-arrow-left-right"></i> DexPra - Mapeamento de Tipos de Serviço
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Loading -->
                            <div id="loadingMapeamento" class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="mt-2 text-muted">Analisando mapeamento...</p>
                            </div>

                            <!-- Conteúdo -->
                            <div id="containerMapeamento" style="display: none;">
                                <!-- Resumo -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card bg-info text-white text-center">
                                            <div class="card-body p-2">
                                                <h5 id="resumoTiposReais">0</h5>
                                                <small>Tipos nos Projetos</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-success text-white text-center">
                                            <div class="card-body p-2">
                                                <h5 id="resumoTiposCSV">0</h5>
                                                <small>Tipos no CSV</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-warning text-white text-center">
                                            <div class="card-body p-2">
                                                <h5 id="resumoNaoMapeados">0</h5>
                                                <small>Não Mapeados</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Abas -->
                                <ul class="nav nav-tabs" id="mapeamentoTabs">
                                    <li class="nav-item">
                                        <button class="nav-link active" id="nao-mapeados-tab" data-bs-toggle="tab" data-bs-target="#nao-mapeados">
                                            <i class="bi bi-exclamation-triangle me-1"></i> Não Mapeados (<span id="countNaoMapeados">0</span>)
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="mapeados-tab" data-bs-toggle="tab" data-bs-target="#mapeados">
                                            <i class="bi bi-check-circle me-1"></i> Mapeados (<span id="countMapeados">0</span>)
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="csv-nao-usado-tab" data-bs-toggle="tab" data-bs-target="#csv-nao-usado">
                                            <i class="bi bi-file-earmark-x me-1"></i> CSV Não Usado (<span id="countCSVNaoUsado">0</span>)
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content mt-3" id="mapeamentoTabsContent">
                                    <!-- Tipos não mapeados -->
                                    <div class="tab-pane fade show active" id="nao-mapeados">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-danger">
                                                    <tr>
                                                        <th>Tipo de Serviço (nos Projetos)</th>
                                                        <th class="text-center">Qtd Projetos</th>
                                                        <th class="text-center">Categoria Atual</th>
                                                        <th>Ação Sugerida</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tabelaNaoMapeados">
                                                    <!-- Preenchido via JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Tipos mapeados -->
                                    <div class="tab-pane fade" id="mapeados">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-success">
                                                    <tr>
                                                        <th>Tipo de Serviço</th>
                                                        <th class="text-center">Qtd Projetos</th>
                                                        <th>Categoria</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tabelaMapeados">
                                                    <!-- Preenchido via JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- CSV não usado -->
                                    <div class="tab-pane fade" id="csv-nao-usado">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-warning">
                                                    <tr>
                                                        <th>Tipo de Serviço (no CSV)</th>
                                                        <th>Categoria</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tabelaCSVNaoUsado">
                                                    <!-- Preenchido via JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-warning btn-sm" onclick="exportarDexPra()">
                                <i class="bi bi-download me-1"></i> Exportar para CSV
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Projetos Ativos -->
            <div class="modal fade" id="modalProjetosAtivos" tabindex="-1" aria-labelledby="modalProjetosAtivosLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalProjetosAtivosLabel">
                                <i class="bi bi-list-task"></i> Projetos Ativos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Campo de Busca -->
                            <div class="mb-3">
                                <input type="text" class="form-control form-control-sm" id="buscaProjetosAtivosInput" placeholder="Buscar por número, projeto, status ou squad...">
                            </div>
                            <!-- Fim Campo de Busca -->
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Conclusão</th>
                                            <th class="text-end">Horas Rest.</th>
                                            <th>Encerramento Previsto</th>
                                            <th>Ações</th>
                                            <th>Backlog</th> <!-- Nova Coluna -->
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaProjetosAtivos">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <a href="/macro/relatorio/ativos" target="_blank" class="btn btn-success">
                                <i class="bi bi-file-earmark-text me-1"></i> Ver Relatório Completo
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Projetos Críticos -->
            <div class="modal fade" id="modalProjetosCriticos" tabindex="-1" aria-labelledby="modalProjetosCriticosLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="modalProjetosCriticosLabel">
                                <i class="bi bi-exclamation-triangle"></i> Projetos Críticos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Conclusão</th>
                                            <th class="text-end">Horas Rest.</th>
                                            <th>Encerramento Previsto</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaProjetosCriticos">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <a href="/macro/relatorio/criticos" target="_blank" class="btn btn-danger">
                                <i class="bi bi-file-earmark-text me-1"></i> Ver Relatório Completo
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Projetos Concluídos -->
            <div class="modal fade" id="modalProjetosConcluidos" tabindex="-1" aria-labelledby="modalProjetosConcluídosLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalProjetosConcluídosLabel">
                                <i class="bi bi-check-circle"></i> Projetos Concluídos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Horas Contratadas</th>
                                            <th class="text-end">Horas Trabalhadas</th>
                                            <th>Data de Término</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaProjetosConcluidos">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Eficiência de Entrega -->
            <div class="modal fade" id="modalEficienciaEntrega" tabindex="-1" aria-labelledby="modalEficienciaEntregaLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="modalEficienciaEntregaLabel">
                                <i class="bi bi-speedometer2"></i> Eficiência de Entrega dos Projetos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Horas Contratadas</th>
                                            <th class="text-end">Horas Trabalhadas</th>
                                            <th class="text-end">Eficiência (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaEficienciaEntrega">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Tempo Médio de Vida -->
            <div class="modal fade" id="modalTempoVida" tabindex="-1" aria-labelledby="modalTempoVidaLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title" id="modalTempoVidaLabel">
                                <i class="bi bi-hourglass-split"></i> Tempo de Vida dos Projetos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info mb-4">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Tempo Médio de Vida:</strong> {{ kpis.tempo_medio_vida }} dias
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Projeto</th>
                                                    <th>Squad</th>
                                                    <th>Início</th>
                                                    <th>Término</th>
                                                    <th class="text-end">Dias</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for projeto in tempo_medio_vida_dados %}
                                                <tr>
                                                    <td>{{ projeto.Projeto }}</td>
                                                    <td>{{ projeto.Squad }}</td>
                                                    <td>{{ projeto.DataInicio.strftime('%d/%m/%Y') }}</td>
                                                    <td>{{ projeto.DataTermino.strftime('%d/%m/%Y') }}</td>
                                                    <td class="text-end">{{ projeto.tempo_vida }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modais para cada Squad -->
            {% for squad in ocupacao_squads %}
            <div class="modal fade" id="modalSquad{{ loop.index }}" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header {% if squad.tem_horas_negativas %}bg-warning{% else %}bg-primary{% endif %} text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-people-fill"></i> {{ squad.nome }}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert {% if squad.tem_horas_negativas %}alert-warning{% else %}alert-primary{% endif %} mb-4">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Total de Projetos:</strong> {{ squad.total_projetos }}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Horas Restantes:</strong> {{ "%.1f"|format(squad.horas_restantes) }}h
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Ocupação:</strong> {{ "%.1f"|format(squad.percentual_ocupacao) }}%
                                    </div>
                                </div>
                                {% if squad.tem_horas_negativas %}
                                <div class="mt-2">
                                    <small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Este Squad possui projetos com horas negativas</small>
                                    <br>
                                    <small class="text-muted"><i class="bi bi-info-circle"></i> Para o cálculo da ocupação total, as horas negativas são substituídas por 10% das horas originalmente contratadas.</small>
                                </div>
                                {% endif %}
                            </div>
                            
                            <h6 class="mb-3">Projetos do Squad</h6>
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th class="text-end">Horas Restantes</th>
                                            <th class="text-end">Conclusão</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for projeto in squad.projetos %}
                                        <tr>
                                            <td>{{ projeto.Projeto }}</td>
                                            <td>
                                                <span class="badge bg-{{ get_status_color(projeto.Status) }}">
                                                    {{ projeto.Status }}
                                                </span>
                                            </td>
                                            <td class="text-end {% if projeto.HorasRestantes < 0 %}text-danger{% endif %}">
                                                {{ "%.1f"|format(projeto.HorasRestantes) }}h
                                                {% if 'HorasRestantesAjustadas' in projeto and projeto.HorasRestantes < 0 %}
                                                <br>
                                                <small class="text-muted" title="Para o cálculo da ocupação, valores negativos são substituídos por 10% das horas originais">
                                                    (ajustado: {{ "%.1f"|format(projeto.HorasRestantesAjustadas) }}h)
                                                </small>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ get_conclusao_color(projeto.Conclusao) }}" 
                                                         role="progressbar" 
                                                         style="width: {{ projeto.Conclusao }}%"
                                                         aria-valuenow="{{ projeto.Conclusao }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(projeto.Conclusao) }}%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        </div>

        <!-- Modal Sprint Semanal do Especialista - VERSÃO MELHORADA -->
        <div class="modal fade" id="modalSprintSemanal" tabindex="-1" aria-labelledby="modalSprintSemanalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sprint-custom" style="max-width: 95vw;">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="modalSprintSemanalLabel">
                            <i class="bi bi-calendar-week"></i> Sprint Semanal - <span id="especialistaNomeSprint"></span>
                        </h5>
                        <div class="d-flex align-items-center">
                            <!-- MELHORADO: Indicadores de Performance mais ricos -->
                            <div class="me-3">
                                <span class="badge bg-light text-dark me-2" title="Percentual de tarefas concluídas">
                                    <i class="bi bi-target"></i> Produtividade: <span id="indicadorProdutividade">-</span>%
                                </span>
                                <span class="badge bg-light text-dark me-2" title="Cumprimento de horas estimadas">
                                    <i class="bi bi-clock-history"></i> Cumprimento: <span id="indicadorCumprimento">-</span>%
                                </span>
                                <!-- NOVO: Indicador de Capacidade -->
                                <span class="badge bg-light text-dark" title="Utilização da capacidade semanal (máx 36h)">
                                    <i class="bi bi-speedometer2"></i> Capacidade: <span id="indicadorCapacidade">-</span>%
                                </span>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                    </div>
                    <div class="modal-body p-0">
                        <!-- MELHORADA: Barra de Controles mais Rica -->
                        <div class="bg-light border-bottom p-3">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="btn-group" role="group" id="weekNavigation">
                                        <!-- Semanas serão adicionadas dinamicamente -->
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-end align-items-center">
                                        <!-- NOVO: Filtros Rápidos -->
                                        <div class="btn-group me-2" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="filtrarTarefas('todas')" id="btnFiltroTodas">
                                                <i class="bi bi-list"></i> Todas
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="filtrarTarefas('pendentes')" id="btnFiltroPendentes">
                                                <i class="bi bi-clock"></i> Pendentes
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success" onclick="filtrarTarefas('concluidas')" id="btnFiltroConcluidas">
                                                <i class="bi bi-check-circle"></i> Concluídas
                                            </button>
                                            <!-- NOVO: Filtro por sobrecarga -->
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="filtrarTarefas('sobrecarga')" id="btnFiltroSobrecarga">
                                                <i class="bi bi-exclamation-triangle"></i> Sobrecarga
                                            </button>
                                        </div>

                                        <!-- MELHORADO: Indicadores e Ações -->
                                        <div class="badge bg-info me-2">
                                            <i class="bi bi-clock"></i> Total: <span id="totalHorasSemana">0</span>h
                                        </div>
                                        
                                        <!-- NOVO: Indicador de Capacidade -->
                                        <div class="badge me-2" id="badgeCapacidadeSemana">
                                            <i class="bi bi-battery-half"></i> <span id="capacidadeSemana">0/36</span>h
                                        </div>
                                        
                                        <!-- MELHORADO: Dropdown de Ações -->
                                        <div class="dropdown me-2">
                                            <button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="bi bi-magic"></i> Ações
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="autoSegmentarTarefas()">
                                                    <i class="bi bi-magic"></i> Auto-Segmentar Tarefas
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="redistribuirCarga()">
                                                    <i class="bi bi-distribute-horizontal"></i> Redistribuir Carga
                                                </a></li>
                                                <!-- NOVO: Balanceamento automático -->
                                                <li><a class="dropdown-item" href="#" onclick="autoBalancearCapacidade()">
                                                    <i class="bi bi-balance-scale"></i> Balancear Capacidade
                                                </a></li>
                                                <!-- NOVO: Sugestões inteligentes -->
                                                <li><a class="dropdown-item" href="#" onclick="obterSugestoes()">
                                                    <i class="bi bi-lightbulb"></i> Sugestões Inteligentes
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportarSprint()">
                                                    <i class="bi bi-download"></i> Exportar Sprint
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="debugSprint()">
                                                    <i class="bi bi-bug"></i> Debug Técnico
                                                </a></li>
                                            </ul>
                                        </div>
                                        
                                        <!-- MELHORADO: Toggle de Visualização -->
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-info active" onclick="alterarVisualizacao('kanban')" id="btnVisuKanban" title="Visualização por Projeto">
                                                <i class="bi bi-kanban"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="alterarVisualizacao('timeline')" id="btnVisuTimeline" title="Timeline por Dia">
                                                <i class="bi bi-calendar3"></i>
                                            </button>
                                            <!-- NOVO: Visualização de capacidade -->
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="alterarVisualizacao('capacity')" id="btnVisuCapacity" title="Análise de Capacidade">
                                                <i class="bi bi-speedometer2"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- MELHORADO: Barra de Progresso da Semana com Capacidade -->
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Progresso da Semana</small>
                                    <small class="text-muted">
                                        <span id="horasConcluidas">0</span>h / <span id="horasTotal">0</span>h
                                        <span class="text-info ms-2">
                                            (Capacidade: <span id="capacidadeUtilizada">0</span>/36h)
                                        </span>
                                    </small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" id="progressoSemana" style="width: 0%"></div>
                                    <!-- NOVO: Linha de capacidade máxima -->
                                    <div class="position-absolute w-100 h-100" style="pointer-events: none;">
                                        <div id="linhaCapacidadeMaxima" style="position: absolute; left: 100%; top: 0; height: 100%; width: 2px; background-color: #dc3545; display: none;"></div>
                                    </div>
                                </div>
                                <!-- NOVO: Alertas de capacidade -->
                                <div id="alertaCapacidade" class="mt-1" style="display: none;">
                                    <small class="text-warning">
                                        <i class="bi bi-exclamation-triangle"></i> 
                                        <span id="textoAlertaCapacidade"></span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Container das Tarefas da Sprint -->
                        <div class="container-fluid p-3">
                            <!-- NOVO: Área de drop para reorganização -->
                            <div id="dropZoneGlobal" class="d-none">
                                <div class="alert alert-info text-center">
                                    <i class="bi bi-arrow-down-circle"></i>
                                    Solte aqui para reorganizar ou mover entre dias
                                </div>
                            </div>
                            
                            <div id="sprintContainer">
                                <!-- Tarefas serão exibidas aqui em formato Trello, Timeline ou Capacidade -->
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <!-- MELHORADO: Resumo de Estatísticas mais detalhado -->
                        <div class="me-auto">
                            <small class="text-muted">
                                <i class="bi bi-list-task"></i> <span id="totalTarefas">0</span> tarefas • 
                                <i class="bi bi-check-circle text-success"></i> <span id="totalConcluidas">0</span> concluídas • 
                                <i class="bi bi-clock text-warning"></i> <span id="totalPendentes">0</span> pendentes •
                                <i class="bi bi-exclamation-triangle text-danger"></i> <span id="totalSobrecarga">0</span> dias sobrecarregados
                            </small>
                        </div>
                        
                        <!-- NOVO: Botões adicionais -->
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="modoFoco()" id="btnModoFoco" title="Visualizar apenas esta semana em tela cheia">
                            <i class="bi bi-fullscreen"></i> Modo Foco
                        </button>
                        
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para Editar Segmento -->
        <div class="modal fade" id="modalEditarSegmento" tabindex="-1" aria-labelledby="modalEditarSegmentoLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarSegmentoLabel">
                            <i class="bi bi-pencil"></i> Editar Segmento
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formEditarSegmento">
                            <input type="hidden" id="segmentoId" />
                            
                            <div class="mb-3">
                                <label for="segmentoDescricao" class="form-label">Descrição do Segmento</label>
                                <textarea class="form-control" id="segmentoDescricao" rows="3"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="segmentoDataInicio" class="form-label">Data de Início</label>
                                    <input type="date" class="form-control" id="segmentoDataInicio" />
                                </div>
                                <div class="col-md-6">
                                    <label for="segmentoHoraInicio" class="form-label">Hora de Início</label>
                                    <input type="time" class="form-control" id="segmentoHoraInicio" />
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label for="segmentoSemanaDestino" class="form-label">Mover para Semana</label>
                                <select class="form-select" id="segmentoSemanaDestino">
                                    <!-- Opções de semanas serão preenchidas dinamicamente -->
                                </select>
                            </div>
                            
                            <div class="mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="segmentoConcluido" />
                                    <label class="form-check-label" for="segmentoConcluido">
                                        Marcar como concluído
                                    </label>
                                </div>
                            </div>
                            
                            <div id="camposConclusao" style="display: none;">
                                <div class="mt-3">
                                    <label for="horasRealizadas" class="form-label">Horas Realizadas</label>
                                    <input type="number" class="form-control" id="horasRealizadas" step="0.5" min="0" />
                                </div>
                                <div class="mt-3">
                                    <label for="notasConclusao" class="form-label">Notas de Conclusão</label>
                                    <textarea class="form-control" id="notasConclusao" rows="2"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="salvarSegmento()">Salvar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM carregado, iniciando configuração...");

            // Função para inicializar os modais
            function initializeModals() {
                console.log("Inicializando modais...");

                // Event delegation para a tabela de especialistas
                document.addEventListener('click', function(event) {
                    const especialistaRow = event.target.closest('#tabelaEspecialistas .clickable-row');
                    if (especialistaRow) {
                        const nomeEspecialista = especialistaRow.dataset.especialista;
                        if (!nomeEspecialista) {
                            console.error("Nome do especialista não encontrado no elemento:", especialistaRow);
                            return;
                        }

                        console.log("Clique em especialista:", nomeEspecialista);
                        
                        // *** GUARDA O NOME DO ESPECIALISTA PARA O SISTEMA DE SPRINT ***
                        window.ultimoEspecialistaClicado = nomeEspecialista;
                        
                        // *** ATUALIZA O TÍTULO DO MODAL COM O NOME DO ESPECIALISTA ***
                        const modalTitulo = document.getElementById('modalEspecialistaProjetosLabel');
                        if (modalTitulo) {
                            modalTitulo.innerHTML = `<i class="bi bi-person"></i> Projetos Ativos - ${nomeEspecialista}`;
                        }
                        
                        const modalEspecialista = new bootstrap.Modal(document.getElementById('modalEspecialistaProjetos'));
                        const modalBody = document.querySelector('#modalEspecialistaProjetos .modal-body');
                        
                        if (!modalBody) {
                            console.error("Elemento '.modal-body' dentro de '#modalEspecialistaProjetos' não encontrado");
                            return;
                        }
                        
                        modalBody.innerHTML = '<p class="text-center">Carregando projetos...</p>';
                        modalEspecialista.show();

                        const url = `/macro/api/projetos/especialista/${encodeURIComponent(nomeEspecialista)}`;
                        console.log("Fazendo requisição para:", url);

                        fetch(url)
                            .then(response => {
                                console.log("Status da resposta:", response.status);
                                return response.json();
                            })
                            .then(projetos => {
                                console.log("Projetos recebidos:", projetos);
                                if (projetos && projetos.length > 0) {
                                    // Formata as linhas usando a função padronizada
                                    const linhasHTML = projetos.map(p => formatarLinhaMacro(p)).join('');
                                    
                                    modalBody.innerHTML = `
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover"> <!-- Removido table-striped, adicionado table-hover -->
                                                <thead>
                                                    <tr>
                                                        <th>Número</th>
                                                        <th>Projeto</th>
                                                        <th>Status</th>
                                                        <th>Squad</th>
                                                        <th>Conclusão</th>
                                                        <th>Horas Rest.</th>
                                                        <th>Previsão</th>
                                                        <th>Ações</th> <!-- Nova coluna -->
                                                        <th>Backlog</th> <!-- Nova Coluna -->
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${linhasHTML} <!-- Usa as linhas formatadas -->
                                                </tbody>
                                            </table>
                                        </div>`;
                                } else {
                                    modalBody.innerHTML = '<p class="text-center">Nenhum projeto ativo encontrado</p>';
                                }
                            })
                            .catch(error => {
                                console.error("Erro ao carregar projetos:", error);
                                modalBody.innerHTML = '<p class="text-center text-danger">Erro ao carregar projetos</p>';
                            });
                    }

                    const accountRow = event.target.closest('tr[data-account]');
                    if (accountRow) {
                        const nomeAccount = accountRow.dataset.account;
                        if (!nomeAccount) {
                            console.error("Nome do account manager não encontrado no elemento:", accountRow);
                            return;
                        }

                        console.log("Clique em account manager:", nomeAccount);
                        const modalAccount = new bootstrap.Modal(document.getElementById('modalAccountProjetos'));
                        const modalBody = document.querySelector('#modalAccountProjetos .modal-body');
                        
                        if (!modalBody) {
                            console.error("Elemento '.modal-body' dentro de '#modalAccountProjetos' não encontrado");
                            return;
                        }
                        
                        modalBody.innerHTML = '<p class="text-center">Carregando projetos...</p>';
                        modalAccount.show();

                        const url = `/macro/api/projetos/account/${encodeURIComponent(nomeAccount)}`;
                        console.log("Fazendo requisição para:", url);

                        fetch(url)
                            .then(response => {
                                console.log("Status da resposta:", response.status);
                                return response.json();
                            })
                            .then(projetos => {
                                console.log("Projetos recebidos para Account:", projetos);
                                if (projetos && projetos.length > 0) {
                                    // ****** USA A NOVA FUNÇÃO formatarLinhaAccount ******
                                    const linhasHTML = projetos.map(p => formatarLinhaAccount(p)).join(''); 
                                    
                                    modalBody.innerHTML = `
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover"> 
                                                <thead>
                                                    <tr>
                                                        <th>Número</th>
                                                        <th>Projeto</th>
                                                        <th>Status</th>
                                                        <th>Squad</th>
                                                        <th>Especialista</th>
                                                        <th>Conclusão</th>
                                                        <th>Horas Rest.</th>
                                                        <th>Previsão</th>
                                                        <th>Ações</th> <!-- Nova coluna -->
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${linhasHTML} 
                                                </tbody>
                                            </table>
                                        </div>`;
                                } else {
                                    modalBody.innerHTML = '<p class="text-center">Nenhum projeto ativo encontrado</p>';
                                }
                            })
                            .catch(error => {
                                console.error("Erro ao carregar projetos:", error);
                                modalBody.innerHTML = '<p class="text-center text-danger">Erro ao carregar projetos</p>';
                            });
                    }
                });
            }

            // Função para formatar linha da tabela nos modais Ativos/Críticos do Macro
            function formatarLinhaMacro(p) {
                console.log("Formatando linha para:", p); // <-- DEBUG: Ver o objeto recebido
                try {
                    if (!p) {
                        console.error('Projeto indefinido ou nulo no Macro');
                        return '<tr><td colspan="9" class="text-center">Dados inválidos</td></tr>'; // Colspan atualizado para 9
                    }

                    const numero = p.numero || '';
                    const nomeProjeto = p.projeto || 'N/A';
                    const status = p.status || 'N/D';
                    const squad = p.squad || 'N/D';
                    const conclusaoRaw = p.conclusao;
                    const horasRestantesRaw = p.horasRestantes;
                    const esforcoRaw = p.Horas;
                    const backlog_exists = p.backlog_exists; // Assumindo que este campo virá da API
                    
                    // Validação e conversão numérica mais robusta
                    const conclusao = !isNaN(parseFloat(conclusaoRaw)) ? parseFloat(conclusaoRaw) : 0;
                    const horasRestantes = !isNaN(parseFloat(horasRestantesRaw)) ? parseFloat(horasRestantesRaw) : 0;
                    const esforco = !isNaN(parseFloat(esforcoRaw)) ? parseFloat(esforcoRaw) : 0;
                    
                    const vencimento = p.dataPrevEnc || 'N/A'; // Usar dataPrevEnc do Macro

                    // --- Lógica de formatação copiada do Gerencial --- 
                    // Classe de cores para Conclusão
                    let progressClassConclusao = 'progress-info'; // Default
                    if (conclusao < 30) {
                        progressClassConclusao = 'progress-danger';
                    } else if (conclusao < 70) {
                        progressClassConclusao = 'progress-warning';
                    } else if (conclusao >= 70) { // >= 70 para ser verde
                        progressClassConclusao = 'progress-success';
                    }

                    // Formata a célula de conclusão com a barra de progresso
                    const conclusaoHTML = `
                        <div class="progress-value">
                            <span class="progress-value-text">${conclusao}%</span>
                        </div>
                        <div class="progress-thin ${progressClassConclusao}">
                            <div class="progress-bar" style="width: ${conclusao}%"></div>
                        </div>
                    `;
                    
                    // --- Lógica para Horas Restantes (Espelhada do Gerencial - Cor Inline) ---
                    console.log(`[HR Debug ${numero}] Entrada: horas=${horasRestantes}, esforco=${esforco}`);
                    let horasClass = 'progress-success'; // Mantém para possível estilo adicional
                    let corBarra = '#198754'; // Default: Verde
                    let percentualHoras = 0;

                    if (horasRestantes < 0) {
                        horasClass = 'progress-danger';
                        corBarra = '#dc3545'; // Vermelho
                        percentualHoras = 100;
                        console.log(`[HR Debug ${numero}] Condição: Negativo`);
                    } else if (horasRestantes < 10) {
                        horasClass = 'progress-warning';
                        corBarra = '#ffc107'; // Amarelo
                        console.log(`[HR Debug ${numero}] Condição: Positivo < 10`);
                        if (esforco > 0) {
                            percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
                            console.log(`[HR Debug ${numero}] Calculado (<10): esforco=${esforco}, percentual=${percentualHoras}`);
                        } else {
                             console.log(`[HR Debug ${numero}] Ignorado (<10): esforco=${esforco}`);
                             percentualHoras = 0; // Garante 0 se esforço inválido
                        } 
                    } else { // horasRestantes >= 10
                        // horasClass já é 'progress-success'
                        // corBarra já é '#198754' (Verde)
                        console.log(`[HR Debug ${numero}] Condição: Positivo >= 10`);
                        if (esforco > 0) {
                            percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
                             console.log(`[HR Debug ${numero}] Calculado (>=10): esforco=${esforco}, percentual=${percentualHoras}`);
                        } else {
                             console.log(`[HR Debug ${numero}] Ignorado (>=10): esforco=${esforco}`);
                             percentualHoras = 0; // Garante 0 se esforço inválido
                        } 
                    }
                    console.log(`[HR Debug ${numero}] Final: classe=${horasClass}, cor=${corBarra}, largura=${percentualHoras.toFixed(1)}%`); 

                    const horasHTML = `
                        <div class="progress-value">
                            <span class="progress-value-text ${horasRestantes < 0 ? 'text-danger fw-bold' : ''}">${(!isNaN(horasRestantes)) ? horasRestantes.toFixed(1) : 'N/A'}h</span>
                        </div>
                        <div class="progress-thin ${horasClass}">
                            <div class="progress-bar" style="width: ${percentualHoras.toFixed(1)}%; background-color: ${corBarra};"></div>
                        </div>
                    `;
                    // --- Fim Lógica Horas Restantes (Gerencial - Cor Inline) ---

                    // Link para o ticket se o número existir
                    const numeroLink = numero ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${numero}" target="_blank" style="text-decoration: none; color: inherit;">${numero}</a>` : 'N/A';

                    // Badge para Status (usando a função getStatusColor já existente no Macro)
                    const statusBadge = `<span class="badge bg-${getStatusColor(status || '')}">${status || 'N/A'}</span>`; // Garante string vazia se status for null

                    console.log(`Calculados para ${p.numero || 'N/A'}: esforco=${esforco}, horasRest=${horasRestantes}, concl=${conclusao}`); // <-- DEBUG: Ver valores calculados

                    return `
                        <tr>
                            <td>${numeroLink}</td>
                            <td class="projeto-col" title="${nomeProjeto}"><span class="truncate-text">${nomeProjeto}</span></td>
                            <td class="status-col">${statusBadge}</td>
                            <td class="squad-col" title="${squad}">${squad}</td>
                            <td class="text-end">${conclusaoHTML}</td>
                            <td class="text-end">${horasHTML}</td>
                            <td>${vencimento}</td>
                            <td>
                                <a href="/macro/status-report/${numero}" target="_blank" class="btn btn-sm btn-outline-primary" title="Status Report">
                                    <i class="bi bi-file-earmark-text"></i>
                                </a>
                            </td>
                            <td>
                                ${backlog_exists && numero ? 
                                    `<a href="/backlog/board/${numero}" target="_blank" class="btn btn-sm btn-info" title="Abrir Quadro de Backlog">
                                        <i class="bi bi-kanban"></i>
                                    </a>` : 
                                    '<span class="text-muted small"><i class="bi bi-ban"></i></span>'
                                }
                            </td>
                        </tr>
                    `;
                } catch (error) {
                    console.error('Erro ao formatar linha no Macro:', error, p);
                    return '<tr><td colspan="8" class="text-center text-danger">Erro ao processar dados</td></tr>'; // Colspan atualizado para 8
                }
            }

            // NOVA Função para formatar linha da tabela no modal Account Manager
            function formatarLinhaAccount(p) {
                console.log("Formatando linha para Account:", p); 
                try {
                    if (!p) {
                        console.error('Projeto indefinido ou nulo no Account Modal');
                        return '<tr><td colspan="9" class="text-center">Dados inválidos</td></tr>';
                    }

                    const numero = p.numero || '';
                    const nomeProjeto = p.projeto || 'N/A';
                    const status = p.status || 'N/D';
                    const squad = p.squad || 'N/D';
                    const especialista = p.especialista || 'N/A'; // <<< Pega o especialista
                    const conclusaoRaw = p.conclusao;
                    const horasRestantesRaw = p.horasRestantes;
                    const esforcoRaw = p.Horas;
                    
                    const conclusao = !isNaN(parseFloat(conclusaoRaw)) ? parseFloat(conclusaoRaw) : 0;
                    const horasRestantes = !isNaN(parseFloat(horasRestantesRaw)) ? parseFloat(horasRestantesRaw) : 0;
                    const esforco = !isNaN(parseFloat(esforcoRaw)) ? parseFloat(esforcoRaw) : 0;
                    
                    const vencimento = p.dataPrevEnc || 'N/A'; 

                    // --- Lógica de formatação (igual a formatarLinhaMacro) ---
                    let progressClassConclusao = 'progress-info'; 
                    if (conclusao < 30) progressClassConclusao = 'progress-danger';
                    else if (conclusao < 70) progressClassConclusao = 'progress-warning';
                    else if (conclusao >= 70) progressClassConclusao = 'progress-success';

                    const conclusaoHTML = `
                        <div class="progress-value"><span class="progress-value-text">${conclusao}%</span></div>
                        <div class="progress-thin ${progressClassConclusao}"><div class="progress-bar" style="width: ${conclusao}%"></div></div>
                    `;
                    
                    let horasClass = 'progress-success';
                    let corBarra = '#198754'; 
                    let percentualHoras = 0;
                    if (horasRestantes < 0) {
                        horasClass = 'progress-danger'; corBarra = '#dc3545'; percentualHoras = 100;
                    } else if (horasRestantes < 10) {
                        horasClass = 'progress-warning'; corBarra = '#ffc107';
                        if (esforco > 0) percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
                        else percentualHoras = 0;
                    } else {
                        if (esforco > 0) percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
                        else percentualHoras = 0;
                    }

                    const horasHTML = `
                        <div class="progress-value"><span class="progress-value-text ${horasRestantes < 0 ? 'text-danger fw-bold' : ''}">${(!isNaN(horasRestantes)) ? horasRestantes.toFixed(1) : 'N/A'}h</span></div>
                        <div class="progress-thin ${horasClass}"><div class="progress-bar" style="width: ${percentualHoras.toFixed(1)}%; background-color: ${corBarra};"></div></div>
                    `;
                    
                    const numeroLink = numero ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${numero}" target="_blank" style="text-decoration: none; color: inherit;">${numero}</a>` : 'N/A';
                    const statusBadge = `<span class="badge bg-${getStatusColor(status || '')}">${status || 'N/A'}</span>`; 

                    // --- Monta a linha da tabela COM a coluna Especialista mas SEM Backlog ---
                    return `
                        <tr>
                            <td>${numeroLink}</td>
                            <td class="projeto-col" title="${nomeProjeto}"><span class="truncate-text">${nomeProjeto}</span></td>
                            <td class="status-col">${statusBadge}</td>
                            <td class="squad-col" title="${squad}">${squad}</td>
                            <td>${especialista}</td> <!-- <<< Coluna Especialista -->
                            <td class="text-end">${conclusaoHTML}</td>
                            <td class="text-end">${horasHTML}</td>
                            <td>${vencimento}</td>
                            <td>
                                <a href="/macro/status-report/${numero}" target="_blank" class="btn btn-sm btn-outline-primary" title="Status Report">
                                    <i class="bi bi-file-earmark-text"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                } catch (error) {
                    console.error('Erro ao formatar linha no Account Modal:', error, p);
                    return '<tr><td colspan="9" class="text-center text-danger">Erro ao processar dados</td></tr>';
                }
            }

            // Função para carregar dados dos KPIs
            function carregarDadosKPI() {
                console.log("Carregando dados dos KPIs...");

                // Projetos Ativos
                fetch('/macro/api/projetos/ativos')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaProjetosAtivos');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => formatarLinhaMacro(p)).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum projeto ativo encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar projetos ativos:", error);
                        document.getElementById('tabelaProjetosAtivos').innerHTML = 
                            '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });

                // Projetos Críticos
                fetch('/macro/api/projetos/criticos')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaProjetosCriticos');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => formatarLinhaMacro(p)).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum projeto crítico encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar projetos críticos:", error);
                        document.getElementById('tabelaProjetosCriticos').innerHTML = 
                            '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });

                // Projetos Concluídos
                fetch('/macro/api/projetos/concluidos')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaProjetosConcluidos');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => `
                                <tr>
                                    <td>${p.projeto ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${p.numero}" target="_blank" style="text-decoration: none; color: inherit;">${p.projeto}</a>` : 'N/A'}</td>
                                    <td><span class="badge bg-${getStatusColor(p.status)}">${p.status || 'N/A'}</span></td>
                                    <td>${p.squad || 'N/A'}</td>
                                    <td class="text-end">${p.horasContratadas != null ? p.horasContratadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td class="text-end">${p.horasTrabalhadas != null ? p.horasTrabalhadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td>${p.dataTermino || 'N/A'}</td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum projeto concluído encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar projetos concluídos:", error);
                        document.getElementById('tabelaProjetosConcluidos').innerHTML = 
                            '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });

                // Eficiência de Entrega
                fetch('/macro/api/projetos/eficiencia')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaEficienciaEntrega');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => `
                                <tr>
                                    <td>${p.projeto ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${p.numero}" target="_blank" style="text-decoration: none; color: inherit;">${p.projeto}</a>` : 'N/A'}</td>
                                    <td><span class="badge bg-${getStatusColor(p.status)}">${p.status || 'N/A'}</span></td>
                                    <td>${p.squad || 'N/A'}</td>
                                    <td class="text-end">${p.horasContratadas != null ? p.horasContratadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td class="text-end">${p.horasTrabalhadas != null ? p.horasTrabalhadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td class="text-end">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-${getEficienciaColor(p.eficiencia)}" 
                                                 role="progressbar" 
                                                 style="width: ${p.eficiencia}%"
                                                 aria-valuenow="${p.eficiencia}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                ${p.eficiencia != null ? p.eficiencia.toFixed(1) + '%' : 'N/A'}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum dado de eficiência encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar dados de eficiência:", error);
                        document.getElementById('tabelaEficienciaEntrega').innerHTML = 
                            '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });
            }

            // Função para carregar o gráfico de status
            function carregarGraficoStatus() {
                console.log("Carregando gráfico de status...");
                const ctx = document.getElementById('statusChart').getContext('2d');
                
                fetch('/macro/api/filter')
                .then(response => response.json())
                .then(data => {
                    console.log("Dados recebidos da API:", data);
                    
                    // Tenta extrair os dados de status de várias maneiras possíveis
                    let statusData = null;
                    
                    if (data && data.por_status && Object.keys(data.por_status).length > 0) {
                        statusData = data.por_status;
                        console.log("Usando dados diretos da API: data.por_status");
                    } else if (data && data.data && data.data.por_status && Object.keys(data.data.por_status).length > 0) {
                        statusData = data.data.por_status;
                        console.log("Usando dados aninhados: data.data.por_status");
                    } else if (data && data.agregacoes && data.agregacoes.por_status && Object.keys(data.agregacoes.por_status).length > 0) {
                        statusData = data.agregacoes.por_status;
                        console.log("Usando estrutura alternativa: data.agregacoes.por_status");
                    } else if (typeof data === 'object' && Object.keys(data).length > 0) {
                        // Tentativa de último recurso
                        console.log("Tentando usar o próprio objeto data como fonte de dados");
                        
                        // Procura por qualquer propriedade que possa ser usada como fonte de dados
                        for (const key in data) {
                            if (data[key] && typeof data[key] === 'object' && data[key].quantidade !== undefined) {
                                statusData = data;
                                console.log("Usando o objeto data diretamente");
                                break;
                            }
                        }
                    }
                    
                    if (!statusData) {
                        // Dados de exemplo para forçar exibição do gráfico (apenas para depuração)
                        console.warn("ATENÇÃO: Usando dados estáticos para o gráfico porque nenhum dado válido foi encontrado");
                        statusData = {
                            'NOVO': {'quantidade': 9, 'horas_totais': 168.0, 'conclusao_media': 0.0, 'cor': 'info'},
                            'AGUARDANDO': {'quantidade': 22, 'horas_totais': 872.0, 'conclusao_media': 18.9, 'cor': 'warning'},
                            'EM ATENDIMENTO': {'quantidade': 34, 'horas_totais': 3190.0, 'conclusao_media': 17.5, 'cor': 'primary'},
                            'FECHADO': {'quantidade': 56, 'horas_totais': 2498.0, 'conclusao_media': 72.8, 'cor': 'success'}
                        };
                    }
                    
                    console.log("Dados de status para o gráfico:", statusData);
                    
                    // Lista de status que queremos incluir no gráfico
                    const statusPermitidos = ['NOVO', 'EM ATENDIMENTO', 'AGUARDANDO', 'BLOQUEADO', 'FECHADO'];
                    
                    // Processa os dados para o gráfico
                    let dadosProcessados = {};
                    
                    // Inicializa o valor combinado para FECHADO que incluirá RESOLVIDO
                    let fechadoCombinado = {
                        quantidade: 0,
                        horas_totais: 0.0,
                        conclusao_media: 0.0,
                        cor: 'success'
                    };
                    
                    // Primeiro passo: processar os dados
                    for (const status in statusData) {
                        const statusUpper = status.toUpperCase();
                        const data = statusData[status];
                        
                        // Ignora status que não queremos exibir
                        if (!statusPermitidos.includes(statusUpper) && statusUpper !== 'RESOLVIDO') {
                            console.log(`Ignorando status não permitido: ${status}`);
                            continue;
                        }
                        
                        // Se não tiver quantidade definida, pula
                        if (!data || typeof data !== 'object' || data.quantidade === undefined) {
                            console.warn(`Status ${status} não tem dados válidos:`, data);
                            continue;
                        }
                        
                        // Tratamento especial para FECHADO e RESOLVIDO (combinados)
                        if (statusUpper === 'RESOLVIDO' || statusUpper === 'FECHADO') {
                            fechadoCombinado.quantidade += parseInt(data.quantidade || 0);
                            fechadoCombinado.horas_totais += parseFloat(data.horas_totais || 0);
                            console.log(`Combinando ${status} com FECHADO: +${data.quantidade} projetos`);
                            continue;
                        }
                        
                        // Adiciona outros status normalmente
                        dadosProcessados[statusUpper] = {
                            quantidade: parseInt(data.quantidade || 0),
                            horas_totais: parseFloat(data.horas_totais || 0),
                            conclusao_media: parseFloat(data.conclusao_media || 0),
                            cor: data.cor || getStatusColor(statusUpper)
                        };
                    }
                    
                    // Adiciona FECHADO combinado se tiver dados
                    if (fechadoCombinado.quantidade > 0) {
                        dadosProcessados['FECHADO'] = fechadoCombinado;
                        console.log(`FECHADO (combinado): ${fechadoCombinado.quantidade} projetos`);
                    }
                    
                    // Garante que todos os status permitidos existam com valores padrão
                    for (const status of statusPermitidos) {
                        if (!dadosProcessados[status]) {
                            dadosProcessados[status] = {
                                quantidade: 0,
                                horas_totais: 0.0,
                                conclusao_media: 0.0,
                                cor: getStatusColor(status)
                            };
                        }
                    }
                    
                    console.log("Dados processados para o gráfico:", dadosProcessados);
                    
                    // Extrai os labels e valores para o gráfico
                    const labels = Object.keys(dadosProcessados);
                    const valores = labels.map(status => dadosProcessados[status].quantidade);
                    const cores = labels.map(status => getStatusBackgroundColor(status));
                    
                    if (labels.length === 0) {
                        console.error("Nenhum status válido encontrado para o gráfico");
                        ctx.canvas.parentElement.innerHTML = '<div class="alert alert-danger mt-3">Não há dados de status para exibir no gráfico</div>';
                        return;
                    }
                    
                    console.log("Labels finais:", labels);
                    console.log("Valores finais:", valores);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Quantidade de Projetos',
                                data: valores,
                                backgroundColor: cores,
                                borderColor: cores,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Distribuição de Projetos por Status'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Quantidade: ${context.parsed.y}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar dados do gráfico:", error);
                    ctx.canvas.parentElement.innerHTML = '<div class="alert alert-danger mt-3">Erro ao carregar dados: ' + error.message + '</div>';
                });
            }

            // Funções auxiliares para cores
            function getStatusColor(status) {
                const cores = {
                    'NOVO': 'info',
                    'EM ATENDIMENTO': 'primary',
                    'AGUARDANDO': 'warning',
                    'BLOQUEADO': 'danger',
                    'FECHADO': 'success',
                    'ENCERRADO': 'success',
                    'RESOLVIDO': 'success',
                    'CANCELADO': 'secondary'
                };
                return cores[status?.toUpperCase()] || 'secondary';
            }

            function getStatusBackgroundColor(status) {
                if (!status) return '#6c757d'; // Retorna cinza secundário para valores nulos
                
                const cores = {
                    'NOVO': '#17a2b8',
                    'EM ATENDIMENTO': '#007bff',
                    'AGUARDANDO': '#ffc107',
                    'BLOQUEADO': '#dc3545',
                    'FECHADO': '#28a745',
                    'ENCERRADO': '#28a745',
                    'RESOLVIDO': '#28a745',
                    'CANCELADO': '#6c757d'
                };
                return cores[status.toUpperCase()] || '#6c757d';
            }

            function getEficienciaColor(eficiencia) {
                if (eficiencia >= 90) return 'success';
                if (eficiencia >= 70) return 'info';
                if (eficiencia >= 50) return 'warning';
                return 'danger';
            }

            // Inicializa os modais
            initializeModals();
            
            // Carrega os dados dos KPIs e o gráfico
            carregarDadosKPI();
            carregarGraficoStatus();
            
            // Implementa a busca de especialistas
            const buscaEspecialista = document.getElementById('buscaEspecialistaInput');
            if (buscaEspecialista) {
                buscaEspecialista.addEventListener('keyup', function() {
                    const termo = this.value.toLowerCase();
                    const linhas = document.querySelectorAll('#tabelaEspecialistas tbody tr');
                    
                    linhas.forEach(linha => {
                        const nomeEspecialista = linha.querySelector('td:first-child').textContent.toLowerCase();
                        if (nomeEspecialista.includes(termo)) {
                            linha.style.display = '';
                        } else {
                            linha.style.display = 'none';
                        }
                    });
                });
            }

            // <<< INÍCIO: Lógica de Busca para Modal Projetos Ativos >>>
            const buscaInput = document.getElementById('buscaProjetosAtivosInput');
            const tabelaBody = document.getElementById('tabelaProjetosAtivos');

            if (buscaInput && tabelaBody) {
                buscaInput.addEventListener('keyup', function() {
                    const termoBusca = this.value.toLowerCase().trim();
                    const linhas = tabelaBody.getElementsByTagName('tr');

                    for (let i = 0; i < linhas.length; i++) {
                        const linha = linhas[i];
                        const celulas = linha.getElementsByTagName('td');
                        let encontrou = false;

                        // Verifica colunas relevantes (Número[0], Projeto[1], Status[2], Squad[3])
                        if (celulas.length > 3) { 
                            const textoLinha = (
                                (celulas[0]?.textContent || '') + ' ' + 
                                (celulas[1]?.textContent || '') + ' ' + 
                                (celulas[2]?.textContent || '') + ' ' + 
                                (celulas[3]?.textContent || '')
                            ).toLowerCase();

                            if (textoLinha.includes(termoBusca)) {
                                encontrou = true;
                            }
                        }
                        
                        // Mostra ou esconde a linha
                        linha.style.display = encontrou ? '' : 'none';
                    }
                });
            }
            // <<< FIM: Lógica de Busca >>>

            // <<< INÍCIO: Lógica do Modal Projetos por Status >>>
            // Adiciona evento de clique nas linhas da tabela de status
            document.addEventListener('click', function(e) {
                console.log('Clique detectado em:', e.target);
                const row = e.target.closest('tr.clickable-row[data-status]');
                if (row) {
                    const status = row.getAttribute('data-status');
                    console.log('Linha clicável encontrada com status:', status);
                    if (status) {
                        abrirModalProjetosPorStatus(status);
                    }
                } else {
                    console.log('Não é uma linha clicável');
                }
            });

            function abrirModalProjetosPorStatus(status) {
                console.log(`Abrindo modal para status: ${status}`);
                
                // Atualiza o título do modal
                document.getElementById('modalProjetosPorStatusLabel').innerHTML = `
                    <i class="bi bi-clipboard-check"></i> Projetos com Status: ${status}
                `;
                
                // Determina se é projeto fechado para ajustar colunas
                const isProjetoFechado = status.toUpperCase() === 'FECHADO';
                
                // Atualiza o corpo do modal com a estrutura da tabela
                const modalBody = document.querySelector('#modalProjetosPorStatus .modal-body');
                
                if (isProjetoFechado) {
                    // Estrutura para projetos fechados (sem coluna Conclusão)
                    modalBody.innerHTML = `
                        <!-- Campo de Busca -->
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-sm" id="buscaProjetosStatusInput" placeholder="Buscar por número, projeto, status ou squad...">
                        </div>
                        <!-- Fim Campo de Busca -->
                        <div class="table-responsive">
                            <table class="table table-hover" style="min-width: 800px;">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Projeto</th>
                                        <th>Status</th>
                                        <th>Squad</th>
                                        <th>Horas Restantes</th>
                                        <th>Previsão Encerramento</th>
                                        <th>Status Report</th>
                                        <th>Backlog</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaProjetosStatus">
                                    <tr><td colspan="8" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    // Estrutura padrão para outros status
                    modalBody.innerHTML = `
                        <!-- Campo de Busca -->
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-sm" id="buscaProjetosStatusInput" placeholder="Buscar por número, projeto, status ou squad...">
                        </div>
                        <!-- Fim Campo de Busca -->
                        <div class="table-responsive">
                            <table class="table table-hover" style="min-width: 800px;">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Projeto</th>
                                        <th>Status</th>
                                        <th>Squad</th>
                                        <th>Conclusão</th>
                                        <th>Horas Restantes</th>
                                        <th>Previsão Encerramento</th>
                                        <th>Status Report</th>
                                        <th>Backlog</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaProjetosStatus">
                                    <tr><td colspan="9" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                // Mostra o modal
                const modal = new bootstrap.Modal(document.getElementById('modalProjetosPorStatus'));
                modal.show();
                
                // Busca os dados da API
                fetch(`/macro/api/projetos/status/${encodeURIComponent(status)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(`Dados recebidos para status ${status}:`, data);
                        
                        const tbody = document.getElementById('tabelaProjetosStatus');
                        
                        if (!data || data.length === 0) {
                            const colspan = isProjetoFechado ? 8 : 9;
                            tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted">Nenhum projeto encontrado</td></tr>`;
                            return;
                        }
                        
                        // Usa a função de formatação apropriada baseada no status
                        const formatarFuncao = isProjetoFechado ? formatarLinhaProjetoFechado : formatarLinhaMacro;
                        tbody.innerHTML = data.map(formatarFuncao).join('');
                        
                        console.log(`Modal preenchido com ${data.length} projetos para status: ${status}`);
                        
                        // Reaplica a lógica de busca após carregar os dados
                        aplicarBuscaModalStatus();
                    })
                    .catch(error => {
                        console.error("Erro ao carregar projetos:", error);
                        const tbody = document.getElementById('tabelaProjetosStatus');
                        const colspan = isProjetoFechado ? 8 : 9;
                        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">Erro ao carregar projetos: ${error.message}</td></tr>`;
                    });
            }

            // Função para aplicar busca no modal de status
            function aplicarBuscaModalStatus() {
                const buscaStatusInput = document.getElementById('buscaProjetosStatusInput');
                if (buscaStatusInput) {
                    // Remove listeners anteriores
                    buscaStatusInput.removeEventListener('keyup', buscarProjetosStatus);
                    // Adiciona novo listener
                    buscaStatusInput.addEventListener('keyup', buscarProjetosStatus);
                }
            }

            function buscarProjetosStatus() {
                const termoBusca = this.value.toLowerCase().trim();
                const tabelaBody = document.getElementById('tabelaProjetosStatus');
                
                if (tabelaBody) {
                    const linhas = tabelaBody.getElementsByTagName('tr');

                    for (let i = 0; i < linhas.length; i++) {
                        const linha = linhas[i];
                        const celulas = linha.getElementsByTagName('td');
                        let encontrou = false;

                        // Verifica colunas relevantes (Número[0], Projeto[1], Status[2], Squad[3])
                        if (celulas.length > 3) { 
                            const textoLinha = (
                                (celulas[0]?.textContent || '') + ' ' + 
                                (celulas[1]?.textContent || '') + ' ' + 
                                (celulas[2]?.textContent || '') + ' ' + 
                                (celulas[3]?.textContent || '')
                            ).toLowerCase();

                            if (textoLinha.includes(termoBusca)) {
                                encontrou = true;
                            }
                        }
                        
                        // Mostra ou esconde a linha
                        linha.style.display = encontrou ? '' : 'none';
                    }
                }
            }
            // <<< FIM: Lógica do Modal Projetos por Status >>>

            // Função específica para formatar linha de projetos FECHADOS (sem coluna Conclusão)
            function formatarLinhaProjetoFechado(p) {
                console.log("Formatando linha para projeto fechado:", p);
                try {
                    if (!p) {
                        console.error('Projeto indefinido ou nulo no modal fechado');
                        return '<tr><td colspan="8" class="text-center">Dados inválidos</td></tr>';
                    }

                    const numero = p.numero || '';
                    const nomeProjeto = p.projeto || 'N/A';
                    const status = p.status || 'N/D';
                    const squad = p.squad || 'N/D';
                    const horasRestantesRaw = p.horasRestantes;
                    const backlog_exists = p.backlog_exists;
                    
                    const horasRestantes = !isNaN(parseFloat(horasRestantesRaw)) ? parseFloat(horasRestantesRaw) : 0;
                    const vencimento = p.dataPrevEnc || 'N/A';

                    // Para projetos fechados, horas restantes sempre 0 e sem barra de progresso
                    const horasHTML = `<span class="text-muted">${horasRestantes.toFixed(1)}h</span>`;

                    const numeroLink = numero ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${numero}" target="_blank" style="text-decoration: none; color: inherit;">${numero}</a>` : 'N/A';
                    const statusBadge = `<span class="badge bg-${getStatusColor(status || '')}">${status || 'N/A'}</span>`;

                    return `
                        <tr>
                            <td>${numeroLink}</td>
                            <td class="projeto-col" title="${nomeProjeto}"><span class="truncate-text">${nomeProjeto}</span></td>
                            <td class="status-col">${statusBadge}</td>
                            <td class="squad-col" title="${squad}">${squad}</td>
                            <td class="text-end">${horasHTML}</td>
                            <td>${vencimento}</td>
                            <td>
                                <a href="/macro/status-report/${numero}" target="_blank" class="btn btn-sm btn-outline-primary" title="Status Report">
                                    <i class="bi bi-file-earmark-text"></i>
                                </a>
                            </td>
                            <td>
                                ${backlog_exists && numero ? 
                                    `<a href="/backlog/board/${numero}" target="_blank" class="btn btn-sm btn-info" title="Abrir Quadro de Backlog">
                                        <i class="bi bi-kanban"></i>
                                    </a>` : 
                                    '<span class="text-muted small"><i class="bi bi-ban"></i></span>'
                                }
                            </td>
                        </tr>
                    `;
                } catch (error) {
                    console.error('Erro ao formatar linha de projeto fechado:', error, p);
                    return '<tr><td colspan="8" class="text-center text-danger">Erro ao processar dados</td></tr>';
                }
            }
        });

        // ==============================
        // SISTEMA DE SPRINT SEMANAL - VERSÃO MELHORADA
        // ==============================
        
        let especialistaAtualSprint = null;
        let semanaAtualSprint = null;
        let semanasDisponiveis = [];
        let capacidadeAtualSprint = null; // NOVO: dados de capacidade
        let modoFocoAtivo = false; // NOVO: controle do modo foco

        // NOVO: Variáveis para Drag & Drop
        let draggedElement = null;
        let dropZoneActive = false;

        // Função para truncar nome do projeto de forma inteligente
        function truncarNomeProjeto(nomeCompleto) {
            if (!nomeCompleto) return 'Projeto';
            
            // Se for um número (ID), retorna como estava
            if (!isNaN(nomeCompleto)) return `Projeto ${nomeCompleto}`;
            
            // Limita a 25 caracteres
            if (nomeCompleto.length <= 25) return nomeCompleto;
            
            // Trunca de forma inteligente
            const palavras = nomeCompleto.split(' ');
            let resultado = '';
            
            for (let palavra of palavras) {
                if ((resultado + palavra).length > 25) break;
                resultado += (resultado ? ' ' : '') + palavra;
            }
            
            // Se não conseguiu nem uma palavra, pega os primeiros 22 chars + "..."
            if (!resultado) {
                resultado = nomeCompleto.substring(0, 22) + '...';
            }
            
            return resultado;
        }

        // Função para abrir o modal de Sprint Semanal
        function abrirSprintSemanal() {
            // *** MÉTODO MELHORADO: Busca o nome do especialista de múltiplas formas ***
            let nomeEspecialista = null;
            
            // 1. Primeiro, tenta pegar do atributo data guardado no clique
            if (window.ultimoEspecialistaClicado) {
                nomeEspecialista = window.ultimoEspecialistaClicado;
                console.log('[Sprint] Nome via variável global:', nomeEspecialista);
            }
            
            // 2. Se não conseguiu, tenta extrair do título do modal
            if (!nomeEspecialista) {
                const titulo = document.getElementById('modalEspecialistaProjetosLabel').textContent;
                const nomeMatch = titulo.match(/Projetos Ativos - (.+)/);
                if (nomeMatch) {
                    nomeEspecialista = nomeMatch[1].trim();
                    console.log('[Sprint] Nome via título modal:', nomeEspecialista);
                }
            }
            
            // 3. Validação final
            if (!nomeEspecialista || nomeEspecialista === 'Especialista') {
                alert('⚠️ Erro: Nome do especialista não encontrado.\\n\\nTente fechar e abrir novamente o modal do especialista.');
                return;
            }
            
            especialistaAtualSprint = nomeEspecialista;
            document.getElementById('especialistaNomeSprint').textContent = especialistaAtualSprint;
            
            console.log('[Sprint] Abrindo Sprint Semanal para:', especialistaAtualSprint);
            
            // Fecha o modal atual e abre o Sprint
            bootstrap.Modal.getInstance(document.getElementById('modalEspecialistaProjetos')).hide();
            
            const modalSprint = new bootstrap.Modal(document.getElementById('modalSprintSemanal'));
            modalSprint.show();
            
            // Carrega os dados da sprint E capacidade
            carregarSprintSemanal();
            carregarCapacidadeEspecialista(); // NOVO: carrega dados de capacidade
        }

        // NOVO: Função para carregar dados de capacidade
        function carregarCapacidadeEspecialista() {
            if (!especialistaAtualSprint) return;
            
            const url = `/backlog/api/specialists/${encodeURIComponent(especialistaAtualSprint)}/capacity?weeks=3`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('[Capacity] Dados de capacidade recebidos:', data);
                    capacidadeAtualSprint = data;
                    atualizarIndicadoresCapacidade();
                })
                .catch(error => {
                    console.error('[Capacity] Erro ao carregar capacidade:', error);
                    capacidadeAtualSprint = null;
                });
        }

        // Função para carregar dados da Sprint Semanal
        function carregarSprintSemanal() {
            if (!especialistaAtualSprint) return;
            
            document.getElementById('sprintContainer').innerHTML = '<p class="text-center">Carregando sprint...</p>';
            
            // Busca segmentos da semana atual + 2 próximas
            const url = `/backlog/api/specialists/${encodeURIComponent(especialistaAtualSprint)}/weekly-segments?view=extended`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('[Sprint] Dados recebidos:', data);
                    
                    if (data.weeks && data.weeks.length > 0) {
                        semanasDisponiveis = data.weeks;
                        semanaAtualSprint = data.weeks[0]; // Primeira semana (atual)
                        
                        criarNavegacaoSemanas(data.weeks);
                        exibirSemana(semanaAtualSprint);
                    } else {
                        document.getElementById('sprintContainer').innerHTML = 
                            '<p class="text-center text-muted">Nenhuma tarefa encontrada para este especialista</p>';
                    }
                })
                .catch(error => {
                    console.error('[Sprint] Erro ao carregar:', error);
                    document.getElementById('sprintContainer').innerHTML = 
                        '<p class="text-center text-danger">Erro ao carregar dados da sprint</p>';
                });
        }

        // NOVO: Função para atualizar indicadores de capacidade
        function atualizarIndicadoresCapacidade() {
            if (!capacidadeAtualSprint || !semanaAtualSprint) return;
            
            // Encontra dados da semana atual
            const semanaCapacidade = capacidadeAtualSprint.weeks.find(w => w.week_start === semanaAtualSprint.week_start);
            
            if (semanaCapacidade) {
                const resumo = semanaCapacidade.resumo;
                
                // Atualiza indicador de capacidade no header
                document.getElementById('indicadorCapacidade').textContent = resumo.percentual_ocupacao_semana;
                
                // Atualiza badge de capacidade
                document.getElementById('capacidadeSemana').textContent = `${resumo.total_horas_semana}/40`;
                document.getElementById('capacidadeUtilizada').textContent = resumo.total_horas_semana;
                
                // Define cor do badge baseado na utilização
                const badgeCapacidade = document.getElementById('badgeCapacidadeSemana');
                badgeCapacidade.className = 'badge me-2';
                
                if (resumo.percentual_ocupacao_semana > 100) {
                    badgeCapacidade.classList.add('bg-danger');
                } else if (resumo.percentual_ocupacao_semana > 90) {
                    badgeCapacidade.classList.add('bg-warning');
                } else if (resumo.percentual_ocupacao_semana > 70) {
                    badgeCapacidade.classList.add('bg-success');
                } else {
                    badgeCapacidade.classList.add('bg-info');
                }
                
                // Atualiza alerta de capacidade
                const alertaCapacidade = document.getElementById('alertaCapacidade');
                const textoAlerta = document.getElementById('textoAlertaCapacidade');
                
                if (resumo.dias_sobrecarregados > 0) {
                    alertaCapacidade.style.display = 'block';
                    textoAlerta.textContent = `${resumo.dias_sobrecarregados} dia(s) com sobrecarga detectada (>7.2h/dia)`;
                } else if (resumo.percentual_ocupacao_semana > 100) {
                    alertaCapacidade.style.display = 'block';
                    textoAlerta.textContent = `Semana com ${resumo.total_horas_semana}h (excede limite de 36h)`;
                } else {
                    alertaCapacidade.style.display = 'none';
                }
                
                // Atualiza estatísticas do footer
                document.getElementById('totalSobrecarga').textContent = resumo.dias_sobrecarregados;
            }
        }

        // Função para criar navegação entre semanas
        function criarNavegacaoSemanas(weeks) {
            const navigation = document.getElementById('weekNavigation');
            navigation.innerHTML = '';
            
            weeks.forEach((week, index) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `btn btn-outline-info ${week.is_current_week ? 'active' : ''}`;
                
                // MELHORADO: Mostra indicador de capacidade na navegação
                let capacidadeInfo = '';
                if (capacidadeAtualSprint) {
                    const weekCapacity = capacidadeAtualSprint.weeks.find(w => w.week_start === week.week_start);
                    if (weekCapacity) {
                        const percentual = weekCapacity.resumo.percentual_ocupacao_semana;
                        let corCapacidade = 'text-success';
                        if (percentual > 100) corCapacidade = 'text-danger';
                        else if (percentual > 90) corCapacidade = 'text-warning';
                        
                        capacidadeInfo = `<small class="${corCapacidade}">${percentual}%</small>`;
                    }
                }
                
                btn.innerHTML = `
                    <div class="d-flex flex-column">
                        <small>${week.week_label}</small>
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-light text-dark">${week.total_hours}h</span>
                            ${capacidadeInfo}
                        </div>
                    </div>
                `;
                btn.onclick = () => selecionarSemana(week, btn);
                navigation.appendChild(btn);
            });
        }

        // Função para selecionar uma semana
        function selecionarSemana(week, btnElement) {
            // Remove active de todos os botões
            document.querySelectorAll('#weekNavigation .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Adiciona active no botão clicado
            btnElement.classList.add('active');
            
            semanaAtualSprint = week;
            exibirSemana(week);
            atualizarIndicadoresCapacidade(); // NOVO: atualiza capacidade ao trocar semana
        }

        // Função para exibir tarefas de uma semana
        function exibirSemana(week) {
            document.getElementById('totalHorasSemana').textContent = week.total_hours;
            
            // MELHORADO: Atualiza indicadores e estatísticas
            calcularIndicadores(week);
            atualizarEstatisticas(week);
            atualizarIndicadoresCapacidade(); // NOVO: atualiza capacidade
            
            const container = document.getElementById('sprintContainer');
            
            if (!week.segments || week.segments.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <i class="bi bi-calendar-x fs-1 text-muted"></i>
                        <h5 class="mt-3 text-muted">Nenhuma tarefa para esta semana</h5>
                        <p class="text-muted">Semana de ${week.week_label}</p>
                    </div>
                `;
                return;
            }
            
            // MELHORADO: Aplica filtros
            let segmentosFiltrados = week.segments;
            
            if (filtroAtivo === 'pendentes') {
                segmentosFiltrados = week.segments.filter(s => !s.is_completed);
            } else if (filtroAtivo === 'concluidas') {
                segmentosFiltrados = week.segments.filter(s => s.is_completed);
            } else if (filtroAtivo === 'sobrecarga') {
                // NOVO: Filtro por dias com sobrecarga
                segmentosFiltrados = filtrarTarefasSobrecarga(week.segments);
            }
            
            // MELHORADO: Escolhe visualização
            let html;
            if (visualizacaoAtiva === 'timeline') {
                // Cria uma cópia da semana com segmentos filtrados para timeline
                const weekFiltrada = { ...week, segments: segmentosFiltrados };
                html = criarVisualizacaoTimeline(weekFiltrada);
            } else if (visualizacaoAtiva === 'capacity') {
                // NOVA: Visualização de capacidade
                html = criarVisualizacaoCapacidade(week, segmentosFiltrados);
            } else {
                // Visualização Kanban (padrão)
                html = criarVisualizacaoKanban(segmentosFiltrados);
            }
            
            container.innerHTML = html;
            
            // NOVO: Inicializa drag & drop após renderizar
            inicializarDragDrop();
            
            // CORRIGIDO: Chama as funções de indicadores e estatísticas
            calcularIndicadores(week);
            atualizarEstatisticas(week);
            
            // NOVO: Atualiza indicadores de capacidade se disponível
            atualizarIndicadoresCapacidade();
        }

        // NOVA: Função para filtrar tarefas em dias com sobrecarga
        function filtrarTarefasSobrecarga(segments) {
            if (!capacidadeAtualSprint || !semanaAtualSprint) return segments;
            
            const weekCapacity = capacidadeAtualSprint.weeks.find(w => w.week_start === semanaAtualSprint.week_start);
            if (!weekCapacity) return segments;
            
            // Identifica dias com sobrecarga
            const diasSobrecarga = Object.entries(weekCapacity.capacidade_por_dia)
                .filter(([dia, info]) => info.conflitos)
                .map(([dia, info]) => info.data);
            
            // Filtra segmentos dos dias com sobrecarga
            return segments.filter(segment => {
                const dataSegmento = new Date(segment.start_datetime).toISOString().split('T')[0];
                return diasSobrecarga.includes(dataSegmento);
            });
        }

        // NOVA: Visualização de Capacidade
        function criarVisualizacaoCapacidade(week, segments) {
            if (!capacidadeAtualSprint) {
                return `
                    <div class="text-center p-5">
                        <i class="bi bi-exclamation-circle fs-1 text-warning"></i>
                        <h5 class="mt-3 text-warning">Dados de Capacidade Indisponíveis</h5>
                        <p class="text-muted">Não foi possível carregar os dados de capacidade para análise</p>
                    </div>
                `;
            }
            
            const weekCapacity = capacidadeAtualSprint.weeks.find(w => w.week_start === week.week_start);
            if (!weekCapacity) return '<p class="text-center text-muted">Dados de capacidade não encontrados</p>';
            
            let html = '<div class="row">';
            
            // Cria card para cada dia da semana
            Object.entries(weekCapacity.capacidade_por_dia).forEach(([nomeDia, diaInfo]) => {
                const tarefasDia = segments.filter(s => {
                    const dataSegmento = new Date(s.start_datetime).toISOString().split('T')[0];
                    return dataSegmento === diaInfo.data;
                });
                
                const statusClass = diaInfo.conflitos ? 'border-danger' : 
                                   diaInfo.status === 'quase_cheio' ? 'border-warning' :
                                   diaInfo.status === 'bom' ? 'border-success' : 'border-info';
                
                html += `
                    <div class="col-md-5col mb-3" style="flex: 0 0 20%; max-width: 20%;">
                        <div class="card ${statusClass} h-100">
                            <div class="card-header ${diaInfo.conflitos ? 'bg-danger text-white' : 'bg-light'}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">${nomeDia}</h6>
                                    <small>${new Date(diaInfo.data).toLocaleDateString('pt-BR')}</small>
                                </div>
                                <div class="mt-2">
                                    <div class="d-flex justify-content-between">
                                        <small>Capacidade:</small>
                                        <small><strong>${diaInfo.horas_alocadas}h / 8h</strong></small>
                                    </div>
                                    <div class="progress mt-1" style="height: 6px;">
                                        <div class="progress-bar ${diaInfo.conflitos ? 'bg-white' : 'bg-primary'}" 
                                             style="width: ${Math.min(diaInfo.percentual_ocupacao, 100)}%"></div>
                                    </div>
                                    ${diaInfo.conflitos ? 
                                        `<small class="text-white"><i class="bi bi-exclamation-triangle"></i> Sobrecarga de ${(diaInfo.horas_alocadas - 8).toFixed(1)}h</small>` :
                                        `<small>Disponível: ${diaInfo.horas_disponiveis}h</small>`
                                    }
                                </div>
                            </div>
                            <div class="card-body p-2" style="min-height: 200px;">
                `;
                
                if (tarefasDia.length === 0) {
                    html += '<p class="text-muted text-center mt-3"><small>Sem tarefas alocadas</small></p>';
                } else {
                    tarefasDia.forEach(segment => {
                        const isCompleted = segment.is_completed;
                        
                        html += `
                            <div class="card mb-2 ${isCompleted ? 'bg-light border-success' : 'border-secondary'}" 
                                 onclick="editarSegmento(${segment.id})" 
                                 style="cursor: pointer;"
                                 draggable="true" 
                                 ondragstart="iniciarDrag(event, ${segment.id})">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="card-title mb-1" style="font-size: 0.8rem;">
                                            ${isCompleted ? '<i class="bi bi-check-circle text-success me-1"></i>' : '<i class="bi bi-circle text-muted me-1"></i>'}
                                            ${segment.task_title}
                                        </h6>
                                        <span class="badge ${isCompleted ? 'bg-success' : 'bg-primary'}">${segment.estimated_hours}h</span>
                                    </div>
                                    <small class="text-muted">${truncarNomeProjeto(segment.project_name)}</small>
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            ${new Date(segment.start_datetime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                            </div>
                            <!-- NOVO: Zona de drop para o dia -->
                            <div class="card-footer p-2 drop-zone" 
                                 ondrop="drop(event, '${diaInfo.data}')" 
                                 ondragover="allowDrop(event)"
                                 style="min-height: 30px; border-top: 2px dashed #ccc;">
                                <small class="text-muted text-center d-block">
                                    <i class="bi bi-plus-circle"></i> Solte tarefas aqui
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        // Torna as novas funções acessíveis globalmente
        window.filtrarTarefas = filtrarTarefas;
        window.alterarVisualizacao = alterarVisualizacao;
        window.redistribuirCarga = redistribuirCarga;
        window.exportarSprint = exportarSprint;
        
        // ==============================
        // NOVAS FUNCIONALIDADES MELHORADAS
        // ==============================
        
        let filtroAtivo = 'todas';
        let visualizacaoAtiva = 'kanban';

        // NOVO: Função para atualizar indicadores de capacidade
        function atualizarIndicadoresCapacidade() {
            if (!capacidadeAtualSprint || !semanaAtualSprint) return;
            
            // Encontra dados da semana atual
            const semanaCapacidade = capacidadeAtualSprint.weeks.find(w => w.week_start === semanaAtualSprint.week_start);
            
            if (semanaCapacidade) {
                const resumo = semanaCapacidade.resumo;
                
                // Atualiza indicador de capacidade no header
                document.getElementById('indicadorCapacidade').textContent = resumo.percentual_ocupacao_semana;
                
                // Atualiza badge de capacidade
                document.getElementById('capacidadeSemana').textContent = `${resumo.total_horas_semana}/36`;
                document.getElementById('capacidadeUtilizada').textContent = resumo.total_horas_semana;
                
                // Define cor do badge baseado na utilização
                const badgeCapacidade = document.getElementById('badgeCapacidadeSemana');
                badgeCapacidade.className = 'badge me-2';
                
                if (resumo.percentual_ocupacao_semana > 100) {
                    badgeCapacidade.classList.add('bg-danger');
                } else if (resumo.percentual_ocupacao_semana > 90) {
                    badgeCapacidade.classList.add('bg-warning');
                } else if (resumo.percentual_ocupacao_semana > 70) {
                    badgeCapacidade.classList.add('bg-success');
                } else {
                    badgeCapacidade.classList.add('bg-info');
                }
                
                // Atualiza alerta de capacidade
                const alertaCapacidade = document.getElementById('alertaCapacidade');
                const textoAlerta = document.getElementById('textoAlertaCapacidade');
                
                if (resumo.dias_sobrecarregados > 0) {
                    alertaCapacidade.style.display = 'block';
                    textoAlerta.textContent = `${resumo.dias_sobrecarregados} dia(s) com sobrecarga detectada (>7.2h/dia)`;
                } else if (resumo.percentual_ocupacao_semana > 100) {
                    alertaCapacidade.style.display = 'block';
                    textoAlerta.textContent = `Semana com ${resumo.total_horas_semana}h (excede limite de 36h)`;
                } else {
                    alertaCapacidade.style.display = 'none';
                }
                
                // Atualiza estatísticas do footer
                document.getElementById('totalSobrecarga').textContent = resumo.dias_sobrecarregados;
            }
        }

        // NOVO: Função para carregar dados de capacidade
        function carregarCapacidadeEspecialista() {
            if (!especialistaAtualSprint) return;
            
            const url = `/backlog/api/specialists/${encodeURIComponent(especialistaAtualSprint)}/capacity?weeks=3`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('[Capacity] Dados de capacidade recebidos:', data);
                    capacidadeAtualSprint = data;
                    atualizarIndicadoresCapacidade();
                })
                .catch(error => {
                    console.error('[Capacity] Erro ao carregar capacidade:', error);
                    capacidadeAtualSprint = null;
                });
        }

        // NOVA: Visualização de Capacidade
        function criarVisualizacaoCapacidade(week, segments) {
            if (!capacidadeAtualSprint) {
                return `
                    <div class="text-center p-5">
                        <i class="bi bi-exclamation-circle fs-1 text-warning"></i>
                        <h5 class="mt-3 text-warning">Dados de Capacidade Indisponíveis</h5>
                        <p class="text-muted">Não foi possível carregar os dados de capacidade para análise</p>
                    </div>
                `;
            }
            
            const weekCapacity = capacidadeAtualSprint.weeks.find(w => w.week_start === week.week_start);
            if (!weekCapacity) return '<p class="text-center text-muted">Dados de capacidade não encontrados</p>';
            
            let html = '<div class="row">';
            
            // Cria card para cada dia da semana
            Object.entries(weekCapacity.capacidade_por_dia).forEach(([nomeDia, diaInfo]) => {
                const tarefasDia = segments.filter(s => {
                    const dataSegmento = new Date(s.start_datetime).toISOString().split('T')[0];
                    return dataSegmento === diaInfo.data;
                });
                
                const statusClass = diaInfo.conflitos ? 'border-danger' : 
                                   diaInfo.status === 'quase_cheio' ? 'border-warning' :
                                   diaInfo.status === 'bom' ? 'border-success' : 'border-info';
                
                html += `
                    <div class="col-md-5col mb-3" style="flex: 0 0 20%; max-width: 20%;">
                        <div class="card ${statusClass} h-100">
                            <div class="card-header ${diaInfo.conflitos ? 'bg-danger text-white' : 'bg-light'}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">${nomeDia}</h6>
                                    <small>${new Date(diaInfo.data).toLocaleDateString('pt-BR')}</small>
                                </div>
                                <div class="mt-2">
                                    <div class="d-flex justify-content-between">
                                        <small>Capacidade:</small>
                                        <small><strong>${diaInfo.horas_alocadas}h / 8h</strong></small>
                                    </div>
                                    <div class="progress mt-1" style="height: 6px;">
                                        <div class="progress-bar ${diaInfo.conflitos ? 'bg-white' : 'bg-primary'}" 
                                             style="width: ${Math.min(diaInfo.percentual_ocupacao, 100)}%"></div>
                                    </div>
                                    ${diaInfo.conflitos ? 
                                        `<small class="text-white"><i class="bi bi-exclamation-triangle"></i> Sobrecarga de ${(diaInfo.horas_alocadas - 8).toFixed(1)}h</small>` :
                                        `<small>Disponível: ${diaInfo.horas_disponiveis}h</small>`
                                    }
                                </div>
                            </div>
                            <div class="card-body p-2" style="min-height: 200px;">
                `;
                
                if (tarefasDia.length === 0) {
                    html += '<p class="text-muted text-center mt-3"><small>Sem tarefas alocadas</small></p>';
                } else {
                    tarefasDia.forEach(segment => {
                        const isCompleted = segment.is_completed;
                        
                        html += `
                            <div class="card mb-2 ${isCompleted ? 'bg-light border-success' : 'border-secondary'}" 
                                 onclick="editarSegmento(${segment.id})" 
                                 style="cursor: pointer;"
                                 draggable="true" 
                                 ondragstart="iniciarDrag(event, ${segment.id})">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="card-title mb-1" style="font-size: 0.8rem;">
                                            ${isCompleted ? '<i class="bi bi-check-circle text-success me-1"></i>' : '<i class="bi bi-circle text-muted me-1"></i>'}
                                            ${segment.task_title}
                                        </h6>
                                        <span class="badge ${isCompleted ? 'bg-success' : 'bg-primary'}">${segment.estimated_hours}h</span>
                                    </div>
                                    <small class="text-muted">${truncarNomeProjeto(segment.project_name)}</small>
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            ${new Date(segment.start_datetime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                            </div>
                            <!-- NOVO: Zona de drop para o dia -->
                            <div class="card-footer p-2 drop-zone" 
                                 ondrop="drop(event, '${diaInfo.data}')" 
                                 ondragover="allowDrop(event)"
                                 style="min-height: 30px; border-top: 2px dashed #ccc;">
                                <small class="text-muted text-center d-block">
                                    <i class="bi bi-plus-circle"></i> Solte tarefas aqui
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // NOVA: Função para filtrar tarefas em dias com sobrecarga
        function filtrarTarefasSobrecarga(segments) {
            if (!capacidadeAtualSprint || !semanaAtualSprint) return segments;
            
            const weekCapacity = capacidadeAtualSprint.weeks.find(w => w.week_start === semanaAtualSprint.week_start);
            if (!weekCapacity) return segments;
            
            // Identifica dias com sobrecarga
            const diasSobrecarga = Object.entries(weekCapacity.capacidade_por_dia)
                .filter(([dia, info]) => info.conflitos)
                .map(([dia, info]) => info.data);
            
            // Filtra segmentos dos dias com sobrecarga
            return segments.filter(segment => {
                const dataSegmento = new Date(segment.start_datetime).toISOString().split('T')[0];
                return diasSobrecarga.includes(dataSegmento);
            });
        }

        // ==============================
        // FUNCIONALIDADES DE DRAG & DROP
        // ==============================

        let draggedSegmentId = null;

        function inicializarDragDrop() {
            console.log('[DragDrop] Inicializando drag & drop');
            
            // Adiciona event listeners para elementos draggable
            document.querySelectorAll('[draggable="true"]').forEach(element => {
                element.addEventListener('dragstart', function(e) {
                    draggedSegmentId = this.dataset.segmentId || this.getAttribute('data-segment-id');
                    this.style.opacity = '0.5';
                    console.log('[DragDrop] Iniciando drag do segmento:', draggedSegmentId);
                });
                
                element.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                    draggedSegmentId = null;
                });
            });
        }

        function iniciarDrag(event, segmentId) {
            draggedSegmentId = segmentId;
            event.dataTransfer.setData('text/plain', segmentId);
            console.log('[DragDrop] Drag iniciado para segmento:', segmentId);
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = '#e3f2fd';
        }

        function drop(event, targetDate) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = '';
            
            if (!draggedSegmentId) {
                console.warn('[DragDrop] Nenhum segmento sendo arrastado');
                return;
            }
            
            console.log('[DragDrop] Drop do segmento', draggedSegmentId, 'para data:', targetDate);
            
            // Implementa a movimentação da tarefa
            moverSegmentoParaData(draggedSegmentId, targetDate);
        }

        function moverSegmentoParaData(segmentId, targetDate) {
            console.log('[DragDrop] Movendo segmento', segmentId, 'para', targetDate);
            
            // Chama API para mover o segmento
            fetch(`/backlog/api/segments/${segmentId}/move-week`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    new_week_start: targetDate,
                    new_start_time: '09:00'
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('[DragDrop] Segmento movido com sucesso:', data);
                
                // Recarrega dados após a movimentação
                carregarSprintSemanal();
                carregarCapacidadeEspecialista();
                
                // Feedback visual
                mostrarNotificacao('✅ Tarefa movida com sucesso!', 'success');
            })
            .catch(error => {
                console.error('[DragDrop] Erro ao mover segmento:', error);
                mostrarNotificacao('❌ Erro ao mover tarefa', 'error');
            });
        }

        // ==============================
        // NOVAS FUNCIONALIDADES
        // ==============================

        // NOVA: Função para balanceamento automático de capacidade
        function autoBalancearCapacidade() {
            if (!especialistaAtualSprint) {
                alert('⚠️ Erro: Especialista não identificado');
                return;
            }
            
            const confirmacao = confirm(`🔄 BALANCEAMENTO AUTOMÁTICO DE CAPACIDADE\n\nEsta função irá:\n\n✓ Analisar dias com sobrecarga (>7.2h)\n✓ Redistribuir tarefas automaticamente\n✓ Otimizar cronograma respeitando 7.2h/dia\n✓ Manter ordem de prioridades\n\nContinuar?`);
            
            if (!confirmacao) return;
            
            fetch(`/backlog/api/specialists/${encodeURIComponent(especialistaAtualSprint)}/capacity/auto-balance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    max_hours_per_day: 7.2,
                    weeks_to_balance: 4
                })
            })
            .then(response => response.json())
            .then(data => {
                let mensagem = `✅ BALANCEAMENTO CONCLUÍDO!\n\n`;
                mensagem += `📊 Resultado:\n`;
                mensagem += `- Horas redistribuídas: ${data.summary.total_moved_hours}h\n`;
                mensagem += `- Tarefas afetadas: ${data.summary.total_moved_tasks}\n`;
                mensagem += `- Semanas otimizadas: ${data.summary.weeks_affected}\n\n`;
                
                if (data.balancing_results.length > 0) {
                    mensagem += `📋 DETALHES:\n`;
                    data.balancing_results.forEach((result, index) => {
                        mensagem += `${index + 1}. ${result.day}: ${result.excess_hours}h redistribuídas\n`;
                    });
                }
                
                alert(mensagem);
                
                // Recarrega dados
                carregarSprintSemanal();
                carregarCapacidadeEspecialista();
            })
            .catch(error => {
                console.error('[Auto-Balance] Erro:', error);
                alert(`❌ Erro no balanceamento:\n\n${error.message || 'Erro de conexão'}`);
            });
        }

        // NOVA: Função para obter sugestões inteligentes
        function obterSugestoes() {
            if (!especialistaAtualSprint) {
                alert('⚠️ Erro: Especialista não identificado');
                return;
            }
            
            // Solicita informações da nova tarefa
            const horasTarefa = prompt('💡 SUGESTÕES INTELIGENTES\n\nQuantas horas tem a nova tarefa que você quer alocar?', '8');
            
            if (!horasTarefa || horasTarefa <= 0) return;
            
            fetch(`/backlog/api/specialists/${encodeURIComponent(especialistaAtualSprint)}/capacity/suggestions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    task_hours: parseFloat(horasTarefa),
                    weeks_ahead: 4
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.suggestions && data.suggestions.length > 0) {
                    let mensagem = `💡 SUGESTÕES PARA TAREFA DE ${horasTarefa}H\n\n`;
                    mensagem += `🎯 Top ${Math.min(5, data.suggestions.length)} recomendações:\n\n`;
                    
                    data.suggestions.slice(0, 5).forEach((sugestao, index) => {
                        mensagem += `${index + 1}. ${sugestao.nome_dia} (${sugestao.data})\n`;
                        mensagem += `   📊 ${sugestao.recomendacao} (Score: ${sugestao.score.toFixed(1)})\n`;
                        mensagem += `   ⏰ ${sugestao.horas_disponiveis}h disponíveis\n`;
                        mensagem += `   📈 Ocupação pós: ${sugestao.percentual_ocupacao_pos}%\n\n`;
                    });
                } else {
                    mensagem = `⚠️ Nenhuma sugestão encontrada para tarefa de ${horasTarefa}h\n\n`;
                    mensagem += `Possíveis motivos:\n`;
                    mensagem += `- Especialista com agenda lotada\n`;
                    mensagem += `- Tarefa muito grande (>8h)\n`;
                    mensagem += `- Considere dividir em tarefas menores`;
                }
                
                alert(mensagem);
            })
            .catch(error => {
                console.error('[Sugestões] Erro:', error);
                alert(`❌ Erro ao obter sugestões:\n\n${error.message || 'Erro de conexão'}`);
            });
        }

        // NOVA: Função para modo foco
        function modoFoco() {
            modoFocoAtivo = !modoFocoAtivo;
            
            const modalDialog = document.querySelector('#modalSprintSemanal .modal-dialog');
            const btnModoFoco = document.getElementById('btnModoFoco');
            
            if (modoFocoAtivo) {
                // Ativa modo foco
                modalDialog.style.maxWidth = '100vw';
                modalDialog.style.margin = '0';
                modalDialog.style.height = '100vh';
                modalDialog.querySelector('.modal-content').style.height = '100vh';
                
                btnModoFoco.innerHTML = '<i class="bi bi-fullscreen-exit"></i> Sair do Foco';
                btnModoFoco.classList.remove('btn-outline-primary');
                btnModoFoco.classList.add('btn-primary');
                
                // Esconde navegação de semanas em modo foco
                document.getElementById('weekNavigation').style.display = 'none';
                
                mostrarNotificacao('🎯 Modo Foco Ativado', 'info');
            } else {
                // Desativa modo foco
                modalDialog.style.maxWidth = '95vw';
                modalDialog.style.margin = '1.75rem auto';
                modalDialog.style.height = 'auto';
                modalDialog.querySelector('.modal-content').style.height = 'auto';
                
                btnModoFoco.innerHTML = '<i class="bi bi-fullscreen"></i> Modo Foco';
                btnModoFoco.classList.remove('btn-primary');
                btnModoFoco.classList.add('btn-outline-primary');
                
                // Mostra navegação de semanas
                document.getElementById('weekNavigation').style.display = 'block';
                
                mostrarNotificacao('↩️ Modo Foco Desativado', 'info');
            }
        }

        // NOVA: Sistema de notificações
        function mostrarNotificacao(mensagem, tipo = 'info') {
            // Cria elemento de notificação
            const notificacao = document.createElement('div');
            notificacao.className = `alert alert-${tipo === 'success' ? 'success' : tipo === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
            notificacao.style.position = 'fixed';
            notificacao.style.top = '20px';
            notificacao.style.right = '20px';
            notificacao.style.zIndex = '9999';
            notificacao.style.minWidth = '300px';
            
            notificacao.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notificacao);
            
            // Remove após 3 segundos
            setTimeout(() => {
                if (notificacao && notificacao.parentNode) {
                    notificacao.remove();
                }
            }, 3000);
        }

        // Atualiza a função de exibição de semana para incluir novas funcionalidades
        const exibirSemanaOriginal = exibirSemana;
        exibirSemana = function(week) {
            document.getElementById('totalHorasSemana').textContent = week.total_hours;
            
            // MELHORADO: Atualiza indicadores e estatísticas
            calcularIndicadores(week);
            atualizarEstatisticas(week);
            atualizarIndicadoresCapacidade(); // NOVO: atualiza capacidade
            
            const container = document.getElementById('sprintContainer');
            
            if (!week.segments || week.segments.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <i class="bi bi-calendar-x fs-1 text-muted"></i>
                        <h5 class="mt-3 text-muted">Nenhuma tarefa para esta semana</h5>
                        <p class="text-muted">Semana de ${week.week_label}</p>
                    </div>
                `;
                return;
            }
            
            // MELHORADO: Aplica filtros
            let segmentosFiltrados = week.segments;
            
            if (filtroAtivo === 'pendentes') {
                segmentosFiltrados = week.segments.filter(s => !s.is_completed);
            } else if (filtroAtivo === 'concluidas') {
                segmentosFiltrados = week.segments.filter(s => s.is_completed);
            } else if (filtroAtivo === 'sobrecarga') {
                // NOVO: Filtro por dias com sobrecarga
                segmentosFiltrados = filtrarTarefasSobrecarga(week.segments);
            }
            
            // MELHORADO: Escolhe visualização
            let html;
            if (visualizacaoAtiva === 'timeline') {
                // Cria uma cópia da semana com segmentos filtrados para timeline
                const weekFiltrada = { ...week, segments: segmentosFiltrados };
                html = criarVisualizacaoTimeline(weekFiltrada);
            } else if (visualizacaoAtiva === 'capacity') {
                // NOVA: Visualização de capacidade
                html = criarVisualizacaoCapacidade(week, segmentosFiltrados);
            } else {
                // Visualização Kanban (padrão)
                html = criarVisualizacaoKanban(segmentosFiltrados);
            }
            
            container.innerHTML = html;
            
            // NOVO: Inicializa drag & drop após renderizar
            inicializarDragDrop();
            
            // CORRIGIDO: Chama as funções de indicadores e estatísticas
            calcularIndicadores(week);
            atualizarEstatisticas(week);
            
            // NOVO: Atualiza indicadores de capacidade se disponível
            atualizarIndicadoresCapacidade();
        };

        // Atualiza a função de abertura da sprint semanal
        const abrirSprintSemanalOriginal = abrirSprintSemanal;
        abrirSprintSemanal = function() {
            // *** MÉTODO MELHORADO: Busca o nome do especialista de múltiplas formas ***
            let nomeEspecialista = null;
            
            // 1. Primeiro, tenta pegar do atributo data guardado no clique
            if (window.ultimoEspecialistaClicado) {
                nomeEspecialista = window.ultimoEspecialistaClicado;
                console.log('[Sprint] Nome via variável global:', nomeEspecialista);
            }
            
            // 2. Se não conseguiu, tenta extrair do título do modal
            if (!nomeEspecialista) {
                const titulo = document.getElementById('modalEspecialistaProjetosLabel').textContent;
                const nomeMatch = titulo.match(/Projetos Ativos - (.+)/);
                if (nomeMatch) {
                    nomeEspecialista = nomeMatch[1].trim();
                    console.log('[Sprint] Nome via título modal:', nomeEspecialista);
                }
            }
            
            // 3. Validação final
            if (!nomeEspecialista || nomeEspecialista === 'Especialista') {
                alert('⚠️ Erro: Nome do especialista não encontrado.\\n\\nTente fechar e abrir novamente o modal do especialista.');
                return;
            }
            
            especialistaAtualSprint = nomeEspecialista;
            document.getElementById('especialistaNomeSprint').textContent = especialistaAtualSprint;
            
            console.log('[Sprint] Abrindo Sprint Semanal para:', especialistaAtualSprint);
            
            // Fecha o modal atual e abre o Sprint
            bootstrap.Modal.getInstance(document.getElementById('modalEspecialistaProjetos')).hide();
            
            const modalSprint = new bootstrap.Modal(document.getElementById('modalSprintSemanal'));
            modalSprint.show();
            
            // Carrega os dados da sprint E capacidade
            carregarSprintSemanal();
            carregarCapacidadeEspecialista(); // NOVO: carrega dados de capacidade
        };

        // Torna as novas funções acessíveis globalmente
        window.autoBalancearCapacidade = autoBalancearCapacidade;
        window.obterSugestoes = obterSugestoes;
        window.modoFoco = modoFoco;
        window.iniciarDrag = iniciarDrag;
        window.allowDrop = allowDrop;
        window.drop = drop;

        // ==============================
        // FUNÇÕES BÁSICAS FALTANTES - CORREÇÃO DE BUGS
        // ==============================

        // Função truncarNomeProjeto que estava faltando
        function truncarNomeProjeto(nome) {
            if (!nome) return 'Projeto Desconhecido';
            return nome.length > 25 ? nome.substring(0, 25) + '...' : nome;
        }

        // Função calcularIndicadores que estava faltando
        function calcularIndicadores(week) {
            try {
                if (!week || !week.segments) return;
                
                const totalTarefas = week.segments.length;
                const tarefasConcluidas = week.segments.filter(s => s.is_completed).length;
                const produtividade = totalTarefas > 0 ? Math.round((tarefasConcluidas / totalTarefas) * 100) : 0;
                
                // Atualiza indicadores no header
                const indicadorProdutividade = document.getElementById('indicadorProdutividade');
                if (indicadorProdutividade) {
                    indicadorProdutividade.textContent = produtividade;
                }
                
                // Calcula cumprimento (simplificado)
                const cumprimento = Math.min(100, produtividade + 10); // Simulação
                const indicadorCumprimento = document.getElementById('indicadorCumprimento');
                if (indicadorCumprimento) {
                    indicadorCumprimento.textContent = cumprimento;
                }
                
                console.log('[Indicadores] Calculados:', { produtividade, cumprimento, totalTarefas, tarefasConcluidas });
                
            } catch (error) {
                console.error('[Indicadores] Erro ao calcular:', error);
            }
        }

        // Função atualizarEstatisticas que estava faltando
        function atualizarEstatisticas(week) {
            try {
                if (!week || !week.segments) return;
                
                const totalTarefas = week.segments.length;
                const tarefasConcluidas = week.segments.filter(s => s.is_completed).length;
                const tarefasPendentes = totalTarefas - tarefasConcluidas;
                
                // Calcula dias sobrecarregados se tiver dados de capacidade
                let diasSobrecarregados = 0;
                if (capacidadeAtualSprint && semanaAtualSprint) {
                    const weekCapacity = capacidadeAtualSprint.weeks.find(w => w.week_start === semanaAtualSprint.week_start);
                    if (weekCapacity) {
                        diasSobrecarregados = weekCapacity.resumo.dias_sobrecarregados || 0;
                    }
                }
                
                // Atualiza estatísticas no footer
                const elementoTotalTarefas = document.getElementById('totalTarefas');
                if (elementoTotalTarefas) elementoTotalTarefas.textContent = totalTarefas;
                
                const elementoTotalConcluidas = document.getElementById('totalConcluidas');
                if (elementoTotalConcluidas) elementoTotalConcluidas.textContent = tarefasConcluidas;
                
                const elementoTotalPendentes = document.getElementById('totalPendentes');
                if (elementoTotalPendentes) elementoTotalPendentes.textContent = tarefasPendentes;
                
                const elementoTotalSobrecarga = document.getElementById('totalSobrecarga');
                if (elementoTotalSobrecarga) elementoTotalSobrecarga.textContent = diasSobrecarregados;
                
                // Atualiza progresso da semana
                const horasConcluidas = week.segments.filter(s => s.is_completed).reduce((acc, s) => acc + (s.estimated_hours || 0), 0);
                const horasTotal = week.total_hours || 0;
                
                const elementoHorasConcluidas = document.getElementById('horasConcluidas');
                if (elementoHorasConcluidas) elementoHorasConcluidas.textContent = Math.round(horasConcluidas);
                
                const elementoHorasTotal = document.getElementById('horasTotal');
                if (elementoHorasTotal) elementoHorasTotal.textContent = Math.round(horasTotal);
                
                // Atualiza barra de progresso
                const progressoSemana = document.getElementById('progressoSemana');
                if (progressoSemana && horasTotal > 0) {
                    const percentual = (horasConcluidas / horasTotal) * 100;
                    progressoSemana.style.width = `${Math.min(percentual, 100)}%`;
                }
                
                console.log('[Estatísticas] Atualizadas:', { 
                    totalTarefas, tarefasConcluidas, tarefasPendentes, 
                    horasConcluidas, horasTotal, diasSobrecarregados 
                });
                
            } catch (error) {
                console.error('[Estatísticas] Erro ao atualizar:', error);
            }
        }

        // Função criarVisualizacaoKanban que estava faltando
        function criarVisualizacaoKanban(segments) {
            try {
                if (!segments || segments.length === 0) {
                    return `
                        <div class="text-center p-5">
                            <i class="bi bi-kanban fs-1 text-muted"></i>
                            <h5 class="mt-3 text-muted">Nenhuma tarefa para exibir</h5>
                            <p class="text-muted">Use os filtros acima para visualizar tarefas</p>
                        </div>
                    `;
                }
                
                // Agrupa por projeto
                const segmentosPorProjeto = {};
                segments.forEach(segment => {
                    const projeto = segment.project_name || 'Projeto Desconhecido';
                    if (!segmentosPorProjeto[projeto]) {
                        segmentosPorProjeto[projeto] = [];
                    }
                    segmentosPorProjeto[projeto].push(segment);
                });
                
                let html = '<div class="row">';
                
                Object.entries(segmentosPorProjeto).forEach(([projeto, segs]) => {
                    const totalHoras = segs.reduce((acc, s) => acc + (s.estimated_hours || 0), 0);
                    const concluidas = segs.filter(s => s.is_completed).length;
                    const percentualConclusao = segs.length > 0 ? Math.round((concluidas / segs.length) * 100) : 0;
                    
                    html += `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">${truncarNomeProjeto(projeto)}</h6>
                                    <small>${segs.length} tarefas • ${totalHoras}h • ${percentualConclusao}% concluído</small>
                                </div>
                                <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                    `;
                    
                    segs.forEach(segment => {
                        const isCompleted = segment.is_completed;
                        const dataFormatada = new Date(segment.start_datetime).toLocaleDateString('pt-BR');
                        
                        html += `
                            <div class="card mb-2 ${isCompleted ? 'bg-light border-success' : 'border-secondary'}" 
                                 onclick="editarSegmento(${segment.id})" 
                                 style="cursor: pointer;"
                                 draggable="true" 
                                 ondragstart="iniciarDrag(event, ${segment.id})">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="card-title mb-1" style="font-size: 0.85rem;">
                                            ${isCompleted ? '<i class="bi bi-check-circle text-success me-1"></i>' : '<i class="bi bi-circle text-muted me-1"></i>'}
                                            ${segment.task_title || 'Sem título'}
                                        </h6>
                                        <span class="badge ${isCompleted ? 'bg-success' : 'bg-primary'}">${segment.estimated_hours || 0}h</span>
                                    </div>
                                    <small class="text-muted">📅 ${dataFormatada}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
                
            } catch (error) {
                console.error('[Kanban] Erro ao criar visualização:', error);
                return '<div class="alert alert-danger">Erro ao carregar visualização Kanban</div>';
            }
        }

        // Função criarVisualizacaoTimeline que estava faltando
        function criarVisualizacaoTimeline(week) {
            try {
                if (!week || !week.segments || week.segments.length === 0) {
                    return `
                        <div class="text-center p-5">
                            <i class="bi bi-calendar3 fs-1 text-muted"></i>
                            <h5 class="mt-3 text-muted">Nenhuma tarefa na timeline</h5>
                            <p class="text-muted">Semana de ${week.week_label || 'período selecionado'}</p>
                        </div>
                    `;
                }
                
                // Agrupa por dia
                const segmentosPorDia = {};
                const diasSemana = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta'];
                
                // Inicializa todos os dias
                diasSemana.forEach(dia => {
                    segmentosPorDia[dia] = [];
                });
                
                week.segments.forEach(segment => {
                    const data = new Date(segment.start_datetime);
                    const diaSemana = diasSemana[data.getDay() - 1]; // Ajusta para 0-indexed
                    if (diaSemana && segmentosPorDia[diaSemana]) {
                        segmentosPorDia[diaSemana].push(segment);
                    }
                });
                
                let html = '<div class="timeline-container">';
                
                diasSemana.forEach(dia => {
                    const segmentos = segmentosPorDia[dia];
                    const totalHoras = segmentos.reduce((acc, s) => acc + (s.estimated_hours || 0), 0);
                    const status = totalHoras > 8 ? 'sobrecarga' : totalHoras > 6 ? 'cheio' : 'normal';
                    const statusClass = status === 'sobrecarga' ? 'border-danger' : status === 'cheio' ? 'border-warning' : 'border-primary';
                    
                    html += `
                        <div class="timeline-day mb-3">
                            <div class="card ${statusClass}">
                                <div class="card-header ${status === 'sobrecarga' ? 'bg-danger text-white' : status === 'cheio' ? 'bg-warning' : 'bg-light'}">
                                    <h6 class="mb-0">${dia}</h6>
                                    <small>${segmentos.length} tarefas • ${totalHoras}h${totalHoras > 8 ? ' ⚠️ SOBRECARGA' : ''}</small>
                                </div>
                                <div class="card-body p-2" style="min-height: 150px;">
                    `;
                    
                    if (segmentos.length === 0) {
                        html += '<p class="text-muted text-center mt-3"><small>Nenhuma tarefa agendada</small></p>';
                    } else {
                        segmentos.forEach(segment => {
                            const isCompleted = segment.is_completed;
                            const horario = new Date(segment.start_datetime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                            
                            html += `
                                <div class="timeline-item mb-2 p-2 ${isCompleted ? 'bg-light border-success' : 'bg-white border'}" 
                                     onclick="editarSegmento(${segment.id})" 
                                     style="cursor: pointer; border-radius: 5px;"
                                     draggable="true" 
                                     ondragstart="iniciarDrag(event, ${segment.id})">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            ${isCompleted ? '<i class="bi bi-check-circle text-success me-1"></i>' : '<i class="bi bi-circle text-muted me-1"></i>'}
                                            <strong style="font-size: 0.85rem;">${segment.task_title || 'Sem título'}</strong>
                                        </div>
                                        <span class="badge ${isCompleted ? 'bg-success' : 'bg-primary'}">${segment.estimated_hours || 0}h</span>
                                    </div>
                                    <small class="text-muted">
                                        🕒 ${horario} • ${truncarNomeProjeto(segment.project_name || 'Projeto')}
                                    </small>
                                </div>
                            `;
                        });
                    }
                    
                    html += `
                                    <!-- Zona de drop -->
                                    <div class="drop-zone p-2 mt-2" 
                                         ondrop="drop(event, '${dia}')" 
                                         ondragover="allowDrop(event)"
                                         style="border: 2px dashed #ccc; border-radius: 5px; text-align: center; min-height: 30px;">
                                        <small class="text-muted">
                                            <i class="bi bi-plus-circle"></i> Solte tarefas aqui
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
                
            } catch (error) {
                console.error('[Timeline] Erro ao criar visualização:', error);
                return '<div class="alert alert-danger">Erro ao carregar visualização Timeline</div>';
            }
        }

        // Função editarSegmento que estava faltando
        function editarSegmento(segmentId) {
            try {
                console.log('[Editar] Segmento ID:', segmentId);
                
                // Por enquanto, apenas mostra um alerta
                // Em uma implementação completa, abriria um modal de edição
                const confirmacao = confirm(`Deseja editar o segmento ${segmentId}?\n\nEsta funcionalidade será implementada em breve.`);
                
                if (confirmacao) {
                    // Aqui seria implementada a lógica de edição
                    console.log('[Editar] Implementar edição do segmento', segmentId);
                }
                
            } catch (error) {
                console.error('[Editar] Erro:', error);
            }
        }

        // Funções de filtro que estavam faltando
        function filtrarTarefas(filtro) {
            try {
                console.log('[Filtro] Aplicando filtro:', filtro);
                
                // Remove classe active de todos os botões
                document.querySelectorAll('[id^="btnFiltro"]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Adiciona classe active ao botão clicado
                const btnAtivo = document.getElementById(`btnFiltro${filtro.charAt(0).toUpperCase() + filtro.slice(1)}`);
                if (btnAtivo) {
                    btnAtivo.classList.add('active');
                }
                
                // Atualiza filtro global
                filtroAtivo = filtro;
                
                // Reaplica a visualização com o filtro
                if (semanaAtualSprint) {
                    exibirSemana(semanaAtualSprint);
                }
                
            } catch (error) {
                console.error('[Filtro] Erro ao filtrar:', error);
            }
        }

        // Função de alteração de visualização que estava faltando
        function alterarVisualizacao(tipo) {
            try {
                console.log('[Visualização] Alterando para:', tipo);
                
                // Remove classe active de todos os botões
                document.querySelectorAll('[id^="btnVisu"]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Adiciona classe active ao botão clicado
                const btnAtivo = document.getElementById(`btnVisu${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
                if (btnAtivo) {
                    btnAtivo.classList.add('active');
                }
                
                // Atualiza visualização global
                visualizacaoAtiva = tipo;
                
                // Reaplica a visualização
                if (semanaAtualSprint) {
                    exibirSemana(semanaAtualSprint);
                }
                
            } catch (error) {
                console.error('[Visualização] Erro ao alterar:', error);
            }
        }

        // Funções básicas de ações que estavam faltando
        function redistribuirCarga() {
            alert('🔄 Redistribuição de Carga\n\nEsta funcionalidade será implementada em breve.\nPor enquanto, use o drag & drop para mover tarefas manualmente.');
        }

        function exportarSprint() {
            try {
                if (!especialistaAtualSprint) {
                    alert('⚠️ Erro: Nenhum especialista selecionado');
                    return;
                }
                
                const confirmacao = confirm(`📊 EXPORTAR SPRINT\n\nDeseja exportar os dados da sprint de ${especialistaAtualSprint}?\n\nFormatos disponíveis: JSON, CSV`);
                
                if (confirmacao) {
                    // Abre API de exportação
                    window.open(`/backlog/api/analytics/export/${encodeURIComponent(especialistaAtualSprint)}?format=csv`, '_blank');
                }
                
            } catch (error) {
                console.error('[Exportar] Erro:', error);
                alert('❌ Erro ao exportar dados');
            }
        }

        function debugSprint() {
            try {
                if (!especialistaAtualSprint) {
                    alert('⚠️ Erro: Nenhum especialista selecionado');
                    return;
                }
                
                console.log('[Debug] Estado atual da Sprint:', {
                    especialista: especialistaAtualSprint,
                    semanaAtual: semanaAtualSprint,
                    semanasDisponiveis: semanasDisponiveis,
                    capacidade: capacidadeAtualSprint,
                    filtroAtivo: filtroAtivo,
                    visualizacaoAtiva: visualizacaoAtiva
                });
                
                alert(`🐛 DEBUG SPRINT\n\nEspecialista: ${especialistaAtualSprint}\nFiltro: ${filtroAtivo}\nVisualização: ${visualizacaoAtiva}\n\nVerifique o console para mais detalhes.`);
                
            } catch (error) {
                console.error('[Debug] Erro:', error);
            }
        }

        function autoSegmentarTarefas() {
            alert('🤖 Auto-Segmentação\n\nEsta funcionalidade dividirá automaticamente tarefas grandes em segmentos menores.\n\nSerá implementada em breve.');
        }

        // ==============================
        // DECLARAÇÕES GLOBAIS - CORREÇÃO DE BUGS
        // ==============================
        
        // Torna TODAS as funções principais acessíveis globalmente para evitar erros "function not defined"
        window.calcularIndicadores = calcularIndicadores;
        window.atualizarEstatisticas = atualizarEstatisticas;
        window.atualizarIndicadoresCapacidade = atualizarIndicadoresCapacidade;
        window.criarVisualizacaoKanban = criarVisualizacaoKanban;
        window.criarVisualizacaoTimeline = criarVisualizacaoTimeline;
        window.criarVisualizacaoCapacidade = criarVisualizacaoCapacidade;
        window.editarSegmento = editarSegmento;
        window.filtrarTarefas = filtrarTarefas;
        window.alterarVisualizacao = alterarVisualizacao;
        window.redistribuirCarga = redistribuirCarga;
        window.exportarSprint = exportarSprint;
        window.debugSprint = debugSprint;
        window.autoSegmentarTarefas = autoSegmentarTarefas;
        window.filtrarTarefasSobrecarga = filtrarTarefasSobrecarga;
        window.carregarCapacidadeEspecialista = carregarCapacidadeEspecialista;
        window.truncarNomeProjeto = truncarNomeProjeto;
        
        console.log('[Sistema] Sprint Semanal carregado com todas as funcionalidades');
        console.log('[Sistema] Funções disponíveis:', Object.keys(window).filter(key => key.includes('Seg') || key.includes('Sprint') || key.includes('filtrar') || key.includes('alterar')));

        // === FUNÇÃO PARA CARREGAR RESUMO DOS ESPECIALISTAS ===
        function carregarEExibirResumoEspecialistas() {
            // Abre o modal
            const modal = new bootstrap.Modal(document.getElementById('modalResumoEspecialistas'));
            modal.show();
            
            // Mostra loading
            document.getElementById('loadingEspecialistas').style.display = 'block';
            document.getElementById('cardsEspecialistasContainer').style.display = 'none';
            document.getElementById('estadoVazioEspecialistas').style.display = 'none';
            
            // Busca dados da API
            fetch('/macro/api/especialistas/resumo')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                                 .then(data => {
                     console.log('📦 Dados recebidos da API:', data);
                     
                     // Filtra dados inválidos
                     const dadosFiltrados = data.filter(esp => {
                         if (!esp || !esp.nome) {
                             console.log('❌ Especialista inválido (sem nome):', esp);
                             return false;
                         }
                         const nomeUpper = esp.nome.toUpperCase();
                         const nomesExcluidos = ['CDB DATA', 'SOU CLOUD', 'SQUAD', 'EQUIPE', 'NÃO ALOCADO', 'CONSULTORIA', 'DESENVOLVIMENTO', 'INFRAESTRUTURA'];
                         const excluido = nomesExcluidos.some(excluido => nomeUpper.includes(excluido));
                         if (excluido) {
                             console.log('🚫 Especialista excluído:', esp.nome);
                         }
                         return !excluido;
                     });
                     
                     console.log('✅ Dados filtrados:', dadosFiltrados);
                    
                    const container = document.getElementById('cardsEspecialistasContainer');
                    const totalElement = document.getElementById('totalEspecialistasCards');
                    
                    if (dadosFiltrados.length === 0) {
                        document.getElementById('loadingEspecialistas').style.display = 'none';
                        document.getElementById('estadoVazioEspecialistas').style.display = 'block';
                        return;
                    }
                    
                    totalElement.textContent = `${dadosFiltrados.length} especialistas`;
                    
                                         // Gera HTML dos cards
                     let cardsHTML = '';
                     dadosFiltrados.forEach(esp => {
                         const iniciais = esp.nome.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
                         let statusClasse = 'bg-success';
                         let statusTexto = 'Normal';
                         
                         if (esp.status_sobrecarga === 'SOBRECARREGADO') {
                             statusClasse = 'bg-warning text-dark';
                             statusTexto = 'Sobrecarregado';
                         } else if (esp.status_sobrecarga === 'CRÍTICO') {
                             statusClasse = 'bg-danger';
                             statusTexto = 'Crítico';
                         }
                         
                         // Verificações de segurança para evitar erros
                         const projetosAtivos = esp.projetos_ativos || 0;
                         const projetosConcluidos = esp.projetos_concluidos_mes || 0;
                         const projetosTotal = esp.projetos_total || 0;
                         const projetosHistorico = esp.projetos_concluidos || 0; // Histórico total de concluídos
                         const totalHoras = (esp.total_horas !== undefined && esp.total_horas !== null) ? esp.total_horas : 0;
                         
                                                  cardsHTML += `
                         <div class="col-12 col-md-6 col-lg-3 mb-4">
                             <div class="card-especialista-sou">
                                 <!-- Header Premium com Avatar e Status -->
                                 <div class="card-header-sou">
                                     <div class="avatar-container-sou">
                                         <div class="avatar-sou">${iniciais}</div>
                                         <div class="status-badge ${statusClasse.replace('bg-', 'status-')}">${statusTexto}</div>
                                     </div>
                                     <h6 class="nome-especialista" title="${esp.nome}">${esp.nome}</h6>
                                 </div>
                                 
                                 <!-- Body com Métricas em Grid Moderno -->
                                 <div class="metricas-grid-sou">
                                     <!-- Projetos Ativos (Destaque Principal) -->
                                     <div class="metrica-principal">
                                         <div class="metrica-icone"><i class="bi bi-lightning-charge"></i></div>
                                         <div class="metrica-valor">${projetosAtivos}</div>
                                         <div class="metrica-label">Projetos Ativos</div>
                                     </div>
                                     
                                     <!-- Grid 2x2 para outras métricas -->
                                     <div class="metricas-secundarias">
                                         <div class="metrica-item metrica-rosa">
                                             <i class="bi bi-collection"></i>
                                             <span class="valor">${projetosTotal}</span>
                                             <span class="label">Total Histórico</span>
                                         </div>
                                         <div class="metrica-item metrica-azul">
                                             <i class="bi bi-check-circle"></i>
                                             <span class="valor">${projetosHistorico}</span>
                                             <span class="label">Concluídos</span>
                                         </div>
                                         <div class="metrica-item metrica-rosa">
                                             <i class="bi bi-calendar-check"></i>
                                             <span class="valor">${projetosConcluidos}</span>
                                             <span class="label">Este Mês</span>
                                         </div>
                                         <div class="metrica-item metrica-azul">
                                             <i class="bi bi-clock-history"></i>
                                             <span class="valor">${totalHoras.toFixed(1)}h</span>
                                             <span class="label">Horas</span>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <!-- Footer com Botão de Ação -->
                                 <div class="card-footer-sou">
                                     <button class="btn-detalhes-sou" onclick="verDetalhesEspecialista('${esp.nome.replace(/'/g, "\\'")}')">
                                         <i class="bi bi-eye"></i>
                                         <span>Ver Detalhes</span>
                                         <i class="bi bi-arrow-right"></i>
                                     </button>
                                 </div>
                             </div>
                         </div>`;
                     });
                    
                    // Exibe os cards
                    document.getElementById('loadingEspecialistas').style.display = 'none';
                    container.innerHTML = cardsHTML;
                    container.style.display = 'flex';
                })
                                 .catch(error => {
                     console.error('Erro ao carregar resumo dos especialistas:', error);
                     document.getElementById('loadingEspecialistas').style.display = 'none';
                     
                     // Mostra erro detalhado
                     const estadoVazio = document.getElementById('estadoVazioEspecialistas');
                     estadoVazio.innerHTML = `
                         <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
                         <h5 class="mt-3">Erro ao Carregar Dados</h5>
                         <p class="text-muted">${error.message}</p>
                         <button class="btn btn-outline-info btn-sm" onclick="carregarEExibirResumoEspecialistas()">
                             <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                         </button>
                     `;
                     estadoVazio.style.display = 'block';
                 });
        }
        
        // Função para ver detalhes do especialista
        function verDetalhesEspecialista(nomeEspecialista) {
            // Fecha o modal atual
            const modalAtual = bootstrap.Modal.getInstance(document.getElementById('modalResumoEspecialistas'));
            modalAtual.hide();
            
            // Encontra e clica no especialista na tabela principal
            setTimeout(() => {
                const especialistaRow = document.querySelector(`[data-especialista="${nomeEspecialista}"]`);
                if (especialistaRow) {
                    especialistaRow.click();
                }
            }, 500);
        }
        
        // Declara globalmente
        window.carregarEExibirResumoEspecialistas = carregarEExibirResumoEspecialistas;
        window.verDetalhesEspecialista = verDetalhesEspecialista;
        
    </script>

    <!-- Modal Resumo dos Especialistas -->
    <div class="modal fade" id="modalResumoEspecialistas" tabindex="-1" aria-labelledby="modalResumoEspecialistasLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                                 <div class="modal-header modal-header-sou text-white">
                     <h5 class="modal-title" id="modalResumoEspecialistasLabel">
                         <i class="bi bi-collection"></i> Resumo dos Especialistas
                     </h5>
                     <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                 </div>
                <div class="modal-body">
                    <!-- Estado de carregamento -->
                    <div id="loadingEspecialistas" class="text-center p-4">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Carregando dados dos especialistas...</p>
                    </div>
                    
                    <!-- Container dos cards -->
                    <div id="cardsEspecialistasContainer" class="row" style="display: none;">
                        <!-- Cards serão gerados dinamicamente -->
                    </div>
                    
                    <!-- Estado vazio -->
                    <div id="estadoVazioEspecialistas" class="text-center p-4" style="display: none;">
                        <i class="bi bi-info-circle fs-1 text-muted"></i>
                        <h5 class="mt-3">Nenhum dado disponível</h5>
                        <p class="text-muted">Não foi possível carregar os dados dos especialistas.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <span class="text-muted"><i class="bi bi-info-circle"></i> Total: <span id="totalEspecialistasCards">0 especialistas</span></span>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

         <style>
         /* ===== DESIGN SYSTEM SOU.CLOUD - CARDS DE ESPECIALISTAS ===== */
         :root {
             --sou-rosa: #FF2D5F;
             --sou-azul: #07304F;
             --sou-rosa-light: #ff4d7a;
             --sou-azul-light: #0a4a78;
             --sou-rosa-gradient: linear-gradient(135deg, #FF2D5F 0%, #ff4d7a 100%);
             --sou-azul-gradient: linear-gradient(135deg, #07304F 0%, #0a4a78 100%);
             --sou-gradient-premium: linear-gradient(135deg, #07304F 0%, #FF2D5F 50%, #ff4d7a 100%);
             --text-primary: #2d3748;
             --text-secondary: #4a5568;
             --text-muted: #718096;
             --bg-white: #ffffff;
             --shadow-light: 0 4px 20px rgba(7, 48, 79, 0.08);
             --shadow-premium: 0 8px 32px rgba(7, 48, 79, 0.15);
             --shadow-hover: 0 12px 40px rgba(255, 45, 95, 0.2);
         }

         /* Card Principal - Design Premium */
         .card-especialista-sou {
             background: var(--bg-white);
             border-radius: 20px;
             overflow: hidden;
             box-shadow: var(--shadow-light);
             transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
             position: relative;
             height: auto;
             border: 1px solid rgba(7, 48, 79, 0.05);
         }

         .card-especialista-sou:hover {
             transform: translateY(-8px) scale(1.02);
             box-shadow: var(--shadow-hover);
             border-color: rgba(255, 45, 95, 0.1);
         }

         /* Header Premium com Gradiente */
         .card-header-sou {
             background: var(--sou-azul-gradient);
             padding: 1.5rem 1.25rem 1rem;
             text-align: center;
             position: relative;
             overflow: hidden;
         }

         .card-header-sou::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="white" opacity="0.1"/><circle cx="80" cy="30" r="1.5" fill="white" opacity="0.1"/><circle cx="60" cy="70" r="1" fill="white" opacity="0.1"/></svg>');
             pointer-events: none;
         }

         /* Container do Avatar */
         .avatar-container-sou {
             position: relative;
             display: inline-block;
             margin-bottom: 0.75rem;
         }

         /* Avatar Moderno */
         .avatar-sou {
             width: 64px;
             height: 64px;
             border-radius: 50%;
             background: var(--sou-rosa-gradient);
             color: white;
             display: flex;
             align-items: center;
             justify-content: center;
             font-weight: 700;
             font-size: 1.25rem;
             font-family: 'Inter', sans-serif;
             box-shadow: 0 4px 16px rgba(255, 45, 95, 0.3);
             position: relative;
             z-index: 2;
         }

         /* Badge de Status Flutuante */
         .status-badge {
             position: absolute;
             bottom: -4px;
             right: -4px;
             padding: 0.25rem 0.5rem;
             border-radius: 12px;
             font-size: 0.7rem;
             font-weight: 600;
             text-transform: uppercase;
             letter-spacing: 0.025em;
             box-shadow: 0 2px 8px rgba(0,0,0,0.15);
             z-index: 3;
         }

         .status-success { background: #10b981; color: white; }
         .status-warning { background: #f59e0b; color: white; }
         .status-danger { background: #ef4444; color: white; }

         /* Nome do Especialista */
         .nome-especialista {
             color: white;
             font-size: 1rem;
             font-weight: 600;
             margin: 0;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             max-width: 200px;
             text-shadow: 0 1px 2px rgba(0,0,0,0.1);
         }

         /* Grid de Métricas */
         .metricas-grid-sou {
             padding: 1.5rem 1.25rem;
             background: linear-gradient(180deg, #fafbff 0%, #ffffff 100%);
         }

         /* Métrica Principal (Projetos Ativos) */
         .metrica-principal {
             background: var(--sou-gradient-premium);
             border-radius: 16px;
             padding: 1.25rem;
             text-align: center;
             color: white;
             margin-bottom: 1rem;
             position: relative;
             overflow: hidden;
         }

         .metrica-principal::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
             pointer-events: none;
         }

         .metrica-icone {
             font-size: 1.5rem;
             margin-bottom: 0.5rem;
             opacity: 0.9;
         }

         .metrica-valor {
             font-size: 2.5rem;
             font-weight: 800;
             line-height: 1;
             margin-bottom: 0.25rem;
             text-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }

         .metrica-label {
             font-size: 0.875rem;
             font-weight: 500;
             opacity: 0.95;
             letter-spacing: 0.025em;
         }

         /* Grid 2x2 de Métricas Secundárias */
         .metricas-secundarias {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 0.75rem;
         }

         .metrica-item {
             background: white;
             border-radius: 12px;
             padding: 1rem 0.75rem;
             text-align: center;
             border: 1px solid rgba(7, 48, 79, 0.05);
             transition: all 0.3s ease;
             position: relative;
             overflow: hidden;
         }

         .metrica-item:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(0,0,0,0.1);
         }

         .metrica-rosa {
             border-left: 3px solid var(--sou-rosa);
         }

         .metrica-azul {
             border-left: 3px solid var(--sou-azul);
         }

         .metrica-item i {
             font-size: 1.125rem;
             margin-bottom: 0.5rem;
             display: block;
         }

         .metrica-rosa i { color: var(--sou-rosa); }
         .metrica-azul i { color: var(--sou-azul); }

         .metrica-item .valor {
             display: block;
             font-size: 1.5rem;
             font-weight: 700;
             color: var(--text-primary);
             line-height: 1;
             margin-bottom: 0.25rem;
         }

         .metrica-item .label {
             display: block;
             font-size: 0.75rem;
             color: var(--text-secondary);
             font-weight: 500;
             text-transform: uppercase;
             letter-spacing: 0.025em;
         }

         /* Footer com Botão de Ação */
         .card-footer-sou {
             padding: 1rem 1.25rem 1.25rem;
             background: white;
         }

         .btn-detalhes-sou {
             width: 100%;
             background: var(--sou-azul);
             color: white;
             border: none;
             border-radius: 12px;
             padding: 0.875rem 1rem;
             font-weight: 600;
             font-size: 0.875rem;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 0.5rem;
             transition: all 0.3s ease;
             position: relative;
             overflow: hidden;
         }

         .btn-detalhes-sou:hover {
             background: var(--sou-rosa);
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(255, 45, 95, 0.3);
             color: white;
         }

         .btn-detalhes-sou:focus {
             outline: none;
             box-shadow: 0 0 0 3px rgba(7, 48, 79, 0.1);
         }

         .btn-detalhes-sou i:last-child {
             transition: transform 0.3s ease;
         }

         .btn-detalhes-sou:hover i:last-child {
             transform: translateX(4px);
         }

         /* Responsividade para Tablets */
         @media (max-width: 992px) {
             .card-especialista-sou {
                 margin-bottom: 1.5rem;
             }
             
             .avatar-sou {
                 width: 56px;
                 height: 56px;
                 font-size: 1.125rem;
             }
             
             .metrica-valor {
                 font-size: 2.25rem;
             }
         }

         /* Responsividade para Mobile */
         @media (max-width: 768px) {
             .metricas-secundarias {
                 grid-template-columns: 1fr;
                 gap: 0.5rem;
             }
             
             .metrica-item {
                 padding: 0.875rem 0.75rem;
             }
             
             .card-header-sou {
                 padding: 1.25rem 1rem 0.875rem;
             }
         }

         /* Animações de Entrada */
         @keyframes fadeInUp {
             from {
                 opacity: 0;
                 transform: translateY(20px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

         .card-especialista-sou {
             animation: fadeInUp 0.6s ease forwards;
         }

         /* Estados de Loading Melhorados */
         #loadingEspecialistas {
             background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
             border-radius: 16px;
             margin: 2rem 0;
         }

                   #loadingEspecialistas .spinner-border {
              width: 3rem;
              height: 3rem;
              color: var(--sou-azul);
          }

          /* Cabeçalho do Modal com cores SOU.cloud */
          .modal-header-sou {
              background: var(--sou-azul-gradient) !important;
              border-bottom: none;
              padding: 1.5rem 2rem;
              position: relative;
              overflow: hidden;
          }

          .modal-header-sou::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="15" cy="15" r="1.5" fill="white" opacity="0.1"/><circle cx="85" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="65" cy="75" r="0.8" fill="white" opacity="0.1"/></svg>');
              pointer-events: none;
          }

          .modal-header-sou .modal-title {
              font-weight: 600;
              font-size: 1.25rem;
              color: white;
              text-shadow: 0 1px 2px rgba(0,0,0,0.1);
              position: relative;
              z-index: 1;
          }

          .modal-header-sou .modal-title i {
              margin-right: 0.5rem;
              font-size: 1.125rem;
          }

          .modal-header-sou .btn-close-white {
              position: relative;
              z-index: 1;
          }

          /* Animação de loading para botão refresh */
          .spin {
              animation: spin 1s linear infinite;
          }

          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }
     </style>

    <script>
    // === FUNÇÃO PARA CARREGAR TIPOS DE SERVIÇO ===
    function carregarTiposServico() {
        console.log('🔄 Iniciando carregamento dos tipos de serviço...');
        
        // Mostrar loading
        document.getElementById('loadingTiposServico').style.display = 'block';
        document.getElementById('containerTiposServico').style.display = 'none';
        document.getElementById('erroTiposServico').style.display = 'none';

        // Chama a API
        fetch('/macro/api/tipos-servico-simples')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ Dados recebidos:', data);
                
                if (data.success) {
                    preencherTiposServico(data.data);
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
            })
            .catch(error => {
                console.error('❌ Erro ao carregar tipos de serviço:', error);
                
                // Ocultar loading
                document.getElementById('loadingTiposServico').style.display = 'none';
                
                // Mostrar erro
                document.getElementById('erroTiposServico').style.display = 'block';
                document.getElementById('textoErroTiposServico').textContent = error.message;
            });
    }

    function preencherTiposServico(dados) {
        console.log('📊 Preenchendo dados dos tipos de serviço...');
        
        try {
            // Ocultar loading
            document.getElementById('loadingTiposServico').style.display = 'none';
            
            // Preencher resumo geral
            if (dados.resumo) {
                document.getElementById('totalCategorias').textContent = dados.resumo.total_categorias || 0;
                document.getElementById('totalTipos').textContent = dados.resumo.total_tipos || 0;
                document.getElementById('totalProjetos').textContent = dados.resumo.total_projetos || 0;
                
                // Calcula total de horas
                let totalHoras = 0;
                if (dados.categorias) {
                    for (const categoria of Object.values(dados.categorias)) {
                        totalHoras += categoria.horas_totais || 0;
                    }
                }
                document.getElementById('totalHoras').textContent = `${totalHoras.toFixed(0)}h`;
            }
            
            // Preencher informações de período
            if (dados.periodo) {
                const periodoElement = document.getElementById('periodoAnalise');
                const dataAtualizacaoElement = document.getElementById('dataAtualizacao');
                
                if (dados.periodo.data_inicio && dados.periodo.data_fim) {
                    periodoElement.textContent = `${dados.periodo.data_inicio} a ${dados.periodo.data_fim}`;
                } else {
                    periodoElement.textContent = `Mês: ${dados.periodo.mes_referencia || 'N/A'}`;
                }
                
                dataAtualizacaoElement.textContent = `Atualizado em: ${dados.periodo.data_analise || 'N/A'}`;
            }
            
            // Armazena dados globalmente para uso em outras funções
            window.dadosCategoriasGlobal = dados;
            
            // Inicializar com visualização de gráficos (padrão)
            alterarVisualizacao('charts');
            
            // Mostrar container
            document.getElementById('containerTiposServico').style.display = 'block';
            
            console.log('✅ Tipos de serviço carregados com sucesso!');
            
        } catch (error) {
            console.error('❌ Erro ao preencher dados:', error);
            document.getElementById('erroTiposServico').style.display = 'block';
            document.getElementById('textoErroTiposServico').textContent = 'Erro ao processar dados recebidos';
        }
    }

    function criarCardCategoria(nome, dados) {
        const progressoAtivos = dados.total_projetos > 0 ? 
            ((dados.projetos_ativos / dados.total_projetos) * 100).toFixed(1) : 0;

        return `
            <div class="col-lg-4 col-xl-3 mb-3">
                <div class="card h-100 border-0 shadow-sm" style="max-height: 200px;">
                    <div class="card-header bg-primary text-white p-2">
                        <h6 class="card-title mb-0 fw-bold text-truncate" title="${nome}">
                            <i class="bi bi-folder2-open me-1"></i>${nome}
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="row text-center mb-2">
                            <div class="col-4">
                                <div class="fw-bold text-primary">${dados.total_projetos || 0}</div>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-success">${dados.projetos_ativos || 0}</div>
                                <small class="text-muted">Ativos</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-info">${(dados.horas_totais || 0).toFixed(0)}h</div>
                                <small class="text-muted">Horas</small>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">Ativos</small>
                                <small class="text-muted">${progressoAtivos}%</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: ${progressoAtivos}%"></div>
                            </div>
                        </div>
                        
                        <div class="text-muted small text-center">
                            <strong>${(dados.tipos_na_categoria || []).length}</strong> tipos
                        </div>
                    </div>
                    <div class="card-footer p-1 bg-light">
                        <button class="btn btn-outline-primary btn-sm w-100 py-1" onclick="mostrarDetalhesCategoria('${nome.replace(/'/g, "\\'")}', '${encodeURIComponent(JSON.stringify(dados))}')">
                            <i class="bi bi-eye me-1"></i> Detalhes
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function mostrarDetalhesCategoria(nome, dadosEncoded) {
        try {
            const dados = JSON.parse(decodeURIComponent(dadosEncoded));
            
            // Preenche o modal com os dados
            document.getElementById('modalCategoriaNome').textContent = nome;
            document.getElementById('modalTotalProjetos').textContent = dados.total_projetos || 0;
            document.getElementById('modalCategoriaTotalAtivos').textContent = dados.projetos_ativos || 0;
            document.getElementById('modalCategoriaTotalConcluidos').textContent = dados.projetos_concluidos || 0;
            document.getElementById('modalHorasTotais').textContent = `${(dados.horas_totais || 0).toFixed(0)}h`;
            
            // Preenche lista de tipos
            const listaBody = document.getElementById('modalTiposLista');
            listaBody.innerHTML = '';
            
            if (dados.tipos_na_categoria && dados.tipos_na_categoria.length > 0) {
                dados.tipos_na_categoria.forEach((tipo, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${tipo}</td>
                        </tr>
                    `;
                    listaBody.innerHTML += row;
                });
            } else {
                listaBody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">Nenhum tipo de serviço encontrado</td></tr>';
            }
            
            // Mostra o modal
            new bootstrap.Modal(document.getElementById('modalDetalhesCategoria')).show();
            
        } catch (error) {
            console.error('Erro ao mostrar detalhes:', error);
            alert('Erro ao carregar detalhes da categoria');
        }
    }

    // Controle de visualizações
    let visualizacaoAtual = 'charts'; // 'charts', 'table', 'compact'
    let chartTopCategorias = null;
    let chartDistribuicaoHoras = null;

    function alterarVisualizacao(modo) {
        console.log(`🔄 Alterando para visualização: ${modo}`);
        
        // Ocultar todas as visualizações
        document.querySelectorAll('.visualization-view').forEach(view => {
            view.style.display = 'none';
        });
        
        // Resetar botões
        document.querySelectorAll('#btnViewCharts, #btnViewTable, #btnViewCompact').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        
        // Mostrar visualização selecionada e ativar botão
        switch(modo) {
            case 'charts':
                document.getElementById('viewCharts').style.display = 'block';
                document.getElementById('btnViewCharts').classList.remove('btn-outline-primary');
                document.getElementById('btnViewCharts').classList.add('btn-primary');
                gerarGraficos();
                break;
            case 'table':
                document.getElementById('viewTable').style.display = 'block';
                document.getElementById('btnViewTable').classList.remove('btn-outline-primary');
                document.getElementById('btnViewTable').classList.add('btn-primary');
                preencherTabelaDetalhada();
                break;
            case 'compact':
                document.getElementById('viewCompact').style.display = 'block';
                document.getElementById('btnViewCompact').classList.remove('btn-outline-primary');
                document.getElementById('btnViewCompact').classList.add('btn-primary');
                preencherListaCompacta();
                break;
        }
        
        visualizacaoAtual = modo;
    }

    function gerarGraficos() {
        if (!window.dadosCategoriasGlobal) return;
        
        const categorias = window.dadosCategoriasGlobal.categorias;
        const categoriasArray = Object.entries(categorias)
            .sort(([,a], [,b]) => (b.total_projetos || 0) - (a.total_projetos || 0))
            .slice(0, 10); // Top 10
        
        // Gráfico de barras - Top 10 Categorias
        gerarChartTopCategorias(categoriasArray);
        
        // Gráfico de distribuição de horas
        gerarChartDistribuicaoHoras(categoriasArray);
        
        // Resumo executivo
        gerarResumoExecutivo(categoriasArray);
    }

    function gerarChartTopCategorias(categorias) {
        const ctx = document.getElementById('chartTopCategorias');
        
        if (chartTopCategorias) {
            chartTopCategorias.destroy();
        }
        
        const labels = categorias.map(([nome]) => nome.length > 20 ? nome.substring(0, 20) + '...' : nome);
        const projetos = categorias.map(([,dados]) => dados.total_projetos || 0);
        const ativos = categorias.map(([,dados]) => dados.projetos_ativos || 0);
        
        chartTopCategorias = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total de Projetos',
                        data: projetos,
                        backgroundColor: 'rgba(78, 115, 223, 0.8)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Projetos Ativos',
                        data: ativos,
                        backgroundColor: 'rgba(28, 200, 138, 0.8)',
                        borderColor: 'rgba(28, 200, 138, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                },
                interaction: {
                    intersect: false,
                }
            }
        });
    }

    function gerarChartDistribuicaoHoras(categorias) {
        const ctx = document.getElementById('chartDistribuicaoHoras');
        
        if (chartDistribuicaoHoras) {
            chartDistribuicaoHoras.destroy();
        }
        
        const labels = categorias.slice(0, 5).map(([nome]) => nome.length > 15 ? nome.substring(0, 15) + '...' : nome);
        const horas = categorias.slice(0, 5).map(([,dados]) => dados.horas_totais || 0);
        
        const colors = [
            'rgba(78, 115, 223, 0.8)',
            'rgba(28, 200, 138, 0.8)', 
            'rgba(54, 185, 204, 0.8)',
            'rgba(246, 194, 62, 0.8)',
            'rgba(231, 74, 59, 0.8)'
        ];
        
        chartDistribuicaoHoras = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: horas,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed.toFixed(0)}h (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function gerarResumoExecutivo(categorias) {
        const container = document.getElementById('resumoExecutivo');
        
        const top3 = categorias.slice(0, 3);
        const total = window.dadosCategoriasGlobal;
        
        // Calcular eficiência média manualmente
        let totalProjetos = 0;
        let totalConcluidos = 0;
        
        categorias.forEach(([,dados]) => {
            totalProjetos += dados.total_projetos || 0;
            totalConcluidos += dados.projetos_concluidos || 0;
        });
        
        const eficienciaMedia = totalProjetos > 0 ? ((totalConcluidos / totalProjetos) * 100) : 0;
        
        container.innerHTML = `
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-left-success h-100">
                    <div class="card-body py-3">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Categoria Líder</div>
                        <div class="h6 mb-1 font-weight-bold text-gray-800">${top3[0] ? top3[0][0] : 'N/A'}</div>
                        <div class="text-muted small">${top3[0] ? top3[0][1].total_projetos : 0} projetos</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-left-primary h-100">
                    <div class="card-body py-3">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Mais Ativa</div>
                        <div class="h6 mb-1 font-weight-bold text-gray-800">${categorias.find(([,dados]) => dados.projetos_ativos > 0)?.[0] || 'N/A'}</div>
                        <div class="text-muted small">${Math.max(...categorias.map(([,dados]) => dados.projetos_ativos || 0))} ativos</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-left-warning h-100">
                    <div class="card-body py-3">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Mais Horas</div>
                        <div class="h6 mb-1 font-weight-bold text-gray-800">${categorias.sort(([,a], [,b]) => (b.horas_totais || 0) - (a.horas_totais || 0))[0]?.[0] || 'N/A'}</div>
                        <div class="text-muted small">${Math.max(...categorias.map(([,dados]) => dados.horas_totais || 0)).toFixed(0)}h</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card border-left-info h-100">
                    <div class="card-body py-3">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Taxa Conclusão</div>
                        <div class="h6 mb-1 font-weight-bold text-gray-800">${eficienciaMedia.toFixed(1)}%</div>
                        <div class="text-muted small">projetos concluídos</div>
                    </div>
                </div>
            </div>
        `;
    }

    function preencherTabelaDetalhada() {
        const tabelaBody = document.getElementById('tabelaDetalhada');
        
        if (!window.dadosCategoriasGlobal || !window.dadosCategoriasGlobal.categorias) return;
        
        tabelaBody.innerHTML = '';
        
        const categoriasOrdenadas = Object.entries(window.dadosCategoriasGlobal.categorias)
            .sort(([,a], [,b]) => (b.total_projetos || 0) - (a.total_projetos || 0));
        
        categoriasOrdenadas.forEach(([nome, dados]) => {
            const progressoAtivos = dados.total_projetos > 0 ? 
                ((dados.projetos_ativos / dados.total_projetos) * 100).toFixed(1) : 0;
            
            const progressBarClass = progressoAtivos > 70 ? 'bg-success' : progressoAtivos > 40 ? 'bg-warning' : 'bg-danger';
            
            const row = `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="me-2" style="width: 8px; height: 8px; border-radius: 50%; background-color: ${getCategoriaCor(nome)};"></div>
                            <strong>${nome}</strong>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-primary">${dados.total_projetos || 0}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${dados.projetos_ativos || 0}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-info">${dados.projetos_concluidos || 0}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning text-dark">${(dados.horas_totais || 0).toFixed(0)}h</span>
                    </td>
                    <td class="text-center">
                        <div class="progress-value">
                            <span>${progressoAtivos}%</span>
                        </div>
                        <div class="progress progress-thin">
                            <div class="progress-bar ${progressBarClass}" style="width: ${progressoAtivos}%"></div>
                        </div>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-secondary">${(dados.tipos_na_categoria || []).length}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-outline-primary btn-sm" onclick="mostrarDetalhesCategoria('${nome.replace(/'/g, "\\'")}', '${encodeURIComponent(JSON.stringify(dados))}')" title="Ver detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
            tabelaBody.innerHTML += row;
        });
        
        // Ativar busca na tabela
        ativarBuscaTabela();
    }

    function preencherListaCompacta() {
        const container = document.getElementById('listaCompacta');
        
        if (!window.dadosCategoriasGlobal || !window.dadosCategoriasGlobal.categorias) return;
        
        const categorias = Object.entries(window.dadosCategoriasGlobal.categorias)
            .sort(([,a], [,b]) => (b.total_projetos || 0) - (a.total_projetos || 0));
        
        container.innerHTML = '';
        
        categorias.forEach(([nome, dados], index) => {
            const progressoAtivos = dados.total_projetos > 0 ? 
                ((dados.projetos_ativos / dados.total_projetos) * 100).toFixed(1) : 0;
            
            const isTop10 = index < 10;
            const hasAtivos = dados.projetos_ativos > 0;
            
            const card = `
                <div class="col-lg-6 col-xl-4 mb-3 categoria-item" data-top="${isTop10}" data-active="${hasAtivos}" data-categoria="${nome.toLowerCase()}">
                    <div class="card border-0 shadow-sm h-100 position-relative">
                        ${isTop10 ? '<div class="position-absolute top-0 end-0 p-2"><span class="badge bg-success">Top 10</span></div>' : ''}
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0 me-2" style="font-size: 0.9rem;">${nome}</h6>
                                <div class="text-center">
                                    <div class="h5 mb-0 text-primary">${dados.total_projetos || 0}</div>
                                    <small class="text-muted">projetos</small>
                                </div>
                            </div>
                            
                            <div class="row text-center mb-2">
                                <div class="col-4">
                                    <div class="text-success font-weight-bold">${dados.projetos_ativos || 0}</div>
                                    <small class="text-muted">Ativos</small>
                                </div>
                                <div class="col-4">
                                    <div class="text-info font-weight-bold">${dados.projetos_concluidos || 0}</div>
                                    <small class="text-muted">Concluídos</small>
                                </div>
                                <div class="col-4">
                                    <div class="text-warning font-weight-bold">${(dados.horas_totais || 0).toFixed(0)}h</div>
                                    <small class="text-muted">Horas</small>
                                </div>
                            </div>
                            
                            <div class="progress progress-thin mb-2">
                                <div class="progress-bar ${progressoAtivos > 70 ? 'bg-success' : progressoAtivos > 40 ? 'bg-warning' : 'bg-danger'}" 
                                     style="width: ${progressoAtivos}%" title="${progressoAtivos}% ativo"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${(dados.tipos_na_categoria || []).length} tipos</small>
                                <button class="btn btn-outline-primary btn-sm" onclick="mostrarDetalhesCategoria('${nome.replace(/'/g, "\\'")}', '${encodeURIComponent(JSON.stringify(dados))}')" title="Ver detalhes">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
        
        // Ativar filtros
        ativarFiltrosLista();
    }

    function getCategoriaCor(categoria) {
        // Cores baseadas no hash do nome da categoria
        const cores = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#6f42c1', '#20c997', '#fd7e14', '#6610f2', '#e83e8c'
        ];
        
        let hash = 0;
        for (let i = 0; i < categoria.length; i++) {
            hash = categoria.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        return cores[Math.abs(hash) % cores.length];
    }

    function ativarBuscaTabela() {
        const searchInput = document.getElementById('searchTable');
        const tabela = document.getElementById('tableDetalhada');
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const filtro = this.value.toLowerCase();
                const linhas = tabela.querySelectorAll('tbody tr');
                
                linhas.forEach(linha => {
                    const categoria = linha.querySelector('td').textContent.toLowerCase();
                    linha.style.display = categoria.includes(filtro) ? '' : 'none';
                });
            });
        }
    }

    function ativarFiltrosLista() {
        const searchInput = document.getElementById('searchCompact');
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const filtro = this.value.toLowerCase();
                const items = document.querySelectorAll('.categoria-item');
                
                items.forEach(item => {
                    const categoria = item.dataset.categoria;
                    item.style.display = categoria.includes(filtro) ? '' : 'none';
                });
            });
        }
    }

    function filtrarLista(tipo) {
        const items = document.querySelectorAll('.categoria-item');
        const botoes = document.querySelectorAll('#filterAll, #filterTop, #filterActive');
        
        // Reset botões
        botoes.forEach(btn => {
            btn.classList.remove('btn-primary', 'btn-success', 'btn-warning');
            btn.classList.add('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning');
        });
        
        switch(tipo) {
            case 'all':
                items.forEach(item => item.style.display = '');
                document.getElementById('filterAll').classList.remove('btn-outline-primary');
                document.getElementById('filterAll').classList.add('btn-primary');
                break;
            case 'top':
                items.forEach(item => {
                    item.style.display = item.dataset.top === 'true' ? '' : 'none';
                });
                document.getElementById('filterTop').classList.remove('btn-outline-success');
                document.getElementById('filterTop').classList.add('btn-success');
                break;
            case 'active':
                items.forEach(item => {
                    item.style.display = item.dataset.active === 'true' ? '' : 'none';
                });
                document.getElementById('filterActive').classList.remove('btn-outline-warning');
                document.getElementById('filterActive').classList.add('btn-warning');
                break;
        }
    }

    function ordenarTabela(coluna) {
        const tabela = document.getElementById('tableDetalhada');
        const tbody = tabela.querySelector('tbody');
        const linhas = Array.from(tbody.querySelectorAll('tr'));
        
        // Alternar direção da ordenação
        const isAsc = tabela.dataset.sortDir !== 'asc';
        tabela.dataset.sortDir = isAsc ? 'asc' : 'desc';
        tabela.dataset.sortCol = coluna;
        
        linhas.sort((a, b) => {
            let valorA, valorB;
            
            switch(coluna) {
                case 'categoria':
                    valorA = a.querySelector('td').textContent.trim();
                    valorB = b.querySelector('td').textContent.trim();
                    return isAsc ? valorA.localeCompare(valorB) : valorB.localeCompare(valorA);
                case 'total':
                    valorA = parseInt(a.querySelectorAll('td')[1].textContent);
                    valorB = parseInt(b.querySelectorAll('td')[1].textContent);
                    break;
                case 'ativos':
                    valorA = parseInt(a.querySelectorAll('td')[2].textContent);
                    valorB = parseInt(b.querySelectorAll('td')[2].textContent);
                    break;
                case 'concluidos':
                    valorA = parseInt(a.querySelectorAll('td')[3].textContent);
                    valorB = parseInt(b.querySelectorAll('td')[3].textContent);
                    break;
                case 'horas':
                    valorA = parseFloat(a.querySelectorAll('td')[4].textContent);
                    valorB = parseFloat(b.querySelectorAll('td')[4].textContent);
                    break;
                case 'percentual':
                    valorA = parseFloat(a.querySelectorAll('td')[5].textContent);
                    valorB = parseFloat(b.querySelectorAll('td')[5].textContent);
                    break;
                default:
                    return 0;
            }
            
            return isAsc ? valorA - valorB : valorB - valorA;
        });
        
        // Reordenar na tabela
        linhas.forEach(linha => tbody.appendChild(linha));
    }

    function mostrarMapeamentoDexPra() {
        console.log('🔄 Carregando mapeamento DexPra...');
        
        // Mostra modal e loading
        const modal = new bootstrap.Modal(document.getElementById('modalMapeamentoDexPra'));
        modal.show();
        
        document.getElementById('loadingMapeamento').style.display = 'block';
        document.getElementById('containerMapeamento').style.display = 'none';
        
        // Chama API
        fetch('/macro/api/mapeamento-dexpra')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ Mapeamento DexPra recebido:', data);
                
                if (data.success) {
                    preencherMapeamentoDexPra(data.data);
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
            })
            .catch(error => {
                console.error('❌ Erro ao carregar mapeamento:', error);
                alert(`Erro ao carregar mapeamento: ${error.message}`);
            });
    }

    function preencherMapeamentoDexPra(dados) {
        try {
            // Ocultar loading
            document.getElementById('loadingMapeamento').style.display = 'none';
            
            // Preencher resumo
            if (dados.resumo) {
                document.getElementById('resumoTiposReais').textContent = dados.resumo.total_tipos_projetos || 0;
                document.getElementById('resumoTiposCSV').textContent = dados.resumo.total_tipos_csv || 0;
                document.getElementById('resumoNaoMapeados').textContent = dados.resumo.total_nao_mapeados || 0;
                
                // Atualizar contadores nas abas
                document.getElementById('countNaoMapeados').textContent = dados.resumo.total_nao_mapeados || 0;
                document.getElementById('countMapeados').textContent = dados.resumo.total_mapeados || 0;
                document.getElementById('countCSVNaoUsado').textContent = dados.resumo.total_csv_nao_usados || 0;
            }
            
            // Preencher tabela não mapeados
            const tabelaNaoMapeados = document.getElementById('tabelaNaoMapeados');
            tabelaNaoMapeados.innerHTML = '';
            
            if (dados.nao_mapeados && dados.nao_mapeados.length > 0) {
                dados.nao_mapeados.forEach(item => {
                    const row = `
                        <tr>
                            <td><strong>${item.tipo}</strong></td>
                            <td class="text-center"><span class="badge bg-danger">${item.qtd_projetos}</span></td>
                            <td class="text-center"><span class="badge bg-warning">${item.categoria_atual}</span></td>
                            <td><small class="text-primary">${item.acao_sugerida}</small></td>
                        </tr>
                    `;
                    tabelaNaoMapeados.innerHTML += row;
                });
            } else {
                tabelaNaoMapeados.innerHTML = '<tr><td colspan="4" class="text-center text-success">🎉 Todos os tipos estão mapeados!</td></tr>';
            }
            
            // Preencher tabela mapeados
            const tabelaMapeados = document.getElementById('tabelaMapeados');
            tabelaMapeados.innerHTML = '';
            
            if (dados.mapeados && dados.mapeados.length > 0) {
                dados.mapeados.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.tipo}</td>
                            <td class="text-center"><span class="badge bg-success">${item.qtd_projetos}</span></td>
                            <td><span class="badge bg-primary">${item.categoria}</span></td>
                        </tr>
                    `;
                    tabelaMapeados.innerHTML += row;
                });
            }
            
            // Preencher tabela CSV não usado
            const tabelaCSVNaoUsado = document.getElementById('tabelaCSVNaoUsado');
            tabelaCSVNaoUsado.innerHTML = '';
            
            if (dados.csv_nao_usados && dados.csv_nao_usados.length > 0) {
                dados.csv_nao_usados.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.tipo}</td>
                            <td><span class="badge bg-secondary">${item.categoria}</span></td>
                            <td><small class="text-muted">${item.status}</small></td>
                        </tr>
                    `;
                    tabelaCSVNaoUsado.innerHTML += row;
                });
            }
            
            // Mostrar container
            document.getElementById('containerMapeamento').style.display = 'block';
            
            console.log('✅ Mapeamento DexPra preenchido!');
            
        } catch (error) {
            console.error('❌ Erro ao preencher mapeamento:', error);
            alert('Erro ao processar dados do mapeamento');
        }
    }

    function exportarDexPra() {
        // Funcionalidade futura - exportar dados para CSV
        alert('Funcionalidade de exportação será implementada em breve!');
    }

    function debugNormalizacao() {
        console.log('🔍 Executando debug da normalização...');
        
        // Mostra loading
        const btnDebug = event.target;
        const textoOriginal = btnDebug.innerHTML;
        
        btnDebug.innerHTML = '<i class="bi bi-bug"></i> Analisando...';
        btnDebug.disabled = true;
        
        // Chama API de debug
        fetch('/macro/api/debug-normalizacao')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ Debug concluído:', data);
                
                if (data.success) {
                    const resultado = data.data;
                    let relatorio = `📊 DEBUG DA NORMALIZAÇÃO\n\n`;
                    relatorio += `Total tipos nos projetos: ${resultado.total_tipos_projetos}\n`;
                    relatorio += `Total tipos no CSV: ${resultado.total_tipos_csv}\n`;
                    relatorio += `Conflitos encontrados: ${resultado.total_conflitos}\n\n`;
                    
                    if (resultado.total_conflitos > 0) {
                        relatorio += `🔍 CONFLITOS IDENTIFICADOS:\n\n`;
                        resultado.debug_info.conflitos_potenciais.forEach((conflito, index) => {
                            relatorio += `${index + 1}. Normalizado: "${conflito.normalizado}"\n`;
                            relatorio += `   - Projeto: "${conflito.tipo_projeto}"\n`;
                            relatorio += `   - CSV: "${conflito.tipo_csv}" (${conflito.categoria_csv})\n`;
                            relatorio += `   - Textos idênticos: ${conflito.mesmo_texto ? 'Sim' : 'Não'}\n\n`;
                        });
                    } else {
                        relatorio += `✅ Nenhum conflito de normalização encontrado!\n`;
                    }
                    
                    // Mostra em nova janela para facilitar leitura
                    const novaJanela = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
                    novaJanela.document.write(`
                        <html>
                            <head><title>Debug Normalização - Control360</title></head>
                            <body style="font-family: monospace; padding: 20px; background: #f8f9fa;">
                                <h3>🔍 Debug da Normalização de Tipos de Serviço</h3>
                                <pre style="white-space: pre-wrap; background: white; padding: 15px; border-radius: 5px; border: 1px solid #ddd;">${relatorio}</pre>
                                <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Fechar</button>
                            </body>
                        </html>
                    `);
                    novaJanela.document.close();
                    
                    // Também salva no console para desenvolvedores
                    console.log('📊 Relatório de debug:', resultado);
                    
                    alert(`✅ Debug concluído!\n\nConfira a nova janela para ver o relatório detalhado.\nForam encontrados ${resultado.total_conflitos} conflitos de normalização.`);
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }
            })
            .catch(error => {
                console.error('❌ Erro no debug:', error);
                alert(`❌ Erro ao executar debug:\n\n${error.message}`);
            })
            .finally(() => {
                // Restaura botão
                btnDebug.innerHTML = textoOriginal;
                btnDebug.disabled = false;
            });
    }

    function forcarRefreshCSV() {
        console.log('🔄 Forçando refresh do CSV...');
        
        if (!confirm('Tem certeza que deseja forçar a recarga do arquivo CSV? Isso irá limpar o cache.')) {
            return;
        }
        
        const btnRefresh = event.target;
        const textoOriginal = btnRefresh.innerHTML;
        
        // Mostra loading no botão
        btnRefresh.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Atualizando...';
        btnRefresh.disabled = true;
        
        // Chama API de refresh
        fetch('/macro/api/refresh-tipos-servico', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('✅ Refresh CSV concluído:', data);
            
            if (data.success) {
                alert(`✅ Cache atualizado com sucesso!\n\n${data.message}\n\nTipos carregados: ${data.data.tipos_carregados}\nArquivo válido: ${data.data.arquivo_valido ? 'Sim' : 'Não'}`);
                
                // Recarrega os dados automaticamente
                carregarTiposServico();
            } else {
                throw new Error(data.message || 'Erro desconhecido');
            }
        })
        .catch(error => {
            console.error('❌ Erro no refresh CSV:', error);
            alert(`❌ Erro ao atualizar cache do CSV:\n\n${error.message}\n\nVerifique os logs do servidor para mais detalhes.`);
        })
        .finally(() => {
            // Restaura botão
            btnRefresh.innerHTML = textoOriginal;
            btnRefresh.disabled = false;
        });
    }

    // Carregar automaticamente quando a aba for clicada
    document.addEventListener('DOMContentLoaded', function() {
        const tabTiposServico = document.getElementById('tipos-servico-tab');
        if (tabTiposServico) {
            tabTiposServico.addEventListener('shown.bs.tab', function () {
                console.log('🔄 Aba Tipos de Serviço ativada, carregando dados...');
                carregarTiposServico();
            });
        }
    });

    // Exportar função globalmente
    window.carregarTiposServico = carregarTiposServico;
    </script>
    
    <!-- CSS customizado para melhorar o visual dos cards de tipos de serviço -->
    <style>
        /* Animações suaves para os cards */
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        /* Efeito de hover nos botões */
        .btn {
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* Cards de tipos de serviço seguindo padrão do Macro - removido gradientes */
        
        /* Animação de loading melhorada */
        .spinner-border {
            animation: spinner-border-custom 1s linear infinite;
        }
        
        @keyframes spinner-border-custom {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Efeito de pulsação nos números */
        .metric-number {
            animation: pulse-number 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulse-number {
            from {
                opacity: 0.8;
            }
            to {
                opacity: 1;
            }
        }
        
        /* Responsividade melhorada */
        @media (max-width: 768px) {
            .card-body h3 {
                font-size: 1.5rem;
            }
            
            .fs-4 {
                font-size: 1.2rem !important;
            }
        }
        
        /* Efeito glassmorphism nos cards de ação */
        .action-buttons-card {
            backdrop-filter: blur(10px);
            background: rgba(248, 249, 250, 0.8) !important;
        }
        
        /* Estilos para a aba de relatórios */
        .hover-card {
            transition: all 0.3s ease;
        }
        
        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
        
        .hover-card .btn {
            transition: all 0.2s ease;
        }
        
        .hover-card:hover .btn {
            transform: scale(1.05);
        }
    </style>
</body>
</html>
