<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Macro</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery (necessário para Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle com Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Inter', sans-serif; 
        }
        .card { 
            margin-bottom: 1.5rem; 
        }
        .graficos-container { 
            display: flex; 
            gap: 1.5rem; 
            margin-bottom: 1.5rem; 
        }
        .card-grafico { 
            flex: 1; 
            min-width: 0; 
        }
        .spin { 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }
        
        #statusChart { 
            height: 400px !important; 
            max-height: 400px !important; 
        }
        
        .bg-purple { 
            background-color: #6f42c1; 
        }
        .bg-purple-light { 
            background-color: rgba(111, 66, 193, 0.15); 
        }
        .text-purple { 
            color: #6f42c1; 
        }
        .border-left-purple { 
            border-left: 0.25rem solid #6f42c1 !important; 
        }
        
        .bg-danger-light { 
            background-color: rgba(220, 53, 69, 0.15); 
        }
        .text-danger { 
            color: #dc3545; 
        }
        .border-left-danger { 
            border-left: 0.25rem solid #dc3545 !important; 
        }
        
        .border-left-primary { 
            border-left: 0.25rem solid #4e73df !important; 
        }
        .border-left-success { 
            border-left: 0.25rem solid #1cc88a !important; 
        }
        .border-left-info { 
            border-left: 0.25rem solid #36b9cc !important; 
        }
        .border-left-warning { 
            border-left: 0.25rem solid #f6c23e !important; 
        }
        
        .card.shadow { 
            height: 100%; 
        }
        .card-body { 
            height: calc(100% - 48px); 
        }
        .card-grafico canvas { 
            max-height: 100%; 
        }
        
        .kpi-action-card { 
            cursor: pointer; 
            transition: transform 0.2s ease-in-out; 
        }
        .kpi-action-card:hover { 
            transform: translateY(-5px); 
        }
        
        .btn-purple { 
            background-color: #6f42c1; 
            color: white; 
        }
        .btn-purple:hover { 
            background-color: #5a32a3; 
            color: white; 
        }
        
        .modal-content { 
            border-radius: 0.5rem; 
            border: none; 
            max-height: 90vh;
            width: 100%;
        }
        .modal-header { 
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 0.75rem 1.25rem;
        }
        .modal-footer { 
            border-radius: 0 0 0.5rem 0.5rem;
            padding: 0.75rem;
        }
        .modal-xl {
            max-width: 95%;
            max-height: 90vh;
        }
        .modal-body {
            max-height: calc(90vh - 120px);
            min-height: 600px; /* Adicionado para altura mínima consistente */
            overflow-y: auto;
        }
        
        .modal .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        
        .modal .table thead th {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .modal .table tbody td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .modal .table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .modal .table tbody tr:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .table-responsive {
            max-height: calc(90vh - 150px);
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .progress-thin {
            height: 6px;
            margin-top: 4px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-thin .progress-bar {
            border-radius: 3px;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0,0,0,0.02);
        }

        /* <<< INÍCIO: Estilos Tabela Gerencial (Barras de Progresso, etc.) >>> */
        .progress-thin {
            height: 6px;
            margin-top: 4px;
            background-color: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-thin .progress-bar {
            border-radius: 3px;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .progress-value-text {
            font-family: 'Inter', monospace;
        }

        /* Cores para diferentes níveis de progresso (Conclusão E Horas Restantes) - FORÇADO */
        .progress-danger .progress-bar {
            background-color: #dc3545 !important; /* Vermelho */
        }
        .progress-warning .progress-bar {
            background-color: #ffc107 !important; /* Amarelo */
        }
        .progress-success .progress-bar {
            background-color: #198754 !important; /* Verde */
        }
        .progress-info .progress-bar {
            background-color: #0dcaf0 !important; /* Azul Info (caso usado) */
        }

        /* Cores/Estilos específicos para Horas Restantes - REMOVIDO (usando padrão acima) */
        /* .horas-restantes-positivo .progress-bar { background-color: #198754 !important; } */
        /* .horas-restantes-negativo .progress-bar { background-color: #dc3545 !important; } */
        /* .horas-restantes-zerado .progress-bar { background-color: #ffc107 !important; } */

        /* Estilos para limitar tamanho das colunas e texto */
        .modal .table td.projeto-col {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal .table td.squad-col {
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .modal .table td.status-col {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        /* <<< FIM: Estilos Tabela Gerencial >>> */

    </style>
</head>
<body style="padding-top: 70px;">
    <!-- Barra de Navegação Principal Fixa (Colada) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('macro.dashboard') }}">
                <i class="bi bi-speedometer2"></i> Control360
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'gerencial.dashboard' else '' }}" href="{{ url_for('gerencial.dashboard') }}">
                            <i class="bi bi-kanban"></i>
                            <span>Gerencial</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'macro.dashboard' else '' }}" href="{{ url_for('macro.dashboard') }}">
                            <i class="bi bi-speedometer2"></i>
                            <span>Macro</span>
                        </a>
                    </li>
                    <!-- Item 'Performance' removido -->
                    
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'macro.apresentacao' else '' }}" href="{{ url_for('macro.apresentacao') }}">
                            <i class="bi bi-file-earmark-slides"></i>
                            <span>Status Report</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav> 
    
    <!-- Container Principal (Conteúdo Mantido) -->
    <div class="container-fluid mt-4">
    
        <!-- NOVO TITULO E DATA -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800"><i class="bi bi-speedometer2 me-2"></i>Visão Macro</h1>
            <span class="text-muted small">
                 {% if hora_atualizacao %}
                    Atualizado em: {{ hora_atualizacao.strftime('%d/%m/%Y %H:%M:%S') }}
                 {% endif %}
            </span>
        </div>
        <!-- FIM NOVO TITULO E DATA -->

        <!-- Modal Projetos do Especialista -->
        <div class="modal fade" id="modalEspecialistaProjetos" tabindex="-1" aria-labelledby="modalEspecialistaProjetosLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="modalEspecialistaProjetosLabel">
                            <i class="bi bi-person"></i> Projetos Ativos - Especialista
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="listaProjetosModal">
                            <p class="text-center">Carregando projetos...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Projetos do Account Manager -->
        <div class="modal fade" id="modalAccountProjetos" tabindex="-1" aria-labelledby="modalAccountProjetosLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="modalAccountProjetosLabel">
                            <i class="bi bi-person-badge"></i> Projetos Ativos - Account Manager
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="listaProjetosAccountModal">
                            <p class="text-center">Carregando projetos...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid py-4">
            <!-- Cabeçalho (REMOVENDO TITULO ANTIGO) -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <!-- REMOVENDO H1 ANTIGO -->
                <!-- 
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="bi bi-speedometer2 me-2"></i> Visão Macro
                </h1>
                -->
            </div>

            <!-- GRID 1: Cards principais -->
            <div class="row mb-4">
                <!-- Card Projetos Ativos -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-success shadow h-100 py-2 kpi-action-card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modalProjetosAtivos">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Projetos Ativos</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.projetos_ativos }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-calendar fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Projetos Críticos -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-danger shadow h-100 py-2 kpi-action-card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modalProjetosCriticos">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                        Projetos Críticos</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.projetos_criticos }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Eficiência de Entrega -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Eficiência de Entrega</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.eficiencia_entrega }}%</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-speedometer2 fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Projetos Concluídos -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-success shadow h-100 py-2 kpi-action-card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modalProjetosConcluidos">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Projetos Concluídos</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ kpis.projetos_concluidos }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="bi bi-check-circle-fill fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRID 2: Cards secundários -->
            <div class="row mb-4">
                <!-- Card Tempo Médio de Vida -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-info shadow h-100 py-2">
                        <div class="card-body">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Tempo Médio de Vida
                            </div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div class="h2 mb-0 font-weight-bold text-gray-800">{{ kpis.tempo_medio_vida }} dias</div>
                            </div>
                            <div class="col-auto" style="position: absolute; top: 1rem; right: 1.5rem;">
                                <i class="bi bi-hourglass-split fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Média de Horas -->
                <div class="col-xl-3 col-md-6">
                    <div class="card border-left-primary shadow h-100 py-2">
                        <div class="card-body">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Média de Horas por Projeto
                            </div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div class="h2 mb-0 font-weight-bold text-gray-800">{{ kpis.media_horas }}h</div>
                            </div>
                            <div class="col-auto" style="position: absolute; top: 1rem; right: 1.5rem;">
                                <i class="bi bi-clock-history fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card de Ocupação por Squad -->
                <div class="col-xl-6 col-md-12">
                    <div class="card border-left-warning shadow h-100 py-2">
                        <div class="card-body">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-3">
                                Ocupação por Squad
                            </div>
                            <div class="squad-list">
                                {% for squad in ocupacao_squads %}
                                <div class="squad-info mb-2" data-bs-toggle="modal" data-bs-target="#modalSquad{{ loop.index }}" style="cursor: pointer;">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="fw-bold">{{ squad.nome }}</span>
                                        <span class="badge {% if squad.tem_horas_negativas %}bg-warning{% else %}bg-primary{% endif %}">
                                            {{ "%.1f"|format(squad.horas_restantes) }}h
                                        </span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar {% if squad.tem_horas_negativas %}bg-warning{% else %}bg-primary{% endif %}" 
                                             role="progressbar" 
                                             style="width: {{ "%.1f"|format(squad.percentual_ocupacao) }}%">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

           

            <!-- Conteúdo das Abas (Estrutura Mantida) -->
            <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button">
                        <i class="bi bi-clipboard-check me-1"></i> Por Status
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="especialistas-tab" data-bs-toggle="tab" data-bs-target="#especialistas" type="button">
                        <i class="bi bi-people me-1"></i> Especialistas
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="accounts-tab" data-bs-toggle="tab" data-bs-target="#accounts" type="button">
                        <i class="bi bi-briefcase me-1"></i> Account Managers
                    </button>
                </li>
                 <!-- Nova Aba para Projetos em Risco -->
                 <li class="nav-item" role="presentation">
                    <button class="nav-link" id="risco-tab" data-bs-toggle="tab" data-bs-target="#risco" type="button">
                        <i class="bi bi-exclamation-triangle me-1"></i> Projetos em Risco
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="dashboardTabsContent">
                <!-- Aba Status (Gráfico e Tabela Resumo) -->
                <div class="tab-pane fade show active" id="status" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6" style="height: 400px;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="card-title">Resumo por Status</h5>
                                    
                                    <!-- Tabela 1: Projetos Ativos -->
                                    <h6 class="card-subtitle mb-2 text-muted">Projetos Ativos</h6>
                                    <div class="table-responsive mb-4">
                                        <table class="table table-hover table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Status</th>
                                                    <th class="text-end">Quantidade</th>
                                                    <th class="text-end">Horas Totais</th>
                                                    <th class="text-end">Conclusão Média</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for status, data in por_status.items() %}
                                                    {% if status in ['EM ATENDIMENTO', 'AGUARDANDO', 'BLOQUEADO'] %}
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-{{ data.cor|default('light') }}">
                                                                {{ status }}
                                                            </span>
                                                        </td>
                                                        <td class="text-end">{{ data.quantidade }}</td>
                                                        <td class="text-end">{{ data.horas_totais|default(0)|round(1) }}h</td>
                                                        <td class="text-end">{{ data.conclusao_media|default(0)|round(1) }}%</td>
                                                    </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Tabela 2: Novo e Fechado -->
                                    <h6 class="card-subtitle mb-2 text-muted">Novo e Fechado</h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Status</th>
                                                    <th class="text-end">Quantidade</th>
                                                    <th class="text-end">Horas Totais</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for status, data in por_status.items() %}
                                                    {% if status in ['NOVO', 'FECHADO'] %}
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-{{ data.cor|default('light') }}">
                                                                {{ status }}
                                                            </span>
                                                        </td>
                                                        <td class="text-end">{{ data.quantidade }}</td>
                                                        <td class="text-end">{{ data.horas_totais|default(0)|round(1) }}h</td>
                                                    </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Especialistas -->
                <div class="tab-pane fade" id="especialistas" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            Alocação por Especialista
                        </div>
                        <div class="card-body">
                            {% include 'macro/partials/tabela_especialistas.html' %}
                        </div>
                    </div>
                </div>

                <!-- Aba Account Managers -->
                <div class="tab-pane fade" id="accounts" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            Projetos por Account Manager
                        </div>
                        <div class="card-body">
                            {% if dados_accounts is defined and dados_accounts %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Account Manager</th>
                                            <th class="text-end">Projetos</th>
                                            <th class="text-end">Horas Totais</th>
                                            <th class="text-end">Horas Restantes</th>
                                            <th class="text-end">Conclusão Média</th>
                                            <th class="text-end">Bloqueados</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in dados_accounts %}
                                        <tr class="clickable-row" data-account="{{ item['Account Manager'] }}" style="cursor: pointer;" title="Clique para ver os projetos de {{ item['Account Manager'] }}">
                                            <td>{{ item['Account Manager'] }}</td>
                                            <td class="text-end">{{ item.total_projetos }}</td>
                                            <td class="text-end">{{ item.horas_totais|round(1) }}h</td>
                                            <td class="text-end {% if item.horas_restantes < 0 %}text-danger fw-bold{% endif %}">
                                                {% if item.horas_restantes < 0 %}
                                                    <i class="bi bi-exclamation-triangle-fill me-1" title="Saldo de horas negativo!"></i>
                                                {% endif %}
                                                {{ "%.1f"|format(item.horas_restantes) }}h
                                            </td>
                                            <td class="text-end">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ get_conclusao_color(item.conclusao_media) }}" 
                                                         role="progressbar" 
                                                         style="width: {{ item.conclusao_media }}%"
                                                         aria-valuenow="{{ item.conclusao_media }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(item.conclusao_media) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                                <span class="badge bg-{{ 'danger' if item.projetos_bloqueados > 0 else 'secondary' }}">
                                                    {{ item.projetos_bloqueados }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Dados de Account Managers não disponíveis ou coluna não encontrada no CSV.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                 <!-- Aba Projetos em Risco (Nova Aba) -->
                <div class="tab-pane fade" id="risco" role="tabpanel">
                     <div class="card">
                         <div class="card-header">
                            Projetos em Risco (Preventivo)
                        </div>
                        <div class="card-body">
                            {% if projetos_risco %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th>Horas Restantes</th>
                                            <th>Data de Término</th>
                                            <th>Conclusão (%)</th>
                                            <th>Motivo do Risco</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for projeto in projetos_risco %}
                                        <tr>
                                            <td>{{ projeto.Projeto }}</td>
                                            <td>
                                                <span class="badge bg-{{ get_status_color(projeto.Status) }}">
                                                    {{ projeto.Status }}
                                                </span>
                                            </td>
                                            <td>{{ projeto.Squad }}</td>
                                            <td>{{ "%.1f"|format(projeto.HorasRestantes) }}h</td>
                                            <td>{{ projeto.DataTermino }}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ get_conclusao_color(projeto.Conclusao) }}" 
                                                         role="progressbar" 
                                                         style="width: {{ projeto.Conclusao }}%"
                                                         aria-valuenow="{{ projeto.Conclusao }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ "%.1f"|format(projeto.Conclusao) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="text-warning">
                                                    <i class="bi bi-info-circle"></i>
                                                    {{ projeto.motivo_risco }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                             {% else %}
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle"></i> Nenhum projeto em risco identificado.
                            </div>
                            {% endif %}
                        </div>
                     </div>
                </div>

            </div> <!-- Fim tab-content -->

            <!-- Modal Projetos Ativos -->
            <div class="modal fade" id="modalProjetosAtivos" tabindex="-1" aria-labelledby="modalProjetosAtivosLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalProjetosAtivosLabel">
                                <i class="bi bi-list-task"></i> Projetos Ativos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Conclusão</th>
                                            <th class="text-end">Horas Rest.</th>
                                            <th>Encerramento Previsto</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaProjetosAtivos">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Projetos Críticos -->
            <div class="modal fade" id="modalProjetosCriticos" tabindex="-1" aria-labelledby="modalProjetosCriticosLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="modalProjetosCriticosLabel">
                                <i class="bi bi-exclamation-triangle"></i> Projetos Críticos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Conclusão</th>
                                            <th class="text-end">Horas Rest.</th>
                                            <th>Encerramento Previsto</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaProjetosCriticos">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Projetos Concluídos -->
            <div class="modal fade" id="modalProjetosConcluidos" tabindex="-1" aria-labelledby="modalProjetosConcluídosLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="modalProjetosConcluídosLabel">
                                <i class="bi bi-check-circle"></i> Projetos Concluídos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Horas Contratadas</th>
                                            <th class="text-end">Horas Trabalhadas</th>
                                            <th>Data de Término</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaProjetosConcluidos">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Eficiência de Entrega -->
            <div class="modal fade" id="modalEficienciaEntrega" tabindex="-1" aria-labelledby="modalEficienciaEntregaLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="modalEficienciaEntregaLabel">
                                <i class="bi bi-speedometer2"></i> Eficiência de Entrega dos Projetos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="min-width: 800px;">
                                    <thead>
                                        <tr>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th>Squad</th>
                                            <th class="text-end">Horas Contratadas</th>
                                            <th class="text-end">Horas Trabalhadas</th>
                                            <th class="text-end">Eficiência (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabelaEficienciaEntrega">
                                        <!-- Será preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Tempo Médio de Vida -->
            <div class="modal fade" id="modalTempoVida" tabindex="-1" aria-labelledby="modalTempoVidaLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title" id="modalTempoVidaLabel">
                                <i class="bi bi-hourglass-split"></i> Tempo de Vida dos Projetos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info mb-4">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Tempo Médio de Vida:</strong> {{ kpis.tempo_medio_vida }} dias
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Projeto</th>
                                                    <th>Squad</th>
                                                    <th>Início</th>
                                                    <th>Término</th>
                                                    <th class="text-end">Dias</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for projeto in tempo_medio_vida_dados %}
                                                <tr>
                                                    <td>{{ projeto.Projeto }}</td>
                                                    <td>{{ projeto.Squad }}</td>
                                                    <td>{{ projeto.DataInicio.strftime('%d/%m/%Y') }}</td>
                                                    <td>{{ projeto.DataTermino.strftime('%d/%m/%Y') }}</td>
                                                    <td class="text-end">{{ projeto.tempo_vida }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modais para cada Squad -->
            {% for squad in ocupacao_squads %}
            <div class="modal fade" id="modalSquad{{ loop.index }}" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header {% if squad.tem_horas_negativas %}bg-warning{% else %}bg-primary{% endif %} text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-people-fill"></i> {{ squad.nome }}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert {% if squad.tem_horas_negativas %}alert-warning{% else %}alert-primary{% endif %} mb-4">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Total de Projetos:</strong> {{ squad.total_projetos }}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Horas Restantes:</strong> {{ "%.1f"|format(squad.horas_restantes) }}h
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Ocupação:</strong> {{ "%.1f"|format(squad.percentual_ocupacao) }}%
                                    </div>
                                </div>
                                {% if squad.tem_horas_negativas %}
                                <div class="mt-2">
                                    <small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Este Squad possui projetos com horas negativas</small>
                                    <br>
                                    <small class="text-muted"><i class="bi bi-info-circle"></i> Para o cálculo da ocupação total, as horas negativas são substituídas por 10% das horas originalmente contratadas.</small>
                                </div>
                                {% endif %}
                            </div>
                            
                            <h6 class="mb-3">Projetos do Squad</h6>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Projeto</th>
                                            <th>Status</th>
                                            <th class="text-end">Horas Restantes</th>
                                            <th class="text-end">Conclusão</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for projeto in squad.projetos %}
                                        <tr>
                                            <td>{{ projeto.Projeto }}</td>
                                            <td>
                                                <span class="badge bg-{{ get_status_color(projeto.Status) }}">
                                                    {{ projeto.Status }}
                                                </span>
                                            </td>
                                            <td class="text-end {% if projeto.HorasRestantes < 0 %}text-danger{% endif %}">
                                                {{ "%.1f"|format(projeto.HorasRestantes) }}h
                                                {% if 'HorasRestantesAjustadas' in projeto and projeto.HorasRestantes < 0 %}
                                                <br>
                                                <small class="text-muted" title="Para o cálculo da ocupação, valores negativos são substituídos por 10% das horas originais">
                                                    (ajustado: {{ "%.1f"|format(projeto.HorasRestantesAjustadas) }}h)
                                                </small>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-{{ get_conclusao_color(projeto.Conclusao) }}" 
                                                         role="progressbar" 
                                                         style="width: {{ projeto.Conclusao }}%"
                                                         aria-valuenow="{{ projeto.Conclusao }}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="100">
                                                        {{ projeto.Conclusao }}%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM carregado, iniciando configuração...");

            // Função para inicializar os modais
            function initializeModals() {
                console.log("Inicializando modais...");

                // Event delegation para a tabela de especialistas
                document.addEventListener('click', function(event) {
                    const especialistaRow = event.target.closest('#tabelaEspecialistas .clickable-row');
                    if (especialistaRow) {
                        const nomeEspecialista = especialistaRow.dataset.especialista;
                        if (!nomeEspecialista) {
                            console.error("Nome do especialista não encontrado no elemento:", especialistaRow);
                            return;
                        }

                        console.log("Clique em especialista:", nomeEspecialista);
                        const modalEspecialista = new bootstrap.Modal(document.getElementById('modalEspecialistaProjetos'));
                        const modalBody = document.getElementById('listaProjetosModal');
                        
                        if (!modalBody) {
                            console.error("Elemento 'listaProjetosModal' não encontrado");
                            return;
                        }
                        
                        modalBody.innerHTML = '<p class="text-center">Carregando projetos...</p>';
                        modalEspecialista.show();

                        const url = `/macro/api/projetos/especialista/${encodeURIComponent(nomeEspecialista)}`;
                        console.log("Fazendo requisição para:", url);

                        fetch(url)
                            .then(response => {
                                console.log("Status da resposta:", response.status);
                                return response.json();
                            })
                            .then(projetos => {
                                console.log("Projetos recebidos:", projetos);
                                if (projetos && projetos.length > 0) {
                                    // Formata as linhas usando a função padronizada
                                    const linhasHTML = projetos.map(p => formatarLinhaMacro(p)).join('');
                                    
                                    modalBody.innerHTML = `
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover"> <!-- Removido table-striped, adicionado table-hover -->
                                                <thead>
                                                    <tr>
                                                        <th>Número</th>
                                                        <th>Projeto</th>
                                                        <th>Status</th>
                                                        <th>Squad</th>
                                                        <th>Conclusão</th>
                                                        <th>Horas Rest.</th>
                                                        <th>Previsão</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${linhasHTML} <!-- Usa as linhas formatadas -->
                                                </tbody>
                                            </table>
                                        </div>`;
                                } else {
                                    modalBody.innerHTML = '<p class="text-center">Nenhum projeto ativo encontrado</p>';
                                }
                            })
                            .catch(error => {
                                console.error("Erro ao carregar projetos:", error);
                                modalBody.innerHTML = '<p class="text-center text-danger">Erro ao carregar projetos</p>';
                            });
                    }

                    const accountRow = event.target.closest('tr[data-account]');
                    if (accountRow) {
                        const nomeAccount = accountRow.dataset.account;
                        if (!nomeAccount) {
                            console.error("Nome do account manager não encontrado no elemento:", accountRow);
                            return;
                        }

                        console.log("Clique em account manager:", nomeAccount);
                        const modalAccount = new bootstrap.Modal(document.getElementById('modalAccountProjetos'));
                        const modalBody = document.getElementById('listaProjetosAccountModal');
                        
                        if (!modalBody) {
                            console.error("Elemento 'listaProjetosAccountModal' não encontrado");
                            return;
                        }
                        
                        modalBody.innerHTML = '<p class="text-center">Carregando projetos...</p>';
                        modalAccount.show();

                        const url = `/macro/api/projetos/account/${encodeURIComponent(nomeAccount)}`;
                        console.log("Fazendo requisição para:", url);

                        fetch(url)
                            .then(response => {
                                console.log("Status da resposta:", response.status);
                                return response.json();
                            })
                            .then(projetos => {
                                console.log("Projetos recebidos:", projetos);
                                if (projetos && projetos.length > 0) {
                                    // Formata as linhas usando a função padronizada
                                    const linhasHTML = projetos.map(p => formatarLinhaMacro(p)).join('');
                                    
                                    modalBody.innerHTML = `
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover"> <!-- Removido table-striped, adicionado table-hover -->
                                                <thead>
                                                    <tr>
                                                        <th>Número</th>
                                                        <th>Projeto</th>
                                                        <th>Status</th>
                                                        <th>Squad</th>
                                                        <th>Especialista</th>
                                                        <th>Conclusão</th>
                                                        <th>Horas Rest.</th>
                                                        <th>Previsão</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${linhasHTML} <!-- Usa as linhas formatadas -->
                                                </tbody>
                                            </table>
                                        </div>`;
                                } else {
                                    modalBody.innerHTML = '<p class="text-center">Nenhum projeto ativo encontrado</p>';
                                }
                            })
                            .catch(error => {
                                console.error("Erro ao carregar projetos:", error);
                                modalBody.innerHTML = '<p class="text-center text-danger">Erro ao carregar projetos</p>';
                            });
                    }
                });
            }

            // Função para formatar linha da tabela nos modais Ativos/Críticos do Macro
            function formatarLinhaMacro(p) {
                console.log("Formatando linha para:", p); // <-- DEBUG: Ver o objeto recebido
                try {
                    if (!p) {
                        console.error('Projeto indefinido ou nulo no Macro');
                        return '<tr><td colspan="7" class="text-center">Dados inválidos</td></tr>';
                    }

                    const numero = p.numero || '';
                    const nomeProjeto = p.projeto || 'N/A';
                    const status = p.status || 'N/D';
                    const squad = p.squad || 'N/D';
                    const conclusaoRaw = p.conclusao;
                    const horasRestantesRaw = p.horasRestantes;
                    const esforcoRaw = p.Horas;
                    
                    // Validação e conversão numérica mais robusta
                    const conclusao = !isNaN(parseFloat(conclusaoRaw)) ? parseFloat(conclusaoRaw) : 0;
                    const horasRestantes = !isNaN(parseFloat(horasRestantesRaw)) ? parseFloat(horasRestantesRaw) : 0;
                    const esforco = !isNaN(parseFloat(esforcoRaw)) ? parseFloat(esforcoRaw) : 0;
                    
                    const vencimento = p.dataPrevEnc || 'N/A'; // Usar dataPrevEnc do Macro

                    // --- Lógica de formatação copiada do Gerencial --- 
                    // Classe de cores para Conclusão
                    let progressClassConclusao = 'progress-info'; // Default
                    if (conclusao < 30) {
                        progressClassConclusao = 'progress-danger';
                    } else if (conclusao < 70) {
                        progressClassConclusao = 'progress-warning';
                    } else if (conclusao >= 70) { // >= 70 para ser verde
                        progressClassConclusao = 'progress-success';
                    }

                    // Formata a célula de conclusão com a barra de progresso
                    const conclusaoHTML = `
                        <div class="progress-value">
                            <span class="progress-value-text">${conclusao}%</span>
                        </div>
                        <div class="progress-thin ${progressClassConclusao}">
                            <div class="progress-bar" style="width: ${conclusao}%"></div>
                        </div>
                    `;
                    
                    // --- Lógica para Horas Restantes (Espelhada do Gerencial - Cor Inline) ---
                    console.log(`[HR Debug ${numero}] Entrada: horas=${horasRestantes}, esforco=${esforco}`);
                    let horasClass = 'progress-success'; // Mantém para possível estilo adicional
                    let corBarra = '#198754'; // Default: Verde
                    let percentualHoras = 0;

                    if (horasRestantes < 0) {
                        horasClass = 'progress-danger';
                        corBarra = '#dc3545'; // Vermelho
                        percentualHoras = 100;
                        console.log(`[HR Debug ${numero}] Condição: Negativo`);
                    } else if (horasRestantes < 10) {
                        horasClass = 'progress-warning';
                        corBarra = '#ffc107'; // Amarelo
                        console.log(`[HR Debug ${numero}] Condição: Positivo < 10`);
                        if (esforco > 0) {
                            percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
                            console.log(`[HR Debug ${numero}] Calculado (<10): esforco=${esforco}, percentual=${percentualHoras}`);
                        } else {
                             console.log(`[HR Debug ${numero}] Ignorado (<10): esforco=${esforco}`);
                             percentualHoras = 0; // Garante 0 se esforço inválido
                        } 
                    } else { // horasRestantes >= 10
                        // horasClass já é 'progress-success'
                        // corBarra já é '#198754' (Verde)
                        console.log(`[HR Debug ${numero}] Condição: Positivo >= 10`);
                        if (esforco > 0) {
                            percentualHoras = Math.min(100, Math.max(0, (horasRestantes / esforco) * 100));
                             console.log(`[HR Debug ${numero}] Calculado (>=10): esforco=${esforco}, percentual=${percentualHoras}`);
                        } else {
                             console.log(`[HR Debug ${numero}] Ignorado (>=10): esforco=${esforco}`);
                             percentualHoras = 0; // Garante 0 se esforço inválido
                        } 
                    }
                    console.log(`[HR Debug ${numero}] Final: classe=${horasClass}, cor=${corBarra}, largura=${percentualHoras.toFixed(1)}%`); 

                    const horasHTML = `
                        <div class="progress-value">
                            <span class="progress-value-text ${horasRestantes < 0 ? 'text-danger fw-bold' : ''}">${(!isNaN(horasRestantes)) ? horasRestantes.toFixed(1) : 'N/A'}h</span>
                        </div>
                        <div class="progress-thin ${horasClass}">
                            <div class="progress-bar" style="width: ${percentualHoras.toFixed(1)}%; background-color: ${corBarra};"></div>
                        </div>
                    `;
                    // --- Fim Lógica Horas Restantes (Gerencial - Cor Inline) ---

                    // Link para o ticket se o número existir
                    const numeroLink = numero ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${numero}" target="_blank" style="text-decoration: none; color: inherit;">${numero}</a>` : 'N/A';

                    // Badge para Status (usando a função getStatusColor já existente no Macro)
                    const statusBadge = `<span class="badge bg-${getStatusColor(status || '')}">${status || 'N/A'}</span>`; // Garante string vazia se status for null

                    console.log(`Calculados para ${p.numero || 'N/A'}: esforco=${esforco}, horasRest=${horasRestantes}, concl=${conclusao}`); // <-- DEBUG: Ver valores calculados

                    return `
                        <tr>
                            <td>${numeroLink}</td>
                            <td class="projeto-col" title="${nomeProjeto}"><span class="truncate-text">${nomeProjeto}</span></td>
                            <td class="status-col">${statusBadge}</td>
                            <td class="squad-col" title="${squad}">${squad}</td>
                            <td class="text-end">${conclusaoHTML}</td>
                            <td class="text-end">${horasHTML}</td>
                            <td>${vencimento}</td>
                        </tr>
                    `;
                } catch (error) {
                    console.error('Erro ao formatar linha no Macro:', error, p);
                    return '<tr><td colspan="7" class="text-center text-danger">Erro ao processar dados</td></tr>';
                }
            }

            // Função para carregar dados dos KPIs
            function carregarDadosKPI() {
                console.log("Carregando dados dos KPIs...");

                // Projetos Ativos
                fetch('/macro/api/projetos/ativos')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaProjetosAtivos');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => formatarLinhaMacro(p)).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum projeto ativo encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar projetos ativos:", error);
                        document.getElementById('tabelaProjetosAtivos').innerHTML = 
                            '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });

                // Projetos Críticos
                fetch('/macro/api/projetos/criticos')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaProjetosCriticos');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => formatarLinhaMacro(p)).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum projeto crítico encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar projetos críticos:", error);
                        document.getElementById('tabelaProjetosCriticos').innerHTML = 
                            '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });

                // Projetos Concluídos
                fetch('/macro/api/projetos/concluidos')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaProjetosConcluidos');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => `
                                <tr>
                                    <td>${p.projeto ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${p.numero}" target="_blank" style="text-decoration: none; color: inherit;">${p.projeto}</a>` : 'N/A'}</td>
                                    <td><span class="badge bg-${getStatusColor(p.status)}">${p.status || 'N/A'}</span></td>
                                    <td>${p.squad || 'N/A'}</td>
                                    <td class="text-end">${p.horasContratadas != null ? p.horasContratadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td class="text-end">${p.horasTrabalhadas != null ? p.horasTrabalhadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td>${p.dataTermino || 'N/A'}</td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum projeto concluído encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar projetos concluídos:", error);
                        document.getElementById('tabelaProjetosConcluidos').innerHTML = 
                            '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });

                // Eficiência de Entrega
                fetch('/macro/api/projetos/eficiencia')
                    .then(response => response.json())
                    .then(projetos => {
                        const tbody = document.getElementById('tabelaEficienciaEntrega');
                        if (projetos && projetos.length > 0) {
                            tbody.innerHTML = projetos.map(p => `
                                <tr>
                                    <td>${p.projeto ? `<a href="https://atendimento.sou.cloud/Ticket/Edit/${p.numero}" target="_blank" style="text-decoration: none; color: inherit;">${p.projeto}</a>` : 'N/A'}</td>
                                    <td><span class="badge bg-${getStatusColor(p.status)}">${p.status || 'N/A'}</span></td>
                                    <td>${p.squad || 'N/A'}</td>
                                    <td class="text-end">${p.horasContratadas != null ? p.horasContratadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td class="text-end">${p.horasTrabalhadas != null ? p.horasTrabalhadas.toFixed(1) + 'h' : 'N/A'}</td>
                                    <td class="text-end">
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-${getEficienciaColor(p.eficiencia)}" 
                                                 role="progressbar" 
                                                 style="width: ${p.eficiencia}%"
                                                 aria-valuenow="${p.eficiencia}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                ${p.eficiencia != null ? p.eficiencia.toFixed(1) + '%' : 'N/A'}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum dado de eficiência encontrado</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao carregar dados de eficiência:", error);
                        document.getElementById('tabelaEficienciaEntrega').innerHTML = 
                            '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar dados</td></tr>';
                    });
            }

            // Função para carregar o gráfico de status
            function carregarGraficoStatus() {
                console.log("Carregando gráfico de status...");
                const ctx = document.getElementById('statusChart').getContext('2d');
                
                fetch('/macro/api/filter')
                .then(response => response.json())
                .then(data => {
                    console.log("Dados recebidos da API:", data);
                    
                    // Tenta extrair os dados de status de várias maneiras possíveis
                    let statusData = null;
                    
                    if (data && data.por_status && Object.keys(data.por_status).length > 0) {
                        statusData = data.por_status;
                        console.log("Usando dados diretos da API: data.por_status");
                    } else if (data && data.data && data.data.por_status && Object.keys(data.data.por_status).length > 0) {
                        statusData = data.data.por_status;
                        console.log("Usando dados aninhados: data.data.por_status");
                    } else if (data && data.agregacoes && data.agregacoes.por_status && Object.keys(data.agregacoes.por_status).length > 0) {
                        statusData = data.agregacoes.por_status;
                        console.log("Usando estrutura alternativa: data.agregacoes.por_status");
                    } else if (typeof data === 'object' && Object.keys(data).length > 0) {
                        // Tentativa de último recurso
                        console.log("Tentando usar o próprio objeto data como fonte de dados");
                        
                        // Procura por qualquer propriedade que possa ser usada como fonte de dados
                        for (const key in data) {
                            if (data[key] && typeof data[key] === 'object' && data[key].quantidade !== undefined) {
                                statusData = data;
                                console.log("Usando o objeto data diretamente");
                                break;
                            }
                        }
                    }
                    
                    if (!statusData) {
                        // Dados de exemplo para forçar exibição do gráfico (apenas para depuração)
                        console.warn("ATENÇÃO: Usando dados estáticos para o gráfico porque nenhum dado válido foi encontrado");
                        statusData = {
                            'NOVO': {'quantidade': 9, 'horas_totais': 168.0, 'conclusao_media': 0.0, 'cor': 'info'},
                            'AGUARDANDO': {'quantidade': 22, 'horas_totais': 872.0, 'conclusao_media': 18.9, 'cor': 'warning'},
                            'EM ATENDIMENTO': {'quantidade': 34, 'horas_totais': 3190.0, 'conclusao_media': 17.5, 'cor': 'primary'},
                            'FECHADO': {'quantidade': 56, 'horas_totais': 2498.0, 'conclusao_media': 72.8, 'cor': 'success'}
                        };
                    }
                    
                    console.log("Dados de status para o gráfico:", statusData);
                    
                    // Lista de status que queremos incluir no gráfico
                    const statusPermitidos = ['NOVO', 'EM ATENDIMENTO', 'AGUARDANDO', 'BLOQUEADO', 'FECHADO'];
                    
                    // Processa os dados para o gráfico
                    let dadosProcessados = {};
                    
                    // Inicializa o valor combinado para FECHADO que incluirá RESOLVIDO
                    let fechadoCombinado = {
                        quantidade: 0,
                        horas_totais: 0.0,
                        conclusao_media: 0.0,
                        cor: 'success'
                    };
                    
                    // Primeiro passo: processar os dados
                    for (const status in statusData) {
                        const statusUpper = status.toUpperCase();
                        const data = statusData[status];
                        
                        // Ignora status que não queremos exibir
                        if (!statusPermitidos.includes(statusUpper) && statusUpper !== 'RESOLVIDO') {
                            console.log(`Ignorando status não permitido: ${status}`);
                            continue;
                        }
                        
                        // Se não tiver quantidade definida, pula
                        if (!data || typeof data !== 'object' || data.quantidade === undefined) {
                            console.warn(`Status ${status} não tem dados válidos:`, data);
                            continue;
                        }
                        
                        // Tratamento especial para FECHADO e RESOLVIDO (combinados)
                        if (statusUpper === 'RESOLVIDO' || statusUpper === 'FECHADO') {
                            fechadoCombinado.quantidade += parseInt(data.quantidade || 0);
                            fechadoCombinado.horas_totais += parseFloat(data.horas_totais || 0);
                            console.log(`Combinando ${status} com FECHADO: +${data.quantidade} projetos`);
                            continue;
                        }
                        
                        // Adiciona outros status normalmente
                        dadosProcessados[statusUpper] = {
                            quantidade: parseInt(data.quantidade || 0),
                            horas_totais: parseFloat(data.horas_totais || 0),
                            conclusao_media: parseFloat(data.conclusao_media || 0),
                            cor: data.cor || getStatusColor(statusUpper)
                        };
                    }
                    
                    // Adiciona FECHADO combinado se tiver dados
                    if (fechadoCombinado.quantidade > 0) {
                        dadosProcessados['FECHADO'] = fechadoCombinado;
                        console.log(`FECHADO (combinado): ${fechadoCombinado.quantidade} projetos`);
                    }
                    
                    // Garante que todos os status permitidos existam com valores padrão
                    for (const status of statusPermitidos) {
                        if (!dadosProcessados[status]) {
                            dadosProcessados[status] = {
                                quantidade: 0,
                                horas_totais: 0.0,
                                conclusao_media: 0.0,
                                cor: getStatusColor(status)
                            };
                        }
                    }
                    
                    console.log("Dados processados para o gráfico:", dadosProcessados);
                    
                    // Extrai os labels e valores para o gráfico
                    const labels = Object.keys(dadosProcessados);
                    const valores = labels.map(status => dadosProcessados[status].quantidade);
                    const cores = labels.map(status => getStatusBackgroundColor(status));
                    
                    if (labels.length === 0) {
                        console.error("Nenhum status válido encontrado para o gráfico");
                        ctx.canvas.parentElement.innerHTML = '<div class="alert alert-danger mt-3">Não há dados de status para exibir no gráfico</div>';
                        return;
                    }
                    
                    console.log("Labels finais:", labels);
                    console.log("Valores finais:", valores);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Quantidade de Projetos',
                                data: valores,
                                backgroundColor: cores,
                                borderColor: cores,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Distribuição de Projetos por Status'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Quantidade: ${context.parsed.y}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar dados do gráfico:", error);
                    ctx.canvas.parentElement.innerHTML = '<div class="alert alert-danger mt-3">Erro ao carregar dados: ' + error.message + '</div>';
                });
            }

            // Funções auxiliares para cores
            function getStatusColor(status) {
                const cores = {
                    'NOVO': 'info',
                    'EM ATENDIMENTO': 'primary',
                    'AGUARDANDO': 'warning',
                    'BLOQUEADO': 'danger',
                    'FECHADO': 'success',
                    'ENCERRADO': 'success',
                    'RESOLVIDO': 'success',
                    'CANCELADO': 'secondary'
                };
                return cores[status?.toUpperCase()] || 'secondary';
            }

            function getStatusBackgroundColor(status) {
                if (!status) return '#6c757d'; // Retorna cinza secundário para valores nulos
                
                const cores = {
                    'NOVO': '#17a2b8',
                    'EM ATENDIMENTO': '#007bff',
                    'AGUARDANDO': '#ffc107',
                    'BLOQUEADO': '#dc3545',
                    'FECHADO': '#28a745',
                    'ENCERRADO': '#28a745',
                    'RESOLVIDO': '#28a745',
                    'CANCELADO': '#6c757d'
                };
                return cores[status.toUpperCase()] || '#6c757d';
            }

            function getEficienciaColor(eficiencia) {
                if (eficiencia >= 90) return 'success';
                if (eficiencia >= 70) return 'info';
                if (eficiencia >= 50) return 'warning';
                return 'danger';
            }

            // Inicializa os modais
            initializeModals();
            
            // Carrega os dados dos KPIs e o gráfico
            carregarDadosKPI();
            carregarGraficoStatus();
            
            // Implementa a busca de especialistas
            const buscaEspecialista = document.getElementById('buscaEspecialistaInput');
            if (buscaEspecialista) {
                buscaEspecialista.addEventListener('keyup', function() {
                    const termo = this.value.toLowerCase();
                    const linhas = document.querySelectorAll('#tabelaEspecialistas tbody tr');
                    
                    linhas.forEach(linha => {
                        const nomeEspecialista = linha.querySelector('td:first-child').textContent.toLowerCase();
                        if (nomeEspecialista.includes(termo)) {
                            linha.style.display = '';
                        } else {
                            linha.style.display = 'none';
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
