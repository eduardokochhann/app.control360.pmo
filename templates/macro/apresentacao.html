<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Report</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery (necessário para Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle com Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
        }

        body { 
            background-color: var(--light-bg); 
            font-family: 'Inter', sans-serif;
            color: var(--primary-color);
        }

        .card { 
            margin-bottom: 1rem; 
            border-radius: 0.5rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1) !important;
            border: none;
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 0.5rem 0.5rem 0 0 !important;
            font-weight: 600;
            padding: 1rem;
        }

        .gradient-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .header-principal {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .graficos-container { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card-grafico { 
            min-width: 0;
        }

        /* Status e Indicadores */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            display: inline-block;
        }

        .badge-counter {
            position: relative;
            font-size: 0.85rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.5rem;
            margin-left: 0.4rem;
            font-weight: 600;
            background-color: var(--primary-color);
            color: white;
        }

        /* Indicadores de variação */
        .variacao-positiva { color: var(--success-color); }
        .variacao-negativa { color: var(--danger-color); }
        .variacao-neutra { color: #6c757d; }

        .variacao-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .variacao-badge.positiva {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .variacao-badge.negativa {
            background-color: rgba(192, 57, 43, 0.1);
            color: var(--danger-color);
        }

        .variacao-badge.neutra {
            background-color: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        /* KPI Cards */
        .kpi-card {
            height: 100%;
            transition: all 0.3s ease;
            border-left: 4px solid var(--secondary-color);
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .kpi-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Gráficos */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Tabelas */
        .table-responsive-sm {
            margin-bottom: 1rem;
        }

        .table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .table thead th {
            background-color: var(--light-bg);
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            color: var(--primary-color);
        }

        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .table-sm td, .table-sm th {
            padding: 0.5rem;
        }

        /* Comparativo */
        .comparativo-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* Alertas */
        .alert {
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .graficos-container,
            .comparativo-container {
                grid-template-columns: 1fr;
            }
            
            .kpi-value {
                font-size: 1.5rem;
            }
        }

        .kpi-card {
            margin-bottom: 1rem;
        }
        .kpi-title {
            font-size: 0.9rem;
            color: #666;
        }
        .kpi-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .azure-border {
            border-left: 4px solid #0078D4 !important;
        }
        .m365-border {
            border-left: 4px solid #D83B01 !important;
        }
        .datapower-border {
            border-left: 4px solid #107C10 !important;
        }
        .cdb-border {
            border-left: 4px solid #5C2D91 !important;
        }

        @media print {
            @page {
                size: landscape;
                margin: 0.5in;
            }

            html, body {
                width: 100%;
                height: 100%;
                overflow: hidden !important;
            }

            body {
                font-size: 10pt;
                padding-top: 0 !important;
                background-color: initial !important;
                color: inherit !important;
                transform-origin: top left;
                transform: scale(0.7);
            }

            .navbar,
            .nav-tabs,
            .d-sm-flex.align-items-center.justify-content-between.mb-4,
            #scrollToTopBtn {
                display: none !important;
            }

            .card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                margin-bottom: 0.5rem !important;
                page-break-inside: avoid;
                background-color: inherit !important;
            }

            .card-header {
                border-bottom: 1px solid #ddd !important;
                padding: 0.5rem !important;
                background: inherit !important;
                color: inherit !important;
            }

            .card-header h5, .card-header h6 {
                font-size: 12pt !important;
                color: inherit !important;
            }

            .card-body {
                padding: 0.5rem !important;
                background-color: inherit !important;
                color: inherit !important;
            }

            h1, h2, h3, h4, h5, h6 {
                color: inherit !important;
                page-break-after: avoid;
            }

            .kpi-value {
                font-size: 1.5rem !important;
                color: inherit !important;
            }

            .kpi-title {
                color: inherit !important;
            }

            .badge {
                border: 1px solid #ccc !important;
                color: inherit !important;
                background-color: inherit !important;
            }

            .badge.bg-primary { background-color: var(--bs-primary) !important; color: white !important; }
            .badge.bg-secondary { background-color: var(--bs-secondary) !important; color: white !important; }
            .badge.bg-success { background-color: var(--bs-success) !important; color: white !important; }
            .badge.bg-danger { background-color: var(--bs-danger) !important; color: white !important; }
            .badge.bg-warning { background-color: var(--bs-warning) !important; color: black !important; }
            .badge.bg-info { background-color: var(--bs-info) !important; color: black !important; }
            .badge.bg-light { background-color: var(--bs-light) !important; color: black !important; }
            .badge.bg-dark { background-color: var(--bs-dark) !important; color: white !important; }

            .table {
                font-size: 9pt;
                color: inherit !important;
            }

            .table thead th {
                background-color: inherit !important;
                color: inherit !important;
            }

            .table tbody tr:hover {
                background-color: inherit !important;
            }

            .text-success { color: var(--success-color) !important; }
            .text-danger { color: var(--danger-color) !important; }
            .text-muted { color: #6c757d !important; }
            .text-primary { color: var(--primary-color) !important; }
            .text-warning { color: var(--warning-color) !important; }
            .text-info { color: var(--bs-info) !important; }
            
            .variacao-positiva { color: var(--success-color) !important; }
            .variacao-negativa { color: var(--danger-color) !important; }
            .variacao-neutra { color: #6c757d !important; }

            .bi-arrow-up, .bi-arrow-down {
            }

            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body style="padding-top: 70px;">
    <!-- Barra de Navegação Principal Fixa (Colada) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('macro.dashboard') }}">
                <i class="bi bi-speedometer2"></i> Control360
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'gerencial.dashboard' else '' }}" href="{{ url_for('gerencial.dashboard') }}">
                            <i class="bi bi-kanban"></i>
                            <span>Gerencial</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'macro.dashboard' else '' }}" href="{{ url_for('macro.dashboard') }}">
                            <i class="bi bi-speedometer2"></i>
                            <span>Macro</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'macro.apresentacao' else '' }}" href="{{ url_for('macro.apresentacao') }}">
                            <i class="bi bi-file-earmark-slides"></i>
                            <span>Status Report</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav> 
    
    <!-- Container Principal (Conteúdo Mantido) -->
    <div class="container-fluid mt-4">
    
        <!-- CABEÇALHO ANTIGO REMOVIDO -->
        <!-- 
        <div class="container-fluid mb-4 pt-3">
            <div class="row align-items-start">
                ...
            </div>
        </div>
        -->
        
        <!-- TITULO PRINCIPAL -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <div>
                <h1 class="h3 mb-0" style="color: var(--primary-color);"><i class="bi bi-file-earmark-slides me-2"></i>Status Report</h1>
                <p class="text-muted small mb-0">Fonte de dados: {{ fonte_dados }}</p>
            </div>
            
            <!-- Seletor Mensal / Histórico -->
            <div class="btn-group">
                <a href="{{ url_for('macro.apresentacao') }}" class="btn btn-primary active" aria-current="page">
                    <i class="bi bi-calendar-month me-1"></i>Mensal
                </a>
                <a href="{{ url_for('macro.apresentacao_periodo') }}" class="btn btn-outline-primary">
                    <i class="bi bi-bar-chart-line-fill me-1"></i>Histórico
                </a>
            </div>
        </div>
        <!-- FIM TITULO PRINCIPAL -->

        <!-- Exibição de Erro -->
        {% if error %}
        <div class="col-12">
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
            </div>
        </div>
        {% endif %}

        <!-- ABAS DE NAVEGAÇÃO POR MÊS (RESTAURADAS) -->
        <div class="container-fluid mb-3">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    {# Link para a visão padrão/atual #}
                    {# Ativo se NENHUM mes/ano for passado na URL #}
                    {% set is_default = not request.args.get('mes') and not request.args.get('ano') %}
                    <a class="nav-link {{ 'active' if is_default else '' }}" 
                       href="{{ url_for('macro.apresentacao') }}">
                       Visão Atual
                    </a>
                </li>
                
                {# ABAS DINÂMICAS baseadas nas fontes detectadas automaticamente #}
                {% if fontes_disponiveis %}
                    {% for fonte in fontes_disponiveis %}
                        <li class="nav-item">
                            {% set is_active = request.args.get('mes') == fonte.mes|string and request.args.get('ano') == fonte.ano|string %}
                            <a class="nav-link {{ 'active' if is_active else '' }}" 
                               href="{{ url_for('macro.apresentacao', mes=fonte.mes, ano=fonte.ano) }}">
                               {{ fonte.nome_exibicao }}
                            </a>
                        </li>
                    {% endfor %}
                {% else %}
                    {# Fallback para abas fixas caso a detecção automática falhe #}
                    <!-- Reordenado para Decrescente -->
                    <li class="nav-item">
                        {# Link para Abr/2025 #}
                        {% set is_abr = request.args.get('mes') == '4' and request.args.get('ano') == '2025' %}
                        <a class="nav-link {{ 'active' if is_abr else '' }}" 
                           href="{{ url_for('macro.apresentacao', mes=4, ano=2025) }}">
                           Abr/2025
                        </a>
                    </li>
                    <li class="nav-item">
                        {# Link para Mar/2025 #}
                        {% set is_mar = request.args.get('mes') == '3' and request.args.get('ano') == '2025' %}
                        <a class="nav-link {{ 'active' if is_mar else '' }}" 
                           href="{{ url_for('macro.apresentacao', mes=3, ano=2025) }}">
                           Mar/2025
                        </a>
                    </li>
                    <li class="nav-item">
                        {# Link para Fev/2025 #}
                        {% set is_fev = request.args.get('mes') == '2' and request.args.get('ano') == '2025' %}
                        <a class="nav-link {{ 'active' if is_fev else '' }}" 
                           href="{{ url_for('macro.apresentacao', mes=2, ano=2025) }}">
                           Fev/2025
                        </a>
                    </li>
                    <li class="nav-item">
                        {# Link para Jan/2025 #}
                        {% set is_jan = request.args.get('mes') == '1' and request.args.get('ano') == '2025' %}
                        <a class="nav-link {{ 'active' if is_jan else '' }}" 
                           href="{{ url_for('macro.apresentacao', mes=1, ano=2025) }}">
                           Jan/2025
                        </a>
                    </li>
                {% endif %}
                <!-- Adicionar mais meses históricos aqui se necessário (manter ordem decrescente) -->
            </ul>
        </div>
        <!-- FIM ABAS DE NAVEGAÇÃO -->

        <div class="container-fluid py-3">
            <!-- Resumo e Comparativos -->
            <div class="row mb-3">
                <!-- Mensagem de erro se houver -->
                {% if error %}
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ error }}
                    </div>
                </div>
                {% else %}
                
                <!-- Resumo de projetos ativos -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card shadow" id="cardResumoAtivos">
                            <div class="card-header py-2 bg-primary text-white"> {# Revertido para bg-primary #}
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Resumo de projetos ativos</h5> {# Mês/Ano já removido #}
                                    <button type="button" class="btn btn-sm btn-outline-light" 
                                            onclick="copiarCardParaPowerPoint('cardResumoAtivos')"
                                            title="Copiar para PowerPoint">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h5 class="text-center mb-3">
                                            Total de projetos ativos: 
                                            <span class="badge bg-primary fs-6">{{ total_ativos_atual }}</span>
                                            
                                            {# -- INÍCIO: Indicador de Variação (já usa variáveis diretas) -- #}
                                            {% set variacao_ativos = total_ativos_atual - total_ativos_anterior %}
                                            {% if variacao_ativos != 0 %}
                                                <span class="ms-2 small {% if variacao_ativos > 0 %}text-success{% elif variacao_ativos < 0 %}text-danger{% endif %}">
                                                    ({{ '%+d'|format(variacao_ativos) }} vs {{ nome_mes_comparativo | default('mês ant.') }})
                                                    <i class="bi {% if variacao_ativos > 0 %}bi-arrow-up{% elif variacao_ativos < 0 %}bi-arrow-down{% endif %}"></i>
                                                </span>
                                            {% else %}
                                                <span class="ms-2 small text-muted">
                                                    (= vs {{ nome_mes_comparativo | default('mês ant.') }})
                                                </span>
                                            {% endif %}
                                            {# -- FIM: Indicador de Variação -- #}
                                            
                                        </h5>
                                    </div>
                                </div>
                                
                                {# Definir variáveis para contagens individuais usando a nova chave agregacoes_por_status #}
                                {% set novo = agregacoes_por_status.get('NOVO', {}).get('quantidade', 0) %}
                                {% set em_andamento = agregacoes_por_status.get('EM ATENDIMENTO', {}).get('quantidade', 0) %}
                                {% set aguardando = agregacoes_por_status.get('AGUARDANDO', {}).get('quantidade', 0) %}
                                {% set bloqueado = agregacoes_por_status.get('BLOQUEADO', {}).get('quantidade', 0) %}
                                
                                <div class="row g-3">
                                    <!-- Card 1: Status Novo -->
                                    <div class="col-md-3">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-light py-2"> {# Revertido para bg-light #}
                                                <h6 class="mb-0">STATUS NOVO</h6> {# Revertido para h6 #}
                                            </div>
                                            <div class="card-body text-center"> {# Revertido para text-center #}
                                                <h2 class="display-6">{{ novo }}</h2> {# Removido mb-0 #}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Card 2: Status Em andamento -->
                                    <div class="col-md-3">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-light py-2"> {# Revertido para bg-light #}
                                                <h6 class="mb-0">STATUS EM ANDAMENTO</h6> {# Revertido para h6 #}
                                            </div>
                                            <div class="card-body text-center"> {# Revertido para text-center #}
                                                <h2 class="display-6">{{ em_andamento }}</h2> {# Removido mb-0 #}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Card 3: Status Aguardando -->
                                    <div class="col-md-3">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-light py-2"> {# Revertido para bg-light #}
                                                <h6 class="mb-0">STATUS AGUARDANDO</h6> {# Revertido para h6 #}
                                            </div>
                                            <div class="card-body text-center"> {# Revertido para text-center #}
                                                <h2 class="display-6">{{ aguardando }}</h2> {# Removido mb-0 #}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Card 4: Status Bloqueado -->
                                    <div class="col-md-3">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-header bg-light py-2"> {# Revertido para bg-light #}
                                                <h6 class="mb-0">STATUS BLOQUEADO</h6> {# Revertido para h6 #}
                                            </div>
                                            <div class="card-body text-center"> {# Revertido para text-center #}
                                                <h2 class="display-6">{{ bloqueado }}</h2> {# Removido mb-0 #}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distribuição por Squad -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card shadow" id="cardDistribuicaoSquad">
                            <div class="card-header py-2 bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Distribuição por Squad</h5>
                                    <button type="button" class="btn btn-sm btn-outline-light" 
                                            onclick="copiarCardParaPowerPoint('cardDistribuicaoSquad')"
                                            title="Copiar para PowerPoint">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-3">
                                    <!-- Azure -->
                                    <div class="col-md-3">
                                        <div class="card border-start border-primary border-4 shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">AZURE</h5>
                                                {# Usar a nova chave agregacoes_por_status_squad_especialista #}
                                                {% set azure_total = 0 %}
                                                {% if agregacoes_por_status_squad_especialista and 'AZURE' in agregacoes_por_status_squad_especialista %}
                                                    {% set azure_total = agregacoes_por_status_squad_especialista.get('AZURE', {}).get('NOVO', 0) + 
                                                               agregacoes_por_status_squad_especialista.get('AZURE', {}).get('EM ATENDIMENTO', 0) + 
                                                               agregacoes_por_status_squad_especialista.get('AZURE', {}).get('AGUARDANDO', 0) + 
                                                               agregacoes_por_status_squad_especialista.get('AZURE', {}).get('BLOQUEADO', 0) %}
                                                {% endif %}
                                                <h2 class="display-6 mb-3">{{ azure_total }}</h2>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <span class="badge bg-primary">Novo: {{ agregacoes_por_status_squad_especialista.get('AZURE', {}).get('NOVO', 0) }}</span>
                                                    <span class="badge bg-warning">Em andamento: {{ agregacoes_por_status_squad_especialista.get('AZURE', {}).get('EM ATENDIMENTO', 0) }}</span>
                                                    <span class="badge bg-info">Aguardando: {{ agregacoes_por_status_squad_especialista.get('AZURE', {}).get('AGUARDANDO', 0) }}</span>
                                                    <span class="badge bg-danger">Bloqueado: {{ agregacoes_por_status_squad_especialista.get('AZURE', {}).get('BLOQUEADO', 0) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- M365 -->
                                    <div class="col-md-3">
                                        <div class="card border-start border-danger border-4 shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">M365</h5>
                                                {# Usar a nova chave agregacoes_por_status_squad_especialista #}
                                                {% set m365_total = 0 %}
                                                {% if agregacoes_por_status_squad_especialista and 'M365' in agregacoes_por_status_squad_especialista %}
                                                    {% set m365_total = agregacoes_por_status_squad_especialista.get('M365', {}).get('NOVO', 0) + 
                                                               agregacoes_por_status_squad_especialista.get('M365', {}).get('EM ATENDIMENTO', 0) + 
                                                               agregacoes_por_status_squad_especialista.get('M365', {}).get('AGUARDANDO', 0) + 
                                                               agregacoes_por_status_squad_especialista.get('M365', {}).get('BLOQUEADO', 0) %}
                                                {% endif %}
                                                <h2 class="display-6 mb-3">{{ m365_total }}</h2>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <span class="badge bg-primary">Novo: {{ agregacoes_por_status_squad_especialista.get('M365', {}).get('NOVO', 0) }}</span>
                                                    <span class="badge bg-warning">Em andamento: {{ agregacoes_por_status_squad_especialista.get('M365', {}).get('EM ATENDIMENTO', 0) }}</span>
                                                    <span class="badge bg-info">Aguardando: {{ agregacoes_por_status_squad_especialista.get('M365', {}).get('AGUARDANDO', 0) }}</span>
                                                    <span class="badge bg-danger">Bloqueado: {{ agregacoes_por_status_squad_especialista.get('M365', {}).get('BLOQUEADO', 0) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Data&Power -->
                                    <div class="col-md-3">
                                        <div class="card border-start border-success border-4 shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">DATA&POWER</h5>
                                                {# Usar a nova chave agregacoes_por_status_squad_especialista #}
                                                {% set datapower_total = 0 %}
                                                {% if agregacoes_por_status_squad_especialista and 'DATA E POWER' in agregacoes_por_status_squad_especialista %}
                                                    {% set datapower_total = agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('NOVO', 0) + 
                                                           agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('EM ATENDIMENTO', 0) + 
                                                           agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('AGUARDANDO', 0) + 
                                                           agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('BLOQUEADO', 0) %}
                                                {% endif %}
                                                <h2 class="display-6 mb-3">{{ datapower_total }}</h2>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <span class="badge bg-primary">Novo: {{ agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('NOVO', 0) }}</span>
                                                    <span class="badge bg-warning">Em andamento: {{ agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('EM ATENDIMENTO', 0) }}</span>
                                                    <span class="badge bg-info">Aguardando: {{ agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('AGUARDANDO', 0) }}</span>
                                                    <span class="badge bg-danger">Bloqueado: {{ agregacoes_por_status_squad_especialista.get('DATA E POWER', {}).get('BLOQUEADO', 0) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CDB -->
                                    <div class="col-md-3">
                                        <div class="card border-start border-info border-4 shadow-sm">
                                            <div class="card-body">
                                                <h5 class="card-title">CDB</h5>
                                                {% set cdb_total = 0 %}
                                                {% if agregacoes_por_status_squad_especialista and 'CDB' in agregacoes_por_status_squad_especialista %}
                                                    {% set cdb_total = agregacoes_por_status_squad_especialista.get('CDB', {}).get('NOVO', 0) + 
                                                             agregacoes_por_status_squad_especialista.get('CDB', {}).get('EM ATENDIMENTO', 0) + 
                                                             agregacoes_por_status_squad_especialista.get('CDB', {}).get('AGUARDANDO', 0) + 
                                                             agregacoes_por_status_squad_especialista.get('CDB', {}).get('BLOQUEADO', 0) %}
                                                {% endif %}
                                                <h2 class="display-6 mb-3">{{ cdb_total }}</h2>
                                                <div class="d-flex flex-wrap gap-1">
                                                    <span class="badge bg-primary">Novo: {{ agregacoes_por_status_squad_especialista.get('CDB', {}).get('NOVO', 0) }}</span>
                                                    <span class="badge bg-warning">Em andamento: {{ agregacoes_por_status_squad_especialista.get('CDB', {}).get('EM ATENDIMENTO', 0) }}</span>
                                                    <span class="badge bg-info">Aguardando: {{ agregacoes_por_status_squad_especialista.get('CDB', {}).get('AGUARDANDO', 0) }}</span>
                                                    <span class="badge bg-danger">Bloqueado: {{ agregacoes_por_status_squad_especialista.get('CDB', {}).get('BLOQUEADO', 0) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid Principal de 4 cards -->
                <div class="row g-3 mb-4">
                    <!-- Projetos Entregues -->
                    <div class="col-lg-3">
                        <div class="card shadow h-100" id="cardProjetosEntregues">
                            <div class="card-header py-2 bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Projetos entregues</h6>
                                    <button type="button" class="btn btn-sm btn-outline-light" 
                                            onclick="copiarCardParaPowerPoint('cardProjetosEntregues')"
                                            title="Copiar para PowerPoint">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <!-- Entregues no mês -->
                                <div class="card mb-2 border-0">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Entregues no mês:</small>
                                            <span class="fs-4 fw-bold">{{ projetos_entregues.total_mes }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- No prazo -->
                                <div class="card mb-2 border-0 bg-success bg-opacity-10">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">No prazo:</small>
                                            <span class="fs-4 fw-bold">{{ projetos_entregues.no_prazo }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fora do prazo -->
                                <div class="card mb-3 border-0 bg-warning bg-opacity-10">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Fora do prazo:</small>
                                            <span class="fs-4 fw-bold">{{ projetos_entregues.fora_prazo }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Histórico de evolução -->
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-2">
                                        <small class="text-muted d-block mb-2">Histórico de evolução</small>
                                        <div class="table-responsive">
                                            <table class="table table-sm mb-0">
                                                <tbody>
                                                    {% if projetos_entregues and projetos_entregues.historico %}
                                                        {% for item in projetos_entregues.historico %}
                                                        <tr>
                                                            <td>{{ item.mes }}</td>
                                                            <td class="text-end">{{ item.quantidade }}</td>
                                                            {# Ajuste para tratar variacao_percentual como string '-' ou número #}
                                                            <td class="text-end 
                                                                {% if item.variacao_percentual is number and item.variacao_percentual > 0 %}text-success
                                                                {% elif item.variacao_percentual is number and item.variacao_percentual < 0 %}text-danger
                                                                {% else %}text-muted{% endif %}">
                                                                {# Exibe o valor percentual se for número, senão exibe '-' #}
                                                                {% if item.variacao_percentual is number %}{{ '%.1f'|format(item.variacao_percentual) }}%{% else %}-{% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    {% else %}
                                                        <tr>
                                                            <td colspan="3" class="text-center text-muted">Histórico indisponível</td>
                                                        </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Novos Projetos -->
                    <div class="col-lg-3">
                        <div class="card shadow h-100" id="cardNovosProjetos">
                            <div class="card-header py-2 bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Novos Projetos</h6>
                                    <button type="button" class="btn btn-sm btn-outline-light" 
                                            onclick="copiarCardParaPowerPoint('cardNovosProjetos')"
                                            title="Copiar para PowerPoint">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <!-- Azure -->
                                <div class="card mb-2 border-0">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Azure:</small>
                                            <div>
                                                <span class="fs-4 fw-bold">{{ novos_projetos_comparativo.por_squad.get('AZURE', {}).get('atual', 0) }}</span>
                                                {% set variacao = novos_projetos_comparativo.por_squad.get('AZURE', {}).get('variacao_abs', 0) %}
                                                <span class="ms-2 small {% if variacao > 0 %}text-success{% elif variacao < 0 %}text-danger{% else %}text-muted{% endif %}">
                                                    ({{ '%+d'|format(variacao) }})
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- M365 -->
                                <div class="card mb-2 border-0">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">M365:</small>
                                            <div>
                                                <span class="fs-4 fw-bold">{{ novos_projetos_comparativo.por_squad.get('M365', {}).get('atual', 0) }}</span>
                                                {% set variacao = novos_projetos_comparativo.por_squad.get('M365', {}).get('variacao_abs', 0) %}
                                                <span class="ms-2 small {% if variacao > 0 %}text-success{% elif variacao < 0 %}text-danger{% else %}text-muted{% endif %}">
                                                    ({{ '%+d'|format(variacao) }})
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Data&Power -->
                                <div class="card mb-2 border-0">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Data&Power:</small>
                                            <div>
                                                <span class="fs-4 fw-bold">{{ novos_projetos_comparativo.por_squad.get('DATA E POWER', {}).get('atual', 0) }}</span>
                                                {% set variacao = novos_projetos_comparativo.por_squad.get('DATA E POWER', {}).get('variacao_abs', 0) %}
                                                <span class="ms-2 small {% if variacao > 0 %}text-success{% elif variacao < 0 %}text-danger{% else %}text-muted{% endif %}">
                                                    ({{ '%+d'|format(variacao) }})
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Total -->
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Total:</small>
                                            <div>
                                                <span class="fs-4 fw-bold">{{ novos_projetos_comparativo.total.get('atual', 0) }}</span>
                                                {% set variacao_abs = novos_projetos_comparativo.total.get('variacao_abs', 0) %}
                                                <span class="ms-2 small {% if variacao_abs > 0 %}text-success{% elif variacao_abs < 0 %}text-danger{% else %}text-muted{% endif %}">
                                                    ({{ '%+d'|format(variacao_abs) }})
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Seção Destacada para Variação Percentual Total -->
                                <div class="text-center mt-4"> 
                                    {% set variacao_pct_total = novos_projetos_comparativo.total.get('variacao_pct', 0) %}
                                    <span class="fs-3 fw-bold {% if variacao_pct_total > 0 %}text-success{% elif variacao_pct_total < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {{ '%+.1f'|format(variacao_pct_total) }}%
                                    </span>
                                    <small class="text-muted d-block mt-1">Novos projetos em relação a {{ nome_mes_comparativo | default('mês anterior') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Outros indicadores -->
                    <div class="col-lg-3">
                        <div class="card shadow h-100" id="cardOutrosIndicadores">
                            <div class="card-header py-2 bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Outros indicadores</h6>
                                    <button type="button" class="btn btn-sm btn-outline-light" 
                                            onclick="copiarCardParaPowerPoint('cardOutrosIndicadores')"
                                            title="Copiar para PowerPoint">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3 d-flex flex-column justify-content-center">
                                <!-- Tempo médio de vida -->
                                <div class="text-center mb-4">
                                    <span class="fs-1 fw-bold d-block">{{ '%.1f'|format(tempo_medio_vida.media_dias | default(0.0)) }} dias</span>
                                    <small class="text-muted">Tempo médio de vida</small>
                                    {% if tempo_medio_vida_variacao_pct is defined %}
                                        <div class="mt-1">
                                            <span class="small {% if tempo_medio_vida_variacao_pct < 0 %}text-success{% elif tempo_medio_vida_variacao_pct > 0 %}text-danger{% else %}text-muted{% endif %}">
                                                ({{ '%+.1f'|format(tempo_medio_vida_variacao_pct) }}% com relação a {{ mes_comparativo_abrev | default('mês ant.') }})
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Diferença de projetos entregues -->
                                <div class="text-center">
                                    {% set variacao_ent = diferenca_entregues_abs | default(0) %}
                                    {# Busca a variação percentual correspondente #}
                                    {% set variacao_ent_pct = variacao_entregues_pct | default(0.0) %}
                                    
                                    {# Container para alinhar número e porcentagem #}
                                    <div class="d-flex align-items-baseline justify-content-center">
                                        <span class="fs-3 fw-bold {% if variacao_ent > 0 %}text-success{% elif variacao_ent < 0 %}text-danger{% else %}text-muted{% endif %}">
                                            {{ '%+d'|format(variacao_ent) }}
                                        </span>
                                        {# Adiciona a porcentagem ao lado, se não for zero, com fonte menor e espaço #}
                                        {% if variacao_ent != 0 %}
                                            <span class="ms-2 fs-6 fw-normal {% if variacao_ent > 0 %}text-success{% elif variacao_ent < 0 %}text-danger{% else %}text-muted{% endif %}">({{ '%+.1f'|format(variacao_ent_pct) }}%)</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">Projetos entregues com<br>relação a {{ nome_mes_comparativo | default('mês anterior') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Projetos ativos por tipo de faturamento -->
                    <div class="col-lg-3">
                        <div class="card shadow h-100" id="cardTiposFaturamento">
                            <div class="card-header py-2 bg-primary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Projetos ativos por tipo de faturamento</h6>
                                    <button type="button" class="btn btn-sm btn-outline-light" 
                                            onclick="copiarCardParaPowerPoint('cardTiposFaturamento')"
                                            title="Copiar para PowerPoint">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                {# --- ALTERAÇÃO: Usar loop e dados comparativos --- #}
                                {% set tipos_ordem = ['INICIO', 'TERMINO', 'PLUS', 'PRIME', 'ENGAJAMENTO', 'FEOP'] %}
                                
                                {% for tipo in tipos_ordem %}
                                    {% set comp_tipo = faturamento_comparativo.get(tipo) %}
                                    {# Exibe apenas se houver dados para este tipo no mês atual ou anterior #}
                                    {% if comp_tipo and (comp_tipo.atual > 0 or comp_tipo.anterior > 0) %}
                                        <div class="card mb-2 border-0">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        {# Mapeia código para nome mais legível #}
                                                        {% if tipo == 'INICIO' %}Faturado no início:
                                                        {% elif tipo == 'TERMINO' %}Faturar no final:
                                                        {% elif tipo == 'PLUS' %}PLUS:
                                                        {% elif tipo == 'PRIME' %}PRIME:
                                                        {% elif tipo == 'ENGAJAMENTO' %}ENGAJAMENTO:
                                                        {% elif tipo == 'FEOP' %}Fat. Outro Proj.:
                                                        {% else %}{{ tipo }}:
                                                        {% endif %}
                                                    </small>
                                                    <div>
                                                        <span class="fs-5 fw-bold">{{ comp_tipo.atual }}</span>
                                                        {% set variacao = comp_tipo.variacao_abs %}
                                                        {# Exibe variação apenas se não for zero #}
                                                        {% if variacao != 0 %}
                                                        <span class="ms-1 small {% if variacao > 0 %}text-success{% elif variacao < 0 %}text-danger{% endif %}">
                                                            ({{ '%+d'|format(variacao) }})
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                {# --- FIM ALTERAÇÃO --- #}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === NOVOS CARDS DO STATUS REPORT === -->
                <!-- Card: Projetos Principais do Mês (linha inteira) -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow h-100" id="cardProjetosPrincipais">
                            <div class="card-header py-2 bg-secondary text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">
                                            <i class="bi bi-star me-2"></i>Principais Projetos do Mês
                                        </h6>
                                        <small class="text-white-50" style="visibility: hidden;">espaço reservado</small>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-light" 
                                                onclick="copiarCardParaPowerPoint('cardProjetosPrincipais')"
                                                title="Copiar para PowerPoint">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-light" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#modalProjetosPrincipais"
                                                title="Configurar projetos principais">
                                            <i class="bi bi-gear"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <!-- Debug: mostrar informações dos projetos principais -->
                                <script>
                                    console.log('🎯 TEMPLATE: Dados projetos_principais:', {{ projetos_principais | tojson | safe }});
                                    console.log('🎯 TEMPLATE: Total projetos:', {{ projetos_principais.projetos|length if projetos_principais.projetos else 0 }});
                                    console.log('🎯 TEMPLATE: URL atual:', window.location.href);
                                    console.log('🎯 TEMPLATE: Parâmetros URL:', new URLSearchParams(window.location.search).toString());
                                </script>
                                
                                {% if projetos_principais.projetos and projetos_principais.projetos|length > 0 %}
                                    {% for projeto in projetos_principais.projetos %}
                                    <div class="card mb-3 border-0 {% if loop.first %}bg-primary bg-opacity-10{% elif loop.index == 2 %}bg-success bg-opacity-10{% else %}bg-warning bg-opacity-10{% endif %}">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1">
                                                        <span class="badge {% if loop.first %}bg-primary{% elif loop.index == 2 %}bg-success{% else %}bg-warning{% endif %} me-2">
                                                            #{{ loop.index }}
                                                        </span>
                                                        {{ projeto.nome_cliente }}
                                                    </h6>
                                                    <p class="card-text small text-muted mb-2">{{ projeto.nome_projeto }}</p>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-secondary">{{ projeto.squad | default('N/A') }}</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Horas trabalhadas no mês -->
                                            <div class="text-left">
                                                <small class="text-muted">
                                                    <strong>{{ projeto.horas_trabalhadas_mes }}h</strong> trabalhadas no mês
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div id="cardProjetosVazio" class="text-center text-muted py-4">
                                        <i class="bi bi-info-circle fs-4 d-block mb-2"></i>
                                        <p class="mb-0">Carregando projetos principais...</p>
                                        <small>Aguarde...</small>
                                    </div>
                                    
                                    <!-- Container para projetos carregados dinamicamente -->
                                    <div id="projetosPrincipaisDinamicos" style="display: none;"></div>
                                {% endif %}
                                

                            </div>
                        </div>
                    </div>

                </div>

                <!-- Card: Projetos Previstos para Encerramento (linha inteira) -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow h-100" id="cardProjetosPrevistos">
                            <div class="card-header py-2 bg-info text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                                                <h6 class="mb-0" id="headerPrevistosTitle">
                            <i class="bi bi-calendar-check me-2"></i>Previstos para <span id="mesPrevisto">Próximo Mês</span>
                        </h6>
                        <small class="text-white-50" id="headerPrevistosSubtitle">Carregando informações...</small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-light" 
                                            onclick="copiarCardParaPowerPoint('cardProjetosPrevistos')"
                                            title="Copiar para PowerPoint">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <!-- Carregamento dinâmico FORÇADO -->
                                <div id="projetosPrevistosDinamicos">
                                    <div class="card mb-3 border-0 bg-info bg-opacity-10">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">Total de projetos:</small>
                                                <span class="fs-5 fw-bold text-info" id="totalPrevistos">Carregando...</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="listaProjetosPrevistos">
                                        <div class="text-center text-muted py-4">
                                            <i class="bi bi-hourglass-split fs-4 d-block mb-2"></i>
                                            <p class="mb-0">Carregando projetos previstos...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- === FIM NOVOS CARDS === -->
                
                {% endif %}
            </div>
        </div>
        
        <!-- Scripts específicos da página -->
        <script>
            // Função de utilidade para formatar números
            function formatNumber(num) {
                return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            }
            
            // Executado quando o DOM estiver carregado
            document.addEventListener('DOMContentLoaded', function() {
                // Obtém o mês e ano da URL atual
                function obterParametrosURL() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const mes = urlParams.get('mes');
                    const ano = urlParams.get('ano');
                    
                    // Se não houver parâmetros, usa os valores do template
                    if (!mes || !ano) {
                        // Extrai mês e ano do texto de mes_referencia (formato: "MM/YYYY")
                        const mesRefStr = "{{ mes_referencia }}";
                        if (mesRefStr && mesRefStr.includes('/')) {
                            const partes = mesRefStr.split('/');
                            return {
                                mes: parseInt(partes[0], 10),
                                ano: parseInt(partes[1], 10)
                            };
                        }
                        return { mes: null, ano: null };
                    }
                    
                    return {
                        mes: parseInt(mes, 10),
                        ano: parseInt(ano, 10)
                    };
                }
                
                // Carrega os dados para cada squad usando o mês e ano corretos
                const params = obterParametrosURL();
                console.log("Parâmetros de data:", params);
                
                // Se temos mês e ano, carregamos com esses parâmetros, caso contrário usamos os dados já renderizados
                if (params.mes && params.ano) {
                    carregarDadosSquad('AZURE', params.mes, params.ano);
                    carregarDadosSquad('M365', params.mes, params.ano);
                    carregarDadosSquad('DATA E POWER', params.mes, params.ano);
                    carregarDadosSquad('CDB', params.mes, params.ano);
                    console.log(`Carregando dados de squads para ${params.mes}/${params.ano}`);
                } else {
                    console.log("Usando dados pre-renderizados dos squads (sem parâmetros de data na URL)");
                }
            });
            
            // Função para carregar dados de squad (mantida para evitar erros de JavaScript)
            function carregarDadosSquad(squad, mes, ano) {
                // Construir a URL com os parâmetros
                var url = "/macro/api/projetos-squad-status-mes?squad=" + encodeURIComponent(squad) + "&mes=" + mes + "&ano=" + ano;
                console.log("Tentando carregar dados para " + squad + " (" + mes + "/" + ano + ") da URL: " + url);
                
                fetch(url)
                    .then(function(response) {
                        console.log("Resposta recebida para " + squad + " com status: " + response.status);
                        if (!response.ok) {
                            throw new Error("Erro ao carregar dados: " + response.status);
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        console.log("Dados recebidos para " + squad + ":", data);
                        atualizarCardsSquad(squad, data);
                    })
                    .catch(function(error) {
                        console.error("Erro ao carregar dados para " + squad + ":", error);
                    });
            }
            
            // Função para atualizar cards de squad (mantida para evitar erros de JavaScript)
            function atualizarCardsSquad(squad, data) {
                console.log("Atualizando cards para squad " + squad + " com dados:", data);
                
                // Mapeamento de status retornados pela API para os IDs no HTML
                var statusMapApi = {
                    "NOVO": "novo",
                    "EM ATENDIMENTO": "em-andamento",
                    "AGUARDANDO": "aguardando",
                    "BLOQUEADO": "bloqueado",
                    "FECHADO": "concluido"
                };
                
                // Método alternativo de atualização direta em todos os elementos com data-squad
                var squadElements = document.querySelectorAll("[data-squad='" + squad + "']");
                console.log("Total de elementos para squad " + squad + ": " + squadElements.length);
                
                // Para cada elemento com data-squad, verificar status e atualizar
                squadElements.forEach(function(element) {
                    var status = element.getAttribute("data-status");
                    console.log("Processando elemento:", squad, status);
                    
                    var valueElement = element.querySelector(".fs-5");
                    if (!valueElement) {
                        console.warn("Não encontrou .fs-5 em:", element);
                        return;
                    }
                    
                    if (status === "total") {
                        valueElement.textContent = data.total || 0;
                        console.log("  -> Atualizado total:", data.total);
                    } else {
                        // Encontra o status na API correspondente ao status HTML
                        var apiStatus = null;
                        for (var key in statusMapApi) {
                            if (statusMapApi[key] === status) {
                                apiStatus = key;
                                break;
                            }
                        }
                        
                        if (apiStatus) {
                            var valor = 0;
                            // Procura valor deste status nos dados da API
                            for (var apiStatusKey in data.por_status) {
                                if (apiStatusKey.toUpperCase() === apiStatus) {
                                    valor = data.por_status[apiStatusKey];
                                    break;
                                }
                            }
                            valueElement.textContent = valor;
                            console.log("  -> Atualizado " + status + " (" + apiStatus + "):", valor);
                        }
                    }
                });
            }

            // Gráfico de Status
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Novo', 'Em andamento', 'Aguardando', 'Bloqueado'],
                    datasets: [{
                        data: [
                            {{ agregacoes_por_status.get('NOVO', {}).get('quantidade', 0) }},
                            {{ agregacoes_por_status.get('EM ATENDIMENTO', {}).get('quantidade', 0) }},
                            {{ agregacoes_por_status.get('AGUARDANDO', {}).get('quantidade', 0) }},
                            {{ agregacoes_por_status.get('BLOQUEADO', {}).get('quantidade', 0) }}
                        ],
                        backgroundColor: [
                            'rgba(13, 110, 253, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(13, 202, 240, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(13, 110, 253, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(13, 202, 240, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gráfico de Squads
            const squadCtx = document.getElementById('squadChart').getContext('2d');
            new Chart(squadCtx, {
                type: 'bar',
                data: {
                    labels: ['Azure', 'M365', 'Data&Power', 'CDB'],
                    datasets: [{
                        label: 'Total de Projetos Ativos',
                        data: {{ squad_chart_data | tojson | safe }},
                        backgroundColor: [
                            'rgba(0, 120, 212, 0.8)',
                            'rgba(216, 59, 1, 0.8)',
                            'rgba(16, 124, 16, 0.8)',
                            'rgba(92, 45, 145, 0.8)'
                        ],
                        borderColor: [
                            'rgba(0, 120, 212, 1)',
                            'rgba(216, 59, 1, 1)',
                            'rgba(16, 124, 16, 1)',
                            'rgba(92, 45, 145, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Gráfico de Tendência (Total Ativos Atual vs Anterior)
            const tendenciaCtx = document.getElementById('tendenciaChart').getContext('2d');
            new Chart(tendenciaCtx, {
                type: 'line',
                data: {
                    labels: ['{{ nome_mes_comparativo | default("Mês Anterior") }}', '{{ nome_mes_referencia }}'], 
                    datasets: [{
                        label: 'Total de Projetos Ativos',
                        data: {{ tendencia_chart_data | tojson | safe }},
                        borderColor: 'rgba(13, 110, 253, 1)',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        </script>
    </div>

    <!-- Modal: Configurar Projetos Principais -->
    <div class="modal fade" id="modalProjetosPrincipais" tabindex="-1" aria-labelledby="modalProjetosPrincipaisLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProjetosPrincipaisLabel">
                        <i class="bi bi-star me-2"></i>Configurar Principais Projetos do Mês
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted mb-2">
                                <i class="bi bi-info-circle me-2"></i>
                                Selecione até 5 principais projetos do mês
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecoes()">
                                <i class="bi bi-x-circle me-1"></i>Limpar Seleções
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarAutomatico()">
                                <i class="bi bi-lightning me-1"></i>Auto (Por Horas)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" 
                                   id="filtroProjetoPrincipal" 
                                   placeholder="🔍 Filtrar projetos..."
                                   onkeyup="filtrarProjetosPrincipais()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtroSquadPrincipal" onchange="filtrarProjetosPrincipais()">
                                <option value="">Todos os Squads</option>
                                <option value="AZURE">AZURE</option>
                                <option value="M365">M365</option>
                                <option value="DATA E POWER">DATA E POWER</option>
                                <option value="CDB">CDB</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="filtroClientePrincipal" onchange="filtrarProjetosPrincipais()">
                                <option value="">Todos os Clientes</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de Projetos -->
                    <div class="border rounded p-2" style="max-height: 400px; overflow-y: auto;">
                        <div id="listaProjetosPrincipais">
                            <div class="text-center py-4" id="loadingState">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                                <p class="text-muted mt-2 mb-1">Carregando projetos...</p>
                                <small class="text-muted">Otimizando dados para melhor performance</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contador de Seleções -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <span id="contadorSelecoes">0</span> de 5 projetos selecionados
                            </small>
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>Total: <span id="totalHorasSelecao">0</span>h
                            </small>
                        </div>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar" id="progressoSelecao" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="salvarProjetosPrincipais()">
                        <i class="bi bi-check-lg me-1"></i>Salvar Configuração
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script: Gerenciamento de Projetos Principais -->
    <script>
        let projetosDisponiveis = [];
        let projetosSelecionados = [];
        const maxSelecoes = 5;
        let cacheProjetosMes = {}; // Cache por mês para performance

        // Carrega projetos quando o modal é aberto
        document.getElementById('modalProjetosPrincipais').addEventListener('show.bs.modal', function() {
            carregarProjetosDisponiveis();
        });

        async function carregarProjetosDisponiveis() {
            try {
                // Mostrar loading otimizado
                const loadingElement = document.getElementById('loadingState');
                if (loadingElement) {
                    loadingElement.querySelector('p').textContent = 'Carregando projetos...';
                    loadingElement.querySelector('small').textContent = 'Aplicando filtros otimizados';
                }
                
                // Detectar mês de referência da URL atual
                const urlParams = new URLSearchParams(window.location.search);
                const mes = urlParams.get('mes');
                const ano = urlParams.get('ano');
                
                // Identificar chave do cache
                const chaveCache = mes && ano ? `${ano}-${mes}` : 'atual';
                
                // Verificar cache primeiro
                if (cacheProjetosMes[chaveCache]) {
                    console.log('📦 Usando dados do cache para melhor performance');
                    const dataCacheada = cacheProjetosMes[chaveCache];
                    projetosDisponiveis = dataCacheada.projetos || [];
                    projetosSelecionados = dataCacheada.selecionados || [];
                    
                    renderizarListaProjetos();
                    popularFiltroClientes();
                    atualizarContadores();
                    return;
                }
                
                let apiUrl = '/macro/api/projetos-disponiveis';
                if (mes && ano) {
                    // Visão histórica - usar parâmetros da URL
                    apiUrl += `?mes_ano=${ano}-${mes.padStart(2, '0')}`;
                    if (loadingElement) {
                        loadingElement.querySelector('small').textContent = `Carregando dados de ${mes}/${ano}`;
                    }
                } else {
                    if (loadingElement) {
                        loadingElement.querySelector('small').textContent = 'Carregando dados da visão atual';
                    }
                }
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    console.log(`📦 Dados recebidos da API:`, {
                        projetos: data.projetos?.length || 0,
                        selecionados: data.selecionados || [],
                        total: data.total,
                        mes_referencia: data.mes_referencia
                    });
                    
                    // Armazenar no cache
                    cacheProjetosMes[chaveCache] = data;
                    
                    projetosDisponiveis = data.projetos || [];
                    projetosSelecionados = data.selecionados || [];
                    
                    console.log(`✅ Arrays atualizados:`, {
                        disponiveis: projetosDisponiveis.length,
                        selecionados: [...projetosSelecionados]
                    });
                    
                    console.log(`✅ Carregados ${projetosDisponiveis.length} projetos para ${chaveCache}`);
                    
                    renderizarListaProjetos();
                    popularFiltroClientes();
                    atualizarContadores();
                } else {
                    const errorText = await response.text();
                    console.error(`❌ Erro HTTP ${response.status}:`, errorText);
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('❌ Erro ao carregar projetos:', error);
                document.getElementById('listaProjetosPrincipais').innerHTML = 
                    '<div class="text-center py-4 text-danger">' +
                    '<i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>' +
                    '<p class="mb-1">Erro ao carregar projetos</p>' +
                    '<small class="text-muted">Verifique sua conexão e tente novamente</small>' +
                    '</div>';
            }
        }

        function renderizarListaProjetos() {
            const container = document.getElementById('listaProjetosPrincipais');
            
            if (projetosDisponiveis.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-muted"><i class="bi bi-inbox"></i> Nenhum projeto encontrado</div>';
                return;
            }

            // Mostrar indicador de performance
            console.log(`🎨 Renderizando ${projetosDisponiveis.length} projetos otimizados`);
            
            // Renderização otimizada usando DocumentFragment
            const fragment = document.createDocumentFragment();
            
            projetosDisponiveis.forEach(projeto => {
                // Garantir conversão correta para string para comparação
                const numeroProjetoStr = String(projeto.numero);
                const isSelected = projetosSelecionados.some(sel => String(sel) === numeroProjetoStr);
                const cliente = projeto.cliente || 'N/A';
                const squad = projeto.squad || 'N/A';
                const horas = projeto.horas_mes || 0;
                
                // Debug log para troubleshooting
                if (projetosSelecionados.length > 0) {
                    console.log(`🔍 Projeto ${numeroProjetoStr}: Selecionado = ${isSelected}`, {
                        numero: numeroProjetoStr,
                        selecionados: projetosSelecionados,
                        includes: projetosSelecionados.includes(numeroProjetoStr)
                    });
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'projeto-item border-bottom py-2';
                itemDiv.setAttribute('data-numero', projeto.numero);
                itemDiv.setAttribute('data-cliente', cliente);
                itemDiv.setAttribute('data-squad', squad);
                
                // Cores das badges dos squads
                const squadColors = {
                    'AZURE': 'bg-primary',
                    'M365': 'bg-success', 
                    'DATA E POWER': 'bg-warning text-dark',
                    'CDB': 'bg-info'
                };
                const squadColor = squadColors[squad] || 'bg-secondary';
                
                itemDiv.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="projeto_${projeto.numero}" 
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleProjetoSelecao('${projeto.numero}', ${horas})">
                        <label class="form-check-label w-100" for="projeto_${projeto.numero}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${cliente}</div>
                                    <div class="text-muted small">${projeto.nome}</div>
                                    <div class="small">
                                        <span class="badge ${squadColor}">${squad}</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-primary">${horas}h</div>
                                    <div class="text-muted small">no mês</div>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                
                fragment.appendChild(itemDiv);
            });
            
            // Renderização única (otimizada)
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function popularFiltroClientes() {
            const selectCliente = document.getElementById('filtroClientePrincipal');
            const clientes = [...new Set(projetosDisponiveis.map(p => p.cliente).filter(c => c && c !== 'N/A'))];
            
            selectCliente.innerHTML = '<option value="">Todos os Clientes</option>';
            clientes.sort().forEach(cliente => {
                selectCliente.innerHTML += `<option value="${cliente}">${cliente}</option>`;
            });
        }

        function toggleProjetoSelecao(numeroProjeto, horas) {
            const checkbox = document.getElementById(`projeto_${numeroProjeto}`);
            const numeroProjetoStr = String(numeroProjeto);
            
            console.log(`🎯 Toggle projeto ${numeroProjetoStr}:`, {
                checked: checkbox.checked,
                selecionadosAntes: [...projetosSelecionados]
            });
            
            if (checkbox.checked) {
                if (projetosSelecionados.length >= maxSelecoes) {
                    checkbox.checked = false;
                    alert(`Você pode selecionar no máximo ${maxSelecoes} projetos.`);
                    return;
                }
                
                // Verificar se já não está selecionado
                if (!projetosSelecionados.some(sel => String(sel) === numeroProjetoStr)) {
                    projetosSelecionados.push(numeroProjetoStr);
                    console.log(`✅ Projeto ${numeroProjetoStr} adicionado`);
                }
            } else {
                projetosSelecionados = projetosSelecionados.filter(sel => String(sel) !== numeroProjetoStr);
                console.log(`❌ Projeto ${numeroProjetoStr} removido`);
            }
            
            console.log(`📊 Selecionados agora:`, [...projetosSelecionados]);
            atualizarContadores();
        }

        function atualizarContadores() {
            const total = projetosSelecionados.length;
            const totalHoras = projetosSelecionados.reduce((sum, numSel) => {
                const projeto = projetosDisponiveis.find(p => String(p.numero) === String(numSel));
                const horas = projeto?.horas_mes || 0;
                console.log(`💰 Projeto ${numSel}: ${horas}h`, projeto ? 'encontrado' : 'NÃO encontrado');
                return sum + horas;
            }, 0);
            
            console.log(`📊 Atualizando contadores:`, {
                total: total,
                totalHoras: totalHoras,
                selecionados: [...projetosSelecionados]
            });
            
            document.getElementById('contadorSelecoes').textContent = total;
            document.getElementById('totalHorasSelecao').textContent = totalHoras.toFixed(1);
            
            const progresso = (total / maxSelecoes) * 100;
            const progressBar = document.getElementById('progressoSelecao');
            progressBar.style.width = `${progresso}%`;
            progressBar.className = `progress-bar ${progresso === 100 ? 'bg-success' : progresso > 80 ? 'bg-warning' : 'bg-info'}`;
        }

        function filtrarProjetosPrincipais() {
            const filtroTexto = document.getElementById('filtroProjetoPrincipal').value.toLowerCase();
            const filtroSquad = document.getElementById('filtroSquadPrincipal').value;
            const filtroCliente = document.getElementById('filtroClientePrincipal').value;
            
            document.querySelectorAll('.projeto-item').forEach(item => {
                const numero = item.dataset.numero;
                const projeto = projetosDisponiveis.find(p => p.numero === numero);
                
                if (!projeto) return;
                
                const textoMatch = !filtroTexto || 
                    projeto.nome.toLowerCase().includes(filtroTexto) ||
                    projeto.cliente.toLowerCase().includes(filtroTexto);
                    
                const squadMatch = !filtroSquad || projeto.squad === filtroSquad;
                const clienteMatch = !filtroCliente || projeto.cliente === filtroCliente;
                
                item.style.display = textoMatch && squadMatch && clienteMatch ? 'block' : 'none';
            });
        }

        function limparSelecoes() {
            projetosSelecionados = [];
            document.querySelectorAll('.form-check-input[type="checkbox"]').forEach(cb => cb.checked = false);
            atualizarContadores();
        }

        function selecionarAutomatico() {
            limparSelecoes();
            
            // Seleciona os 5 projetos com mais horas
            const projetosOrdenados = [...projetosDisponiveis]
                .sort((a, b) => (b.horas_mes || 0) - (a.horas_mes || 0))
                .slice(0, maxSelecoes);
            
            projetosOrdenados.forEach(projeto => {
                const checkbox = document.getElementById(`projeto_${projeto.numero}`);
                if (checkbox) {
                    checkbox.checked = true;
                    projetosSelecionados.push(projeto.numero);
                }
            });
            
            atualizarContadores();
        }

        async function salvarProjetosPrincipais() {
            try {
                // Validar se há projetos selecionados
                if (projetosSelecionados.length === 0) {
                    alert('Selecione pelo menos um projeto antes de salvar.');
                    return;
                }
                
                console.log(`💾 Salvando ${projetosSelecionados.length} projetos:`, [...projetosSelecionados]);
                
                // Detectar mês de referência da URL atual
                const urlParams = new URLSearchParams(window.location.search);
                const mes = urlParams.get('mes');
                const ano = urlParams.get('ano');
                
                let apiUrl = '/macro/api/salvar-projetos-principais';
                if (mes && ano) {
                    // Visão histórica - usar parâmetros da URL
                    apiUrl += `?mes_ano=${ano}-${mes.padStart(2, '0')}`;
                    console.log(`📅 Salvando para visão histórica: ${mes}/${ano}`);
                } else {
                    console.log(`📅 Salvando para visão atual`);
                }
                
                const payloadData = {
                    projetos_selecionados: projetosSelecionados
                };
                
                console.log(`🚀 Enviando dados para ${apiUrl}:`, payloadData);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payloadData)
                });
                
                console.log(`📡 Response status: ${response.status}`);
                
                if (response.ok) {
                    const responseData = await response.json();
                    console.log(`✅ Resposta do servidor:`, responseData);
                    
                    // Mostrar mensagem de sucesso
                    alert(`✅ ${projetosSelecionados.length} projetos principais configurados com sucesso!`);
                    
                    // Limpar cache para forçar recarregamento
                    cacheProjetosMes = {};
                    
                    // Fecha o modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalProjetosPrincipais'));
                    modal.hide();
                    
                    // Atualizar card dinamicamente ao invés de recarregar página
                    console.log(`🔄 Atualizando card dinamicamente...`);
                    setTimeout(() => carregarProjetosPrincipaisDinamico(true), 300);
                } else {
                    const errorData = await response.text();
                    console.error(`❌ Erro HTTP ${response.status}:`, errorData);
                    throw new Error(`Erro ${response.status}: ${errorData}`);
                }
            } catch (error) {
                console.error('❌ FUNÇÃO SALVAR: Erro capturado:', error);
                console.error('❌ FUNÇÃO SALVAR: Stack trace:', error.stack);
                console.error('❌ FUNÇÃO SALVAR: Message:', error.message);
                alert(`Erro ao salvar configuração: ${error.message}\nVerifique o console para mais detalhes.`);
            }
        }
    </script>

    <!-- Script: Carregamento Dinâmico de Projetos Principais -->
    <script>
        // Função para carregar projetos principais se o card estiver vazio
        async function carregarProjetosPrincipaisDinamico(forceUpdate = false) {
            try {
                console.log('🔄 DINÂMICO: Verificando se card precisa ser carregado...');
                
                const cardVazio = document.getElementById('cardProjetosVazio');
                const containerDinamico = document.getElementById('projetosPrincipaisDinamicos');
                
                if (!cardVazio && !forceUpdate) {
                    console.log('✅ DINÂMICO: Card já tem projetos, não precisa carregar');
                    return;
                }
                
                if (forceUpdate && containerDinamico) {
                    console.log('🔄 DINÂMICO: Forçando atualização do card...');
                    // Resetar para estado vazio temporariamente
                    containerDinamico.style.display = 'none';
                    if (cardVazio) {
                        cardVazio.style.display = 'block';
                        cardVazio.querySelector('p').textContent = 'Atualizando projetos principais...';
                    }
                }
                
                console.log('🚀 DINÂMICO: Card vazio detectado, carregando projetos...');
                
                // Detectar mês de referência da URL atual
                const urlParams = new URLSearchParams(window.location.search);
                const mes = urlParams.get('mes');
                const ano = urlParams.get('ano');
                
                let apiUrl = '/macro/api/projetos-disponiveis';
                if (mes && ano) {
                    apiUrl += `?mes_ano=${ano}-${mes.padStart(2, '0')}`;
                }
                
                console.log(`🔄 DINÂMICO: Carregando de ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`📦 DINÂMICO: Dados recebidos:`, data);
                
                if (data.selecionados && data.selecionados.length > 0) {
                    console.log(`✅ DINÂMICO: ${data.selecionados.length} projetos selecionados encontrados`);
                    
                    // Filtrar projetos selecionados dos disponíveis
                    const projetosSelecionados = data.projetos.filter(p => 
                        data.selecionados.includes(String(p.numero))
                    );
                    
                    console.log(`🎯 DINÂMICO: ${projetosSelecionados.length} projetos filtrados para exibição`);
                    
                    if (projetosSelecionados.length > 0) {
                        renderizarProjetosPrincipais(projetosSelecionados);
                    } else {
                        mostrarMensagem('Projetos selecionados não encontrados nos dados');
                    }
                } else {
                    console.log('📋 DINÂMICO: Nenhum projeto selecionado, usando automático');
                    mostrarMensagem('Nenhum projeto configurado manualmente');
                }
                
            } catch (error) {
                console.error('❌ DINÂMICO: Erro ao carregar:', error);
                mostrarMensagem('Erro ao carregar projetos principais');
            }
        }
        
        function renderizarProjetosPrincipais(projetos) {
            console.log(`🎨 DINÂMICO: Renderizando ${projetos.length} projetos`);
            
            const container = document.getElementById('projetosPrincipaisDinamicos');
            const cardVazio = document.getElementById('cardProjetosVazio');
            
            let html = '';
            
            projetos.forEach((projeto, index) => {
                const bgClass = index === 0 ? 'bg-primary bg-opacity-10' : 
                               index === 1 ? 'bg-success bg-opacity-10' : 'bg-warning bg-opacity-10';
                const badgeClass = index === 0 ? 'bg-primary' : 
                                  index === 1 ? 'bg-success' : 'bg-warning';
                
                html += `
                    <div class="card mb-3 border-0 ${bgClass}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">
                                        <span class="badge ${badgeClass} me-2">#${index + 1}</span>
                                        ${projeto.cliente || 'N/A'}
                                    </h6>
                                    <p class="card-text small text-muted mb-2">${projeto.nome}</p>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-secondary">${projeto.squad || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <div class="text-left">
                                <small class="text-muted">
                                    <strong>${projeto.horas_mes || 0}h</strong> trabalhadas no mês
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
                         container.innerHTML = html;
             container.style.display = 'block';
             cardVazio.style.display = 'none';
             
             console.log('✅ DINÂMICO: Projetos renderizados com sucesso');
        }
        
                 function mostrarMensagem(mensagem) {
             const cardVazio = document.getElementById('cardProjetosVazio');
             
             if (cardVazio) {
                 cardVazio.querySelector('p').textContent = mensagem;
                 cardVazio.querySelector('small').textContent = 'Configure projetos principais usando o botão ⚙️';
             }
         }
        


        // 🎯 FUNÇÃO PARA CARREGAR PROJETOS PREVISTOS VIA API
        function carregarProjetosPrevistosDinamico() {
            console.log('🚀 Carregando projetos previstos via API...');
            
            // 🔧 CORRIGIDO: Obtém parâmetros da URL atual com fallback para data atual
            const urlParams = new URLSearchParams(window.location.search);
            const dataAtual = new Date();
            const mes = urlParams.get('mes') || dataAtual.getMonth() + 1; // +1 porque getMonth() retorna 0-11
            const ano = urlParams.get('ano') || dataAtual.getFullYear();
            
            console.log(`🔍 DEBUG: URL mes=${urlParams.get('mes')}, ano=${urlParams.get('ano')}`);
            console.log(`🔍 DEBUG: Usando mes=${mes}, ano=${ano} (atual: ${dataAtual.getMonth() + 1}/${dataAtual.getFullYear()})`);
            
            fetch(`/macro/debug/projetos-previstos?mes=${mes}&ano=${ano}`)
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Dados recebidos:', data);
                    
                    if (data.success && data.total_encontrados > 0) {
                        // 🎯 NOVO: Atualiza cabeçalho com informações corretas
                        const mesPrevisto = document.getElementById('mesPrevisto');
                        const subtitulo = document.getElementById('headerPrevistosSubtitle');
                        
                        mesPrevisto.textContent = data.mes_previsto;
                        
                        if (data.eh_visao_atual) {
                            subtitulo.textContent = `Dados atuais - Arquivo: ${data.arquivo_usado}`;
                        } else {
                            subtitulo.textContent = `Salto temporal - Arquivo: ${data.arquivo_usado}`;
                        }
                        
                        // Atualiza total e contagem por squad
                        const totalElement = document.getElementById('totalPrevistos');
                        
                        // Cria texto com contagem por squad na mesma linha
                        let textoCompleto = data.total_encontrados.toString();
                        if (data.squads_ordenados && data.squads_ordenados.length > 0) {
                            const squadTextos = data.squads_ordenados.map(([squad, qtd]) => `${squad}:${qtd}`);
                            textoCompleto = `${squadTextos.join(' | ')} (Total: ${data.total_encontrados})`;
                        }
                        
                        totalElement.textContent = textoCompleto;
                        
                        // Gera lista de projetos em duas colunas
                        const totalProjetos = data.projetos.length;
                        const metade = Math.ceil(totalProjetos / 2);
                        const coluna1 = data.projetos.slice(0, metade);
                        const coluna2 = data.projetos.slice(metade);
                        
                        let html = '<div class="row">';
                        
                        // Coluna 1
                        html += '<div class="col-md-6">';
                        coluna1.forEach(projeto => {
                            html += `
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                    <div class="flex-grow-1">
                                        <div class="fw-medium small">${projeto.cliente} - ${projeto.projeto}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-primary">${projeto.squad}</span>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        
                        // Coluna 2
                        html += '<div class="col-md-6">';
                        coluna2.forEach(projeto => {
                            html += `
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                    <div class="flex-grow-1">
                                        <div class="fw-medium small">${projeto.cliente} - ${projeto.projeto}</div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-primary">${projeto.squad}</span>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        
                        html += '</div>';
                        
                        // Atualiza lista
                        document.getElementById('listaProjetosPrevistos').innerHTML = html;
                        console.log('✅ Projetos previstos carregados com sucesso!');
                    } else {
                        // 🎯 NOVO: Atualiza cabeçalho mesmo quando não há projetos
                        const mesPrevisto = document.getElementById('mesPrevisto');
                        const subtitulo = document.getElementById('headerPrevistosSubtitle');
                        
                        if (data.mes_previsto) {
                            mesPrevisto.textContent = data.mes_previsto;
                        }
                        
                        if (data.eh_visao_atual !== undefined) {
                            if (data.eh_visao_atual) {
                                subtitulo.textContent = `Dados atuais - Arquivo: ${data.arquivo_usado || 'dadosr.csv'}`;
                            } else {
                                subtitulo.textContent = `Salto temporal - Arquivo: ${data.arquivo_usado || 'histórico'}`;
                            }
                        }
                        
                        document.getElementById('totalPrevistos').textContent = '0';
                        document.getElementById('listaProjetosPrevistos').innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-calendar-x fs-4 d-block mb-2"></i>
                                <p class="mb-0">Nenhum projeto previsto para ${data.mes_previsto || 'o próximo mês'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao carregar projetos previstos:', error);
                    
                    // 🎯 NOVO: Atualiza cabeçalho mesmo em caso de erro
                    const subtitulo = document.getElementById('headerPrevistosSubtitle');
                    subtitulo.textContent = 'Erro ao carregar dados';
                    
                    document.getElementById('totalPrevistos').textContent = 'Erro';
                    document.getElementById('listaProjetosPrevistos').innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-exclamation-triangle fs-4 d-block mb-2"></i>
                            <p class="mb-0">Erro ao carregar projetos</p>
                        </div>
                    `;
                });
        }

        // 🎯 FUNÇÃO PARA COPIAR CARD COMO IMAGEM DE ALTA QUALIDADE PARA POWERPOINT
        // Converte o card HTML em imagem PNG de alta resolução e copia para clipboard
        // Uso: Clique no botão de clipboard no card -> Cole no PowerPoint com Ctrl+V
        async function copiarCardParaPowerPoint(cardId) {
            try {
                console.log('📋 Iniciando cópia do card:', cardId);
                
                const card = document.getElementById(cardId);
                if (!card) {
                    throw new Error(`Card ${cardId} não encontrado`);
                }
                
                // 🚫 REMOVIDO: Ícone de processamento (mais discreto)
                const originalButton = event.target.closest('button');
                const originalIcon = originalButton.innerHTML;
                // Apenas desabilita o botão sem mostrar loading visual
                originalButton.disabled = true;
                originalButton.style.opacity = '0.6';
                
                // Aguarda carregamento da biblioteca
                if (!window.html2canvas) {
                    console.log('📦 Carregando html2canvas...');
                    await carregarHtml2Canvas();
                }
                
                // 🛠️ CONFIGURAÇÃO BÁSICA QUE FUNCIONA GARANTIDAMENTE
                const options = {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: false,
                    useCORS: false,
                    width: card.offsetWidth,
                    height: card.offsetHeight
                };
                
                console.log('🖼️ Gerando imagem do card...');
                
                // 🔄 SISTEMA DE FALLBACK ROBUSTO - Testa múltiplas configurações
                let finalCanvas = null;
                
                // Configurações a testar (da mais avançada para mais simples)
                const configOptions = [
                    options, // Configuração inicial
                    { scale: 1, backgroundColor: '#ffffff' }, // Configuração simples
                    { backgroundColor: '#ffffff' }, // Configuração mínima
                    {} // Configuração padrão
                ];
                
                for (let i = 0; i < configOptions.length; i++) {
                    try {
                        console.log(`🧪 Tentativa ${i + 1} com configuração:`, configOptions[i]);
                        const testCanvas = await html2canvas(card, configOptions[i]);
                        
                        console.log(`Canvas ${i + 1}:`, testCanvas.width, 'x', testCanvas.height);
                        
                        // Verifica se o canvas tem dimensões válidas
                        if (testCanvas.width > 0 && testCanvas.height > 0) {
                            // Verifica se tem conteúdo
                            const ctx = testCanvas.getContext('2d');
                            const imageData = ctx.getImageData(0, 0, Math.min(testCanvas.width, 100), Math.min(testCanvas.height, 100));
                            const hasContent = imageData.data.some(channel => channel !== 0);
                            
                            console.log(`Canvas ${i + 1} tem conteúdo:`, hasContent);
                            
                            if (hasContent) {
                                finalCanvas = testCanvas;
                                console.log(`✅ Sucesso na tentativa ${i + 1}!`);
                                break;
                            }
                        }
                    } catch (error) {
                        console.warn(`❌ Tentativa ${i + 1} falhou:`, error.message);
                    }
                }
                
                if (!finalCanvas) {
                    throw new Error('Todas as tentativas de renderização falharam');
                }
                
                // Converte para blob
                const blob = await new Promise(resolve => finalCanvas.toBlob(resolve, 'image/png', 1.0));
                console.log('✅ Blob gerado:', blob.size, 'bytes');
                
                // Copia para clipboard
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': blob
                    })
                ]);
                
                console.log('✅ Card copiado para clipboard!');
                
                // ✨ MELHORADO: Feedback visual mais sutil
                originalButton.innerHTML = '<i class="bi bi-check-lg text-success"></i>';
                originalButton.style.opacity = '1';
                
                setTimeout(() => {
                    originalButton.innerHTML = originalIcon;
                    originalButton.disabled = false;
                    originalButton.style.opacity = '1';
                }, 1500); // Reduzido de 2000 para 1500ms
                
                // Cria uma notificação mais elegante
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Sucesso!</strong> Card copiado para clipboard.<br>
                            <small>Cole no PowerPoint com Ctrl+V</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                `;
                
                // Anima entrada
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.transition = 'all 0.3s ease-in-out';
                    toast.style.opacity = '1';
                    toast.style.transform = 'translateX(0)';
                }, 10);
                
                // Remove automaticamente após 4 segundos
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 4000);
                
            } catch (error) {
                console.error('❌ Erro ao copiar card:', error);
                
                // ✨ MELHORADO: Restaura botão com consistência visual
                if (originalButton) {
                    originalButton.innerHTML = originalIcon;
                    originalButton.disabled = false;
                    originalButton.style.opacity = '1';
                }
                
                // Notificação de erro mais elegante (substituindo alert)
                const errorToast = document.createElement('div');
                errorToast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed';
                errorToast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                errorToast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Erro!</strong> Falha ao copiar card.<br>
                            <small>${error.message}</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                `;
                
                // Anima entrada do toast de erro
                errorToast.style.opacity = '0';
                errorToast.style.transform = 'translateX(100%)';
                document.body.appendChild(errorToast);
                
                setTimeout(() => {
                    errorToast.style.transition = 'all 0.3s ease-in-out';
                    errorToast.style.opacity = '1';
                    errorToast.style.transform = 'translateX(0)';
                }, 10);
                
                // Remove automaticamente após 5 segundos
                setTimeout(() => {
                    if (errorToast.parentElement) {
                        errorToast.remove();
                    }
                }, 5000);
            }
        }
        
        // Função para carregar html2canvas dinamicamente
        function carregarHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => {
                    console.log('✅ html2canvas carregado');
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('Falha ao carregar html2canvas'));
                };
                document.head.appendChild(script);
            });
        }

        // Executar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DINÂMICO: DOM carregado, iniciando verificação...');
            setTimeout(carregarProjetosPrincipaisDinamico, 500); // Pequeno delay para garantir que o template foi renderizado
            setTimeout(carregarProjetosPrevistosDinamico, 700); // Carrega projetos previstos logo depois
        });
    </script>
</body>
</html> 