{% extends "base.html" %}

{% block title %}{{ titulo_pagina if titulo_pagina else 'Status Report' }}{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Classes para controlar visibilidade na tela e no PDF */
    .pdf-only {
        display: none; /* Oculta elementos que devem aparecer apenas no PDF */
    }
    
    /* Estilos gerais */
    .status-dot {
        height: 25px;
        width: 25px;
        border-radius: 50%;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
        border: 3px solid #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .status-verde { background-color: #1cc88a; } /* Verde do template */
    .status-amarelo { background-color: #f6c23e; } /* Amarelo do template */
    .status-vermelho { background-color: #e74a3b; } /* Vermelho do template */
    .status-cinza { background-color: #858796; } /* Cinza do template */
    .status-text { font-weight: 600; font-size: 1.1rem; }
    
    /* Layout original do projeto */
    .project-details-header {
        font-size: 0.85rem;
        color: #5a5c69;
        margin-bottom: 1.5rem;
        padding: 0.8rem;
        background-color: #f8f9fc;
        border-radius: 0.35rem;
        border: 1px solid #e3e6f0;
    }
    
    .project-details-header strong {
        margin-right: 5px;
    }
    
    .project-details-header span {
        margin-right: 15px;
    }
    
    /* KPI cards originais */
    .kpi-card .card-body {
        display: flex;
        align-items: center;
        height: 85px;
        padding: 0.5rem 0.8rem;
    }
    
    .kpi-card .kpi-content {
        width: 100%;
        margin-left: 0.8rem;
    }
    
    .kpi-card .kpi-icon {
        font-size: 1.8rem;
        color: #dddfeb;
    }
    
    .kpi-card .text-xs {
        font-size: 0.65rem;
        display: block;
        margin-bottom: -2px;
    }
    
    .kpi-card .h1, .kpi-card .h5 {
        font-size: 1.4rem;
        margin-bottom: 0;
        line-height: 1.1;
    }
    
    .kpi-card small.text-muted {
        font-size: 0.65rem;
        line-height: 1;
        display: block;
        margin-top: 1px;
    }
    
    /* Charts originais */
    .chart-card .card-body {
        min-height: 220px;
        padding: 0.8rem;
    }
    
    .chart-card canvas {
        max-height: 200px;
    }
    
    /* Títulos de seções */
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid #e3e6f0;
    }
    
    /* Placeholders originais */
    .placeholder-section {
        background-color: #f8f9fc;
        border: 1px dashed #d1d3e2;
        padding: 1rem;
        border-radius: 0.35rem;
        text-align: center;
        color: #858796;
        margin-top: 1rem;
        font-size: 0.85rem;
    }
    
    .placeholder-section i {
        font-size: 1.2rem;
        margin-bottom: 0.4rem;
        display: block;
    }
    
    .placeholder-section h6 {
        font-size: 0.9rem;
    }
    
    .list-group-item {
        background-color: transparent;
        border-left: none;
        border-right: none;
        border-top: 1px solid #e3e6f0;
        padding: 0.6rem 0;
        font-size: 0.85rem;
    }
    
    .list-group-item:first-child {
        border-top: none;
    }
    
    /* Estilos para campos editáveis */
    .editable-field {
        padding: 2px 5px;
        border-radius: 3px;
        transition: background-color 0.2s;
    }
    
    .edit-mode .editable-field {
        border: 1px dashed #4e73df;
        background-color: rgba(78, 115, 223, 0.1);
        cursor: pointer;
    }
    
    .editable-field.editing {
        background-color: white !important;
        border: 1px solid #4e73df !important;
        padding: 1px 4px;
    }
    
    /* Estilo para o botão de modo de edição ativo */
    #editModeBtn.active {
        background-color: #e74a3b;
        border-color: #e74a3b;
        color: white;
    }
    
    /* Estilo para entrada de edição */
    .edit-input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: inherit;
        font-weight: inherit;
        color: inherit;
        padding: 0;
        margin: 0;
    }
    
    .edit-input:focus {
        outline: none;
    }

    /* --- Estilos para Geração de PDF (WeasyPrint) --- */
    @media print {
        @page {
            size: A4 portrait;
            margin: 10mm; /* Margem moderada e uniforme */
        }

        body {
            font-size: 10pt;
            background-color: #fff !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* Controle de visibilidade básico */
        .pdf-only { display: block !important; }
        .screen-only { display: none !important; }
        
        /* Esconder elementos da UI */
        .navbar, #accordionSidebar, .btn-outline-secondary, footer.sticky-footer, .scroll-to-top {
            display: none !important;
        }
        
        /* Esconder botões de ação na impressão */
        #editModeBtn, #generatePdfBtn, .btn-outline-secondary, .btn-primary {
            display: none !important;
        }
        
        /* Ocultar seção de botões inteira */
        .d-sm-flex.align-items-center.justify-content-between.mb-3 > div {
            display: none !important;
        }
        
        /* Configurações básicas de containers */
        #content-wrapper, #content, .container, .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
        }
        
        /* Preservar quebras de página */
        .placeholder-section, .card {
            page-break-inside: avoid !important;
        }
        
        /* Garantir texto não seja cortado */
        td, th {
            word-wrap: break-word !important;
        }
        
        /* Preservar espaço em branco */
        .row {
            margin-bottom: 5mm !important;
        }
        
        /* Garantir que textos não sejam cortados */
        [data-field="data-prevista"],
        [data-field="horas-utilizadas"],
        [data-field="horas-planejadas"] {
            white-space: nowrap !important;
        }
        
        /* Cabeçalho e rodapé */
        .company-header, .company-footer {
            margin-bottom: 5mm !important;
        }
        
        /* Marca d'água */
        .document-confidential {
            position: fixed !important;
            top: 50% !important;
            left: 0 !important;
            right: 0 !important;
            text-align: center !important;
            transform: rotate(-45deg) !important;
            font-size: 48pt !important;
            color: rgba(200, 200, 200, 0.15) !important;
            z-index: -1 !important;
        }
    }
    
    /* NOVO: Adicionar estilo para status pendente mais visível */
    .badge-pending {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    /* NOVO: Melhores estilos para tabela de marcos */
    .milestone-name {
        font-weight: 600 !important;
        color: #333 !important;
        text-align: left !important;
        display: inline-block !important;
    }
    
    .milestone-date {
        color: #666 !important;
        font-size: 0.85em !important;
        text-align: right !important;
        display: block !important;
    }

    /* Classe para estilo ao gerar PDF via browser */
    .print-mode {
        font-size: 11pt !important;
        line-height: 1.3 !important;
        width: 210mm !important; /* Largura exata do A4 */
        box-sizing: border-box !important;
        padding: 0 !important;
        margin: 0 auto !important;
    }
    
    .print-mode .company-header {
        margin-bottom: 10px !important;
        padding-bottom: 5px !important;
        border-bottom: 1px solid #4e73df !important;
    }
    
    .print-mode .company-logo {
        font-size: 12pt !important;
    }
    
    .print-mode .project-info-line {
        font-size: 8pt !important;
        padding: 4px 6px !important;
        margin-bottom: 10px !important;
    }
    
    .print-mode .row {
        margin-left: -5px !important;
        margin-right: -5px !important;
        margin-bottom: 8px !important;
    }
    
    .print-mode .col-xl-3,
    .print-mode .col-md-6,
    .print-mode .col-lg-6,
    .print-mode .col-md-4 {
        padding-left: 5px !important;
        padding-right: 5px !important;
    }
    
    .print-mode .status-dot {
        height: 10px !important;
        width: 10px !important;
        border-width: 1px !important;
        margin-right: 3px !important;
    }
    
    .print-mode .kpi-card {
        margin-bottom: 8px !important;
    }
    
    .print-mode .kpi-card .card-body {
        height: auto !important;
        min-height: 50px !important;
        padding: 4px 6px !important;
    }
    
    .print-mode .kpi-card .kpi-icon {
        font-size: 1rem !important;
    }
    
    .print-mode .kpi-card .text-xs {
        font-size: 6pt !important;
    }
    
    .print-mode .kpi-card .h1 {
        font-size: 12pt !important;
    }
    
    .print-mode .kpi-card .h5 {
        font-size: 10pt !important;
    }
    
    .print-mode .kpi-card small.text-muted { 
        font-size: 6pt !important; 
    }
    
    .print-mode .card-header {
        padding: 3px 6px !important;
    }
    
    .print-mode .card-header h6 {
        font-size: 10pt !important;
        margin: 0 !important;
    }
    
    .print-mode .chart-card .card-body {
        min-height: 150px !important;
        padding: 5px !important;
    }
    
    .print-mode canvas {
        max-height: 140px !important;
        max-width: none !important;
    }
    
    .print-mode .placeholder-section {
        height: 80px !important;
        padding: 5px !important;
        margin-top: 5px !important;
    }
    
    .print-mode .placeholder-section i {
        font-size: 0.8rem !important;
        margin-bottom: 2px !important;
    }
    
    .print-mode .placeholder-section h6 {
        font-size: 8pt !important;
        margin-bottom: 3px !important;
    }
    
    .print-mode .placeholder-section p {
        font-size: 7pt !important;
        margin-bottom: 0 !important;
    }
    
    .print-mode .company-footer {
        margin-top: 10px !important;
        padding-top: 5px !important;
        font-size: 7pt !important;
    }
    
    .print-mode .company-footer p {
        margin-bottom: 2px !important;
    }

    .print-mode .chart-card {
        margin-bottom: 8px !important;
    }

    .print-mode .chart-card .card-body {
        min-height: 135px !important;
        max-height: 150px !important;
        padding: 5px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* Timeline estilo tabular (igual Marcos) */
    .timeline-section {
        margin-bottom: 15px !important;
        border: 1px solid #e3e6f0 !important;
        border-radius: 0.25rem !important;
        overflow: hidden !important;
    }

    .timeline-section .section-header {
        padding: 8px 12px !important;
        margin: 0 !important;
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #e9ecef !important;
        font-weight: 600 !important;
        color: #495057 !important;
        text-align: left !important;
        display: flex !important;
        align-items: center !important;
    }
    
    .timeline-section .section-header i {
        margin-right: 8px !important;
        font-size: 1rem !important;
    }
    
    .timeline-section .section-header span {
        line-height: 1.2 !important;
        font-size: 0.85rem !important;
    }
    
    /* Cabeçalho da tabela de timeline */
    .timeline-section .column-headers {
        display: flex !important;
        padding: 6px 12px !important;
        font-size: 0.7rem !important;
        font-weight: 700 !important;
        background-color: #eef0f2 !important;
        border-bottom: 1px solid #dee2e6 !important;
        color: #555 !important;
    }
    
    .timeline-section .column-headers .task-column {
        flex: 0 0 50% !important;
        text-align: left !important;
        padding-left: 0 !important;
    }
    
    .timeline-section .column-headers .status-column {
        flex: 0 0 25% !important;
        text-align: center !important;
    }
    
    .timeline-section .column-headers .date-column {
        flex: 0 0 25% !important;
        text-align: right !important;
        padding-right: 12px !important;
    }
    
    .timeline-section .list-group {
        margin-bottom: 0 !important;
    }
    
    .timeline-section .list-group-item {
        padding: 6px 12px !important;
        font-size: 0.8rem !important;
        border: none !important;
        border-bottom: 1px solid #f0f0f0 !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
        transition: background-color 0.15s ease-in-out !important;
    }
    
    .timeline-section .list-group-item:hover {
        background-color: #f8f9fa !important;
    }
    
    .timeline-section .list-group-item:last-child {
        border-bottom: none !important;
    }
    
    .timeline-section .badge {
        flex: 0 0 25% !important;
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
        border-radius: 3px !important;
        margin: 0 auto !important; /* Centralizar horizontalmente */
        text-align: center !important;
        display: inline-block !important;
        width: auto !important;
        min-width: 80px !important;
        max-width: 90px !important; /* Limitar largura máxima */
    }
    
    /* Container de status para centralizar o badge */
    .timeline-section .status-container {
        flex: 0 0 25% !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
    }
    
    /* Badge para A Fazer em cinza */
    .timeline-section .badge.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    .timeline-section .text-muted.small {
        flex: 0 0 25% !important;
        font-size: 0.75rem !important;
        white-space: nowrap !important;
        text-align: right !important;
        color: #6c757d !important;
        padding-right: 12px !important;
    }
    
    .timeline-task-name {
        flex: 0 0 50% !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        margin-right: 0 !important;
        font-weight: 500 !important;
        color: #495057 !important;
        text-align: left !important;
        font-size: 0.8rem !important;
    }
    
    /* Alinhar estilo da tabela de marcos */
    .table-sm th {
        font-weight: 700 !important;
        font-size: 0.7rem !important;
        background-color: #eef0f2 !important;
        color: #555 !important;
        padding: 6px 12px !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .table-sm td {
        font-size: 0.8rem !important;
        padding: 6px 12px !important;
        vertical-align: middle !important;
    }
    
    /* Garantir que os ícones e textos de data fiquem lado a lado */
    .timeline-section .text-muted.small i {
        margin-right: 2px !important;
    }
    
    .timeline-section .text-muted.small span.mx-1 {
        margin-left: 3px !important;
        margin-right: 3px !important;
        opacity: 0.7 !important;
    }

    /* Alinhamento específico para a tabela de marcos */
    .table-sm th:first-child {
        text-align: left !important;
    }
    
    .table-sm th:last-child {
        text-align: right !important;
    }
    
    .table-sm td:first-child {
        text-align: left !important;
    }
    
    .table-sm td:last-child {
        text-align: right !important;
    }

    /* Garantir que os badges em ambas as seções sejam idênticos */
    .timeline-section .badge,
    .table-sm .badge {
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
        border-radius: 3px !important;
        display: inline-block !important;
        text-align: center !important;
        min-width: 80px !important;
    }

    /* Ajuste para o ícone de Marco (ponto de exclamação) */
    .table-sm td .badge.bg-danger {
        font-size: 0.65rem !important;
        padding: 2px 4px !important;
        margin-right: 6px !important;
        width: auto !important;
        min-width: auto !important;
    }
    
    /* Ajuste para o badge de status de Marco */
    .table-sm td:nth-child(2) .badge {
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
        border-radius: 3px !important;
        display: inline-block !important;
        text-align: center !important;
        min-width: 80px !important;
    }
</style>
{% endblock %}

{% block content %}

{% if error %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Erro ao Gerar Status Report</h4>
        <p>{{ error }}</p>
    </div>
{% elif report_data %}
    
    <!-- Cabeçalho da Página -->
    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-file-earmark-text me-2"></i>Status Report
        </h1>
        <div class="screen-only"> <!-- Div para agrupar data e botão -->
            <span class="text-muted small me-3">Gerado em: {{ data_geracao | default('N/A', true) }}</span>
            <!-- Botões de ação - apenas o botão de impressão será visível -->
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="window.print();" title="Usar impressão do navegador">
                <i class="bi bi-printer me-1"></i> Imprimir
            </button>
            <!-- Botões ocultos por padrão -->
            <button class="btn btn-sm btn-warning me-2 d-none" id="editModeBtn" title="Editar relatório antes de baixar">
                <i class="bi bi-pencil-square me-1"></i> <span>Editar Relatório</span>
            </button>
            {% if pdf_generator_available %}
                <a href="{{ url_for('macro.download_status_report', project_id=project_id) }}" 
                   class="btn btn-sm btn-primary d-none" 
                   title="Baixar Relatório em PDF ({{ generator_type }})">
                    <i class="bi bi-download me-1"></i> Baixar PDF (Servidor)
                </a>
            {% endif %}
            <!-- Botão para gerar PDF via JavaScript (oculto) -->
            <button class="btn btn-sm btn-success ms-2 d-none" id="generatePdfBtn" title="Gerar PDF usando o navegador">
                <i class="bi bi-filetype-pdf me-1"></i> Baixar PDF (Browser)
            </button>
        </div>
    </div>

    <!-- Container principal que será convertido para PDF -->
    <div id="pdfContent">
    
    <!-- Cabeçalho Profissional (visível apenas na impressão/PDF) -->
    <div class="company-header pdf-only">
        <div class="company-logo">
            <!-- Logo corporativo -->
            <i class="bi bi-building-fill me-2"></i> Control360 SOU
            <div style="font-size: 9pt; font-weight: normal; color: #666;">Gestão Inteligente de Projetos</div>
        </div>
        <div class="report-date" style="text-align: right;">
            <div style="font-size: 8pt; color: #666;">Status Report</div>
            <strong>{{ data_geracao | default('N/A', true) }}</strong>
        </div>
    </div>
    
    <!-- Marca d'água de confidencialidade -->
    <div class="document-confidential pdf-only">CONFIDENCIAL</div>
    
    <!-- Detalhes do Projeto - Mantém o original na tela, redesenhado apenas na impressão -->
    <div class="project-details-header screen-only">
        <span><strong>Projeto:</strong> <span class="editable-field" data-field="project-name">{{ report_data.info_geral.nome | default('N/A') }}</span></span>
        <span><strong>ID:</strong> <span class="editable-field" data-field="project-id">{{ report_data.info_geral.id | default('N/A') }}</span></span>
        <span><strong>Status Atual:</strong> <span class="editable-field" data-field="project-status">{{ report_data.info_geral.status_atual | default('N/A') }}</span></span>
        <span><strong>Squad:</strong> <span class="editable-field" data-field="project-squad">{{ report_data.info_geral.squad | default('N/A') }}</span></span>
        <span><strong>Especialista:</strong> <span class="editable-field" data-field="project-specialist">{{ report_data.info_geral.especialista | default('N/A') }}</span></span>
    </div>

    <!-- Versão para impressão (apenas visível no PDF) -->
    <div class="project-info-line pdf-only">
        <span class="project-info-item"><strong>Projeto:</strong> <span class="editable-field" data-field="project-name">{{ report_data.info_geral.nome | default('N/A') }}</span></span>
        <span class="project-info-separator">|</span>
        <span class="project-info-item"><strong>ID:</strong> <span class="editable-field" data-field="project-id">{{ report_data.info_geral.id | default('N/A') }}</span></span>
        <span class="project-info-separator">|</span>
        <span class="project-info-item"><strong>Status:</strong> <span class="editable-field" data-field="project-status">{{ report_data.info_geral.status_atual | default('N/A') }}</span></span>
        <span class="project-info-separator">|</span>
        <span class="project-info-item"><strong>Squad:</strong> <span class="editable-field" data-field="project-squad">{{ report_data.info_geral.squad | default('N/A') }}</span></span>
        <span class="project-info-separator">|</span>
        <span class="project-info-item"><strong>Especialista:</strong> <span class="editable-field" data-field="project-specialist">{{ report_data.info_geral.especialista | default('N/A') }}</span></span>
    </div>

    <!-- Linha de KPIs Resumo -->
    <div class="row">
        <!-- Status Geral -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-clipboard-data kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">STATUS GERAL</div>
                        {% set status_color_class = report_data.status_geral_indicador | default('cinza') %}
                        <div class="d-flex align-items-center">
                             <span class="status-dot status-{{ status_color_class }}" data-status-dot></span>
                             <span class="h5 status-text text-{{ status_color_class }} editable-field" data-field="status-geral" data-status-text>{{ status_color_class | capitalize | default('A Definir') }}</span>
                             <div class="status-selector ml-2" style="display:none;">
                                <select class="form-select form-select-sm">
                                    <option value="verde">Verde</option>
                                    <option value="amarelo">Amarelo</option>
                                    <option value="vermelho">Vermelho</option>
                                    <option value="cinza">Cinza</option>
                                </select>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- % Concluído -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-check2-circle kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">% CONCLUÍDO</div>
                        <div class="h1 mb-0 font-weight-bold text-gray-800 editable-field" data-field="percentual-concluido">{{ report_data.progresso.percentual_concluido | round(1) }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Prazo -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-calendar-week kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">STATUS DO PRAZO</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800 editable-field" data-field="status-prazo">{{ report_data.progresso.status_prazo | default('A Definir') }}</div>
                        <small class="text-muted">Prev: <span class="editable-field" data-field="data-prevista">{{ report_data.progresso.data_prevista_termino | default('N/A', true) }}</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- % Esforço Consumido -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-hourglass-split kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">% ESFORÇO CONSUMIDO</div>
                        <div class="h1 mb-0 font-weight-bold text-gray-800 editable-field" data-field="percentual-esforco">{{ report_data.esforco.percentual_consumido | round(1) }}%</div>
                        <small class="text-muted"><span class="editable-field" data-field="horas-utilizadas">{{ report_data.esforco.horas_utilizadas | round(1) }}</span>h / <span class="editable-field" data-field="horas-planejadas">{{ report_data.esforco.horas_planejadas | round(1) }}</span>h</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Linha de Gráficos (Lado a Lado) -->
    <div class="row">
        <!-- Coluna Esquerda: Gráfico de Progresso -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow chart-card h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Progresso (% Concluído)</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <canvas id="progressoChart" style="max-height: 200px;"></canvas>
                </div>
            </div>
        </div>
        <!-- Coluna Direita: Gráfico de Esforço -->
        <div class="col-lg-6 mb-4">
             <div class="card shadow chart-card h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Esforço (Horas Planejado vs Utilizado)</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <canvas id="esforcoChart" style="max-height: 200px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Marcos Recentes (Linha inteira) -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="placeholder-section">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-calendar-check text-primary me-2"></i>
                    <h6 class="section-title mb-0">Marcos Recentes</h6>
                </div>
                {% if report_data and report_data.marcos_recentes and report_data.marcos_recentes|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr class="table-light">
                                    <th style="width: 50%">Marco</th>
                                    <th style="width: 25%">Status</th>
                                    <th style="width: 25%">Data Planejada</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for marco in report_data.marcos_recentes %}
                                    <tr {% if marco.atrasado %}class="table-danger"{% endif %}>
                                        <td>
                                            {% if marco.atrasado %}<span class="badge bg-danger me-1" title="Marco atrasado!">!</span>{% endif %}
                                            <span class="milestone-name">{{ marco.nome }}</span>
                                        </td>
                                        <td>
                                            <span class="badge {% if marco.status == 'COMPLETED' or marco.status == 'CONCLUÍDO' %}bg-success{% elif marco.status == 'IN_PROGRESS' or marco.status == 'EM ANDAMENTO' %}bg-primary{% elif marco.status == 'DELAYED' or marco.status == 'ATRASADO' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                {% if marco.status == 'COMPLETED' or marco.status == 'CONCLUÍDO' %}Concluído
                                                {% elif marco.status == 'IN_PROGRESS' or marco.status == 'EM ANDAMENTO' %}Em Andamento
                                                {% elif marco.status == 'DELAYED' or marco.status == 'ATRASADO' %}Atrasado
                                                {% else %}Pendente{% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="milestone-date">{{ marco.data_planejada }}</span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">Nenhum marco definido para este projeto.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Linha do Tempo (Linha inteira) -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="placeholder-section">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-list-task text-primary me-2"></i>
                    <h6 class="section-title mb-0">Linha do Tempo (Tarefas)</h6>
                </div>
                <div class="card shadow-sm h-100">
                    <div id="timeline-loading" class="text-center p-3">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span class="text-muted small">Carregando tarefas...</span>
                    </div>
                    
                    <div id="timeline-error" class="text-center p-3 text-danger" style="display: none;">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <span id="timeline-error-message" class="small">Erro ao carregar tarefas</span>
                    </div>
                    
                    <div id="timeline-empty" class="text-center p-3 text-muted" style="display: none;">
                        <i class="bi bi-info-circle me-2"></i>
                        <span class="small">Nenhuma tarefa encontrada</span>
                    </div>
                    
                    <!-- Lista de tarefas -->
                    <div id="timeline-content" style="display: none;">
                        <!-- Próximas tarefas -->
                        <div class="timeline-section">
                            <div class="section-header">
                                <i class="bi bi-calendar-event text-warning"></i>
                                <span class="fw-bold">Próximas Tarefas</span>
                            </div>
                            <ul class="list-group list-group-flush" id="upcoming-tasks-list"></ul>
                        </div>
                        
                        <!-- Tarefas em andamento -->
                        <div class="timeline-section">
                            <div class="section-header">
                                <i class="bi bi-play-circle text-primary"></i>
                                <span class="fw-bold">Em Andamento</span>
                            </div>
                            <ul class="list-group list-group-flush" id="started-tasks-list"></ul>
                        </div>
                        
                        <!-- Tarefas concluídas -->
                        <div class="timeline-section">
                            <div class="section-header">
                                <i class="bi bi-check-circle text-success"></i>
                                <span class="fw-bold">Concluídas</span>
                            </div>
                            <ul class="list-group list-group-flush" id="completed-tasks-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Riscos e Impedimentos (Linha inteira) -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="placeholder-section"> {# ENVOLVENDO COM placeholder-section #}
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i> {# Ícone e cor do título #}
                    <h6 class="section-title mb-0">Riscos e Impedimentos</h6> {# TÍTULO FORA DO CARD #}
                </div>
                <div class="card shadow-sm h-100"> {# Removido card-header daqui #}
                    <div class="card-body p-0" style="min-height: 180px;">
                        {% if report_data.riscos_impedimentos and report_data.riscos_impedimentos|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover table-striped mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 50%; padding-left: 1rem;">Descrição</th>
                                            <th class="text-center" style="width: 25%;">Severidade</th>
                                            <th class="text-center" style="width: 25%; padding-right: 1rem;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for risco in report_data.riscos_impedimentos %}
                                            <tr>
                                                <td style="white-space: pre-wrap; word-break: break-word; font-size: 0.75rem; padding-left: 1rem;">{{ risco.description }}</td>
                                                <td class="text-center">
                                                    {% set severity_class = 'badge bg-secondary' %}
                                                    {% if risco.severity == 'Crítico' %}
                                                        {% set severity_class = 'badge bg-danger' %}
                                                    {% elif risco.severity == 'Alto' %}
                                                        {% set severity_class = 'badge bg-warning text-dark' %}
                                                    {% elif risco.severity == 'Médio' %}
                                                        {% set severity_class = 'badge bg-info text-dark' %}
                                                    {% elif risco.severity == 'Baixo' %}
                                                        {% set severity_class = 'badge bg-secondary' %}
                                                    {% endif %}
                                                    <span class="{{ severity_class }}" style="font-size: 0.65rem;">{{ risco.severity }}</span>
                                                </td>
                                                <td class="text-center" style="padding-right: 1rem;">
                                                    {% set status_class = 'badge bg-secondary' %}
                                                    {% if risco.status == 'Ativo' %}
                                                        {% set status_class = 'badge bg-warning text-dark' %}
                                                    {% elif risco.status == 'Mitigado' %}
                                                        {% set status_class = 'badge bg-info text-dark' %}
                                                    {% elif risco.status == 'Resolvido' %}
                                                        {% set status_class = 'badge bg-success' %}
                                                    {% endif %}
                                                    <span class="{{ status_class }}" style="font-size: 0.65rem;">{{ risco.status }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center text-muted small py-3 px-3" style="min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <i class="bi bi-shield-check" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                <span>Nenhum risco ou impedimento ativo identificado para este projeto.</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rodapé Profissional -->
    <div class="company-footer pdf-only">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <div style="text-align: left; font-size: 7pt; color: #666;">
                Documento gerado em: {{ data_geracao | default('N/A', true) }}
            </div>
            <div style="text-align: right; font-size: 7pt; color: #666;">
                Página 1 de 1
            </div>
        </div>
        <p>Este documento é <strong>confidencial</strong> e destinado exclusivamente para o cliente.</p>
        <p>© 2025 SOU Tecnologia - Todos os direitos reservados • <span style="color: #666;">suporte@control360.com.br</span></p>
    </div>
    
    </div><!-- Fim do container para PDF -->

{% else %}
     <div class="alert alert-warning" role="alert">
        Não foi possível carregar os dados para o Status Report do projeto ID {{ project_id }}.
    </div>
{% endif %}

<!-- Script para passar dados para JS e inicializar gráficos -->
<script id="report-data-json" type="application/json">
    {{ report_data | tojson | safe if report_data else '{}' }}
</script>

{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- Importar bibliotecas necessárias para geração de PDF no navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Variáveis para o modo de edição ---
        const editModeBtn = document.getElementById('editModeBtn');
        const pdfContent = document.getElementById('pdfContent');
        const editableFields = document.querySelectorAll('.editable-field');
        let editMode = false;
        let charts = {}; // Armazena referências para os gráficos
        
        // --- Código para geração de gráficos ---
        const reportDataElement = document.getElementById('report-data-json');
        if (!reportDataElement) {
            console.error('Elemento com dados do report não encontrado!');
            return;
        }
        
        let reportData;
        try {
            reportData = JSON.parse(reportDataElement.textContent);
            console.log("Dados do Report para JS:", reportData);
        } catch (e) {
            console.error("Erro ao parsear dados JSON do report:", e);
            return;
        }

        // Verifica se os dados necessários existem ANTES de tentar criar os gráficos
        if (!reportData || !reportData.progresso || !reportData.esforco) {
            console.warn("Dados incompletos ou não encontrados para gerar gráficos.");
            // Opcional: Ocultar ou mostrar mensagem nos divs dos gráficos
             const progressoCanvas = document.getElementById('progressoChart');
            const esforcoCanvas = document.getElementById('esforcoChart');
            if (progressoCanvas) progressoCanvas.parentElement.innerHTML = '<p class="text-muted text-center mt-5">Dados de progresso indisponíveis.</p>';
            if (esforcoCanvas) esforcoCanvas.parentElement.innerHTML = '<p class="text-muted text-center mt-5">Dados de esforço indisponíveis.</p>';
            return; // Não tenta criar os gráficos
        }
        
        // Somente continua se reportData for válido
        try {
            // --- Gráfico de Progresso (Gauge/Doughnut) ---
            const progressoCtx = document.getElementById('progressoChart')?.getContext('2d');
            if (progressoCtx) {
                const percentualConcluido = reportData.progresso.percentual_concluido || 0;
                const corProgresso = percentualConcluido >= 70 ? '#1cc88a' : (percentualConcluido >= 50 ? '#f6c23e' : '#e74a3b');

                charts.progresso = new Chart(progressoCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [percentualConcluido, 100 - percentualConcluido],
                            backgroundColor: [corProgresso, '#e9ecef'],
                            borderColor: [corProgresso, '#e9ecef'],
                            borderWidth: 1,
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        aspectRatio: 2,
                        cutout: '75%',
                        layout: {
                            padding: {
                                bottom: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false },
                            title: { display: false },
                            animation: {
                                onComplete: function(animation) {
                                    var chartInstance = animation.chart,
                                        ctx = chartInstance.ctx;
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    ctx.font = "bold 24px Inter";

                                    var value = chartInstance.data.datasets[0].data[0];
                                    var color = chartInstance.data.datasets[0].backgroundColor[0]; 
                                    ctx.fillStyle = color;

                                    var x = chartInstance.width / 2;
                                    var y = chartInstance.height / 1.1;
                                    
                                    ctx.fillText(value + '%', x, y);
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn("Elemento canvas 'progressoChart' não encontrado.");
            }

            // --- Gráfico de Esforço (Barras) ---
            const esforcoCtx = document.getElementById('esforcoChart')?.getContext('2d');
            if (esforcoCtx) {
                const horasPlanejadas = reportData.esforco.horas_planejadas || 0;
                const horasUtilizadas = reportData.esforco.horas_utilizadas || 0;
                const corPlanejado = '#adb5bd';
                const corUtilizado = horasUtilizadas > horasPlanejadas ? '#e74a3b' : '#4e73df';

                charts.esforco = new Chart(esforcoCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Utilizado', 'Planejado'],
                        datasets: [
                            {
                                label: 'Horas',
                                data: [horasUtilizadas, horasPlanejadas],
                                backgroundColor: [corUtilizado, corPlanejado],
                                borderColor: [corUtilizado, corPlanejado],
                                borderWidth: 1,
                                barPercentage: 0.6, 
                                categoryPercentage: 0.7
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false,
                        aspectRatio: 2.2,
                        layout: {
                            padding: {
                                left: 5,
                                right: 10,
                                top: 5,
                                bottom: 5
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed.x.toFixed(1) + 'h';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Horas',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: true,
                                    drawBorder: true,
                                    drawOnChartArea: true,
                                    drawTicks: true,
                                    color: '#e9ecef'
                                }
                            },
                            y: {
                                ticks: {
                                    padding: 5
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn("Elemento canvas 'esforcoChart' não encontrado.");
            }
        } catch (chartError) {
            console.error("Erro ao criar gráficos:", chartError);
        }

        // --- Função para atualizar os gráficos com novos valores ---
        function updateCharts(forPdf = false) {
            // Atualiza gráfico de progresso
            if (charts.progresso) {
                const percentualText = document.querySelector('[data-field="percentual-concluido"]').textContent;
                const percentual = parseFloat(percentualText.replace('%', ''));
                const corProgresso = percentual >= 70 ? '#1cc88a' : (percentual >= 50 ? '#f6c23e' : '#e74a3b');
                
                charts.progresso.data.datasets[0].data[0] = percentual;
                charts.progresso.data.datasets[0].data[1] = 100 - percentual;
                charts.progresso.data.datasets[0].backgroundColor[0] = corProgresso;
                charts.progresso.data.datasets[0].borderColor[0] = corProgresso;
                
                // Ajusta fontes para PDF
                if (forPdf) {
                    charts.progresso.options.plugins.animation.onComplete = function(animation) {
                        var chartInstance = animation.chart,
                            ctx = chartInstance.ctx;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.font = "bold 18px Inter"; // Fonte menor para PDF
                        
                        var value = chartInstance.data.datasets[0].data[0];
                        var color = chartInstance.data.datasets[0].backgroundColor[0]; 
                        ctx.fillStyle = color;
                        
                        var x = chartInstance.width / 2;
                        var y = chartInstance.height / 1.1;
                        
                        ctx.fillText(value + '%', x, y);
                    };
                }
                
                charts.progresso.update();
            }
            
            // Atualiza gráfico de esforço
            if (charts.esforco) {
                const horasUtilizadasText = document.querySelector('[data-field="horas-utilizadas"]').textContent;
                const horasPlanejadaText = document.querySelector('[data-field="horas-planejadas"]').textContent;
                
                const horasUtilizadas = parseFloat(horasUtilizadasText);
                const horasPlanejadas = parseFloat(horasPlanejadaText);
                
                const corUtilizado = horasUtilizadas > horasPlanejadas ? '#e74a3b' : '#4e73df';
                
                charts.esforco.data.datasets[0].data[0] = horasUtilizadas;
                charts.esforco.data.datasets[0].data[1] = horasPlanejadas;
                charts.esforco.data.datasets[0].backgroundColor[0] = corUtilizado;
                charts.esforco.data.datasets[0].borderColor[0] = corUtilizado;
                
                // Ajusta para PDF
                if (forPdf) {
                    charts.esforco.options.scales.x.title.display = false; // Remove título do eixo X
                    charts.esforco.options.scales.x.ticks.font = { size: 8 }; // Fonte menor nos ticks
                    charts.esforco.options.scales.y.ticks.font = { size: 8 }; // Fonte menor nos ticks
                }
                
                charts.esforco.update();
            }
        }

        // --- Funções para o modo de edição ---
        // Alternar modo de edição
        function toggleEditMode() {
            editMode = !editMode;
            
            if (editMode) {
                // Ativar modo de edição
                pdfContent.classList.add('edit-mode');
                editModeBtn.classList.add('active');
                editModeBtn.querySelector('span').textContent = 'Salvar Alterações';
                
                // Tornar editável o seletor de status
                const statusSelector = document.querySelector('.status-selector');
                if (statusSelector) {
                    statusSelector.style.display = 'inline-block';
                    const statusText = document.querySelector('[data-status-text]');
                    if (statusText) {
                        statusText.style.display = 'none';
                    }
                    
                    // Seleciona o valor atual no dropdown
                    const statusDot = document.querySelector('[data-status-dot]');
                    const currentStatus = statusDot.className.includes('verde') ? 'verde' : 
                                          statusDot.className.includes('amarelo') ? 'amarelo' : 
                                          statusDot.className.includes('vermelho') ? 'vermelho' : 'cinza';
                    
                    const selectElement = statusSelector.querySelector('select');
                    selectElement.value = currentStatus;
                    
                    // Adiciona listener para mudar a cor do status dot quando o select muda
                    selectElement.addEventListener('change', function() {
                        const newStatus = selectElement.value;
                        statusDot.className = 'status-dot status-' + newStatus;
                        statusText.className = 'h5 status-text text-' + newStatus + ' editable-field';
                        statusText.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    });
                }

                // Não permite editar a tabela de marcos, apenas os demais campos editáveis
                const marcosTable = document.querySelector('.col-md-4 .card.shadow .table-responsive');
                if (marcosTable) {
                    marcosTable.setAttribute('data-original-state', 'preserved');
                    console.log("Tabela de marcos preservada no modo de edição");
                }
            } else {
                // Desativar modo de edição
                pdfContent.classList.remove('edit-mode');
                editModeBtn.classList.remove('active');
                editModeBtn.querySelector('span').textContent = 'Editar Relatório';
                
                // Desativar e esconder o seletor de status
                const statusSelector = document.querySelector('.status-selector');
                if (statusSelector) {
                    statusSelector.style.display = 'none';
                    const statusText = document.querySelector('[data-status-text]');
                    if (statusText) {
                        statusText.style.display = 'inline';
                    }
                }
                
                // Remover quaisquer inputs ativos
                document.querySelectorAll('.edit-input').forEach(input => {
                    const parent = input.parentElement;
                    parent.textContent = input.value;
                    parent.classList.remove('editing');
                });
                
                // Atualizar os gráficos
                updateCharts();
            }
        }
        
        // Adicionar listeners para os campos editáveis
        editableFields.forEach(field => {
            field.addEventListener('click', function() {
                // Só edita se estiver no modo de edição
                if (!editMode || field.classList.contains('editing')) return;
                
                // Caso especial para status-geral (que tem select)
                if (field.dataset.field === 'status-geral') return;
                
                // Cria um input para editar o valor
                const originalText = field.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalText;
                input.className = 'edit-input';
                
                // Para percentuais e horas, forçar números
                if (field.dataset.field === 'percentual-concluido' || 
                    field.dataset.field === 'percentual-esforco' ||
                    field.dataset.field === 'horas-utilizadas' ||
                    field.dataset.field === 'horas-planejadas') {
                    input.type = 'number';
                    input.step = '0.1';
                    input.min = '0';
                    input.value = originalText.replace('%', '');
                }
                
                // Para datas
                if (field.dataset.field === 'data-prevista') {
                    const dateParts = originalText.split('/');
                    if (dateParts.length === 3) {
                        input.type = 'date';
                        // Formato yyyy-mm-dd para input date
                        input.value = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    }
                }
                
                field.textContent = '';
                field.appendChild(input);
                field.classList.add('editing');
                input.focus();
                
                // Lidar com perda de foco ou Enter para salvar
                input.addEventListener('blur', saveChanges);
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveChanges();
                    }
                });
                
                function saveChanges() {
                    let newValue = input.value;
                    
                    // Para percentuais, adicionar % de volta
                    if (field.dataset.field === 'percentual-concluido' || 
                        field.dataset.field === 'percentual-esforco') {
                        newValue += '%';
                    }
                    
                    // Para datas, converter de volta para dd/mm/yyyy
                    if (field.dataset.field === 'data-prevista' && input.type === 'date') {
                        const date = new Date(input.value);
                        if (!isNaN(date.getTime())) {
                            const day = date.getDate().toString().padStart(2, '0');
                            const month = (date.getMonth() + 1).toString().padStart(2, '0');
                            const year = date.getFullYear();
                            newValue = `${day}/${month}/${year}`;
                        }
                    }
                    
                    field.textContent = newValue;
                    field.classList.remove('editing');
                }
            });
        });
        
        // Adicionar listener ao botão de modo de edição
        if (editModeBtn) {
            editModeBtn.addEventListener('click', toggleEditMode);
        }

        // --- CONFIGURAÇÃO DE GERAÇÃO DE PDF via html2pdf.js ---
        const generatePDFBtn = document.getElementById('generatePdfBtn');
        if (generatePDFBtn) {
            generatePDFBtn.addEventListener('click', function() {
                // Se estiver no modo de edição, salvar alterações primeiro
                if (editMode) {
                    toggleEditMode(); // Sai do modo de edição e salva alterações
                }
                
                // Mostra um indicador de carregamento para processos longos
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style.position = 'fixed';
                loadingOverlay.style.top = '0';
                loadingOverlay.style.left = '0';
                loadingOverlay.style.width = '100%';
                loadingOverlay.style.height = '100%';
                loadingOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.justifyContent = 'center';
                loadingOverlay.style.alignItems = 'center';
                loadingOverlay.style.zIndex = '9999';
                loadingOverlay.innerHTML = `
                    <div style="text-align: center;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Gerando PDF, aguarde...</p>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);

                // Obter elemento a ser convertido
                const element = document.getElementById('pdfContent');
                
                // Adiciona uma classe temporária para aplicar estilos de impressão
                element.classList.add('print-mode');
                
                // Mostra elementos que são apenas para PDF
                const pdfElements = element.querySelectorAll('.pdf-only');
                pdfElements.forEach(el => {
                    el.style.display = 'block';
                });
                
                // Esconde elementos que são apenas para tela
                const screenElements = element.querySelectorAll('.screen-only');
                screenElements.forEach(el => {
                    el.style.display = 'none';
                });
                
                // Nome do arquivo a ser gerado
                const projectName = reportData?.info_geral?.nome || 'status_report';
                const projectId = reportData?.info_geral?.id || '';
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `status_report_${projectName.toLowerCase().replace(/\s+/g, '_')}_${projectId}_${today}.pdf`;
                
                // Primeiro, otimiza os gráficos para o PDF
                updateCharts(true);
                
                // Espera um tempo para que os gráficos sejam renderizados corretamente
                setTimeout(() => {
                    try {
                        // Captura os canvas de gráficos e os converte para imagens para melhor compatibilidade
                        const chartCanvases = pdfContent.querySelectorAll('canvas');
                        const chartPromises = Array.from(chartCanvases).map(canvas => {
                            return new Promise((resolve) => {
                                const img = new Image();
                                img.src = canvas.toDataURL('image/png');
                                img.style.maxWidth = '100%';
                                img.style.height = 'auto';
                                img.onload = () => {
                                    // Substitui o canvas pela imagem
                                    canvas.parentNode.replaceChild(img, canvas);
                                    resolve();
                                };
                            });
                        });
                        
                        // Quando todas as imagens estiverem carregadas, gera o PDF
                        Promise.all(chartPromises).then(() => {
                            // Configuração para PDF profissional 
                            const pdfOptions = {
                                margin: [10, 10, 10, 10], // Margens simples e uniformes em mm
                                filename: filename,
                                image: { type: 'jpeg', quality: 0.98 },
                                html2canvas: { 
                                    scale: 2, // Resolução padrão
                                    useCORS: true,
                                    letterRendering: true,
                                    allowTaint: true,
                                    backgroundColor: '#ffffff',
                                    logging: true, // Habilitar logs para diagnóstico
                                    onclone: function(clonedDocument) {
                                        // Certifique-se de que os elementos estão visíveis
                                        const clonedContent = clonedDocument.getElementById('pdfContent');
                                        if (clonedContent) {
                                            // Remover classes que podem afetar visibilidade
                                            clonedContent.classList.add('print-mode');
                                            
                                            // Mostrar elementos PDF-only
                                            const pdfElements = clonedContent.querySelectorAll('.pdf-only');
                                            pdfElements.forEach(el => el.style.display = 'block');
                                            
                                            // Esconder elementos screen-only
                                            const screenElements = clonedContent.querySelectorAll('.screen-only');
                                            screenElements.forEach(el => el.style.display = 'none');
                                        }
                                    }
                                },
                                jsPDF: { 
                                    unit: 'mm', 
                                    format: 'a4', 
                                    orientation: 'portrait',
                                    compress: true
                                },
                                pagebreak: { mode: 'avoid-all' }
                            };
                            
                            // Gerar o PDF com configuração básica
                            html2pdf().from(element).set(pdfOptions).save().then(() => {
                                // Restaurar elementos após gerar PDF
                                pdfElements.forEach(el => el.style.display = 'none');
                                screenElements.forEach(el => el.style.display = 'block');
                                element.classList.remove('print-mode');
                                document.body.removeChild(loadingOverlay);
                                
                                // Restaurar os canvas originais
                                updateCharts();
                            }).catch(error => {
                                console.error('Erro ao gerar PDF:', error);
                                alert('Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.');
                                document.body.removeChild(loadingOverlay);
                                
                                // Restaurar os canvas originais
                                updateCharts();
                            });
                        });
                    } catch (error) {
                        console.error('Erro ao preparar PDF:', error);
                        alert('Ocorreu um erro ao preparar o PDF. Por favor, tente novamente.');
                        document.body.removeChild(loadingOverlay);
                    }
                }, 300); // Tempo para garantir que os gráficos sejam renderizados
            });
        }
    });
</script>

<!-- Script para carregar a linha do tempo -->
<script>
// Formatação de data
function formatDateString(dateStr) {
    if (!dateStr) return "-";
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr; // Retorna a string original se a data for inválida
        return date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'});
    } catch (e) {
        console.error("Erro ao formatar data:", e, dateStr);
        return dateStr;
    }
}

// Escapa HTML para tooltips seguros
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// Função para carregar a timeline de tarefas
document.addEventListener('DOMContentLoaded', function() {
    // Elementos DOM para manipulação
    const loadingElement = document.getElementById('timeline-loading');
    const errorElement = document.getElementById('timeline-error');
    const errorMessageElement = document.getElementById('timeline-error-message');
    const emptyElement = document.getElementById('timeline-empty');
    const contentElement = document.getElementById('timeline-content');
    
    // Listas para as tarefas
    const upcomingTasksList = document.getElementById('upcoming-tasks-list');
    const startedTasksList = document.getElementById('started-tasks-list');
    const completedTasksList = document.getElementById('completed-tasks-list');
    
    // Verifica se os elementos existem
    if (!loadingElement || !errorElement || !emptyElement || !contentElement ||
        !upcomingTasksList || !startedTasksList || !completedTasksList) {
        console.error("Elementos da linha do tempo não encontrados");
        return;
    }
    
    // Função para mostrar/ocultar elementos de status
    function setTimelineStatus(isLoading, hasError, errorMsg, isEmpty) {
        loadingElement.style.display = isLoading ? 'block' : 'none';
        errorElement.style.display = hasError ? 'block' : 'none';
        if (errorMsg) errorMessageElement.textContent = errorMsg;
        emptyElement.style.display = isEmpty ? 'block' : 'none';
        contentElement.style.display = (!isLoading && !hasError && !isEmpty) ? 'block' : 'none';
    }
    
    // Busca o ID do projeto da página
    const projectId = "{{ project_id }}";
    if (!projectId) {
        setTimelineStatus(false, true, "ID do projeto não definido", false);
        return;
    }
    
    // Busca o backlog do projeto
    console.log("Buscando backlog para projeto", projectId);
    fetch(`/backlog/api/projects/${projectId}/backlog`)
        .then(response => {
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error("Nenhum backlog encontrado para este projeto");
                }
                throw new Error(`Erro ao buscar backlog: ${response.status}`);
            }
            return response.json();
        })
        .then(backlogData => {
            const backlogId = backlogData.id;
            console.log("Backlog encontrado:", backlogId);
            
            // Agora busca as tarefas da timeline
            return fetch(`/backlog/api/backlogs/${backlogId}/timeline-tasks`);
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro ao carregar tarefas: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Dados da timeline recebidos:", data);
            
            // Verifica se há tarefas para exibir
            const hasUpcoming = data.upcoming_tasks && data.upcoming_tasks.length > 0;
            const hasStarted = data.recently_started && data.recently_started.length > 0;
            const hasCompleted = data.recently_completed && data.recently_completed.length > 0;
            
            if (!hasUpcoming && !hasStarted && !hasCompleted) {
                setTimelineStatus(false, false, null, true);
                return;
            }
            
            // Renderiza tarefas futuras
            if (hasUpcoming) {
                let html = '';
                // Adicionar cabeçalho
                html += `
                    <div class="column-headers">
                        <div class="task-column">Tarefa</div>
                        <div class="status-column">Status</div>
                        <div class="date-column">Período</div>
                    </div>
                `;
                data.upcoming_tasks.forEach(task => {
                    const startDate = task.start_date ? formatDateString(task.start_date) : '-';
                    const dueDate = task.due_date ? formatDateString(task.due_date) : '-';
                    
                    html += `
                        <li class="list-group-item" title="${escapeHtml(task.description || '')}">
                            <span class="timeline-task-name">${escapeHtml(task.title)}</span>
                            <div class="status-container">
                                <span class="badge bg-secondary">A Fazer</span>
                            </div>
                            <span class="text-muted small">
                                ${startDate} → ${dueDate}
                            </span>
                        </li>
                    `;
                });
                upcomingTasksList.innerHTML = html || '<li class="list-group-item text-center text-muted small">Nenhuma tarefa futura</li>';
            } else {
                upcomingTasksList.innerHTML = '<li class="list-group-item text-center text-muted small">Nenhuma tarefa futura</li>';
            }
            
            // Renderiza tarefas em andamento
            if (hasStarted) {
                let html = '';
                // Adicionar cabeçalho
                html += `
                    <div class="column-headers">
                        <div class="task-column">Tarefa</div>
                        <div class="status-column">Status</div>
                        <div class="date-column">Período</div>
                    </div>
                `;
                data.recently_started.forEach(task => {
                    const startDate = task.start_date ? formatDateString(task.start_date) : '-';
                    const dueDate = task.due_date ? formatDateString(task.due_date) : '-';
                    
                    html += `
                        <li class="list-group-item" title="${escapeHtml(task.description || '')}">
                            <span class="timeline-task-name">${escapeHtml(task.title)}</span>
                            <div class="status-container">
                                <span class="badge bg-primary">Andamento</span>
                            </div>
                            <span class="text-muted small">
                                ${startDate} → ${dueDate}
                            </span>
                        </li>
                    `;
                });
                startedTasksList.innerHTML = html || '<li class="list-group-item text-center text-muted small">Nenhuma tarefa em andamento</li>';
            } else {
                startedTasksList.innerHTML = '<li class="list-group-item text-center text-muted small">Nenhuma tarefa em andamento</li>';
            }
            
            // Renderiza tarefas concluídas
            if (hasCompleted) {
                let html = '';
                // Adicionar cabeçalho
                html += `
                    <div class="column-headers">
                        <div class="task-column">Tarefa</div>
                        <div class="status-column">Status</div>
                        <div class="date-column">Data Conclusão</div>
                    </div>
                `;
                data.recently_completed.forEach(task => {
                    const completedDate = task.completed_at ? formatDateString(task.completed_at) : '-';
                    
                    html += `
                        <li class="list-group-item" title="${escapeHtml(task.description || '')}">
                            <span class="timeline-task-name">${escapeHtml(task.title)}</span>
                            <div class="status-container">
                                <span class="badge bg-success">Concluído</span>
                            </div>
                            <span class="text-muted small">
                                ${completedDate}
                            </span>
                        </li>
                    `;
                });
                completedTasksList.innerHTML = html || '<li class="list-group-item text-center text-muted small">Nenhuma tarefa concluída</li>';
            } else {
                completedTasksList.innerHTML = '<li class="list-group-item text-center text-muted small">Nenhuma tarefa concluída</li>';
            }
            
            // Mostra o conteúdo
            setTimelineStatus(false, false, null, false);
        })
        .catch(error => {
            console.error("Erro ao carregar timeline:", error);
            setTimelineStatus(false, true, error.message, false);
        });
});
</script>
{% endblock %}