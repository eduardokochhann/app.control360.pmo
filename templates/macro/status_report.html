{% extends "base.html" %}

{% block title %}{{ titulo_pagina if titulo_pagina else 'Status Report' }}{% endblock %}

{% block extra_css %}
<style>
    .status-dot {
        height: 25px;
        width: 25px;
        border-radius: 50%;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
        border: 3px solid #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .status-verde { background-color: #1cc88a; } /* Verde do template */
    .status-amarelo { background-color: #f6c23e; } /* Amarelo do template */
    .status-vermelho { background-color: #e74a3b; } /* Vermelho do template */
    .status-cinza { background-color: #858796; } /* Cinza do template */
    .status-text { font-weight: 600; font-size: 1.1rem; }
    .kpi-card .card-body {
        display: flex;
        align-items: center;
        height: 85px;
        padding: 0.5rem 0.8rem;
    }
    .kpi-card .kpi-content {
        width: 100%;
        margin-left: 0.8rem;
    }
    .kpi-card .kpi-icon {
        font-size: 1.8rem;
        color: #dddfeb;
    }
    .kpi-card .text-xs {
        font-size: 0.65rem;
        display: block;
        margin-bottom: -2px;
    }
    .kpi-card .h1, .kpi-card .h5 {
        font-size: 1.4rem;
        margin-bottom: 0;
        line-height: 1.1;
    }
    .kpi-card small.text-muted {
        font-size: 0.65rem;
        line-height: 1;
        display: block;
        margin-top: 1px;
    }
    .chart-card .card-body {
         min-height: 220px;
         padding: 0.8rem;
    }
    .chart-card canvas {
        max-height: 200px;
    }
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid #e3e6f0;
    }
    .project-details-header {
        font-size: 0.85rem;
        color: #5a5c69;
        margin-bottom: 1.5rem;
        padding: 0.8rem;
        background-color: #f8f9fc;
        border-radius: 0.35rem;
        border: 1px solid #e3e6f0;
    }
    .project-details-header strong {
        margin-right: 5px;
    }
    .project-details-header span {
        margin-right: 15px;
    }
    .list-group-item {
        background-color: transparent;
        border-left: none;
        border-right: none;
        border-top: 1px solid #e3e6f0;
        padding: 0.6rem 0;
        font-size: 0.85rem;
    }
    .list-group-item:first-child {
        border-top: none;
    }
    .placeholder-section {
        background-color: #f8f9fc;
        border: 1px dashed #d1d3e2;
        padding: 1rem;
        border-radius: 0.35rem;
        text-align: center;
        color: #858796;
        margin-top: 1rem;
        font-size: 0.85rem;
    }
    .placeholder-section i {
        font-size: 1.2rem;
        margin-bottom: 0.4rem;
        display: block;
    }
    .placeholder-section h6 {
         font-size: 0.9rem;
    }

    /* --- Estilos para Geração de PDF (WeasyPrint) --- */
    @media print {
        @page {
            size: A4 portrait; /* Define tamanho e orientação */
            margin: 1.5cm; /* Margens da página */
        }

        body {
            font-size: 10pt; /* Tamanho de fonte base para PDF */
            background-color: #fff !important; /* Garante fundo branco */
            -webkit-print-color-adjust: exact; /* Força cores de fundo em alguns renderizadores */
            print-color-adjust: exact;
        }

        /* Esconde elementos da UI */
        .navbar, /* Esconde a navbar do base.html (se estendido) */
        #accordionSidebar, /* Esconde a sidebar */
        #content > nav, /* Esconde a topbar dentro do content */
        footer.sticky-footer, /* Esconde o footer */
        .scroll-to-top, /* Esconde botão de scroll */
        .btn-outline-secondary, /* Esconde o próprio botão de imprimir/download */
        .d-sm-flex.align-items-center.justify-content-between.mb-3 > div:last-child /* Esconde div com data e botão */
        {
            display: none !important;
        }

        /* Ajusta container principal */
        #content-wrapper, #content {
             padding: 0 !important;
             margin: 0 !important;
             background-color: #fff !important;
        }
        .container, .container-fluid {
            padding-left: 0 !important;
            padding-right: 0 !important;
             max-width: 100% !important; /* Ocupa largura disponível dentro das margens */
        }
        
        /* Ajusta Título Principal */
         .d-sm-flex.align-items-center.justify-content-between.mb-3 > h1 {
             margin-bottom: 0.8rem !important; /* Espaço abaixo do título */
             font-size: 16pt; /* Tamanho maior para título */
             width: 100%; /* Ocupa toda a largura */
             text-align: center; /* Centraliza título */
             border-bottom: 1px solid #ccc; /* Linha abaixo do título */
             padding-bottom: 0.5rem;
         }
         /* Remove justificar do flex para centralizar título */
         .d-sm-flex.align-items-center.justify-content-between.mb-3 {
             justify-content: center !important; 
         }

        /* Ajusta Detalhes do Projeto */
        .project-details-header {
            font-size: 9pt;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            box-shadow: none;
            background-color: #f9f9f9 !important; /* Fundo leve */
        }
        .project-details-header span {
            margin-right: 10px;
        }

        /* Ajusta Cards */
        .card {
            box-shadow: none !important; /* Remove sombra */
            border: 1px solid #ddd !important; /* Borda simples */
            margin-bottom: 0.8rem;
            page-break-inside: avoid; /* Evita quebrar card entre páginas */
        }
        .card-header {
            background-color: #f5f5f5 !important; /* Fundo do header mais claro */
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid #ddd !important;
        }
         .card-header h6 {
            font-size: 10pt; 
         }
        .border-left-primary, .border-left-info, .border-left-warning, .border-left-success {
            border-left: 3px solid !important; /* Mantém a cor da borda, mas mais fina */
        }

        /* Ajusta KPIs */
        .kpi-card .card-body {
            height: auto; /* Altura automática */
            min-height: 65px; /* Altura mínima */
            padding: 0.4rem 0.6rem;
        }
        .kpi-card .kpi-icon {
            font-size: 1.5rem;
        }
        .kpi-card .text-xs { font-size: 7pt; }
        .kpi-card .h1, .kpi-card .h5 { font-size: 12pt; }
        .kpi-card small.text-muted { font-size: 7pt; }
        .status-dot { height: 15px; width: 15px; border-width: 2px; }

        /* Ajusta Gráficos */
        .chart-card .card-body {
            min-height: 180px; /* Altura mínima */
            padding: 0.5rem;
        }
        canvas {
            max-width: 100% !important; /* Garante que caiba */
        }
        
        /* Ajusta Placeholders */
        .placeholder-section {
            background-color: #f9f9f9 !important;
            border: 1px solid #ddd !important;
            padding: 0.8rem;
            font-size: 8pt;
            page-break-inside: avoid;
        }
        .placeholder-section i { font-size: 1rem; margin-bottom: 0.2rem; }
        .placeholder-section h6 { font-size: 9pt; }

        /* Remove links */
        a { text-decoration: none !important; color: inherit !important; }
    }

</style>
{% endblock %}

{% block content %}

{% if error %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Erro ao Gerar Status Report</h4>
        <p>{{ error }}</p>
    </div>
{% elif report_data %}
    <!-- Cabeçalho da Página -->
    <div class="d-sm-flex align-items-center justify-content-between mb-3">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="bi bi-file-earmark-text me-2"></i>Status Report
        </h1>
        <div> <!-- Div para agrupar data e botão -->
            <span class="text-muted small me-3">Gerado em: {{ data_geracao | default('N/A', true) }}</span>
            {% if weasyprint_installed %}
                <a href="{{ url_for('macro.download_status_report', project_id=project_id) }}" 
                   class="btn btn-sm btn-primary" 
                   title="Baixar Relatório em PDF">
                    <i class="bi bi-download me-1"></i> Baixar PDF
                </a>
            {% else %}
                 <button class="btn btn-sm btn-outline-secondary" onclick="window.print();" title="Gerador de PDF não instalado. Usando impressão do navegador.">
                    <i class="bi bi-printer me-1"></i> Imprimir
                </button>
                 <small class="text-danger ms-2" title="Instale WeasyPrint e dependências para download direto.">(PDF direto indisponível)</small>
            {% endif %}
        </div>
    </div>

    <!-- Detalhes do Projeto (Movido para o Cabeçalho) -->
    <div class="project-details-header">
        <span><strong>Projeto:</strong> {{ report_data.info_geral.nome | default('N/A') }}</span>
        <span><strong>ID:</strong> {{ report_data.info_geral.id | default('N/A') }}</span>
        <span><strong>Status Atual:</strong> {{ report_data.info_geral.status_atual | default('N/A') }}</span>
        <span><strong>Squad:</strong> {{ report_data.info_geral.squad | default('N/A') }}</span>
        <span><strong>Especialista:</strong> {{ report_data.info_geral.especialista | default('N/A') }}</span>
    </div>

    <!-- Linha de KPIs Resumo -->
    <div class="row">
        <!-- Status Geral -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-clipboard-data kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Status Geral</div>
                        {% set status_color_class = report_data.status_geral_indicador | default('cinza') %}
                        <div class="d-flex align-items-center">
                             <span class="status-dot status-{{ status_color_class }}" style="height:20px; width:20px; margin-right:5px;"></span>
                             <span class="h5 status-text text-{{ status_color_class }}">{{ status_color_class | capitalize | default('A Definir') }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- % Concluído -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-check2-circle kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">% Concluído</div>
                        <div class="h1 mb-0 font-weight-bold text-gray-800">{{ report_data.progresso.percentual_concluido | round(1) }}%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Prazo -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-calendar-week kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Status do Prazo</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ report_data.progresso.status_prazo | default('A Definir') }}</div>
                        <small class="text-muted">Prev: {{ report_data.progresso.data_prevista_termino | default('N/A', true) }}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- % Esforço Consumido -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2 kpi-card">
                <div class="card-body">
                    <i class="bi bi-hourglass-split kpi-icon"></i>
                    <div class="kpi-content">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">% Esforço Consumido</div>
                        <div class="h1 mb-0 font-weight-bold text-gray-800">{{ report_data.esforco.percentual_consumido | round(1) }}%</div>
                        <small class="text-muted">{{ report_data.esforco.horas_utilizadas | round(1) }}h / {{ report_data.esforco.horas_planejadas | round(1) }}h</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Linha de Gráficos (Lado a Lado) -->
    <div class="row">
        <!-- Coluna Esquerda: Gráfico de Progresso -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow chart-card h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Progresso (% Concluído)</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <canvas id="progressoChart" style="max-height: 200px;"></canvas>
                </div>
            </div>
        </div>
        <!-- Coluna Direita: Gráfico de Esforço -->
        <div class="col-lg-6 mb-4">
             <div class="card shadow chart-card h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Esforço (Horas Planejado vs Utilizado)</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <canvas id="esforcoChart" style="max-height: 200px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Linha para Placeholders -->
    <div class="row">
        <div class="col-md-4">
            <div class="placeholder-section">
                <i class="bi bi-calendar-check"></i>
                <h6 class="section-title text-center">Marcos Recentes</h6>
                <p>[Dados sobre marcos recentes serão adicionados aqui]</p>
            </div>
        </div>
        <div class="col-md-4">
             <div class="placeholder-section">
                 <i class="bi bi-list-task"></i>
                <h6 class="section-title text-center">Linha do Tempo (Tarefas)</h6>
                <p>[Uma visualização da linha do tempo das tarefas será adicionada aqui]</p>
            </div>
        </div>
        <div class="col-md-4">
             <div class="placeholder-section">
                <i class="bi bi-exclamation-triangle"></i>
                <h6 class="section-title text-center">Riscos e Impedimentos</h6>
                <p>[Informações sobre riscos e impedimentos serão exibidas aqui]</p>
            </div>
        </div>
    </div>

{% else %}
     <div class="alert alert-warning" role="alert">
        Não foi possível carregar os dados para o Status Report do projeto ID {{ project_id }}.
    </div>
{% endif %}

<!-- Script para passar dados para JS e inicializar gráficos -->
<script id="report-data-json" type="application/json">
    {{ report_data | tojson | safe if report_data else '{}' }}
</script>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const reportDataElement = document.getElementById('report-data-json');
        if (!reportDataElement) {
            console.error('Elemento com dados do report não encontrado!');
            return;
        }
        
        let reportData;
        try {
            reportData = JSON.parse(reportDataElement.textContent);
            console.log("Dados do Report para JS:", reportData);
        } catch (e) {
            console.error("Erro ao parsear dados JSON do report:", e);
            return;
        }

        // Verifica se os dados necessários existem ANTES de tentar criar os gráficos
        if (!reportData || !reportData.progresso || !reportData.esforco) {
            console.warn("Dados incompletos ou não encontrados para gerar gráficos.");
            // Opcional: Ocultar ou mostrar mensagem nos divs dos gráficos
             const progressoCanvas = document.getElementById('progressoChart');
            const esforcoCanvas = document.getElementById('esforcoChart');
            if (progressoCanvas) progressoCanvas.parentElement.innerHTML = '<p class="text-muted text-center mt-5">Dados de progresso indisponíveis.</p>';
            if (esforcoCanvas) esforcoCanvas.parentElement.innerHTML = '<p class="text-muted text-center mt-5">Dados de esforço indisponíveis.</p>';
            return; // Não tenta criar os gráficos
        }
        
        // Somente continua se reportData for válido
        try {
            // --- Gráfico de Progresso (Gauge/Doughnut) ---
            const progressoCtx = document.getElementById('progressoChart')?.getContext('2d'); // Adiciona '?' para segurança
            if (progressoCtx) {
                const percentualConcluido = reportData.progresso.percentual_concluido || 0;
                const corProgresso = percentualConcluido >= 70 ? '#1cc88a' : (percentualConcluido >= 50 ? '#f6c23e' : '#e74a3b');

                new Chart(progressoCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [percentualConcluido, 100 - percentualConcluido],
                            backgroundColor: [corProgresso, '#e9ecef'],
                            borderColor: [corProgresso, '#e9ecef'], // Adiciona borda para clareza
                            borderWidth: 1,
                            circumference: 180, // Meia rosca
                            rotation: 270 // Começa de baixo
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        aspectRatio: 2, // Ajusta proporção para meia rosca
                        cutout: '75%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false },
                            title: { display: false },
                            animation: {
                                onComplete: function(animation) {
                                    var chartInstance = animation.chart,
                                        ctx = chartInstance.ctx;
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    ctx.font = "bold 24px Inter"; // Ajuste fonte e tamanho

                                    // Pega o valor do primeiro dataset
                                    var value = chartInstance.data.datasets[0].data[0];
                                    // Pega a cor do primeiro dataset
                                    var color = chartInstance.data.datasets[0].backgroundColor[0]; 
                                    ctx.fillStyle = color;

                                    var x = chartInstance.width / 2;
                                    var y = chartInstance.height / 1.1; // Ajusta posição Y para meia rosca
                                    
                                    ctx.fillText(value + '%', x, y);
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn("Elemento canvas 'progressoChart' não encontrado.");
            }

            // --- Gráfico de Esforço (Barras) ---
            const esforcoCtx = document.getElementById('esforcoChart')?.getContext('2d'); // Adiciona '?' para segurança
             if (esforcoCtx) {
                const horasPlanejadas = reportData.esforco.horas_planejadas || 0;
                const horasUtilizadas = reportData.esforco.horas_utilizadas || 0;
                const corPlanejado = '#adb5bd'; // Cinza mais claro
                const corUtilizado = horasUtilizadas > horasPlanejadas ? '#e74a3b' : '#4e73df'; // Vermelho se estourou, Azul senão

                new Chart(esforcoCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Utilizado', 'Planejado'], // Ordem invertida para foco no utilizado
                        datasets: [
                            {
                                label: 'Horas',
                                data: [horasUtilizadas, horasPlanejadas],
                                backgroundColor: [corUtilizado, corPlanejado],
                                borderColor: [corUtilizado, corPlanejado],
                                borderWidth: 1,
                                barPercentage: 0.5, 
                                categoryPercentage: 0.6
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false,
                         aspectRatio: 2.5,
                        plugins: {
                            legend: { display: false }, // Remove a legenda, cores já indicam
                            title: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed.x.toFixed(1) + 'h';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Horas'
                                }
                            },
                            y: {
                                // display: false 
                            }
                        }
                    }
                });
            } else {
                 console.warn("Elemento canvas 'esforcoChart' não encontrado.");
            }
        } catch (chartError) {
            console.error("Erro ao criar gráficos:", chartError);
             // Opcional: Mostrar erro no lugar dos gráficos
        }

    });
</script>
{% endblock %} 