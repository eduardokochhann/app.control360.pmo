{% extends "base.html" %}

{% block title %}{{ titulo_pagina if titulo_pagina else 'Status Report' }}{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* === CORES SOU.CLOUD === */
    :root {
        --sou-rosa: #FF2D5F;
        --sou-azul: #07304F;
        --sou-azul-claro: #4a90e2;
        --sou-cinza: #f8f9fc;
        --sou-cinza-escuro: #5a5c69;
    }

    /* === CONTROLE DE VISIBILIDADE === */
    .pdf-only {
        display: none;
    }
    
    .hours-private {
        display: block;
    }
    
    .hours-public {
        display: none;
    }
    
    /* Quando em modo público, inverte a visibilidade */
    .public-mode .hours-private {
        display: none !important;
    }
    
    .public-mode .hours-public {
        display: block !important;
    }
    
    /* Forçar visibilidade padrão no modo privado */
    body:not(.public-mode) .hours-private {
        display: block !important;
    }
    
    body:not(.public-mode) .hours-public {
        display: none !important;
    }

    /* === CABEÇALHO PROFISSIONAL === */
    .sou-header {
        background: linear-gradient(135deg, var(--sou-azul) 0%, var(--sou-azul-claro) 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0.5rem;
        position: relative;
        overflow: hidden;
    }
    
    .sou-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 100%;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 45, 95, 0.1) 100%);
    }
    
    .sou-header .container-fluid {
        position: relative;
        z-index: 2;
    }
    
    .sou-logo {
        max-height: 60px;
        filter: brightness(0) invert(1);
    }
    
    .report-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .report-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-top: 0.5rem;
    }

    /* === CARDS DE KPI PROFISSIONAIS === */
    .kpi-card-modern {
        border: none;
        border-radius: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 0.25rem 1rem rgba(0,0,0,0.1);
    }
    
    .kpi-card-modern:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 2rem rgba(0,0,0,0.15);
    }
    
    .kpi-card-modern .card-body {
        padding: 1.5rem;
        position: relative;
    }
    
    .kpi-icon-modern {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2.5rem;
        opacity: 0.1;
        color: var(--sou-azul);
    }
    
    .kpi-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--sou-cinza-escuro);
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .kpi-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--sou-azul);
        line-height: 1;
        margin-bottom: 0.25rem;
    }
    
    .kpi-subtitle {
        font-size: 0.8rem;
        color: var(--sou-cinza-escuro);
        opacity: 0.8;
    }
    
    /* Variações de cores para KPIs */
    .kpi-status .kpi-icon-modern { color: var(--sou-rosa); }
    .kpi-progress .kpi-icon-modern { color: #28a745; }
    .kpi-schedule .kpi-icon-modern { color: #ffc107; }
    .kpi-effort .kpi-icon-modern { color: var(--sou-azul-claro); }

    /* === STATUS DOTS MELHORADOS === */
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-dot-modern {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        position: relative;
    }
    
    .status-dot-modern::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.5; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .status-no-prazo { background-color: #28a745; }
    .status-no-prazo::after { background-color: #28a745; }
    
    .status-atencao { background-color: #ffc107; }
    .status-atencao::after { background-color: #ffc107; }
    
    .status-critico { background-color: var(--sou-rosa); }
    .status-critico::after { background-color: var(--sou-rosa); }
    
    .status-concluido { background-color: var(--sou-azul); }
    .status-concluido::after { background-color: var(--sou-azul); }

    /* === INFORMAÇÕES DO PROJETO === */
    .project-info-modern {
        background: linear-gradient(135deg, #ffffff 0%, var(--sou-cinza) 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(7, 48, 79, 0.1);
    }
    
    .project-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .project-info-item {
        display: flex;
        flex-direction: column;
    }
    
    .project-info-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--sou-cinza-escuro);
        margin-bottom: 0.25rem;
        letter-spacing: 0.5px;
    }
    
    .project-info-value {
        font-size: 1rem;
        font-weight: 600;
        color: var(--sou-azul);
    }

    /* === SEÇÕES DE CONTEÚDO === */
    .content-section {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.05);
        border: 1px solid rgba(7, 48, 79, 0.1);
    }
    
    .section-header-modern {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--sou-cinza);
    }
    
    .section-icon {
        background: linear-gradient(135deg, var(--sou-rosa) 0%, #ff4569 100%);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.1rem;
    }
    
    .section-title-modern {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--sou-azul);
        margin: 0;
    }

    /* === TABELAS PROFISSIONAIS === */
    .table-modern {
        margin-bottom: 0;
    }
    
    .table-modern thead th {
        background: linear-gradient(135deg, var(--sou-azul) 0%, var(--sou-azul-claro) 100%);
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        padding: 1rem 0.75rem;
    }
    
    .table-modern tbody td {
        vertical-align: middle;
        padding: 0.75rem;
        border-bottom: 1px solid rgba(7, 48, 79, 0.1);
    }
    
    .table-modern tbody tr:hover {
        background-color: rgba(7, 48, 79, 0.02);
    }

    /* === BADGES MODERNOS === */
    .badge-modern {
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.75rem;
    }
    
    .badge-success-modern { background-color: #28a745; }
    .badge-warning-modern { background-color: #ffc107; color: #000; }
    .badge-danger-modern { background-color: var(--sou-rosa); }
    .badge-primary-modern { background-color: var(--sou-azul); }
    .badge-info-modern { background-color: var(--sou-azul-claro); }

    /* === BOTÕES PROFISSIONAIS === */
    .btn-sou-primary {
        background: linear-gradient(135deg, var(--sou-azul) 0%, var(--sou-azul-claro) 100%);
        border: none;
        color: white;
        font-weight: 600;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }
    
    .btn-sou-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(7, 48, 79, 0.3);
    }
    
    .btn-sou-secondary {
        background: linear-gradient(135deg, var(--sou-rosa) 0%, #ff4569 100%);
        border: none;
        color: white;
        font-weight: 600;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }
    
    .btn-sou-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(255, 45, 95, 0.3);
    }

    /* === TOGGLE PARA VISIBILIDADE DE HORAS === */
    .hours-visibility-toggle {
        position: fixed;
        top: 100px;
        left: 20px;
        z-index: 1000;
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 0.25rem 1rem rgba(0,0,0,0.15);
        border: 1px solid rgba(7, 48, 79, 0.1);
        transition: all 0.3s ease;
    }
    
    .toggle-hide-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: var(--sou-cinza-escuro);
        font-size: 0.8rem;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s ease;
        opacity: 0.6;
    }
    
    .toggle-hide-btn:hover {
        background-color: rgba(255, 45, 95, 0.1);
        color: var(--sou-rosa);
        opacity: 1;
        transform: scale(1.1);
    }
    
    .hours-visibility-toggle.hidden {
        transform: translateX(-100%);
        opacity: 0;
        pointer-events: none;
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: var(--sou-azul);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    /* === ESTILOS TIMELINE === */
    .timeline-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(7, 48, 79, 0.1);
    }
    
    .timeline-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .timeline-section .section-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: rgba(7, 48, 79, 0.02);
        border-radius: 0.5rem;
        border-left: 4px solid var(--sou-azul);
    }
    
    .timeline-section .section-header i {
        margin-right: 0.5rem;
        font-size: 1.1rem;
    }
    
    .timeline-section .section-header span {
        font-weight: 600;
        font-size: 1rem;
        color: var(--sou-azul);
    }

    /* === ESTILOS PARA PDF === */
    @media print {
        @page {
            size: A4 portrait;
            margin: 1cm;
        }
        
        .pdf-only {
            display: block !important;
        }
        
        .screen-only {
            display: none !important;
        }
        
        .hours-visibility-toggle {
            display: none !important;
        }
        
        .sou-header {
            background: var(--sou-azul) !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        
        .kpi-card-modern {
            page-break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
        }
        
        .content-section {
            page-break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
        }
        
        .section-icon {
            background: var(--sou-rosa) !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        
        .table-modern thead th {
            background: var(--sou-azul) !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        
        .timeline-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
            page-break-inside: avoid;
        }
        
        .timeline-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .timeline-section .section-header {
            background: rgba(7, 48, 79, 0.05) !important;
            border-left: 3px solid var(--sou-azul) !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
    }

    /* === BOTÕES PROFISSIONAIS === */
    .btn-sou-primary {
        background: linear-gradient(135deg, var(--sou-azul) 0%, var(--sou-azul-claro) 100%);
        border: none;
        color: white;
        font-weight: 600;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }
    
    .btn-sou-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(7, 48, 79, 0.3);
        color: white;
    }
    
    .btn-sou-secondary {
        background: linear-gradient(135deg, var(--sou-rosa) 0%, #ff4569 100%);
        border: none;
        color: white;
        font-weight: 600;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }
    
    .btn-sou-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(255, 45, 95, 0.3);
        color: white;
    }

    /* === SEÇÕES DE CONTEÚDO === */
    .content-section {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.05);
        border: 1px solid rgba(7, 48, 79, 0.1);
    }
    
    .section-header-modern {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--sou-cinza);
    }
    
    .section-icon {
        background: linear-gradient(135deg, var(--sou-rosa) 0%, #ff4569 100%);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.1rem;
    }
    
    .section-title-modern {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--sou-azul);
        margin: 0;
    }

    /* === TABELAS PROFISSIONAIS === */
    .table-modern {
        margin-bottom: 0;
    }
    
    .table-modern thead th {
        background: linear-gradient(135deg, var(--sou-azul) 0%, var(--sou-azul-claro) 100%);
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
        padding: 1rem 0.75rem;
    }
    
    .table-modern tbody td {
        vertical-align: middle;
        padding: 0.75rem;
        border-bottom: 1px solid rgba(7, 48, 79, 0.1);
    }
    
    .table-modern tbody tr:hover {
        background-color: rgba(7, 48, 79, 0.02);
    }

    /* === BADGES MODERNOS === */
    .badge-modern {
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.75rem;
    }
    
    .badge-success-modern { background-color: #28a745; }
    .badge-warning-modern { background-color: #ffc107; color: #000; }
    .badge-danger-modern { background-color: var(--sou-rosa); }
    .badge-primary-modern { background-color: var(--sou-azul); }
    .badge-info-modern { background-color: var(--sou-azul-claro); }

    /* === ESTILOS PARA PDF === */
    @media print {
        @page {
            size: A4 portrait;
            margin: 1cm;
        }
        
        .pdf-only {
            display: block !important;
        }
        
        .screen-only {
            display: none !important;
        }
        
        .hours-visibility-toggle {
            display: none !important;
        }
        
        .sou-header {
            background: var(--sou-azul) !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        
        .kpi-card-modern {
            page-break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
        }
        
        .content-section {
            page-break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
        }
        
        .section-icon {
            background: var(--sou-rosa) !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
        
        .table-modern thead th {
            background: var(--sou-azul) !important;
            -webkit-print-color-adjust: exact;
            color-adjust: exact;
        }
    }

    /* === RESPONSIVIDADE === */
    @media (max-width: 768px) {
        .report-title {
            font-size: 2rem;
        }
        
        .project-info-grid {
            grid-template-columns: 1fr;
        }
        
        .hours-visibility-toggle {
            position: relative;
            right: auto;
            top: auto;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if error %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Erro ao Gerar Status Report</h4>
            <p>{{ error }}</p>
        </div>
    {% elif report_data %}
        
        <!-- Toggle de Visibilidade de Horas (só na tela) -->
        <div class="hours-visibility-toggle screen-only" id="hoursToggleContainer">
            <button class="toggle-hide-btn" onclick="hideToggle()" title="Ocultar controle (Ctrl+Shift+M para mostrar)">
                <i class="bi bi-x"></i>
            </button>
            <div class="d-flex align-items-center">
                <span class="me-2 small fw-bold">Modo Cliente:</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="publicModeToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="ms-2 small">
                    <span class="private-label">Detalhado</span>
                    <span class="public-label" style="display: none;">Público</span>
                </span>
            </div>
            <small class="text-muted d-block mt-1">
                <span class="private-desc">Mostra valores de horas</span>
                <span class="public-desc" style="display: none;">Oculta valores sensíveis</span>
            </small>
        </div>

        <!-- Cabeçalho Principal -->
        <div class="sou-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <img src="{{ url_for('static', filename='images/sou.cloud.png') }}" alt="SOU.cloud" class="sou-logo">
                    </div>
                    <div class="col-md-8 text-center">
                        <h1 class="report-title">Status Report</h1>
                        <p class="report-subtitle">Relatório Executivo de Acompanhamento</p>
                    </div>
                    <div class="col-md-2 text-end">
                        <div class="screen-only">
                            <a href="{{ url_for('backlog.board_by_project', project_id=project_id) }}" 
                               class="btn btn-sou-secondary btn-sm me-2">
                                <i class="bi bi-kanban me-1"></i> Kanban
                            </a>
                            <button class="btn btn-sou-primary btn-sm" onclick="window.print();">
                                <i class="bi bi-printer me-1"></i> PDF
                            </button>
                        </div>
                        <div class="pdf-only text-white">
                            <strong>Data:</strong> {{ data_geracao | default('N/A', true) }}<br>
                            <strong>Versão:</strong> 1.0
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Container principal que será convertido para PDF -->
        <div id="pdfContent">
            
            <!-- Informações do Projeto -->
            <div class="project-info-modern">
                <div class="project-info-grid">
                    <div class="project-info-item">
                        <span class="project-info-label">Projeto</span>
                        <span class="project-info-value">{{ report_data.info_geral.nome | default('N/A') }}</span>
                    </div>
                    <div class="project-info-item">
                        <span class="project-info-label">ID</span>
                        <span class="project-info-value">{{ report_data.info_geral.id | default('N/A') }}</span>
                    </div>
                    <div class="project-info-item">
                        <span class="project-info-label">Squad</span>
                        <span class="project-info-value">{{ report_data.info_geral.squad | default('N/A') }}</span>
                    </div>
                    <div class="project-info-item">
                        <span class="project-info-label">Especialista</span>
                        <span class="project-info-value">{{ report_data.info_geral.especialista | default('N/A') }}</span>
                    </div>
                    <div class="project-info-item">
                        <span class="project-info-label">Prazo</span>
                        <span class="project-info-value">{{ report_data.info_geral.data_vencimento | default('A definir') }}</span>
                    </div>
                    <div class="project-info-item">
                        <span class="project-info-label">Status</span>
                        <span class="project-info-value">{{ report_data.info_geral.status_atual | default('N/A') }}</span>
                    </div>
                </div>
            </div>

            <!-- KPIs Principais -->
            <div class="row mb-4">
                <!-- Status Geral -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card kpi-card-modern kpi-status h-100">
                        <div class="card-body">
                            <i class="bi bi-speedometer2 kpi-icon-modern"></i>
                            <span class="kpi-label">Status Geral</span>
                            {% set status_color_class = report_data.status_geral_indicador | default('cinza') %}
                            {% set status_text_map = {
                                'verde': 'Saudável',
                                'amarelo': 'Atenção',
                                'vermelho': 'Crítico',
                                'azul': 'Concluído',
                                'cinza': 'Não Iniciado'
                            } %}
                            <div class="status-indicator">
                                <span class="status-dot-modern status-{{ status_color_class.replace('verde', 'no-prazo').replace('amarelo', 'atencao').replace('vermelho', 'critico').replace('azul', 'concluido') }}"></span>
                                <span class="kpi-value">{{ status_text_map.get(status_color_class, 'Não Iniciado') }}</span>
                            </div>
                            <div class="kpi-subtitle">Situação atual do projeto</div>
                        </div>
                    </div>
                </div>

                <!-- Progresso -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card kpi-card-modern kpi-progress h-100">
                        <div class="card-body">
                            <i class="bi bi-graph-up kpi-icon-modern"></i>
                            <span class="kpi-label">Progresso</span>
                            <div class="kpi-value">{{ report_data.progresso.percentual_concluido | round(1) }}%</div>
                            <div class="kpi-subtitle">Conclusão das atividades</div>
                        </div>
                    </div>
                </div>

                <!-- Status do Prazo -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card kpi-card-modern kpi-schedule h-100">
                        <div class="card-body">
                            <i class="bi bi-calendar-check kpi-icon-modern"></i>
                            <span class="kpi-label">Cronograma</span>
                            <div class="kpi-value" style="font-size: 1.5rem;">{{ report_data.progresso.status_prazo | default('A Definir') }}</div>
                            <div class="kpi-subtitle">Prev: {{ report_data.progresso.data_prevista_termino | default(report_data.info_geral.data_vencimento | default('N/A', true)) }}</div>
                        </div>
                    </div>
                </div>

                <!-- Esforço (com controle de visibilidade) -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card kpi-card-modern kpi-effort h-100">
                        <div class="card-body">
                            <i class="bi bi-hourglass-split kpi-icon-modern"></i>
                            <span class="kpi-label">Esforço</span>
                            
                            <!-- Versão Privada (com valores) -->
                            <div class="hours-private">
                                <div class="kpi-value">{{ report_data.esforco.percentual_consumido | round(1) }}%</div>
                                <div class="kpi-subtitle">{{ report_data.esforco.horas_utilizadas | round(1) }}h / {{ report_data.esforco.horas_planejadas | round(1) }}h</div>
                            </div>
                            
                            <!-- Versão Pública (sem valores específicos) -->
                            <div class="hours-public">
                                {% if report_data.esforco.percentual_consumido | round(1) <= 80 %}
                                    <div class="kpi-value" style="font-size: 1.4rem;">Dentro do Previsto</div>
                                    <div class="kpi-subtitle">Consumo controlado</div>
                                {% elif report_data.esforco.percentual_consumido | round(1) <= 100 %}
                                    <div class="kpi-value" style="font-size: 1.4rem;">Próximo ao Limite</div>
                                    <div class="kpi-subtitle">Monitoramento ativo</div>
                                {% else %}
                                    <div class="kpi-value" style="font-size: 1.4rem;">Acima do Previsto</div>
                                    <div class="kpi-subtitle">Requer atenção</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Linha de Gráficos (Lado a Lado) -->
            <div class="row">
                <!-- Coluna Esquerda: Gráfico de Progresso -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow chart-card h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Progresso (% Concluído)</h6>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <canvas id="progressoChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Coluna Direita: Gráfico de Esforço -->
                <div class="col-lg-6 mb-4">
                     <div class="card shadow chart-card h-100">
                        <div class="card-header py-3">
                            <!-- Título privado (com valores de horas) -->
                            <h6 class="m-0 font-weight-bold text-primary hours-private">Esforço (Horas Planejado vs Utilizado)</h6>
                            <!-- Título público (progresso de tarefas) -->
                            <h6 class="m-0 font-weight-bold text-primary hours-public">Progresso das Tarefas</h6>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <!-- Gráfico privado (com valores de horas detalhados) -->
                            <canvas id="esforcoChart" class="hours-private" style="max-height: 200px;"></canvas>
                            
                            <!-- Gráfico público (tarefas criadas vs concluídas) -->
                            <canvas id="tarefasChart" class="hours-public" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marcos Recentes (Linha inteira) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="content-section">
                        <div class="section-header-modern">
                            <div class="section-icon">
                                <i class="bi bi-calendar-check"></i>
                            </div>
                            <h6 class="section-title-modern">Marcos Recentes</h6>
                        </div>
                        {% if report_data and report_data.marcos_recentes and report_data.marcos_recentes|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-modern">
                                    <thead>
                                        <tr>
                                            <th style="width: 50%">Marco</th>
                                            <th style="width: 20%">Status</th>
                                            <th style="width: 30%">Data Planejada</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for marco in report_data.marcos_recentes %}
                                            <tr {% if marco.atrasado %}class="table-danger"{% endif %}>
                                                <td>
                                                    {% if marco.atrasado %}<span class="badge bg-danger me-1" title="Marco atrasado!">!</span>{% endif %}
                                                    <span class="milestone-name">{{ marco.nome | default(marco.title | default('Marco sem nome')) }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if marco.status == 'Concluído' or marco.status == 'Completed' %}bg-success
                                                        {% elif marco.status == 'Em Andamento' or marco.status == 'In Progress' %}bg-primary
                                                        {% elif marco.status == 'Atrasado' or marco.status == 'Delayed' %}bg-danger
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ marco.status | default('N/A') }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="milestone-date">{{ marco.data_planejada | default(marco.due_date | default('N/A')) }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">Nenhum marco definido para este projeto.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Linha do Tempo (Linha inteira) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="content-section">
                        <div class="section-header-modern">
                            <div class="section-icon">
                                <i class="bi bi-list-task"></i>
                            </div>
                            <h6 class="section-title-modern">Linha do Tempo (Tarefas)</h6>
                        </div>
                        <div class="card shadow-sm h-100" style="border: none; box-shadow: none !important; background: transparent;">
                            {# Mostrar loading apenas se NÃO for PDF #}
                            <div id="timeline-loading" class="text-center p-3" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <span class="text-muted small">Carregando tarefas...</span>
                            </div>
                            
                            <div id="timeline-error" class="text-center p-3 text-danger" style="display: none;">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                <span id="timeline-error-message" class="small">Erro ao carregar tarefas</span>
                            </div>
                            
                            <div id="timeline-empty" class="text-center p-3 text-muted" style="display: none;">
                                <i class="bi bi-info-circle me-2"></i>
                                <span class="small">Nenhuma tarefa encontrada</span>
                            </div>
                            
                            <!-- Lista de tarefas -->
                            {# Mostrar conteúdo da timeline: se for PDF, renderiza direto; senão, JS controla #}
                            <div id="timeline-content" style="display: block;">
                                <!-- Próximas tarefas - OCULTADO conforme solicitado -->
                                <div class="timeline-section" style="display: none;">
                                    <div class="section-header">
                                        <i class="bi bi-calendar-event text-warning"></i>
                                        <span class="fw-bold">Próximas Tarefas (7 dias)</span>
                                    </div>
                                    {% if report_data.tarefas_proximo_prazo and report_data.tarefas_proximo_prazo|length > 0 %}
                                        <div class="table-responsive">
                                            <table class="table table-modern">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 50%">Tarefa</th>
                                                        <th style="width: 20%">Prioridade</th>
                                                        <th style="width: 30%">Prazo</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for task in report_data.tarefas_proximo_prazo %}
                                                        <tr>
                                                            <td>
                                                                <span class="timeline-task-name">{{ task.titulo | default('Tarefa sem título') }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-warning text-dark">{{ task.prioridade | default('N/A') }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="text-muted small">{{ task.data_vencimento | default('-') }}</span>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted small p-3">Nenhuma tarefa com prazo nos próximos 7 dias.</div>
                                    {% endif %}
                                </div>
                                
                                <!-- 1. Tarefas concluídas -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-check-circle text-success"></i>
                                        <span class="fw-bold">Concluídas</span>
                                    </div>
                                    {% if report_data.tarefas_concluidas and report_data.tarefas_concluidas|length > 0 %}
                                        <div class="table-responsive">
                                            <table class="table table-modern">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 50%">Tarefa</th>
                                                        <th style="width: 20%">Prioridade</th>
                                                        <th style="width: 30%">Prazo/Conclusão</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for task in report_data.tarefas_concluidas %}
                                                        <tr>
                                                            <td>
                                                                <span class="timeline-task-name">{{ task.titulo | default('Tarefa sem título') }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-success">{{ task.prioridade | default('N/A') }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="text-muted small">{{ task.data_vencimento | default('-') }}</span>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted small p-3">Nenhuma tarefa concluída.</div>
                                    {% endif %}
                                </div>
                                
                                <!-- 2. Tarefas em Revisão -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-search text-info"></i>
                                        <span class="fw-bold">Em Revisão</span>
                                    </div>
                                    {% if report_data.tarefas_em_revisao and report_data.tarefas_em_revisao|length > 0 %}
                                        <div class="table-responsive">
                                            <table class="table table-modern">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 50%">Tarefa</th>
                                                        <th style="width: 20%">Prioridade</th>
                                                        <th style="width: 30%">Prazo</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for task in report_data.tarefas_em_revisao %}
                                                        <tr>
                                                            <td>
                                                                <span class="timeline-task-name">{{ task.titulo | default('Tarefa sem título') }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-info">{{ task.prioridade | default('N/A') }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="text-muted small">{{ task.data_vencimento | default('-') }}</span>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted small p-3">Nenhuma tarefa em revisão.</div>
                                    {% endif %}
                                </div>
                                
                                <!-- 3. Tarefas em andamento -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-play-circle text-primary"></i>
                                        <span class="fw-bold">Em Andamento</span>
                                    </div>
                                    {% if report_data.tarefas_em_andamento and report_data.tarefas_em_andamento|length > 0 %}
                                        <div class="table-responsive">
                                            <table class="table table-modern">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 50%">Tarefa</th>
                                                        <th style="width: 20%">Prioridade</th>
                                                        <th style="width: 30%">Prazo</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for task in report_data.tarefas_em_andamento %}
                                                        <tr>
                                                            <td>
                                                                <span class="timeline-task-name">{{ task.titulo | default('Tarefa sem título') }}</span>
                                                            </td>
                                                            <td>
                                                                <span class="badge bg-primary">{{ task.prioridade | default('N/A')}}</span>
                                                            </td>
                                                            <td>
                                                                <span class="text-muted small">{{ task.data_vencimento | default('-') }}</span>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted small p-3">Nenhuma tarefa em andamento.</div>
                                    {% endif %}
                                </div>
                                
                                <!-- 4. Tarefas Pendentes -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-pause-circle text-secondary"></i>
                                        <span class="fw-bold">Pendente</span>
                                    </div>
                                    {% if report_data.tarefas_pendentes and report_data.tarefas_pendentes|length > 0 %}
                                        <div class="table-responsive">
                                            <table class="table table-modern">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 50%">Tarefa</th>
                                                        <th style="width: 20%">Prioridade</th>
                                                        <th style="width: 30%">Prazo</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for task in report_data.tarefas_pendentes %}
                                                        <tr>
                                                            <td>
                                                                <span class="timeline-task-name">{{ task.titulo | default('Tarefa sem título') }}</span>
                                                            </td>
                                                            <td>
                                                                {% set priority_class = 'bg-secondary' %}
                                                                {% if task.prioridade == 'Alta' %} {% set priority_class = 'bg-warning text-dark' %}
                                                                {% elif task.prioridade == 'Urgente' %} {% set priority_class = 'bg-danger' %}
                                                                {% elif task.prioridade == 'Média' %} {% set priority_class = 'bg-info' %}
                                                                {% elif task.prioridade == 'Baixa' %} {% set priority_class = 'bg-success' %}{% endif %}
                                                                <span class="badge {{ priority_class }}">{{ task.prioridade | default('N/A')}}</span>
                                                            </td>
                                                            <td>
                                                                <span class="text-muted small">{{ task.data_vencimento | default('-') }}</span>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted small p-3">Nenhuma tarefa pendente.</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riscos e Impedimentos (Linha inteira) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="content-section">
                        <div class="section-header-modern">
                            <div class="section-icon">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                            <h6 class="section-title-modern">Riscos e Impedimentos</h6>
                        </div>
                        {% if report_data and report_data.riscos_impedimentos and report_data.riscos_impedimentos|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-modern">
                                    <thead>
                                        <tr>
                                            <th style="width: 50%">Descrição do Risco</th>
                                            <th style="width: 20%">Severidade</th>
                                            <th style="width: 30%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for risco in report_data.riscos_impedimentos %}
                                            <tr>
                                                <td>
                                                    <span class="risk-description">{{ risco.descricao | default('Sem descrição') }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if risco.severidade == 'Crítico' or risco.severidade == 'Critico' %}bg-danger
                                                        {% elif risco.severidade == 'Alto' or risco.severidade == 'Alta' %}bg-danger
                                                        {% elif risco.severidade == 'Médio' or risco.severidade == 'Medio' or risco.severidade == 'Média' %}bg-warning text-dark
                                                        {% elif risco.severidade == 'Baixo' or risco.severidade == 'Baixa' %}bg-success
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ risco.severidade | default('N/A') }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if risco.status == 'Ativo' %}bg-warning text-dark
                                                        {% elif risco.status == 'Resolvido' %}bg-success
                                                        {% elif risco.status == 'Mitigado' %}bg-info
                                                        {% elif risco.status == 'Em Monitoramento' %}bg-info
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ risco.status | default('N/A') }}
                                                    </span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">Nenhum risco ou impedimento identificado para este projeto.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notas e Observações (Linha inteira) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="content-section">
                        <div class="section-header-modern">
                            <div class="section-icon">
                                <i class="bi bi-journal-text"></i>
                            </div>
                            <h6 class="section-title-modern">Notas e Observações</h6>
                        </div>
                        {% if report_data and report_data.notas and report_data.notas|length > 0 %}
                            <div class="card">
                                <div class="list-group list-group-flush note-section">
                                    {% for nota in report_data.notas %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <div class="mb-2">
                                                        <span class="badge badge-modern
                                                            {% if nota.categoria == 'decision' %}badge-primary-modern
                                                            {% elif nota.categoria == 'impediment' %}badge-danger-modern
                                                            {% elif nota.categoria == 'general' %}badge-info-modern
                                                            {% else %}badge-info-modern{% endif %} me-1">
                                                            {% if nota.categoria == 'decision' %}Decisão
                                                            {% elif nota.categoria == 'impediment' %}Impedimento
                                                            {% elif nota.categoria == 'general' %}Geral
                                                            {% else %}{{ nota.categoria | title }}{% endif %}
                                                        </span>
                                                        {% if nota.prioridade %}
                                                            <span class="badge 
                                                                {% if nota.prioridade == 'Alta' %}bg-danger
                                                                {% elif nota.prioridade == 'Média' %}bg-warning text-dark
                                                                {% elif nota.prioridade == 'Baixa' %}bg-success
                                                                {% else %}bg-secondary{% endif %} me-1">
                                                                {{ nota.prioridade }}
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    <p class="mb-1">{{ nota.conteudo | default('Nota sem conteúdo') }}</p>
                                                    {% if nota.data_criacao %}
                                                        <small class="text-muted">{{ nota.data_criacao }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">Nenhuma nota ou observação registrada para este projeto.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Próximos Passos (Linha inteira) - COMENTADO PARA IMPLEMENTAÇÃO FUTURA -->
            <!--
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="placeholder-section">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-arrow-right-circle text-success me-2"></i>
                            <h6 class="section-title mb-0">Próximos Passos</h6>
                        </div>
                        {% if report_data and report_data.proximos_passos and report_data.proximos_passos|length > 0 %}
                            <div class="card">
                                <div class="list-group list-group-flush">
                                    {% for passo in report_data.proximos_passos %}
                                        <div class="list-group-item">
                                            <div class="d-flex align-items-start">
                                                <i class="bi bi-arrow-right text-primary me-2 mt-1"></i>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-1">{{ passo.titulo | default('Passo sem título') }}</h6>
                                                    {% if passo.descricao %}
                                                        <p class="mb-1">{{ passo.descricao }}</p>
                                                    {% endif %}
                                                    {% if passo.prazo %}
                                                        <small class="text-muted">
                                                            <i class="bi bi-calendar me-1"></i>Prazo: {{ passo.prazo }}
                                                        </small>
                                                    {% endif %}
                                                    {% if passo.responsavel %}
                                                        <small class="text-muted ms-3">
                                                            <i class="bi bi-person me-1"></i>{{ passo.responsavel }}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted">Nenhum próximo passo definido para este projeto.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            -->

            <!-- Rodapé da empresa (apenas para PDF) -->
            <div class="company-footer pdf-only">
                <div class="footer-line"><strong>Control360.SOU - Project Management Office</strong></div>
                <div class="footer-line">Relatório gerado automaticamente pelo sistema PMO</div>
                <div class="footer-line">Data: {{ data_geracao | default('N/A', true) }}</div>
            </div>

            </div> <!-- Fim do pdfContent -->
        </div>
    {% else %}
        <p>Nenhum dado de relatório disponível.</p>
    {% endif %}
</div>

<script>
// Função para carregar dados das tarefas quando não é PDF
document.addEventListener('DOMContentLoaded', function() {
    console.log('Status Report - DOM carregado');
    
    // Verificar se não é visualização PDF
    const isForPdf = {{ 'true' if for_pdf else 'false' }};
    
    if (!isForPdf) {
        console.log('Modo não-PDF detectado, mostrando conteúdo das tarefas...');
        
        // Ocultar loading e mostrar conteúdo
        const timelineLoading = document.getElementById('timeline-loading');
        const timelineContent = document.getElementById('timeline-content');
        
        if (timelineLoading) {
            timelineLoading.style.display = 'none';
        }
        
        if (timelineContent) {
            timelineContent.style.display = 'block';
        }
        
        console.log('Timeline content exibido com sucesso');
    }
    
    // Carregar gráficos
    initCharts();
    
    // Inicializar toggle de visibilidade de horas
    initHoursVisibilityToggle();
    
    // Inicializar gráfico público de tarefas (só quando necessário)
    // initPublicTasksChart(); // Será chamado pelo toggle quando necessário
});

// Variáveis globais para controlar gráficos
let tarefasChartInstance = null;

// Função para controlar a visibilidade de informações de horas
function initHoursVisibilityToggle() {
    const toggle = document.getElementById('publicModeToggle');
    const body = document.body;
    const privateLabel = document.querySelector('.private-label');
    const publicLabel = document.querySelector('.public-label');
    const privateDesc = document.querySelector('.private-desc');
    const publicDesc = document.querySelector('.public-desc');
    
    if (!toggle) return;
    
    // Garantir estado inicial correto
    if (!toggle.checked) {
        body.classList.remove('public-mode');
    }
    
    toggle.addEventListener('change', function() {
        if (this.checked) {
            // Modo público - ocultar valores sensíveis
            body.classList.add('public-mode');
            privateLabel.style.display = 'none';
            publicLabel.style.display = 'inline';
            privateDesc.style.display = 'none';
            publicDesc.style.display = 'block';
            
            // Criar gráfico de tarefas se ainda não existe
            if (!tarefasChartInstance) {
                console.log('Criando gráfico de tarefas...');
                initPublicTasksChart();
            } else {
                console.log('Gráfico de tarefas já existe, reutilizando...');
            }
            
            console.log('Modo público ativado - valores de horas ocultos');
            console.log('Classe public-mode aplicada:', body.classList.contains('public-mode'));
        } else {
            // Modo privado - mostrar valores detalhados
            body.classList.remove('public-mode');
            privateLabel.style.display = 'inline';
            publicLabel.style.display = 'none';
            privateDesc.style.display = 'block';
            publicDesc.style.display = 'none';
            
            console.log('Modo privado ativado - valores de horas visíveis');
            console.log('Classe public-mode removida:', !body.classList.contains('public-mode'));
        }
    });
    
    console.log('Toggle de visibilidade de horas inicializado');
    
    // Debug do estado inicial
    console.log('Estado inicial do toggle:', toggle.checked);
    console.log('Classe public-mode inicial:', document.body.classList.contains('public-mode'));
    console.log('Canvas esforço visível:', document.getElementById('esforcoChart') ? 'SIM' : 'NÃO');
    console.log('Canvas tarefas visível:', document.getElementById('tarefasChart') ? 'SIM' : 'NÃO');
}

// Função para inicializar o gráfico público de tarefas
function initPublicTasksChart() {
    const tarefasCtx = document.getElementById('tarefasChart');
    if (!tarefasCtx) {
        console.log('Canvas de tarefas não encontrado');
        return;
    }
    
    // Verificar se estamos realmente em modo público
    if (!document.body.classList.contains('public-mode')) {
        console.log('Tentativa de criar gráfico de tarefas fora do modo público - ignorando');
        return;
    }
    
    console.log('Iniciando criação do gráfico de tarefas em modo público...');
    
    // Usar dados reais das tarefas do backend
    const reportData = {
        // Dados de contagem de tarefas reais - a serem implementados no backend
        {% if report_data.contagem_tarefas %}
        contagem_tarefas: {
            total: {{ report_data.contagem_tarefas.total | default(0) }},
            concluidas: {{ report_data.contagem_tarefas.concluidas | default(0) }},
            restantes: {{ report_data.contagem_tarefas.restantes | default(0) }}
        }
        {% else %}
                 // Fallback: calcular baseado nas listas de tarefas disponíveis
         contagem_tarefas: {
             concluidas: {{ (report_data.tarefas_concluidas | length) if report_data.tarefas_concluidas else 0 }},
             em_andamento: {{ (report_data.tarefas_em_andamento | length) if report_data.tarefas_em_andamento else 0 }},
             proximo_prazo: {{ (report_data.tarefas_proximo_prazo | length) if report_data.tarefas_proximo_prazo else 0 }},
             em_revisao: {{ (report_data.tarefas_em_revisao | length) if report_data.tarefas_em_revisao else 0 }},
             pendentes: {{ (report_data.tarefas_pendentes | length) if report_data.tarefas_pendentes else 0 }},
             // Fallback para usar progresso se as listas estiverem vazias
             usar_progresso_fallback: true,
             percentual_progresso: {{ report_data.progresso.percentual_concluido | default(0) | round(1) }}
         }
        {% endif %}
    };
    
    let tarefasConcluidas, tarefasRestantes;
    
    {% if report_data.contagem_tarefas %}
    // Usar dados diretos do backend se disponíveis
    tarefasConcluidas = reportData.contagem_tarefas.concluidas;
    tarefasRestantes = reportData.contagem_tarefas.restantes;
         {% else %}
     // Calcular baseado nas listas de tarefas disponíveis
     tarefasConcluidas = reportData.contagem_tarefas.concluidas;
     const tarefasNaoConcluidas = 
         reportData.contagem_tarefas.em_andamento + 
         reportData.contagem_tarefas.proximo_prazo + 
         reportData.contagem_tarefas.em_revisao + 
         reportData.contagem_tarefas.pendentes;
     tarefasRestantes = tarefasNaoConcluidas;
     
     // Se todas as listas estão vazias, usar progresso como fallback
     const totalTarefasContadas = tarefasConcluidas + tarefasRestantes;
     if (totalTarefasContadas === 0 && reportData.contagem_tarefas.usar_progresso_fallback) {
         console.log('Listas de tarefas vazias, usando progresso como fallback...');
         const percentual = reportData.contagem_tarefas.percentual_progresso;
         const estimativa = 15; // Base estimada
         tarefasConcluidas = Math.round((percentual / 100) * estimativa);
         tarefasRestantes = estimativa - tarefasConcluidas;
         console.log('Fallback aplicado:', tarefasConcluidas, 'concluídas de', estimativa);
     }
     {% endif %}
    
    // Garantir valores mínimos para visualização
    const tarefasConcluidasDisplay = Math.max(0, tarefasConcluidas);
    const tarefasRestantesDisplay = Math.max(1, tarefasRestantes);
    const totalTarefas = tarefasConcluidasDisplay + tarefasRestantesDisplay;
    
    tarefasChartInstance = new Chart(tarefasCtx, {
        type: 'doughnut',
        data: {
            labels: ['Concluídas', 'Restantes'],
            datasets: [{
                data: [tarefasConcluidasDisplay, tarefasRestantesDisplay],
                backgroundColor: [
                    '#07304F', // Azul SOU.cloud para concluídas
                    '#e3e6f0'  // Cinza para restantes
                ],
                borderWidth: 3,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        font: {
                            size: 12
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(0);
                                    return {
                                        text: `${label}: ${value} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].backgroundColor[i],
                                        pointStyle: 'circle'
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    console.log('📊 GRÁFICO DE TAREFAS INICIALIZADO:');
    console.log('✅ Concluídas:', tarefasConcluidasDisplay);
    console.log('⏳ Restantes:', tarefasRestantesDisplay); 
    console.log('📈 Total:', totalTarefas);
    console.log('📋 Dados brutos:', reportData.contagem_tarefas);
    console.log('🖼️ Canvas:', !!tarefasCtx);
    console.log('📊 Chart.js:', !!tarefasChartInstance);
    
    // Alerta se os dados parecem incorretos
    if (totalTarefas < 5) {
        console.warn('⚠️ ATENÇÃO: Total de tarefas muito baixo. Pode indicar problema nos dados do backend.');
    }
}

function initCharts() {
    // Dados do relatório
    const reportData = {
        progresso: {
            percentual_concluido: {{ report_data.progresso.percentual_concluido | default(0) | round(1) }},
        },
        esforco: {
            horas_utilizadas: {{ report_data.esforco.horas_utilizadas | default(0) | round(1) }},
            horas_planejadas: {{ report_data.esforco.horas_planejadas | default(0) | round(1) }},
            percentual_consumido: {{ report_data.esforco.percentual_consumido | default(0) | round(1) }}
        }
    };
    
    console.log('Dados para gráficos:', reportData);
    
    // Gráfico de Progresso (Doughnut)
    const progressoCtx = document.getElementById('progressoChart');
    if (progressoCtx) {
        const percentualConcluido = reportData.progresso.percentual_concluido;
        const percentualRestante = 100 - percentualConcluido;
        
        new Chart(progressoCtx, {
            type: 'doughnut',
            data: {
                labels: ['Concluído', 'Restante'],
                datasets: [{
                    data: [percentualConcluido, percentualRestante],
                    backgroundColor: [
                        '#1cc88a', // Verde para concluído
                        '#e3e6f0'  // Cinza para restante
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico de Esforço (Bar)
    const esforcoCtx = document.getElementById('esforcoChart');
    if (esforcoCtx) {
        const horasUtilizadas = reportData.esforco.horas_utilizadas;
        const horasPlanejadas = reportData.esforco.horas_planejadas;
        const horasRestantes = Math.max(0, horasPlanejadas - horasUtilizadas);
        
        new Chart(esforcoCtx, {
            type: 'bar',
            data: {
                labels: ['Horas'],
                datasets: [
                    {
                        label: 'Utilizadas',
                        data: [horasUtilizadas],
                        backgroundColor: '#4e73df',
                        borderColor: '#4e73df',
                        borderWidth: 1
                    },
                    {
                        label: 'Restantes',
                        data: [horasRestantes],
                        backgroundColor: '#e3e6f0',
                        borderColor: '#e3e6f0',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + 'h';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + 'h';
                            }
                        }
                    }
                }
            }
        });
    }
}

// === CONTROLE DE VISIBILIDADE DO TOGGLE ===
function hideToggle() {
    const toggleContainer = document.getElementById('hoursToggleContainer');
    if (toggleContainer) {
        toggleContainer.classList.add('hidden');
        // Salvar no localStorage que está oculto
        localStorage.setItem('toggleHidden', 'true');
    }
}

function showToggle() {
    const toggleContainer = document.getElementById('hoursToggleContainer');
    if (toggleContainer) {
        toggleContainer.classList.remove('hidden');
        // Salvar no localStorage que está visível
        localStorage.setItem('toggleHidden', 'false');
    }
}

// Combinação de teclas Ctrl+Shift+M para mostrar o toggle
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey && event.shiftKey && event.key === 'M') {
        event.preventDefault();
        const toggleContainer = document.getElementById('hoursToggleContainer');
        if (toggleContainer && toggleContainer.classList.contains('hidden')) {
            showToggle();
        }
    }
});

// Verificar localStorage ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    const isHidden = localStorage.getItem('toggleHidden') === 'true';
    if (isHidden) {
        const toggleContainer = document.getElementById('hoursToggleContainer');
        if (toggleContainer) {
            toggleContainer.classList.add('hidden');
        }
    }
});
</script>

<!-- Carregar Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}