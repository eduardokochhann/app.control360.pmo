{% extends "base.html" %}

{% block title %}{{ titulo_pagina if titulo_pagina else 'Status Report' }}{% endblock %}

{% block extra_css %}
{{ super() }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Classes para controlar visibilidade na tela e no PDF */
    .pdf-only {
        display: none; /* Oculta elementos que devem aparecer apenas no PDF */
    }
    
    /* Estilos gerais */
    .status-dot {
        height: 25px;
        width: 25px;
        border-radius: 50%;
        display: inline-block;
        vertical-align: middle;
        margin-right: 8px;
        border: 3px solid #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .status-verde { background-color: #1cc88a; } /* Verde do template */
    .status-amarelo { background-color: #f6c23e; } /* Amarelo do template */
    .status-vermelho { background-color: #e74a3b; } /* Vermelho do template */
    .status-cinza { background-color: #858796; } /* Cinza do template */
    .status-text { font-weight: 600; font-size: 1.1rem; }
    
    /* Layout original do projeto */
    .project-details-header {
        font-size: 0.85rem;
        color: #5a5c69;
        margin-bottom: 1.5rem;
        padding: 0.8rem;
        background-color: #f8f9fc;
        border-radius: 0.35rem;
        border: 1px solid #e3e6f0;
        display: flex; /* Adicionado para garantir o comportamento flex */
        flex-wrap: wrap; /* Permite que os itens quebrem para a próxima linha */
        align-items: center; /* Alinha os itens verticalmente */
    }
    
    .project-details-header strong {
        margin-right: 5px;
    }
    
    .project-details-header span {
        margin-right: 20px; /* Aumentar um pouco o espaço entre os itens */
        margin-bottom: 8px; /* Adicionar espaço inferior para quando quebrar a linha */
        white-space: nowrap; /* Evitar que o texto do item quebre no meio */
    }
    
    /* KPI cards originais */
    .kpi-card .card-body {
        display: flex;
        align-items: center;
        height: 85px;
        padding: 0.5rem 0.8rem;
    }
    
    .kpi-card .kpi-content {
        width: 100%;
        margin-left: 0.8rem;
        text-align: left; /* Adicionado para alinhar conteúdo à esquerda */
    }
    
    .kpi-card .kpi-icon {
        font-size: 1.8rem;
        color: #dddfeb;
    }
    
    .kpi-card .text-xs {
        font-size: 0.65rem;
        display: block;
        margin-bottom: -2px;
    }
    
    .kpi-card .h1, .kpi-card .h5 {
        font-size: 1.4rem;
        margin-bottom: 0;
        line-height: 1.1;
    }
    
    .kpi-card small.text-muted {
        font-size: 0.65rem;
        line-height: 1;
        display: block;
        margin-top: 1px;
    }
    
    /* Charts originais */
    .chart-card .card-body {
        min-height: 220px; /* Altura original */
        padding: 0.8rem; /* Revertido para padding original/simples */
        /* Removidos display:flex e outros que podem ter causado estreitamento */
    }
    
    .chart-card canvas {
        max-height: 200px; /* Reativado */
        min-height: 180px; /* Mantido, pode ser !important se necessário */
        /* Removidos min-width e max-width % para deixar o Chart.js gerenciar mais */
    }
    
    /* Títulos de seções */
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid #e3e6f0;
    }
    
    /* Placeholders originais */
    .placeholder-section {
        background-color: #f8f9fc;
        border: 1px dashed #d1d3e2;
        padding: 1rem;
        border-radius: 0.35rem;
        text-align: center;
        color: #858796;
        margin-top: 1rem;
        font-size: 0.85rem;
    }
    
    .placeholder-section i {
        font-size: 1.2rem;
        margin-bottom: 0.4rem;
        display: block;
    }
    
    .placeholder-section h6 {
        font-size: 0.9rem;
    }
    
    .list-group-item {
        background-color: transparent;
        border-left: none;
        border-right: none;
        border-top: 1px solid #e3e6f0;
        padding: 0.6rem 0;
        font-size: 0.85rem;
    }
    
    .list-group-item:first-child {
        border-top: none;
    }
    
    /* Estilos para campos editáveis */
    .editable-field {
        padding: 2px 5px;
        border-radius: 3px;
        transition: background-color 0.2s;
    }
    
    .edit-mode .editable-field {
        border: 1px dashed #4e73df;
        background-color: rgba(78, 115, 223, 0.1);
        cursor: pointer;
    }
    
    .editable-field.editing {
        background-color: white !important;
        border: 1px solid #4e73df !important;
        padding: 1px 4px;
    }
    
    /* Estilo para o botão de modo de edição ativo */
    #editModeBtn.active {
        background-color: #e74a3b;
        border-color: #e74a3b;
        color: white;
    }
    
    /* Estilo para entrada de edição */
    .edit-input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: inherit;
        font-weight: inherit;
        color: inherit;
        padding: 0;
        margin: 0;
    }
    
    .edit-input:focus {
        outline: none;
    }

    /* --- Estilos para Geração de PDF (WeasyPrint) --- */
    @media print {
        @page {
            size: A4 portrait;
            margin: 3mm !important; /* Margens mínimas reduzidas */
        }

        body {
            background-color: #fff !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* --- Controle de Visibilidade Essencial para Impressão do Navegador --- */
        .screen-only,
        .navbar, 
        #accordionSidebar, 
        footer.sticky-footer, 
        .scroll-to-top,
        #editModeBtn, 
        #generatePdfBtn, /* Botão do html2pdf.js */
        button.btn-outline-secondary.ms-2[onclick="window.print();"], /* Botão "Imprimir" específico */
        a.btn.btn-sm.btn-primary[title*='Baixar Relatório em PDF'], /* Botão "Baixar PDF (Servidor)" */
        .d-sm-flex.align-items-center.justify-content-between.mb-3 > .screen-only, /* Container dos botões no header da página */
        .d-sm-flex.align-items-center.justify-content-between.mb-3 > h1.h3.text-gray-800 /* Oculta o H1 original na impressão */
        {
            display: none !important;
        }

        .pdf-only { /* Elementos que SÓ devem aparecer em qualquer tipo de PDF/impressão */
            display: block !important; 
        }

        /* Evitar quebras indesejadas DENTRO de seções importantes */
        .placeholder-section, .card, .timeline-section, .table-responsive > table {
            page-break-inside: avoid !important;
        }

        /* Evitar quebra de página ANTES de um rodapé da empresa, se possível */
        .company-footer.pdf-only {
            page-break-before: auto !important; 
        }

        /* Estilos para o cabeçalho da empresa na impressão do navegador */
        /* ANTIGO CABEÇALHO - SERÁ OCULTADO ABAIXO */
        /* .company-header.pdf-only { ... } */
        /* .company-header.pdf-only .print-logo { ... } */
        /* .company-header.pdf-only .company-header-text { ... } */
        /* .company-header.pdf-only .company-logo { ... } */
        /* .company-header.pdf-only .report-date-print { ... } */

        /* NOVO LAYOUT DO CABEÇALHO DE IMPRESSÃO */
        .print-header-layout.pdf-only {
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important; /* Alinha blocos internos (logo-area, company-info-area) à esquerda */
            width: 100% !important;
            margin-bottom: 10px !important; /* Reduzido para menos espaço antes dos detalhes do projeto */
        }

        .print-header-layout.pdf-only .print-logo-area {
            width: 100%; 
            display: flex !important;
            justify-content: flex-start !important; /* Alinha o logo à esquerda */
            margin-bottom: 10px !important;
        }

        .print-header-layout.pdf-only .print-logo-large {
            max-height: 30px !important; /* Tamanho do logo reduzido */
            width: auto !important;
            opacity: 0.9 !important; 
        }

        .print-header-layout.pdf-only .company-info-area {
            width: 100%;
            display: flex !important;
            flex-direction: column !important;
            align-items: flex-start !important; /* Alinha "Control360" e "Data" à esquerda */
            margin-bottom: 10px !important; /* Espaço entre info empresa e título Status Report */
        }

        .print-header-layout.pdf-only .company-name {
            font-size: 10pt !important; 
            font-weight: bold !important;
            color: #444 !important;
            margin-bottom: 3px !important;
        }

        .print-header-layout.pdf-only .report-date {
            font-size: 8pt !important;
            color: #666 !important;
        }
        
        .print-header-layout.pdf-only .print-title-area {
            width: 100% !important;
            text-align: center !important; /* Centraliza o título "Status Report" */
            margin-bottom: 15px !important; /* Espaço após o título */
            padding-bottom: 10px !important; /* Espaço para a borda */
            border-bottom: 1px solid #e3e6f0 !important; /* Borda abaixo do título */
        }

        .print-header-layout.pdf-only .print-main-title {
            font-size: 1.6rem !important; 
            font-weight: 600 !important;
            color: #333 !important;
            margin: 0 !important;
        }

        /* Comentar ou remover regras para o antigo .company-header.pdf-only se não forem mais necessárias */
        /*
        .company-header.pdf-only,
        .company-header.pdf-only .print-logo,
        .company-header.pdf-only .company-header-text,
        .company-header.pdf-only .company-logo,
        .company-header.pdf-only .report-date-print {
            display: none !important;
        }
        */

        /* Estilos para a linha de informações do projeto na impressão do navegador */
        .project-info-line.pdf-only {
            font-size: 8.5pt !important;
            padding: 4px 0px !important; /* Mantém padding vertical, zero horizontal */
            margin-bottom: 30px !important;
            text-align: left !important;
            width: 100% !important;
            box-sizing: border-box !important;
            padding-left: 0 !important; /* Garante que não haja padding esquerdo */
            display: block !important; /* Adicionado para garantir o comportamento de bloco */
        }

    }
    
    /* NOVO: Adicionar estilo para status pendente mais visível */
    .badge-pending {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    /* NOVO: Melhores estilos para tabela de marcos */
    .milestone-name {
        font-weight: 600 !important;
        color: #333 !important;
        text-align: left !important;
        display: inline-block !important;
    }
    
    .milestone-date {
        color: #666 !important;
        font-size: 0.85em !important;
        text-align: right !important;
        display: block !important;
    }

    /* Classe para estilo ao gerar PDF via browser */
    .print-mode {
        font-size: 8pt !important;
        line-height: 1.3 !important;
        width: 210mm !important; /* Largura exata do A4 */
        box-sizing: border-box !important;
        padding: 0 !important;
        margin: 0 auto !important;
    }
    
    .print-mode .company-header {
        margin-bottom: 10px !important;
        padding-bottom: 5px !important;
        border-bottom: 1px solid #4e73df !important;
        display: flex; /* Usar flexbox para alinhar os itens */
        flex-direction: column; /* Empilhar verticalmente */
        align-items: flex-start; /* Alinhar itens à esquerda */
        width: 100% !important; /* Garantir largura total */
        box-sizing: border-box !important; /* Incluir padding e border na largura total */
        /* padding-left: 25pt !important; */ /* Removido para alinhar à esquerda da página */
    }
    
    .print-mode .company-logo {
        font-size: 12pt !important;
        font-weight: bold; /* Adicionado para destacar */
        margin-bottom: 3px; /* Espaço entre logo e data do relatório */
    }

    .print-mode .report-date-print { /* Nova classe para estilizar a data do relatório */
        font-size: 8pt !important;
        color: #666 !important;
        /* align-self: flex-end; */ /* Removido para alinhar à esquerda com o pai */
        /* margin-top: -1.5em; */ /* Removido */
    }
    
    .print-mode .project-info-line {
        font-size: 7.8pt !important; /* Reduzido de 8.5pt */
        padding: 4px 0px !important; /* Ajustando padding, removendo lateral */
        margin-bottom: 30px !important; /* Aumentando margem inferior para mais espaço */
        text-align: left !important; /* Garantindo alinhamento à esquerda */
        width: 100% !important; /* Garantir largura total */
        box-sizing: border-box !important; /* Incluir padding na largura total */
        /* padding-left: 25pt !important; */ /* Removido para alinhar à esquerda da página */
    }
    
    .print-mode .row {
        margin-left: -5px !important;
        margin-right: -5px !important;
        margin-bottom: 8px !important;
    }
    
    .print-mode .col-xl-3,
    .print-mode .col-md-6,
    .print-mode .col-lg-6,
    .print-mode .col-md-4 {
        padding-left: 5px !important;
        padding-right: 5px !important;
    }
    
    .print-mode .status-dot {
        height: 10px !important;
        width: 10px !important;
        border-width: 1px !important;
        margin-right: 3px !important;
    }
    
    .print-mode .kpi-card {
        margin-bottom: 8px !important;
    }
    
    .print-mode .kpi-card .card-body {
        height: auto !important;
        min-height: 50px !important;
        padding: 4px 6px !important;
    }
    
    .print-mode .kpi-card .kpi-icon {
        font-size: 1rem !important;
    }
    
    .print-mode .kpi-card .text-xs {
        font-size: 6pt !important;
    }
    
    .print-mode .kpi-card .h1 {
        font-size: 12pt !important;
    }
    
    .print-mode .kpi-card .h5 {
        font-size: 10pt !important;
    }
    
    .print-mode .kpi-card small.text-muted { 
        font-size: 6pt !important; 
    }
    
    .print-mode .card-header {
        padding: 3px 6px !important;
    }
    
    .print-mode .card-header h6 {
        font-size: 10pt !important;
        margin: 0 !important;
    }
    
    .print-mode .chart-card .card-body {
        min-height: 150px !important;
        padding: 5px !important;
    }
    
    .print-mode canvas {
        max-height: 140px !important;
        max-width: none !important;
    }
    
    .print-mode .placeholder-section {
        height: 80px !important;
        padding: 5px !important;
        margin-top: 5px !important;
    }
    
    .print-mode .placeholder-section i {
        font-size: 0.8rem !important;
        margin-bottom: 2px !important;
    }
    
    .print-mode .placeholder-section h6 {
        font-size: 8pt !important;
        margin-bottom: 3px !important;
    }
    
    .print-mode .placeholder-section p {
        font-size: 7pt !important;
        margin-bottom: 0 !important;
    }
    
    .print-mode .company-footer {
        margin-top: 10px !important;
        padding-top: 5px !important;
        font-size: 7pt !important;
        page-break-before: auto; /* Evitar quebra de página antes se não for necessário */
    }
    
    .print-mode .company-footer p {
        margin-bottom: 2px !important;
    }

    .print-mode .chart-card {
        margin-bottom: 8px !important;
    }

    .print-mode .chart-card .card-body {
        min-height: 135px !important;
        max-height: 150px !important;
        padding: 5px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* Timeline estilo tabular (igual Marcos) */
    .timeline-section {
        margin-bottom: 15px !important;
        border: 1px solid #e3e6f0 !important;
        border-radius: 0.25rem !important;
        overflow: hidden !important;
    }

    .timeline-section .section-header {
        padding: 8px 12px !important;
        margin: 0 !important;
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #e9ecef !important;
        font-weight: 600 !important;
        color: #495057 !important;
        text-align: left !important;
        display: flex !important;
        align-items: center !important;
    }
    
    .timeline-section .section-header i {
        margin-right: 8px !important;
        font-size: 1rem !important;
    }
    
    .timeline-section .section-header span {
        line-height: 1.2 !important;
        font-size: 0.85rem !important;
    }
    
    /* Cabeçalho da tabela de timeline */
    .timeline-section .column-headers {
        display: flex !important;
        padding: 6px 12px !important;
        font-size: 0.7rem !important;
        font-weight: 700 !important;
        background-color: #eef0f2 !important;
        border-bottom: 1px solid #dee2e6 !important;
        color: #555 !important;
    }
    
    .timeline-section .column-headers .task-column {
        flex: 0 0 50% !important;
        text-align: left !important;
        padding-left: 0 !important;
    }
    
    .timeline-section .column-headers .status-column {
        flex: 0 0 25% !important;
        text-align: center !important;
    }
    
    .timeline-section .column-headers .date-column {
        flex: 0 0 25% !important;
        text-align: right !important;
        padding-right: 12px !important;
    }
    
    .timeline-section .list-group {
        margin-bottom: 0 !important;
    }
    
    .timeline-section .list-group-item {
        padding: 6px 12px !important;
        font-size: 0.8rem !important;
        border: none !important;
        border-bottom: 1px solid #f0f0f0 !important;
        margin: 0 !important;
        display: flex !important;
        align-items: center !important;
        transition: background-color 0.15s ease-in-out !important;
    }
    
    .timeline-section .list-group-item:hover {
        background-color: #f8f9fa !important;
    }
    
    .timeline-section .list-group-item:last-child {
        border-bottom: none !important;
    }
    
    .timeline-section .badge {
        flex: 0 0 25% !important;
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
        border-radius: 3px !important;
        margin: 0 auto !important; /* Centralizar horizontalmente */
        text-align: center !important;
        display: inline-block !important;
        width: auto !important;
        min-width: 80px !important;
        max-width: 90px !important; /* Limitar largura máxima */
    }
    
    /* Container de status para centralizar o badge */
    .timeline-section .status-container {
        flex: 0 0 25% !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
    }
    
    /* Badge para A Fazer em cinza */
    .timeline-section .badge.bg-secondary {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    .timeline-section .text-muted.small {
        flex: 0 0 25% !important;
        font-size: 0.75rem !important;
        white-space: nowrap !important;
        text-align: right !important;
        color: #6c757d !important;
        padding-right: 12px !important;
    }
    
    .timeline-task-name {
        flex: 0 0 50% !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        margin-right: 0 !important;
        font-weight: 500 !important;
        color: #495057 !important;
        text-align: left !important;
        font-size: 0.8rem !important;
    }
    
    /* Alinhar estilo da tabela de marcos */
    .table-sm th {
        font-weight: 700 !important;
        font-size: 0.7rem !important;
        background-color: #eef0f2 !important;
        color: #555 !important;
        padding: 6px 12px !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .table-sm td {
        font-size: 0.8rem !important;
        padding: 6px 12px !important;
        vertical-align: middle !important;
    }
    
    /* Garantir que os ícones e textos de data fiquem lado a lado */
    .timeline-section .text-muted.small i {
        margin-right: 2px !important;
    }
    
    .timeline-section .text-muted.small span.mx-1 {
        margin-left: 3px !important;
        margin-right: 3px !important;
        opacity: 0.7 !important;
    }

    /* Alinhamento específico para a tabela de marcos */
    .table-sm th:first-child {
        text-align: left !important;
    }
    
    .table-sm th:last-child {
        text-align: right !important;
    }
    
    .table-sm td:first-child {
        text-align: left !important;
    }
    
    .table-sm td:last-child {
        text-align: right !important;
    }

    /* Garantir que os badges em ambas as seções sejam idênticos */
    .timeline-section .badge,
    .table-sm .badge {
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
        border-radius: 3px !important;
        display: inline-block !important;
        text-align: center !important;
        min-width: 80px !important;
    }

    /* Ajuste para o ícone de Marco (ponto de exclamação) */
    .table-sm td .badge.bg-danger {
        font-size: 0.65rem !important;
        padding: 2px 4px !important;
        margin-right: 6px !important;
        width: auto !important;
        min-width: auto !important;
    }
    
    /* Ajuste para o badge de status de Marco */
    .table-sm td:nth-child(2) .badge {
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
        border-radius: 3px !important;
        display: inline-block !important;
        text-align: center !important;
        min-width: 80px !important;
    }

    /* Estilos para a seção de notas */
    .note-section .list-group-item {
        transition: background-color 0.2s ease;
        text-align: left !important; /* Força o alinhamento do conteúdo à esquerda */
    }

    .note-section .list-group-item:hover {
        background-color: rgba(0,0,0,0.02);
    }

    .note-section .badge {
        font-size: 0.7rem;
        padding: 0.35em 0.65em;
    }

    .note-section .text-muted {
        font-size: 0.8rem;
    }

    /* Cores específicas para categorias de notas */
    .badge.bg-decision { background-color: #4e73df !important; }
    .badge.bg-impediment { background-color: #e74a3b !important; }
    .badge.bg-general { background-color: #858796 !important; }

    /* Cores específicas para prioridades */
    .badge.bg-high { background-color: #e74a3b !important; }
    .badge.bg-medium { background-color: #f6c23e !important; }
    .badge.bg-low { background-color: #1cc88a !important; }

    /* Ajustes para impressão */
    @media print {
        .note-section {
            break-inside: avoid; /* Manter */
            /* page-break-inside: avoid; */ /* Comentado */
        }
        
        .note-section .list-group-item {
            break-inside: avoid; /* Manter */
            /* page-break-inside: avoid; */ /* Comentado, pois a regra acima é mais específica e tem !important */
        }
    }

    /* Permitir quebra dentro do card da seção de notas, mas manter itens de nota juntos */
    .placeholder-section .card {
        page-break-inside: auto !important;
    }
    /* Reforçar que itens de nota individuais não quebram */
    .placeholder-section .card .note-section .list-group-item {
        page-break-inside: avoid !important; 
    }
    
    /* Permitir quebra dentro do card da seção de Riscos e Impedimentos */
    .placeholder-section:has(h6:contains("Riscos e Impedimentos")) .card {
        page-break-inside: auto !important;
    }

    /* Reforçar que itens de nota individuais NÃO quebram */
    .placeholder-section .card .note-section .list-group-item {
        page-break-inside: avoid !important; 
    }

    /* Estilos para o rodapé da empresa na impressão do navegador */
    .company-footer.pdf-only {
        /* page-break-before: auto !important; */ /* Comentado pois auto é o padrão e pode não ser necessário forçar */
        margin-top: 20px !important; /* Aumentado para mais espaço acima */
        padding-top: 10px !important; /* Aumentado para mais espaço interno acima */
        border-top: 1px solid #ddd !important; /* Adiciona uma linha sutil no topo do rodapé */
        text-align: left !important; /* Alinha todo o texto do rodapé à esquerda */
        font-size: 7pt !important; /* Define um tamanho de fonte base para o rodapé */
        color: #333 !important; /* Cor de texto principal para o rodapé */
    }

    .company-footer.pdf-only .footer-line {
        margin-bottom: 3px !important; /* Pequeno espaço entre as linhas do rodapé */
    }

    /* Garantir que o contêiner dos badges de categoria/prioridade alinhe à esquerda */
    .note-section .list-group-item > .d-flex > div:first-child {
        text-align: left !important;
    }

    /* Garantir que o contêiner das tags (Informação, Combinado) alinhe à esquerda e não tenha padding lateral */
    .note-section .list-group-item .mt-2 {
        text-align: left !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        display: flex !important; /* Para garantir que justify-content funcione */
        justify-content: flex-start !important; /* Alinha itens flex à esquerda */
    }

    /* Remover margem direita dos badges dentro da seção de notas para alinhamento à esquerda completo */
    .note-section .list-group-item .badge.me-1,
    .note-section .list-group-item .badge.me-2, /* Caso usem me-2, etc. */
    .note-section .list-group-item .badge.m-1, /* Caso usem m-1, etc. */
    .note-section .list-group-item .badge.ms-1,
    .note-section .list-group-item .badge.ms-2 {
        margin-right: 0 !important;
        margin-left: 0 !important; /* Adicionado para garantir que não haja margem esquerda também */
    }

    .note-section .list-group-item:hover {
        background-color: rgba(0,0,0,0.02);
    }

</style>

{% endblock %}

{% block content %}

<div class="container-fluid">
    {% if error %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Erro ao Gerar Status Report</h4>
            <p>{{ error }}</p>
        </div>
    {% elif report_data %}
        <div class="report-header text-center">
            <!-- Cabeçalho da Página -->
            <div class="d-sm-flex align-items-center justify-content-between mb-3">
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="bi bi-file-earmark-text me-2"></i>Status Report
                </h1>
                <div class="screen-only"> <!-- Div para agrupar data e botão -->
                    <span class="text-muted small me-3">Gerado em: {{ data_geracao | default('N/A', true) }}</span>
                    <!-- Botão para o Quadro Kanban -->
                    <a href="{{ url_for('backlog.board_by_project', project_id=project_id) }}" 
                       class="btn btn-sm btn-outline-info me-2" 
                       title="Ir para o Quadro Kanban do Projeto">
                        <i class="bi bi-kanban me-1"></i> Quadro Kanban
                    </a>
                    <!-- Botões de ação - apenas o botão de impressão será visível -->
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="window.print();" title="Usar impressão do navegador">
                        <i class="bi bi-printer me-1"></i> Imprimir
                    </button>
                    <!-- Botões ocultos por padrão -->
                    <button class="btn btn-sm btn-warning me-2 d-none" id="editModeBtn" title="Editar relatório antes de baixar">
                        <i class="bi bi-pencil-square me-1"></i> <span>Editar Relatório</span>
                    </button>
                    {% if pdf_generator_available %}
                        <a href="{{ url_for('macro.download_status_report', project_id=project_id) }}" 
                           class="btn btn-sm btn-primary" 
                           title="Baixar Relatório em PDF ({{ generator_type }})">
                            <i class="bi bi-download me-1"></i> Baixar PDF (Servidor)
                        </a>
                    {% endif %}
                    <!-- Botão para gerar PDF via JavaScript (oculto) -->
                    <button class="btn btn-sm btn-success ms-2 d-none" id="generatePdfBtn" title="Gerar PDF usando o navegador">
                        <i class="bi bi-filetype-pdf me-1"></i> Baixar PDF (Browser)
                    </button>
                </div>
            </div>

            <!-- Container principal que será convertido para PDF -->
            <div id="pdfContent">
            
            <!-- NOVO CABEÇALHO PARA IMPRESSÃO (logo, info empresa, título) -->
            <div class="print-header-layout pdf-only">
                <div class="print-logo-area">
                    <img src="{{ url_for('static', filename='images/sou.cloud.png') }}" alt="SOU.cloud Logo" class="print-logo-large">
                </div>
                <div class="company-info-area">
                    <div class="company-name">Control360.SOU - PMO</div>
                    <div class="report-date">Data: <strong>{{ data_geracao | default('N/A', true) }}</strong></div>
                </div>
                <div class="print-title-area">
                    <h1 class="print-main-title">Status Report</h1>
                </div>
            </div>
            
            <!-- Detalhes do Projeto - Mantém o original na tela, redesenhado apenas na impressão -->
            <div class="project-details-header screen-only">
                <span><strong>Projeto:</strong> <span class="editable-field" data-field="project-name">{{ report_data.info_geral.nome | default('N/A') }}</span></span>
                <span><strong>ID:</strong> <span class="editable-field" data-field="project-id">{{ report_data.info_geral.id | default('N/A') }}</span></span>
                <span><strong>Status Atual:</strong> <span class="editable-field" data-field="project-status">{{ report_data.info_geral.status_atual | default('N/A') }}</span></span>
                <span><strong>Squad:</strong> <span class="editable-field" data-field="project-squad">{{ report_data.info_geral.squad | default('N/A') }}</span></span>
                <span><strong>Especialista:</strong> <span class="editable-field" data-field="project-specialist">{{ report_data.info_geral.especialista | default('N/A') }}</span></span>
            </div>

            <!-- Versão para impressão (apenas visível no PDF) -->
            <div class="project-info-line pdf-only">
                <span class="project-info-item"><strong>Projeto:</strong> <span class="editable-field" data-field="project-name">{{ report_data.info_geral.nome | default('N/A') }}</span></span>
                <span class="project-info-separator">|</span>
                <span class="project-info-item"><strong>ID:</strong> <span class="editable-field" data-field="project-id">{{ report_data.info_geral.id | default('N/A') }}</span></span>
                <span class="project-info-separator">|</span>
                <span class="project-info-item"><strong>Status:</strong> <span class="editable-field" data-field="project-status">{{ report_data.info_geral.status_atual | default('N/A') }}</span></span>
                <span class="project-info-separator">|</span>
                <span class="project-info-item"><strong>Squad:</strong> <span class="editable-field" data-field="project-squad">{{ report_data.info_geral.squad | default('N/A') }}</span></span>
                <span class="project-info-separator">|</span>
                <span class="project-info-item"><strong>Especialista:</strong> <span class="editable-field" data-field="project-specialist">{{ report_data.info_geral.especialista | default('N/A') }}</span></span>
            </div>

            <!-- Linha de KPIs Resumo -->
            <div class="row">
                <!-- Status Geral -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2 kpi-card">
                        <div class="card-body">
                            <i class="bi bi-clipboard-data kpi-icon"></i>
                            <div class="kpi-content">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">STATUS GERAL</div>
                                {% set status_color_class = report_data.status_geral_indicador | default('cinza') %}
                                <div class="d-flex align-items-center">
                                     <span class="status-dot status-{{ status_color_class }}" data-status-dot></span>
                                     {% set status_text_map = {
                                         'verde': 'No Prazo',
                                         'amarelo': 'Atenção',
                                         'vermelho': 'Crítico',
                                         'azul': 'Concluído',
                                         'cinza': 'Não Iniciado'
                                     } %}
                                     <span class="h5 status-text text-{{ status_color_class }} editable-field" data-field="status-geral" data-status-text>{{ status_text_map.get(status_color_class, 'Não Iniciado') }}</span>
                                     <div class="status-selector ml-2" style="display:none;">
                                        <select class="form-select form-select-sm">
                                            <option value="verde">No Prazo</option>
                                            <option value="amarelo">Atenção</option>
                                            <option value="vermelho">Crítico</option>
                                            <option value="cinza">Não Iniciado</option>
                                        </select>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- % Concluído -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2 kpi-card">
                        <div class="card-body">
                            <i class="bi bi-check2-circle kpi-icon"></i>
                            <div class="kpi-content">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">% CONCLUÍDO</div>
                                <div class="h1 mb-0 font-weight-bold text-gray-800 editable-field" data-field="percentual-concluido">{{ report_data.progresso.percentual_concluido | round(1) }}%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Prazo -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2 kpi-card">
                        <div class="card-body">
                            <i class="bi bi-calendar-week kpi-icon"></i>
                            <div class="kpi-content">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">STATUS DO PRAZO</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800 editable-field" data-field="status-prazo">{{ report_data.progresso.status_prazo | default('A Definir') }}</div>
                                <small class="text-muted">Prev: <span class="editable-field" data-field="data-prevista">{{ report_data.progresso.data_prevista_termino | default('N/A', true) }}</span></small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- % Esforço Consumido -->
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2 kpi-card">
                        <div class="card-body">
                            <i class="bi bi-hourglass-split kpi-icon"></i>
                            <div class="kpi-content">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">% ESFORÇO CONSUMIDO</div>
                                <div class="h1 mb-0 font-weight-bold text-gray-800 editable-field" data-field="percentual-esforco">{{ report_data.esforco.percentual_consumido | round(1) }}%</div>
                                <small class="text-muted"><span class="editable-field" data-field="horas-utilizadas">{{ report_data.esforco.horas_utilizadas | round(1) }}</span>h / <span class="editable-field" data-field="horas-planejadas">{{ report_data.esforco.horas_planejadas | round(1) }}</span>h</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Linha de Gráficos (Lado a Lado) -->
            <div class="row">
                <!-- Coluna Esquerda: Gráfico de Progresso -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow chart-card h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Progresso (% Concluído)</h6>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <canvas id="progressoChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
                <!-- Coluna Direita: Gráfico de Esforço -->
                <div class="col-lg-6 mb-4">
                     <div class="card shadow chart-card h-100">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Esforço (Horas Planejado vs Utilizado)</h6>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <canvas id="esforcoChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marcos Recentes (Linha inteira) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="placeholder-section">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calendar-check text-primary me-2"></i>
                            <h6 class="section-title mb-0">Marcos Recentes</h6>
                        </div>
                        {% if report_data and report_data.marcos_recentes and report_data.marcos_recentes|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr class="table-light">
                                            <th style="width: 50%">Marco</th>
                                            <th style="width: 25%">Status</th>
                                            <th style="width: 25%">Data Planejada</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for marco in report_data.marcos_recentes %}
                                            <tr {% if marco.atrasado %}class="table-danger"{% endif %}>
                                                <td>
                                                    {% if marco.atrasado %}<span class="badge bg-danger me-1" title="Marco atrasado!">!</span>{% endif %}
                                                    <span class="milestone-name">{{ marco.nome }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if marco.status == 'Concluído' %}bg-success
                                                        {% elif marco.status == 'Em Andamento' %}bg-primary
                                                        {% elif marco.status == 'Atrasado' %}bg-danger
                                                        {% else %}bg-secondary{% endif %}">
                                                        {{ marco.status }} {# Exibe o status diretamente #}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="milestone-date">{{ marco.data_planejada }}</span>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">Nenhum marco definido para este projeto.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Linha do Tempo (Linha inteira) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="placeholder-section">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-list-task text-primary me-2"></i>
                            <h6 class="section-title mb-0">Linha do Tempo (Tarefas)</h6>
                        </div>
                        <div class="card shadow-sm h-100">
                            {# Mostrar loading apenas se NÃO for PDF #}
                            <div id="timeline-loading" class="text-center p-3" {% if for_pdf %}style="display: none;"{% endif %}>
                                <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                <span class="text-muted small">Carregando tarefas...</span>
                            </div>
                            
                            <div id="timeline-error" class="text-center p-3 text-danger" style="display: none;">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                <span id="timeline-error-message" class="small">Erro ao carregar tarefas</span>
                            </div>
                            
                            <div id="timeline-empty" class="text-center p-3 text-muted" style="display: none;">
                                <i class="bi bi-info-circle me-2"></i>
                                <span class="small">Nenhuma tarefa encontrada</span>
                            </div>
                            
                            <!-- Lista de tarefas -->
                            {# Mostrar conteúdo da timeline: se for PDF, renderiza direto; senão, JS controla #}
                            <div id="timeline-content" {% if for_pdf %}style="display: block;"{% else %}style="display: none;"{% endif %}>
                                <!-- Próximas tarefas -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-calendar-event text-warning"></i>
                                        <span class="fw-bold">Próximas Tarefas (7 dias)</span>
                                    </div>
                                    <ul class="list-group list-group-flush" id="upcoming-tasks-list">
                                        {% if for_pdf %}
                                            {# Lógica para PDF para próximas tarefas, se houver dados #}
                                            {% if report_data.tarefas_proximo_prazo and report_data.tarefas_proximo_prazo|length > 0 %}
                                                <div class="column-headers" style="display: flex; justify-content: space-between; padding: 0.5rem 1rem; background-color: #f8f9fc; border-bottom: 1px solid #e3e6f0; font-weight: bold; font-size: 0.75rem;">
                                                    <div class="task-column" style="flex-basis: 50%;">Tarefa</div>
                                                    <div class="status-column" style="flex-basis: 20%; text-align: center;">Prioridade</div>
                                                    <div class="date-column" style="flex-basis: 30%; text-align: right;">Prazo</div>
                                                </div>
                                                {% for task in report_data.tarefas_proximo_prazo %}
                                                    <li class="list-group-item" title="{{ task.description if task.description else '' }}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                                        <span class="timeline-task-name" style="flex-basis: 50%; word-break: break-word;">{{ task.title | default('Tarefa sem título') }}</span>
                                                        <div class="status-container" style="flex-basis: 20%; text-align: center;">
                                                            {# Adapte o badge conforme necessário, ex: task.status ou task.priority #}
                                                            <span class="badge bg-warning text-dark">{{ task.priority | default('N/A') }}</span>
                                                        </div>
                                                        <span class="text-muted small" style="flex-basis: 30%; text-align: right;">
                                                             {{ task.due_date | default('-') }}
                                                        </span>
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <li class="list-group-item text-center text-muted small">Nenhuma tarefa com prazo nos próximos 7 dias.</li>
                                            {% endif %}
                                        {% endif %}
                                        {# Para visualização não-PDF, o JS popula aqui #}
                                    </ul>
                                </div>
                                
                                <!-- Tarefas em andamento -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-play-circle text-primary"></i>
                                        <span class="fw-bold">Em Andamento</span>
                                    </div>
                                    <ul class="list-group list-group-flush" id="started-tasks-list">
                                        {% if for_pdf %}
                                            {# Lógica para PDF para tarefas em andamento, se houver dados #}
                                            {% if report_data.tarefas_em_andamento and report_data.tarefas_em_andamento|length > 0 %}
                                                <div class="column-headers" style="display: flex; justify-content: space-between; padding: 0.5rem 1rem; background-color: #f8f9fc; border-bottom: 1px solid #e3e6f0; font-weight: bold; font-size: 0.75rem;">
                                                    <div class="task-column" style="flex-basis: 50%;">Tarefa</div>
                                                    <div class="status-column" style="flex-basis: 20%; text-align: center;">Prioridade</div>
                                                    <div class="date-column" style="flex-basis: 30%; text-align: right;">Prazo</div>
                                                </div>
                                                {% for task in report_data.tarefas_em_andamento %}
                                                    <li class="list-group-item" title="{{ task.description if task.description else '' }}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                                        <span class="timeline-task-name" style="flex-basis: 50%; word-break: break-word;">{{ task.title | default('Tarefa sem título') }}</span>
                                                        <div class="status-container" style="flex-basis: 20%; text-align: center;">
                                                            <span class="badge bg-primary">{{ task.priority | default('N/A')}}</span>
                                                        </div>
                                                        <span class="text-muted small" style="flex-basis: 30%; text-align: right;">
                                                            {{ task.due_date | default('-') }}
                                                        </span>
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <li class="list-group-item text-center text-muted small">Nenhuma tarefa em andamento.</li>
                                            {% endif %}
                                        {% endif %}
                                        {# Para visualização não-PDF, o JS popula aqui #}
                                    </ul>
                                </div>
                                
                                <!-- NOVA SEÇÃO: Tarefas em Revisão -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-search text-info"></i> {# Ícone para Revisão #}
                                        <span class="fw-bold">Em Revisão</span>
                                    </div>
                                    <ul class="list-group list-group-flush" id="review-tasks-list">
                                        {% if for_pdf %}
                                            {# Lógica para PDF para tarefas em revisão, se houver dados #}
                                            {% if report_data.tarefas_em_revisao and report_data.tarefas_em_revisao|length > 0 %}
                                                <div class="column-headers" style="display: flex; justify-content: space-between; padding: 0.5rem 1rem; background-color: #f8f9fc; border-bottom: 1px solid #e3e6f0; font-weight: bold; font-size: 0.75rem;">
                                                    <div class="task-column" style="flex-basis: 50%;">Tarefa</div>
                                                    <div class="status-column" style="flex-basis: 20%; text-align: center;">Prioridade</div>
                                                    <div class="date-column" style="flex-basis: 30%; text-align: right;">Prazo</div>
                                                </div>
                                                {% for task in report_data.tarefas_em_revisao %}
                                                    <li class="list-group-item" title="{{ task.description if task.description else '' }}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                                        <span class="timeline-task-name" style="flex-basis: 50%; word-break: break-word;">{{ task.title | default('Tarefa sem título') }}</span>
                                                        <div class="status-container" style="flex-basis: 20%; text-align: center;">
                                                            <span class="badge bg-info">{{ task.priority | default('N/A') }}</span>
                                                        </div>
                                                        <span class="text-muted small" style="flex-basis: 30%; text-align: right;">
                                                            {{ task.due_date | default('-') }}
                                                        </span>
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <li class="list-group-item text-center text-muted small">Nenhuma tarefa em revisão.</li>
                                            {% endif %}
                                        {% endif %}
                                        {# Para visualização não-PDF, o JS popula aqui #}
                                    </ul>
                                </div>
                                
                                <!-- NOVA SEÇÃO: Tarefas Pendentes -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-pause-circle text-secondary"></i> {# Ícone para Pendente #}
                                        <span class="fw-bold">Pendente</span>
                                    </div>
                                    <ul class="list-group list-group-flush" id="pending-tasks-list">
                                        {% if for_pdf %}
                                            {# Lógica para PDF para tarefas pendentes, se houver dados #}
                                            {% if report_data.tarefas_pendentes and report_data.tarefas_pendentes|length > 0 %}
                                                <div class="column-headers" style="display: flex; justify-content: space-between; padding: 0.5rem 1rem; background-color: #f8f9fc; border-bottom: 1px solid #e3e6f0; font-weight: bold; font-size: 0.75rem;">
                                                    <div class="task-column" style="flex-basis: 50%;">Tarefa</div>
                                                    <div class="status-column" style="flex-basis: 20%; text-align: center;">Prioridade</div>
                                                    <div class="date-column" style="flex-basis: 30%; text-align: right;">Prazo</div>
                                                </div>
                                                {% for task in report_data.tarefas_pendentes %}
                                                    <li class="list-group-item" title="{{ task.description if task.description else '' }}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; font-size: 0.8rem;">
                                                        <span class="timeline-task-name" style="flex-basis: 50%; word-break: break-word;">{{ task.title | default('Tarefa sem título') }}</span>
                                                        <div class="status-container" style="flex-basis: 20%; text-align: center;">
                                                            {% set priority_class = 'bg-secondary' %}
                                                            {% if task.priority == 'Alta' %} {% set priority_class = 'bg-warning text-dark' %}
                                                            {% elif task.priority == 'Urgente' %} {% set priority_class = 'bg-danger' %}
                                                            {% elif task.priority == 'Média' %} {% set priority_class = 'bg-info' %}
                                                            {% elif task.priority == 'Baixa' %} {% set priority_class = 'bg-success' %}{% endif %}
                                                            <span class="badge {{ priority_class }}">{{ task.priority | default('N/A')}}</span>
                                                        </div>
                                                        <span class="text-muted small" style="flex-basis: 30%; text-align: right;">
                                                            {{ task.due_date | default('-') }}
                                                        </span>
                                                    </li>
                                                {% endfor %}
                                            {% else %}
                                                <li class="list-group-item text-center text-muted small">Nenhuma tarefa pendente.</li>
                                            {% endif %}
                                        {% endif %}
                                        {# Para visualização não-PDF, o JS popula aqui #}
                                    </ul>
                                </div>
                                
                                <!-- Tarefas concluídas -->
                                <div class="timeline-section">
                                    <div class="section-header">
                                        <i class="bi bi-check-circle text-success"></i>
                                        <span class="fw-bold">Concluídas</span>
                                    </div>
                                    <ul class="list-group list-group-flush" id="completed-tasks-list">
                                        {% if for_pdf %}
                                            <li class="list-group-item text-center text-muted small">Dados de tarefas concluídas não disponíveis para PDF.</li>
                                        {% endif %}
                                        {# Para visualização não-PDF, o JS popula aqui #}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Riscos e Impedimentos (Linha inteira) -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="placeholder-section">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
                            <h6 class="section-title mb-0">Riscos e Impedimentos</h6>
                        </div>
                        <div class="card shadow-sm h-100">
                            <div class="card-body p-0" style="min-height: 180px;">
                                {% if report_data.riscos_impedimentos and report_data.riscos_impedimentos|length > 0 %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover table-striped mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 50%; padding-left: 1rem;">Descrição</th>
                                                    <th class="text-center" style="width: 25%;">Severidade</th>
                                                    <th class="text-center" style="width: 25%; padding-right: 1rem;">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for risco in report_data.riscos_impedimentos %}
                                                    <tr>
                                                        <td style="white-space: pre-wrap; word-break: break-word; font-size: 0.75rem; padding-left: 1rem;">{{ risco.description }}</td>
                                                        <td class="text-center">
                                                            {% set severity_class = 'badge bg-secondary' %}
                                                            {% if risco.severity == 'Crítico' %}
                                                                {% set severity_class = 'badge bg-danger' %}
                                                            {% elif risco.severity == 'Alto' %}
                                                                {% set severity_class = 'badge bg-warning text-dark' %}
                                                            {% elif risco.severity == 'Médio' %}
                                                                {% set severity_class = 'badge bg-info text-dark' %}
                                                            {% elif risco.severity == 'Baixo' %}
                                                                {% set severity_class = 'badge bg-secondary' %}
                                                            {% endif %}
                                                            <span class="{{ severity_class }}" style="font-size: 0.65rem;">{{ risco.severity }}</span>
                                                        </td>
                                                        <td class="text-center" style="padding-right: 1rem;">
                                                            {% set status_class = 'badge bg-secondary' %}
                                                            {% if risco.status == 'Ativo' %}
                                                                {% set status_class = 'badge bg-warning text-dark' %}
                                                            {% elif risco.status == 'Mitigado' %}
                                                                {% set status_class = 'badge bg-info text-dark' %}
                                                            {% elif risco.status == 'Resolvido' %}
                                                                {% set status_class = 'badge bg-success' %}
                                                            {% endif %}
                                                            <span class="{{ status_class }}" style="font-size: 0.65rem;">{{ risco.status }}</span>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center text-muted small py-3 px-3" style="min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                        <i class="bi bi-shield-check" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                        <span>Nenhum risco ou impedimento ativo identificado para este projeto.</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notas e Observações -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="placeholder-section">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-journal-text text-primary me-2"></i>
                            <h6 class="section-title mb-0">Notas e Observações</h6>
                        </div>
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                {% if report_data.notas and report_data.notas|length > 0 %}
                                    <div class="list-group list-group-flush">
                                        {% for nota in report_data.notas %}
                                            <div class="list-group-item border-start-0 border-end-0 py-3">
                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <div>
                                                        {% if nota.task_id and nota.task_title %}
                                                            <span class="badge bg-info me-2">Tarefa: {{ nota.task_title }}</span>
                                                        {% endif %}
                                                        <span class="badge bg-{{ nota.category_color }}">{{ nota.category_text }}</span>
                                                        <span class="badge bg-{{ nota.priority_color }}">{{ nota.priority_text }}</span>
                                                    </div>
                                                    <small class="text-muted" title="{{ 'Data do Evento' if nota.event_date else 'Data de Criação' }}">{{ nota.event_date if nota.event_date else nota.created_at }}</small>
                                                </div>
                                                <div class="note-content" style="white-space: pre-wrap; font-size: 0.9rem; text-align: left;">{{ nota.content }}</div>
                                                {% if nota.tags and nota.tags|length > 0 %}
                                                    <div class="mt-2">
                                                        {% for tag in nota.tags %}
                                                            <span class="badge bg-secondary me-1" style="font-size: 0.7rem;">{{ tag }}</span>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="text-center text-muted small py-3 px-3" style="min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                        <i class="bi bi-info-circle" style="font-size: 1.5rem; margin-bottom: 0.5rem;"></i>
                                        <span>Nenhuma nota registrada para este projeto (ID: {{ project_id }}).</span>
                                        <small class="text-muted mt-1">As notas criadas no Quadro aparecerão aqui automaticamente.</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Rodapé Profissional -->
            <div class="company-footer pdf-only">
                <div class="footer-line"> <!-- Nova classe para controle -->
                    Documento gerado em: {{ data_geracao | default('N/A', true) }}
                </div>
                <div class="footer-line"> <!-- Nova classe para controle -->
                    Este documento é destinado exclusivamente para o cliente.
                </div>
                <div class="footer-line"> <!-- Nova classe para controle -->
                    © 2025 SOU.cloud - Todos os direitos reservados
                </div>
            </div>
            
            </div><!-- Fim do container para PDF -->

    {% else %}
         <div class="alert alert-warning" role="alert">
            Não foi possível carregar os dados para o Status Report do projeto ID {{ project_id }}.
        </div>
    {% endif %}
</div>

<!-- Script para passar dados para JS e inicializar gráficos -->
<script id="report-data-json" type="application/json">
    {{ report_data | tojson | safe if report_data else '{}' }}
</script>

{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- Importar bibliotecas necessárias para geração de PDF no navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    let reportData; // Declarar reportData em um escopo mais global

    document.addEventListener('DOMContentLoaded', function() {
        // --- Variáveis para o modo de edição ---
        const editModeBtn = document.getElementById('editModeBtn');
        const pdfContent = document.getElementById('pdfContent');
        const editableFields = document.querySelectorAll('.editable-field');
        let editMode = false;
        let charts = {}; // Armazena referências para os gráficos
        
        // --- Código para geração de gráficos ---
        const reportDataElement = document.getElementById('report-data-json');
        if (!reportDataElement) {
            console.error('Elemento com dados do report não encontrado!');
            // Seta reportData como um objeto vazio para evitar erros subsequentes caso o script da timeline execute.
            reportData = {}; 
            return;
        }
        
        // let reportData; // Removida declaração local
        try {
            reportData = JSON.parse(reportDataElement.textContent); // Atribui à reportData do escopo superior
            console.log("Dados do Report para JS (escopo principal):", reportData);
        } catch (e) {
            console.error("Erro ao parsear dados JSON do report:", e);
            reportData = {}; // Garante que reportData seja um objeto em caso de erro
            return; 
        }

        // Verifica se os dados necessários existem ANTES de tentar criar os gráficos
        if (!reportData || !reportData.progresso || !reportData.esforco) {
            console.warn("Dados incompletos ou não encontrados para gerar gráficos.");
            // Opcional: Ocultar ou mostrar mensagem nos divs dos gráficos
             const progressoCanvas = document.getElementById('progressoChart');
            const esforcoCanvas = document.getElementById('esforcoChart');
            if (progressoCanvas) progressoCanvas.parentElement.innerHTML = '<p class="text-muted text-center mt-5">Dados de progresso indisponíveis.</p>';
            if (esforcoCanvas) esforcoCanvas.parentElement.innerHTML = '<p class="text-muted text-center mt-5">Dados de esforço indisponíveis.</p>';
            return; // Não tenta criar os gráficos
        }
        
        // Somente continua se reportData for válido
        try {
            // --- Gráfico de Progresso (Gauge/Doughnut) ---
            const progressoCtx = document.getElementById('progressoChart')?.getContext('2d');
            if (progressoCtx) {
                const percentualConcluido = reportData.progresso.percentual_concluido || 0;
                const corProgresso = percentualConcluido >= 70 ? '#1cc88a' : (percentualConcluido >= 50 ? '#f6c23e' : '#e74a3b');

                charts.progresso = new Chart(progressoCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [percentualConcluido, 100 - percentualConcluido],
                            backgroundColor: [corProgresso, '#e9ecef'],
                            borderColor: [corProgresso, '#e9ecef'],
                            borderWidth: 1,
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        aspectRatio: 2,
                        cutout: '75%',
                        layout: {
                            padding: {
                                bottom: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false },
                            title: { display: false },
                            animation: {
                                onComplete: function(animation) {
                                    var chartInstance = animation.chart,
                                        ctx = chartInstance.ctx;
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    ctx.font = "bold 24px Inter";

                                    var value = chartInstance.data.datasets[0].data[0];
                                    var color = chartInstance.data.datasets[0].backgroundColor[0]; 
                                    ctx.fillStyle = color;

                                    var x = chartInstance.width / 2;
                                    var y = chartInstance.height / 1.1;
                                    
                                    ctx.fillText(value + '%', x, y);
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn("Elemento canvas 'progressoChart' não encontrado.");
            }

            // --- Gráfico de Esforço (Barras) ---
            const esforcoCtx = document.getElementById('esforcoChart')?.getContext('2d');
            if (esforcoCtx) {
                const horasPlanejadas = reportData.esforco.horas_planejadas || 0;
                const horasUtilizadas = reportData.esforco.horas_utilizadas || 0;
                const corPlanejado = '#adb5bd';
                const corUtilizado = horasUtilizadas > horasPlanejadas ? '#e74a3b' : '#4e73df';

                charts.esforco = new Chart(esforcoCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Utilizado', 'Planejado'],
                        datasets: [
                            {
                                label: 'Horas',
                                data: [horasUtilizadas, horasPlanejadas],
                                backgroundColor: [corUtilizado, corPlanejado],
                                borderColor: [corUtilizado, corPlanejado],
                                borderWidth: 1,
                                barPercentage: 0.5, /* Reduzido de 0.6 */ 
                                categoryPercentage: 0.6 /* Reduzido de 0.7 */
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false,
                        aspectRatio: 2.2, 
                        layout: {
                            padding: { 
                                left: 5, /* Revertido de 45 */
                                right: 10, /* Revertido de 20 */
                                top: 5,
                                bottom: 5
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed.x.toFixed(1) + 'h';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Horas',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: true,
                                    drawBorder: true,
                                    drawOnChartArea: true,
                                    drawTicks: true,
                                    color: '#e9ecef'
                                }
                            },
                            y: {
                                ticks: {
                                    padding: 5,
                                    font: { 
                                        size: 9 /* Reduzir um pouco o tamanho da fonte das legendas Y */ 
                                    }
                                },
                                grid: {
                                    display: false
                                },
                                afterFit: function(scaleInstance) {
                                    scaleInstance.width = scaleInstance.width + 30; // Adicionar 30px para as legendas do eixo Y
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn("Elemento canvas 'esforcoChart' não encontrado.");
            }
        } catch (chartError) {
            console.error("Erro ao criar gráficos:", chartError);
        }

        // --- Função para atualizar os gráficos com novos valores ---
        function updateCharts(forPdf = false) {
            // Atualiza gráfico de progresso
            if (charts.progresso) {
                const percentualText = document.querySelector('[data-field="percentual-concluido"]').textContent;
                const percentual = parseFloat(percentualText.replace('%', ''));
                const corProgresso = percentual >= 70 ? '#1cc88a' : (percentual >= 50 ? '#f6c23e' : '#e74a3b');
                
                charts.progresso.data.datasets[0].data[0] = percentual;
                charts.progresso.data.datasets[0].data[1] = 100 - percentual;
                charts.progresso.data.datasets[0].backgroundColor[0] = corProgresso;
                charts.progresso.data.datasets[0].borderColor[0] = corProgresso;
                
                // Ajusta fontes para PDF
                if (forPdf) {
                    charts.progresso.options.plugins.animation.onComplete = function(animation) {
                        var chartInstance = animation.chart,
                            ctx = chartInstance.ctx;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.font = "bold 18px Inter"; // Fonte menor para PDF
                        
                        var value = chartInstance.data.datasets[0].data[0];
                        var color = chartInstance.data.datasets[0].backgroundColor[0]; 
                        ctx.fillStyle = color;
                        
                        var x = chartInstance.width / 2;
                        var y = chartInstance.height / 1.1;
                        
                        ctx.fillText(value + '%', x, y);
                    };
                }
                
                charts.progresso.update();
            }
            
            // Atualiza gráfico de esforço
            if (charts.esforco) {
                const horasUtilizadasText = document.querySelector('[data-field="horas-utilizadas"]').textContent;
                const horasPlanejadaText = document.querySelector('[data-field="horas-planejadas"]').textContent;
                
                const horasUtilizadas = parseFloat(horasUtilizadasText);
                const horasPlanejadas = parseFloat(horasPlanejadaText);
                
                const corUtilizado = horasUtilizadas > horasPlanejadas ? '#e74a3b' : '#4e73df';
                
                charts.esforco.data.datasets[0].data[0] = horasUtilizadas;
                charts.esforco.data.datasets[0].data[1] = horasPlanejadas;
                charts.esforco.data.datasets[0].backgroundColor[0] = corUtilizado;
                charts.esforco.data.datasets[0].borderColor[0] = corUtilizado;
                
                // Ajusta para PDF
                if (forPdf) {
                    charts.esforco.options.scales.x.title.display = false; // Remove título do eixo X
                    charts.esforco.options.scales.x.ticks.font = { size: 8 }; // Fonte menor nos ticks
                    charts.esforco.options.scales.y.ticks.font = { size: 8 }; // Fonte menor nos ticks
                }
                
                charts.esforco.update();
            }
        }

        // --- Funções para o modo de edição ---
        // Alternar modo de edição
        function toggleEditMode() {
            editMode = !editMode;
            
            if (editMode) {
                // Ativar modo de edição
                pdfContent.classList.add('edit-mode');
                editModeBtn.classList.add('active');
                editModeBtn.querySelector('span').textContent = 'Salvar Alterações';
                
                // Tornar editável o seletor de status
                const statusSelector = document.querySelector('.status-selector');
                if (statusSelector) {
                    statusSelector.style.display = 'inline-block';
                    const statusText = document.querySelector('[data-status-text]');
                    if (statusText) {
                        statusText.style.display = 'none';
                    }
                    
                    // Seleciona o valor atual no dropdown
                    const statusDot = document.querySelector('[data-status-dot]');
                    const currentStatus = statusDot.className.includes('verde') ? 'verde' : 
                                          statusDot.className.includes('amarelo') ? 'amarelo' : 
                                          statusDot.className.includes('vermelho') ? 'vermelho' : 'cinza';
                    
                    const selectElement = statusSelector.querySelector('select');
                    selectElement.value = currentStatus;
                    
                    const statusTextMap = {
                        verde: "No Prazo",
                        amarelo: "Atenção",
                        vermelho: "Crítico",
                        cinza: "Não Iniciado"
                    };
                    
                    // Adiciona listener para mudar a cor do status dot quando o select muda
                    selectElement.addEventListener('change', function() {
                        const newStatusColor = selectElement.value;
                        statusDot.className = 'status-dot status-' + newStatusColor;
                        statusText.className = 'h5 status-text text-' + newStatusColor + ' editable-field';
                        statusText.textContent = statusTextMap[newStatusColor] || 'Não Iniciado';
                    });
                }

                // Não permite editar a tabela de marcos, apenas os demais campos editáveis
                const marcosTable = document.querySelector('.col-md-4 .card.shadow .table-responsive');
                if (marcosTable) {
                    marcosTable.setAttribute('data-original-state', 'preserved');
                    console.log("Tabela de marcos preservada no modo de edição");
                }
            } else {
                // Desativar modo de edição
                pdfContent.classList.remove('edit-mode');
                editModeBtn.classList.remove('active');
                editModeBtn.querySelector('span').textContent = 'Editar Relatório';
                
                // Desativar e esconder o seletor de status
                const statusSelector = document.querySelector('.status-selector');
                if (statusSelector) {
                    statusSelector.style.display = 'none';
                    const statusText = document.querySelector('[data-status-text]');
                    if (statusText) {
                        statusText.style.display = 'inline';
                    }
                }
                
                // Remover quaisquer inputs ativos
                document.querySelectorAll('.edit-input').forEach(input => {
                    const parent = input.parentElement;
                    parent.textContent = input.value;
                    parent.classList.remove('editing');
                });
                
                // Atualizar os gráficos
                updateCharts();
            }
        }
        
        // Adicionar listeners para os campos editáveis
        editableFields.forEach(field => {
            field.addEventListener('click', function() {
                // Só edita se estiver no modo de edição
                if (!editMode || field.classList.contains('editing')) return;
                
                // Caso especial para status-geral (que tem select)
                if (field.dataset.field === 'status-geral') return;
                
                // Cria um input para editar o valor
                const originalText = field.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalText;
                input.className = 'edit-input';
                
                // Para percentuais e horas, forçar números
                if (field.dataset.field === 'percentual-concluido' || 
                    field.dataset.field === 'percentual-esforco' ||
                    field.dataset.field === 'horas-utilizadas' ||
                    field.dataset.field === 'horas-planejadas') {
                    input.type = 'number';
                    input.step = '0.1';
                    input.min = '0';
                    input.value = originalText.replace('%', '');
                }
                
                // Para datas
                if (field.dataset.field === 'data-prevista') {
                    const dateParts = originalText.split('/');
                    if (dateParts.length === 3) {
                        input.type = 'date';
                        // Formato yyyy-mm-dd para input date
                        input.value = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    }
                }
                
                field.textContent = '';
                field.appendChild(input);
                field.classList.add('editing');
                input.focus();
                
                // Lidar com perda de foco ou Enter para salvar
                input.addEventListener('blur', saveChanges);
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveChanges();
                    }
                });
                
                function saveChanges() {
                    let newValue = input.value;
                    
                    // Para percentuais, adicionar % de volta
                    if (field.dataset.field === 'percentual-concluido' || 
                        field.dataset.field === 'percentual-esforco') {
                        newValue += '%';
                    }
                    
                    // Para datas, converter de volta para dd/mm/yyyy
                    if (field.dataset.field === 'data-prevista' && input.type === 'date') {
                        const date = new Date(input.value);
                        if (!isNaN(date.getTime())) {
                            const day = date.getDate().toString().padStart(2, '0');
                            const month = (date.getMonth() + 1).toString().padStart(2, '0');
                            const year = date.getFullYear();
                            newValue = `${day}/${month}/${year}`;
                        }
                    }
                    
                    field.textContent = newValue;
                    field.classList.remove('editing');
                }
            });
        });
        
        // Adicionar listener ao botão de modo de edição
        if (editModeBtn) {
            editModeBtn.addEventListener('click', toggleEditMode);
        }

        // --- CONFIGURAÇÃO DE GERAÇÃO DE PDF via html2pdf.js ---
        const generatePDFBtn = document.getElementById('generatePdfBtn');
        if (generatePDFBtn) {
            generatePDFBtn.addEventListener('click', function() {
                // Se estiver no modo de edição, salvar alterações primeiro
                if (editMode) {
                    toggleEditMode(); // Sai do modo de edição e salva alterações
                }
                
                // Mostra um indicador de carregamento para processos longos
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style.position = 'fixed';
                loadingOverlay.style.top = '0';
                loadingOverlay.style.left = '0';
                loadingOverlay.style.width = '100%';
                loadingOverlay.style.height = '100%';
                loadingOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.justifyContent = 'center';
                loadingOverlay.style.alignItems = 'center';
                loadingOverlay.style.zIndex = '9999';
                loadingOverlay.innerHTML = `
                    <div style="text-align: center;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Gerando PDF, aguarde...</p>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);

                // Obter elemento a ser convertido
                const element = document.getElementById('pdfContent');
                
                // Adiciona uma classe temporária para aplicar estilos de impressão
                element.classList.add('print-mode');
                
                // Mostra elementos que são apenas para PDF
                const pdfElements = element.querySelectorAll('.pdf-only');
                pdfElements.forEach(el => {
                    el.style.display = 'block';
                });
                
                // Esconde elementos que são apenas para tela
                const screenElements = element.querySelectorAll('.screen-only');
                screenElements.forEach(el => {
                    el.style.display = 'none';
                });
                
                // Nome do arquivo a ser gerado
                const projectName = reportData?.info_geral?.nome || 'status_report';
                const projectId = reportData?.info_geral?.id || '';
                const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const filename = `status_report_${projectName.toLowerCase().replace(/\s+/g, '_')}_${projectId}_${today}.pdf`;
                
                // Primeiro, otimiza os gráficos para o PDF
                updateCharts(true);
                
                // Espera um tempo para que os gráficos sejam renderizados corretamente
                setTimeout(() => {
                    try {
                        // Captura os canvas de gráficos e os converte para imagens para melhor compatibilidade
                        const chartCanvases = pdfContent.querySelectorAll('canvas');
                        const chartPromises = Array.from(chartCanvases).map(canvas => {
                            return new Promise((resolve) => {
                                const img = new Image();
                                img.src = canvas.toDataURL('image/png');
                                img.style.maxWidth = '100%';
                                img.style.height = 'auto';
                                img.onload = () => {
                                    // Substitui o canvas pela imagem
                                    canvas.parentNode.replaceChild(img, canvas);
                                    resolve();
                                };
                            });
                        });
                        
                        // Quando todas as imagens estiverem carregadas, gera o PDF
                        Promise.all(chartPromises).then(() => {
                            // Configuração para PDF profissional 
                            const pdfOptions = {
                                margin: [10, 10, 10, 10], // Margens simples e uniformes em mm
                                filename: filename,
                                image: { type: 'jpeg', quality: 0.98 },
                                html2canvas: { 
                                    scale: 2, // Resolução padrão
                                    useCORS: true,
                                    letterRendering: true,
                                    allowTaint: true,
                                    backgroundColor: '#ffffff',
                                    logging: true, // Habilitar logs para diagnóstico
                                    onclone: function(clonedDocument) {
                                        // Certifique-se de que os elementos estão visíveis
                                        const clonedContent = clonedDocument.getElementById('pdfContent');
                                        if (clonedContent) {
                                            // Remover classes que podem afetar visibilidade
                                            clonedContent.classList.add('print-mode');
                                            
                                            // Mostrar elementos PDF-only
                                            const pdfElements = clonedContent.querySelectorAll('.pdf-only');
                                            pdfElements.forEach(el => el.style.display = 'block');
                                            
                                            // Esconder elementos screen-only
                                            const screenElements = clonedContent.querySelectorAll('.screen-only');
                                            screenElements.forEach(el => el.style.display = 'none');
                                        }
                                    }
                                },
                                jsPDF: { 
                                    unit: 'mm', 
                                    format: 'a4', 
                                    orientation: 'portrait',
                                    compress: true
                                },
                                pagebreak: { mode: 'avoid-all' },
                                // Adicionar callback para numeração de página
                                didDrawPage: function (data) {
                                    // Adicionar número da página
                                    const pageCount = data.doc.internal.getNumberOfPages();
                                    data.doc.setFontSize(7);
                                    data.doc.setTextColor(102, 102, 102); // Cor #666
                                    data.doc.text(
                                        'Página ' + data.pageNumber + ' de ' + pageCount,
                                        data.settings.margin.left, // Alinha com a margem esquerda
                                        data.doc.internal.pageSize.height - 7 // Posição no rodapé
                                    );
                                }
                            };
                            
                            // Gerar o PDF com configuração básica
                            html2pdf().from(element).set(pdfOptions).save().then(() => {
                                // Restaurar elementos após gerar PDF
                                pdfElements.forEach(el => el.style.display = 'none');
                                screenElements.forEach(el => el.style.display = 'block');
                                element.classList.remove('print-mode');
                                document.body.removeChild(loadingOverlay);
                                
                                // Restaurar os canvas originais
                                updateCharts();

                                // Limpar a numeração de página manual se existir
                                const pageNumSpans = pdfContent.querySelectorAll('.pageNumber, .totalPages');
                                pageNumSpans.forEach(span => span.textContent = '');

                            }).catch(error => {
                                console.error('Erro ao gerar PDF:', error);
                                alert('Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.');
                                document.body.removeChild(loadingOverlay);
                                
                                // Restaurar os canvas originais
                                updateCharts();

                                // Limpar a numeração de página manual se existir
                                const pageNumSpans = pdfContent.querySelectorAll('.pageNumber, .totalPages');
                                pageNumSpans.forEach(span => span.textContent = '');
                            });
                        });
                    } catch (error) {
                        console.error('Erro ao preparar PDF:', error);
                        alert('Ocorreu um erro ao preparar o PDF. Por favor, tente novamente.');
                        document.body.removeChild(loadingOverlay);
                    }
                }, 300); // Tempo para garantir que os gráficos sejam renderizados
            });
        }
    });
</script>

<!-- Script para carregar a linha do tempo -->
<script>
// Formatação de data
function formatDateStringSR(dateStr) { // Renomeado para evitar conflito se houver outra formatDateString global
    if (!dateStr) return "-";
    // Verifica se a string já está no formato dd/MM/YYYY (pode vir assim do backend)
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
        return dateStr;
    }
    // Se for YYYY-MM-DD (comum de inputs ou algumas APIs)
    if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        const parts = dateStr.split('-');
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    // Tenta parsear como ISO (para datas com hora)
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr; 
        return date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'});
    } catch (e) {
        console.error("[SR Timeline] Erro ao formatar data:", e, dateStr);
        return dateStr;
    }
}

// Escapa HTML para tooltips seguros
function escapeHtmlSR(unsafe) { // Renomeado
    if (!unsafe) return '';
    return unsafe
        .toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

document.addEventListener('DOMContentLoaded', function() {
    // Elementos DOM para manipulação
    const loadingElement = document.getElementById('timeline-loading');
    const errorElement = document.getElementById('timeline-error');
    const errorMessageElement = document.getElementById('timeline-error-message');
    const emptyElement = document.getElementById('timeline-empty');
    const contentElement = document.getElementById('timeline-content');
    
    const upcomingTasksList = document.getElementById('upcoming-tasks-list');
    const startedTasksList = document.getElementById('started-tasks-list'); // Para "Em Andamento"
    const reviewTasksList = document.getElementById('review-tasks-list'); // NOVA LISTA
    const pendingTasksList = document.getElementById('pending-tasks-list'); // NOVA LISTA PENDENTES
    const completedTasksList = document.getElementById('completed-tasks-list');
    
    if (!loadingElement || !errorElement || !emptyElement || !contentElement ||
        !upcomingTasksList || !startedTasksList || !reviewTasksList || !pendingTasksList || !completedTasksList) { // Adicionado pendingTasksList
        console.error("[SR Timeline] Um ou mais elementos da linha do tempo não encontrados no DOM.");
        if(loadingElement) loadingElement.style.display = 'none';
        if(errorElement) {
            errorElement.style.display = 'block';
            if(errorMessageElement) errorMessageElement.textContent = 'Erro na configuração da página (elementos faltando).';
        }
        return;
    }

    // Função para mostrar/ocultar elementos de status da timeline
    function setTimelineDisplayStatus(isLoading, hasError, errorMsg, isEmptyOverall) {
        loadingElement.style.display = isLoading ? 'block' : 'none';
        errorElement.style.display = hasError ? 'block' : 'none';
        if (errorMessageElement && errorMsg) errorMessageElement.textContent = errorMsg;
        emptyElement.style.display = isEmptyOverall ? 'block' : 'none';
        contentElement.style.display = (!isLoading && !hasError && !isEmptyOverall) ? 'block' : 'none';
    }

    // Função auxiliar para renderizar uma lista de tarefas
    function renderTaskListSR(listElement, tasks, sectionTitle, defaultStatusBadge) {
        if (!listElement) {
            console.warn(`[SR Timeline] Elemento de lista para '${sectionTitle}' não encontrado.`);
            return 0; // Retorna 0 tarefas renderizadas
        }
        if (!tasks || tasks.length === 0) {
            listElement.innerHTML = `<li class="list-group-item text-center text-muted small">Nenhuma tarefa ${sectionTitle.toLowerCase()}.</li>`;
            return 0;
        }
        
        let html = '';
        // Adicionar cabeçalho padrão para todas as listas
        html += `
            <div class="column-headers" style="display: flex; justify-content: space-between; padding: 0.5rem 1rem; background-color: #f8f9fc; border-bottom: 1px solid #e3e6f0; font-weight: bold; font-size: 0.75rem;">
                <div class="task-column" style="flex-basis: 50%;">Tarefa</div>
                <div class="status-column" style="flex-basis: 20%; text-align: center;">Prioridade</div>
                <div class="date-column" style="flex-basis: 30%; text-align: right;">Prazo/Conclusão</div>
            </div>
        `;

        tasks.forEach(task => {
            const title = task.title || task.titulo || 'Tarefa sem título';
            const priority = task.priority || 'N/A';
            let dateDisplay = task.due_date ? formatDateStringSR(task.due_date) : 'N/A';
            if (sectionTitle.toLowerCase().includes('concluída') && task.completed_at) {
                dateDisplay = formatDateStringSR(task.completed_at.split(' ')[0]); // Pega só a data de completed_at
            }

            let priorityBadgeClass = 'bg-secondary';
            if (priority === 'Alta') priorityBadgeClass = 'bg-warning text-dark';
            else if (priority === 'Urgente') priorityBadgeClass = 'bg-danger';
            else if (priority === 'Média') priorityBadgeClass = 'bg-info'; // Ajuste para Média ser azul claro
            else if (priority === 'Baixa') priorityBadgeClass = 'bg-success'; // Ajuste para Baixa ser verde claro

            html += `
                <li class="list-group-item" title="${escapeHtmlSR(task.description || '')}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; font-size: 0.8rem;">
                    <span class="timeline-task-name" style="flex-basis: 50%; word-break: break-word;">${escapeHtmlSR(title)}</span>
                    <div class="status-container" style="flex-basis: 20%; text-align: center;">
                        <span class="badge ${priorityBadgeClass}">${escapeHtmlSR(priority)}</span>
                    </div>
                    <span class="text-muted small" style="flex-basis: 30%; text-align: right;">
                        ${dateDisplay}
                    </span>
                </li>
            `;
        });
        listElement.innerHTML = html;
        return tasks.length;
    }

    // Checa se reportData está disponível (deve ter sido parseado pelo script anterior)
    if (typeof reportData === 'undefined' || !reportData) {
        console.error("[SR Timeline] reportData não está definido ou é nulo.");
        setTimelineDisplayStatus(false, true, "Dados do relatório não puderam ser carregados.", false);
        return;
    }

    console.log("[SR Timeline] Usando reportData para popular listas:", reportData);
    
    // Ocultar loading inicial e mensagem de erro/vazio, pois vamos popular ou mostrar mensagens específicas por lista.
    loadingElement.style.display = 'none';
    errorElement.style.display = 'none';
    emptyElement.style.display = 'none';
    contentElement.style.display = 'block'; // Garante que o container das listas esteja visível

    let totalTasksRendered = 0;

    // 1. Próximas Tarefas (usa reportData.tarefas_proximo_prazo)
    totalTasksRendered += renderTaskListSR(upcomingTasksList, reportData.tarefas_proximo_prazo, 'Próximas a Vencer', '<span class="badge bg-warning text-dark">Pendente</span>');

    // 2. Tarefas em Andamento (usa reportData.tarefas_em_andamento)
    totalTasksRendered += renderTaskListSR(startedTasksList, reportData.tarefas_em_andamento, 'Em Andamento', '<span class="badge bg-primary">Andamento</span>');

    // 3. Tarefas em Revisão (usa reportData.tarefas_em_revisao) - NOVA
    totalTasksRendered += renderTaskListSR(reviewTasksList, reportData.tarefas_em_revisao, 'Em Revisão', '<span class="badge bg-info">Revisão</span>');

    // X. Tarefas Pendentes (NOVO)
    totalTasksRendered += renderTaskListSR(pendingTasksList, reportData.tarefas_pendentes, 'Pendentes', '<span class="badge bg-secondary">Pendente</span>');

    // 4. Tarefas Concluídas (usa report_data.tarefas_concluidas)
    totalTasksRendered += renderTaskListSR(completedTasksList, reportData.tarefas_concluidas, 'Concluídas', '<span class="badge bg-success">Concluído</span>');

    // Se nenhuma tarefa foi renderizada em nenhuma lista, mostra a mensagem geral de "timeline vazia"
    if (totalTasksRendered === 0) {
        emptyElement.style.display = 'block';
        // Opcional: esconder o contentElement se não houver absolutamente nada.
        // contentElement.style.display = 'none'; 
    }
});
</script>
{% endblock %}