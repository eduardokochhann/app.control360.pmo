<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Dados - Control360</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
        }
        
        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: #5a6fd8;
            background: #f8f9ff;
        }
        
        .upload-zone.dragover {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .stats-card {
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .data-table {
            font-size: 0.8rem;
        }
        
        /* Melhora visual da tabela */
        .table-container {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .data-table th {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #495057;
        }
        
        .data-table tbody tr:hover {
            background-color: #f8f9ff !important;
        }
        
        .editable-cell {
            cursor: pointer;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .editable-cell:hover {
            background: #f8f9ff;
            border: 1px dashed #667eea;
            cursor: text;
        }
        
        .editable-cell::after {
            content: '‚úé';
            opacity: 0;
            margin-left: 5px;
            color: #667eea;
            font-size: 0.7rem;
            transition: opacity 0.2s;
        }
        
        .editable-cell:hover::after {
            opacity: 0.7;
        }
        
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .processing-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        
        .table-container {
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: auto;
        }
        
        .data-table {
            font-size: 0.8rem;
            white-space: nowrap;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.5rem 0.75rem;
            min-width: 120px;
        }
        
        .data-table th:first-child,
        .data-table td:first-child {
            min-width: 60px;
            max-width: 60px;
        }
        
        .data-table th:last-child,
        .data-table td:last-child {
            min-width: 100px;
            max-width: 100px;
        }
        
        /* Colunas espec√≠ficas com larguras otimizadas */
        .data-table th:nth-child(2), /* Aberto em */
        .data-table td:nth-child(2) {
            min-width: 100px;
            max-width: 100px;
        }
        
        .data-table th:nth-child(3), /* Account Manager */
        .data-table td:nth-child(3) {
            min-width: 140px;
        }
        
        .data-table th:nth-child(4), /* Andamento */
        .data-table td:nth-child(4) {
            min-width: 80px;
            max-width: 80px;
            text-align: center;
        }
        
        .data-table th:nth-child(5), /* Assunto */
        .data-table td:nth-child(5) {
            min-width: 200px;
            max-width: 300px;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .data-table th:nth-child(6), /* Cliente */
        .data-table td:nth-child(6) {
            min-width: 180px;
            max-width: 250px;
        }
    </style>
</head>
<body class="bg-light">
    
    <!-- Header -->
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-database-gear me-2"></i>Gerenciamento de Dados CSV
                    </h1>
                    <p class="mb-0 opacity-75">Upload, processamento e edi√ß√£o dos dados do sistema</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-light">
                        <i class="bi bi-arrow-left me-1"></i>Voltar ao Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-fluid mt-4" style="max-width: 95%">
        
        <!-- Alertas -->
        <div id="alertContainer"></div>
        
        <!-- Estat√≠sticas Atuais -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-file-earmark-text fs-1 text-primary"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="card-title mb-0">Total de Registros</h6>
                                <h4 class="card-text text-primary" id="totalRecords">{{ stats.total_records or 0 }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-hdd-stack fs-1 text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="card-title mb-0">Tamanho do Arquivo</h6>
                                <h4 class="card-text text-info" id="fileSize">{{ (stats.file_size / 1024) | round(1) }} KB</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-calendar-check fs-1 text-success"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="card-title mb-0">√öltima Modifica√ß√£o</h6>
                                <h6 class="card-text text-success" id="lastModified">
                                    {% if stats.last_modified %}
                                        {{ stats.last_modified[:10] }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-list-columns fs-1 text-warning"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="card-title mb-0">Colunas</h6>
                                <h4 class="card-text text-warning" id="totalColumns">{{ stats.columns | length }}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabs de Navega√ß√£o -->
        <ul class="nav nav-tabs mb-3" id="dataTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">
                    <i class="bi bi-cloud-upload me-2"></i>Upload de Dados
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="view-tab" data-bs-toggle="tab" data-bs-target="#view" type="button" role="tab">
                    <i class="bi bi-table me-2"></i>Visualizar/Editar
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                    <i class="bi bi-shield-check me-2"></i>Backups
                </button>
            </li>
        </ul>
        
        <!-- Conte√∫do das Tabs -->
        <div class="tab-content" id="dataTabsContent">
            
            <!-- Tab: Upload de Dados -->
            <div class="tab-pane fade show active" id="upload" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-cloud-upload me-2"></i>Upload Inteligente de CSV
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="upload-zone" id="uploadZone">
                                    <i class="bi bi-cloud-upload display-1 text-primary mb-3"></i>
                                    <h4>Arraste o arquivo CSV aqui</h4>
                                    <p class="text-muted">ou clique para selecionar</p>
                                    <!-- Input de arquivo vis√≠vel mas estilizado -->
                                    <input type="file" id="fileInput" accept=".csv" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;">
                                    <label for="fileInput" class="btn btn-primary mt-2" style="cursor: pointer;">
                                        <i class="bi bi-folder2-open me-2"></i>Selecionar Arquivo
                                    </label>
                                </div>
                                
                                <div id="uploadProgress" class="mt-3" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div id="uploadResult" class="mt-3" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle me-2"></i>Processamento Autom√°tico
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Detec√ß√£o autom√°tica de separadores
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Corre√ß√£o de tipos de dados
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Padroniza√ß√£o de datas
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Normaliza√ß√£o de hor√°rios
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Valida√ß√£o de estrutura
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Backup autom√°tico
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Visualizar/Editar -->
            <div class="tab-pane fade" id="view" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">
                                    <i class="bi bi-table me-2"></i>Dados Atuais
                                </h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="searchInput" placeholder="Buscar nos dados...">
                                    <button class="btn btn-outline-success" onclick="createDataBackup()">
                                        <i class="bi bi-shield-plus me-1"></i>Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container" style="max-height: 75vh; overflow: auto;">
                            <table class="table table-striped table-hover data-table mb-0" id="dataTable" style="min-width: 1400px;">
                                <thead class="table-dark sticky-top">
                                    <!-- Cabe√ßalho ser√° carregado dinamicamente -->
                                </thead>
                                <tbody>
                                    <!-- Dados ser√£o carregados dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center p-3 border-top">
                            <div>
                                <span id="recordsInfo">Carregando...</span>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="pagination">
                                    <!-- Pagina√ß√£o ser√° gerada dinamicamente -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Backups -->
            <div class="tab-pane fade" id="backup" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check me-2"></i>Gerenciamento de Backups
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-success mb-3" onclick="createDataBackup()">
                                    <i class="bi bi-shield-plus me-2"></i>Criar Backup Agora
                                </button>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Backup Autom√°tico:</strong> Um backup √© criado automaticamente sempre que voc√™ faz upload de um novo arquivo.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Localiza√ß√£o dos Backups</h6>
                                        <p class="card-text small text-muted">
                                            <code>data/backups/</code><br>
                                            Formato: <code>dadosr_backup_YYYYMMDD_HHMMSS.csv</code>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
    </div>
    
    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay">
        <div class="processing-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Processando...</span>
            </div>
            <h5>Processando arquivo...</h5>
            <p class="text-muted mb-0">Aguarde enquanto aplicamos corre√ß√µes inteligentes</p>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript -->
    <script>
        let currentData = [];
        let currentPage = 1;
        let totalPages = 1;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM carregado, iniciando aplica√ß√£o...');
            
            // Verifica elementos essenciais
            const essentialElements = {
                'uploadZone': document.getElementById('uploadZone'),
                'fileInput': document.getElementById('fileInput'),
                'uploadResult': document.getElementById('uploadResult')
            };
            
            console.log('üîç Verificando elementos essenciais:', essentialElements);
            
            let missingElements = [];
            for (const [name, element] of Object.entries(essentialElements)) {
                if (!element) {
                    missingElements.push(name);
                }
            }
            
            if (missingElements.length > 0) {
                console.error('‚ùå Elementos n√£o encontrados:', missingElements);
                showAlert(`Erro: Elementos HTML n√£o encontrados: ${missingElements.join(', ')}`, 'danger');
                return;
            }
            
            console.log('‚úÖ Todos os elementos encontrados, configurando...');
            
            // Configurar funcionalidades
            setupUploadZone();
            loadDataPreview();
            
            console.log('üéâ Aplica√ß√£o inicializada com sucesso!');
        });
        
        // Configura√ß√£o da zona de upload
        function setupUploadZone() {
            console.log('üîß Configurando zona de upload...');
            
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            // Verifica√ß√µes de debug
            console.log('üìç uploadZone:', uploadZone);
            console.log('üìç fileInput:', fileInput);
            
            if (!uploadZone) {
                console.error('‚ùå Elemento uploadZone n√£o encontrado!');
                return;
            }
            
            if (!fileInput) {
                console.error('‚ùå Elemento fileInput n√£o encontrado!');
                return;
            }
            
            // Drag and Drop Events
            uploadZone.addEventListener('dragenter', (e) => {
                console.log('üîÑ dragenter');
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragover', (e) => {
                console.log('üîÑ dragover');
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', (e) => {
                console.log('üîÑ dragleave');
                e.preventDefault();
                e.stopPropagation();
                // S√≥ remove se realmente saiu da zona
                if (!uploadZone.contains(e.relatedTarget)) {
                    uploadZone.classList.remove('dragover');
                }
            });
            
            uploadZone.addEventListener('drop', (e) => {
                console.log('üéØ drop - arquivos:', e.dataTransfer.files);
                e.preventDefault();
                e.stopPropagation();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('üìÅ Arquivo selecionado via drop:', files[0].name);
                    handleFileUpload(files[0]);
                } else {
                    console.warn('‚ö†Ô∏è Nenhum arquivo no drop');
                }
            });
            
            // Click na zona de upload (evita o label)
            uploadZone.addEventListener('click', (e) => {
                // Evita conflito com o label
                if (e.target.closest('label[for="fileInput"]')) {
                    console.log('üñ±Ô∏è Click interceptado no label, deixando nativo funcionar');
                    return;
                }
                
                console.log('üñ±Ô∏è Click na zona de upload');
                e.preventDefault();
                e.stopPropagation();
                
                // For√ßa o click no input
                console.log('üîß For√ßando click via JavaScript...');
                fileInput.click();
            });
            
            // Input change
            fileInput.addEventListener('change', (e) => {
                console.log('üìÅ Input change - arquivos:', e.target.files);
                if (e.target.files.length > 0) {
                    console.log('üìÅ Arquivo selecionado via input:', e.target.files[0].name);
                    handleFileUpload(e.target.files[0]);
                } else {
                    console.warn('‚ö†Ô∏è Nenhum arquivo selecionado');
                }
            });
            
            // Teste adicional: verifica se o label est√° funcionando
            const fileLabel = document.querySelector('label[for="fileInput"]');
            if (fileLabel) {
                console.log('‚úÖ Label encontrado:', fileLabel);
                console.log('üîó Label aponta para:', fileLabel.getAttribute('for'));
            } else {
                console.warn('‚ö†Ô∏è Label n√£o encontrado');
            }
            
            console.log('‚úÖ Zona de upload configurada com sucesso!');
            
            // M√©todo de emerg√™ncia: adiciona bot√£o alternativo
            setTimeout(() => {
                console.log('üîß Adicionando m√©todo de emerg√™ncia...');
                createEmergencyUploadButton();
            }, 1000);
        }
        
        // M√©todo de emerg√™ncia: cria bot√£o alternativo
        function createEmergencyUploadButton() {
            const uploadZone = document.getElementById('uploadZone');
            if (!uploadZone) return;
            
            // Verifica se j√° existe
            if (document.getElementById('emergencyUploadBtn')) {
                console.log('üîÑ Bot√£o de emerg√™ncia j√° existe');
                return;
            }
            
            console.log('üö® Criando bot√£o de emerg√™ncia...');
            
            const emergencyBtn = document.createElement('button');
            emergencyBtn.id = 'emergencyUploadBtn';
            emergencyBtn.className = 'btn btn-warning btn-sm mt-2 ms-2';
            emergencyBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Upload Alternativo';
            
            emergencyBtn.addEventListener('click', (e) => {
                console.log('üö® Click no bot√£o de emerg√™ncia');
                e.preventDefault();
                e.stopPropagation();
                
                // Criar input completamente novo
                const emergencyInput = document.createElement('input');
                emergencyInput.type = 'file';
                emergencyInput.accept = '.csv';
                emergencyInput.style.position = 'absolute';
                emergencyInput.style.left = '-9999px';
                emergencyInput.style.opacity = '0';
                
                emergencyInput.addEventListener('change', (e) => {
                    console.log('üìÅ Arquivo selecionado via bot√£o de emerg√™ncia');
                    if (e.target.files.length > 0) {
                        handleFileUpload(e.target.files[0]);
                        document.body.removeChild(emergencyInput);
                    }
                });
                
                document.body.appendChild(emergencyInput);
                emergencyInput.click();
                console.log('üîÑ Input de emerg√™ncia criado e clicado');
            });
            
            // Adiciona ap√≥s o label existente
            const existingLabel = uploadZone.querySelector('label[for="fileInput"]');
            if (existingLabel) {
                existingLabel.parentNode.insertBefore(emergencyBtn, existingLabel.nextSibling);
                console.log('‚úÖ Bot√£o de emerg√™ncia adicionado');
            }
        }
        
        // Manipula upload de arquivo
        async function handleFileUpload(file) {
            console.log('üöÄ Iniciando handleFileUpload com arquivo:', file?.name);
            
            if (!file) {
                console.error('‚ùå Arquivo n√£o fornecido');
                showAlert('Erro: Nenhum arquivo fornecido', 'danger');
                return;
            }
            
            console.log('üìã Detalhes do arquivo:', {
                name: file.name,
                size: file.size,
                sizeFormatted: (file.size / 1024).toFixed(2) + ' KB',
                type: file.type,
                lastModified: file.lastModified
            });
            
            // Verifica tamanho do arquivo
            if (file.size > 10 * 1024 * 1024) { // 10MB
                console.warn('‚ö†Ô∏è Arquivo muito grande:', file.size);
                showAlert('Arquivo muito grande. M√°ximo permitido: 10MB', 'danger');
                return;
            }
            
            if (file.size === 0) {
                console.warn('‚ö†Ô∏è Arquivo vazio:', file.name);
                showAlert('Arquivo est√° vazio ou corrompido.', 'danger');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                console.warn('‚ö†Ô∏è Arquivo n√£o √© CSV:', file.name);
                showAlert('Por favor, selecione um arquivo CSV v√°lido.', 'danger');
                return;
            }
            
            console.log('‚úÖ Arquivo CSV v√°lido, iniciando upload...');
            showProcessing(true);
            
            const formData = new FormData();
            formData.append('file', file);
            
            console.log('üì§ FormData criado, enviando requisi√ß√£o...');
            
            try {
                const response = await fetch('/adminsystem/api/data/upload', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('üì• Resposta recebida:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                const responseText = await response.text();
                console.log('üì• Resposta bruta:', responseText.substring(0, 500));
                
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('üìã Resultado parseado:', result);
                } catch (parseError) {
                    console.error('‚ùå Erro ao parsear JSON:', parseError);
                    console.error('üìÑ Resposta completa:', responseText);
                    throw new Error(`Resposta inv√°lida do servidor: ${parseError.message}`);
                }
                
                if (result.success) {
                    console.log('‚úÖ Upload bem-sucedido!');
                    showUploadResult(result);
                    const recordCount = result.stats ? result.stats.records_count : (result.records_count || 'N/A');
                    showAlert(`Upload conclu√≠do! ${recordCount} registros processados.`, 'success');
                    // Atualiza estat√≠sticas
                    updateStats();
                } else {
                    console.error('‚ùå Erro no resultado:', result.error);
                    showAlert(`Erro no upload: ${result.error}`, 'danger');
                }
                
            } catch (error) {
                console.error('üí• Erro na requisi√ß√£o:', error);
                showAlert('Erro ao processar arquivo', 'danger');
            } finally {
                console.log('üèÅ Finalizando processamento...');
                showProcessing(false);
            }
        }
        
        // Mostra resultado do upload
        function showUploadResult(result) {
            const container = document.getElementById('uploadResult');
            
            let correctionsHtml = '';
            if (result.corrections_applied && result.corrections_applied.length > 0) {
                correctionsHtml = `
                    <div class="mt-3">
                        <h6>Corre√ß√µes Aplicadas:</h6>
                        <ul class="list-unstyled">
                            ${result.corrections_applied.map(correction => 
                                `<li><i class="bi bi-check-circle text-success me-2"></i>${correction}</li>`
                            ).join('')}
                        </ul>
                    </div>
                `;
            }
            
            const recordCount = result.stats ? result.stats.records_count : (result.records_count || 'N/A');
            const columnCount = result.stats ? result.stats.columns_count : (result.columns ? result.columns.length : 'N/A');
            
            container.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle me-2"></i>Arquivo processado com sucesso!</h6>
                    <p class="mb-2">Registros processados: <strong>${recordCount}</strong></p>
                    <p class="mb-0">Colunas identificadas: <strong>${columnCount}</strong></p>
                    ${correctionsHtml}
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="applyUploadedData()">
                        <i class="bi bi-check-lg me-2"></i>Aplicar Altera√ß√µes
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="cancelUpload()">
                        <i class="bi bi-x-lg me-2"></i>Cancelar
                    </button>
                </div>
            `;
            
            container.style.display = 'block';
        }
        
        // Carrega preview dos dados
        async function loadDataPreview(page = 1, search = '') {
            // INTERCEPTADOR CR√çTICO: detecta quem est√° chamando essa fun√ß√£o
            console.log(`üö® LOADATAPREVIEW CHAMADO! p√°gina=${page}, busca="${search}"`);
            console.log(`üìç Stack trace:`, new Error().stack);
            console.log(`‚è∞ Timestamp:`, new Date().toISOString());
            
            try {
                console.log(`Carregando dados - p√°gina ${page}, busca: "${search}"`);
                
                const response = await fetch(`/adminsystem/api/data/preview?page=${page}&per_page=50&search=${encodeURIComponent(search)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('Resposta recebida:', text.substring(0, 200) + '...');
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (parseError) {
                    console.error('Erro ao parsear JSON:', parseError);
                    console.error('Texto recebido:', text);
                    showAlert('Erro: Resposta inv√°lida do servidor', 'danger');
                    return;
                }
                
                if (result.error) {
                    showAlert(`Erro ao carregar dados: ${result.error}`, 'danger');
                    return;
                }
                
                console.log(`Dados carregados: ${result.data.length} registros`);
                
                currentData = result.data;
                currentPage = result.page;
                totalPages = result.total_pages;
                
                renderDataTable(result);
                updatePagination(result);
                updateRecordsInfo(result);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showAlert(`Erro ao carregar dados: ${error.message}`, 'danger');
                
                // Fallback: mostra mensagem na tabela
                const tbody = document.querySelector('#dataTable tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="100%" class="text-center py-4 text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Erro ao carregar dados: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Renderiza tabela de dados
        function renderDataTable(result) {
            console.log(`üé® RENDER DATA TABLE INICIADO!`);
            console.log(`üìä Dados recebidos para render:`, result.data.length, 'registros');
            console.log(`‚ö†Ô∏è ATEN√á√ÉO: Esta fun√ß√£o VAI SOBRESCREVER toda a tabela!`);
            
            const table = document.getElementById('dataTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            if (result.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-4">Nenhum dado encontrado</td></tr>';
                return;
            }
            
            // Cabe√ßalho
            const columns = Object.keys(result.data[0]).filter(key => key !== '_id');
            thead.innerHTML = `
                <tr>
                    <th width="50">ID</th>
                    ${columns.map(col => `<th>${col}</th>`).join('')}
                    <th width="100">A√ß√µes</th>
                </tr>
            `;
            
            // Corpo
            tbody.innerHTML = result.data.map(record => `
                <tr data-id="${record._id}">
                    <td class="text-muted">${record._id}</td>
                    ${columns.map(col => `
                        <td class="editable-cell" data-field="${col}" data-id="${record._id}">
                            ${record[col] || ''}
                        </td>
                    `).join('')}
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editRecord(${record._id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord(${record._id})" title="Deletar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            console.log(`‚úÖ RENDER COMPLETO! Tabela reconstru√≠da com ${result.data.length} registros`);
            
            // Adiciona eventos de edi√ß√£o inline
            setupInlineEditing();
        }
        
        // Configura√ß√£o de edi√ß√£o inline
        function setupInlineEditing() {
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('dblclick', function() {
                    const currentValue = this.textContent.trim();
                    const field = this.dataset.field;
                    const recordId = this.dataset.id;
                    
                    // LOG CR√çTICO: mostrar nome real do campo
                    console.log(`üîç EDITANDO CAMPO: "${field}" (valor atual: "${currentValue}")`);
                    console.log(`üìù Campo em bytes:`, new TextEncoder().encode(field));
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue;
                    input.className = 'form-control form-control-sm';
                    
                    this.innerHTML = '';
                    this.appendChild(input);
                    input.focus();
                    input.select();
                    
                    const saveEdit = async () => {
                        const newValue = input.value.trim();
                        if (newValue !== currentValue) {
                            console.log(`üéØ INICIANDO ATUALIZA√á√ÉO: ${recordId} -> "${field}" -> "${newValue}"`);
                            
                            const success = await updateRecord(recordId, field, newValue);
                            if (success) {
                                this.textContent = newValue;
                                showAlert('Campo atualizado!', 'success', 2000);
                                
                                // Log cr√≠tico: verifica se a c√©lula realmente foi atualizada
                                console.log(`‚úÖ C√âLULA ATUALIZADA: Novo valor na DOM = "${this.textContent}"`);
                                
                                // Aguarda um pouco antes de qualquer recarregamento
                                setTimeout(() => {
                                    console.log(`üîç VERIFICA√á√ÉO AP√ìS DELAY: Valor na DOM = "${this.textContent}"`);
                                }, 2000);
                                
                            } else {
                                this.textContent = currentValue;
                                console.log(`‚ùå REVERTING: Voltando para "${currentValue}"`);
                            }
                        } else {
                            this.textContent = currentValue;
                            console.log(`üîÑ SEM MUDAN√áA: Mantendo "${currentValue}"`);
                        }
                    };
                    
                    input.addEventListener('blur', saveEdit);
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            saveEdit();
                        } else if (e.key === 'Escape') {
                            this.textContent = currentValue;
                        }
                    });
                });
            });
        }
        
        // Atualiza um registro
        async function updateRecord(recordId, field, value) {
            try {
                console.log(`üîÑ Atualizando registro ${recordId}, campo ${field}, valor: ${value}`);
                
                const response = await fetch(`/adminsystem/api/data/record/${recordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });
                
                const result = await response.json();
                console.log('üì• Resposta do servidor:', result);
                
                if (result.success) {
                    console.log('‚úÖ Atualiza√ß√£o bem-sucedida');
                } else {
                    console.log('‚ùå Falha na atualiza√ß√£o:', result.error);
                    showAlert(`Erro: ${result.error}`, 'danger');
                }
                
                return result.success;
                
            } catch (error) {
                console.error('üí• Erro ao atualizar registro:', error);
                showAlert('Erro ao atualizar registro', 'danger');
                return false;
            }
        }
        
        // Deleta um registro
        async function deleteRecord(recordId) {
            if (!confirm('Tem certeza que deseja deletar este registro?')) {
                return;
            }
            
            try {
                const response = await fetch(`/adminsystem/api/data/record/${recordId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('Registro deletado!', 'success');
                    loadDataPreview(currentPage);
                    updateStats();
                } else {
                    showAlert('Erro ao deletar registro', 'danger');
                }
                
            } catch (error) {
                console.error('Erro ao deletar registro:', error);
                showAlert('Erro ao deletar registro', 'danger');
            }
        }
        
        // Cria backup
        async function createDataBackup() {
            try {
                const response = await fetch('/adminsystem/api/data/backup', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Backup criado: ${result.filename}`, 'success');
                } else {
                    showAlert(`Erro ao criar backup: ${result.error}`, 'danger');
                }
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showAlert('Erro ao criar backup', 'danger');
            }
        }
        
        // Configura√ß√£o de busca
        document.getElementById('searchInput').addEventListener('input', function() {
            const search = this.value.trim();
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                loadDataPreview(1, search);
            }, 500);
        });
        
        // Fun√ß√µes auxiliares
        function showProcessing(show) {
            document.getElementById('processingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function showAlert(message, type = 'info', duration = 5000) {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();
            
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                    <strong>${type === 'success' ? 'Sucesso!' : type === 'danger' ? 'Erro!' : 'Info'}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            container.innerHTML = alertHTML;
            
            if (duration > 0) {
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) alert.remove();
                }, duration);
            }
        }
        
        function updatePagination(result) {
            const pagination = document.getElementById('pagination');
            let html = '';
            
            // P√°gina anterior
            if (result.page > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadDataPreview(${result.page - 1})">Anterior</a></li>`;
            }
            
            // P√°ginas numeradas
            const startPage = Math.max(1, result.page - 2);
            const endPage = Math.min(result.total_pages, result.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const active = i === result.page ? 'active' : '';
                html += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadDataPreview(${i})">${i}</a></li>`;
            }
            
            // Pr√≥xima p√°gina
            if (result.page < result.total_pages) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadDataPreview(${result.page + 1})">Pr√≥xima</a></li>`;
            }
            
            pagination.innerHTML = html;
        }
        
        function updateRecordsInfo(result) {
            const info = document.getElementById('recordsInfo');
            const start = (result.page - 1) * result.per_page + 1;
            const end = Math.min(start + result.per_page - 1, result.total);
            info.textContent = `Exibindo ${start}-${end} de ${result.total} registros`;
        }
        
        function updateStats() {
            // Atualiza estat√≠sticas ap√≥s altera√ß√µes (sem reload autom√°tico)
            console.log('üìä Atualizando estat√≠sticas...');
            
            // Busca estat√≠sticas atualizadas
            fetch('/adminsystem/api/data/test')
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Dados de estat√≠sticas recebidos:', data);
                    
                    // Atualiza os cards de estat√≠sticas se existirem
                    const totalRecordsElements = document.querySelectorAll('.stats-card h2');
                    if (totalRecordsElements.length > 0 && data.total_records !== undefined) {
                        totalRecordsElements[0].textContent = data.total_records;
                    }
                    
                    if (totalRecordsElements.length > 2 && data.columns !== undefined) {
                        totalRecordsElements[2].textContent = data.columns;
                    }
                    
                    console.log('‚úÖ Estat√≠sticas atualizadas');
                })
                .catch(error => {
                    console.error('‚ùå Erro ao atualizar estat√≠sticas:', error);
                });
        }
        
        // Aplica dados do upload
        async function applyUploadedData() {
            if (!confirm('Confirma a aplica√ß√£o dos dados? Esta a√ß√£o substituir√° os dados atuais.')) {
                return;
            }
            
            showProcessing(true);
            
            try {
                const response = await fetch('/adminsystem/api/data/apply-upload', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    document.getElementById('uploadResult').style.display = 'none';
                    updateStats();
                } else {
                    showAlert(`Erro: ${result.error}`, 'danger');
                }
                
            } catch (error) {
                console.error('Erro ao aplicar upload:', error);
                showAlert('Erro ao aplicar altera√ß√µes', 'danger');
            } finally {
                showProcessing(false);
            }
        }
        
        // Cancela upload
        function cancelUpload() {
            document.getElementById('uploadResult').style.display = 'none';
            document.getElementById('fileInput').value = '';
            showAlert('Upload cancelado', 'info');
        }
        
    </script>
    
</body>
</html> 