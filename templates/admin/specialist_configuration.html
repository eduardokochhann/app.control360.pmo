{% extends "base.html" %}

{% block title %}Configura√ß√µes de Especialistas - Control360{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
    .admin-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 0;
    }
    
    .config-card {
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .config-card:hover {
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        transform: translateY(-2px);
    }
    
    .config-card.inactive {
        border-left-color: #6c757d;
        opacity: 0.7;
    }
    
    .specialist-name {
        font-weight: 600;
        color: #495057;
    }
    
    .config-detail {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .work-days-indicator {
        display: inline-flex;
        gap: 2px;
        margin-top: 0.5rem;
    }
    
    .day-badge {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
    }
    
    .day-badge.active {
        background: #28a745;
        color: white;
    }
    
    .day-badge.inactive {
        background: #e9ecef;
        color: #6c757d;
    }
    
    .new-config-card {
        border: 2px dashed #667eea;
        background: #f8f9ff;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .new-config-card:hover {
        border-color: #5a6fd8;
        background: #f0f2ff;
    }
    
    .modal-body .form-check-input[type="checkbox"] {
        transform: scale(1.2);
        margin-right: 0.5rem;
    }
    
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    
    /* Fix para dropdowns Bootstrap */
    .btn-group .dropdown-menu {
        z-index: 2000 !important;
        min-width: 160px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .dropdown-toggle::after {
        display: none !important;
    }
    
    .config-card .btn-group {
        position: relative;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    /* Mostra o menu quando tem a classe show */
    .dropdown-menu.show {
        display: block !important;
        position: absolute !important;
        top: 100% !important;
        left: auto !important;
        right: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="admin-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-0">
                    <i class="bi bi-person-gear me-2"></i>Configura√ß√µes de Especialistas
                </h1>
                <p class="mb-0 opacity-75">Gerencie jornadas de trabalho, dias √∫teis e configura√ß√µes individuais</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-light">
                    <i class="bi bi-arrow-left me-1"></i>Voltar ao Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    
    <!-- Alertas -->
    <div id="alertContainer"></div>
    
    <!-- Estat√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-people text-primary fs-1"></i>
                    <h4 class="card-title mt-2">{{ configurations|length }}</h4>
                    <p class="card-text">Especialistas Configurados</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-person-plus text-info fs-1"></i>
                    <h4 class="card-title mt-2" id="unconfiguredCount">0</h4>
                    <p class="card-text">Sem Configura√ß√£o</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-clock text-success fs-1"></i>
                    <h4 class="card-title mt-2" id="avgHours">8.0h</h4>
                    <p class="card-text">Jornada M√©dia</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- A√ß√µes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h3>
                    <i class="bi bi-gear me-2"></i>Configura√ß√µes Ativas
                </h3>
                <div>
                    <button class="btn btn-primary" onclick="showNewConfigModal()">
                        <i class="bi bi-plus-circle me-2"></i>Nova Configura√ß√£o
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshConfigurations()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Configura√ß√µes -->
    <div class="row" id="configurationsContainer">
        <!-- Configura√ß√µes ser√£o carregadas aqui -->
    </div>
    
    <!-- Espa√ßamento adicional para evitar sobreposi√ß√£o de dropdowns -->
    <div class="row mt-5 pt-4">
        <div class="col-lg-6">
            <div class="card new-config-card h-100" onclick="showNewConfigModal()">
                <div class="card-body text-center py-5">
                    <i class="bi bi-plus-circle display-1 text-primary mb-3"></i>
                    <h5>Adicionar Nova Configura√ß√£o</h5>
                    <p class="text-muted">Configure jornada e dias √∫teis para um especialista</p>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- Modal para Criar/Editar Configura√ß√£o -->
<div class="modal fade" id="configModal" tabindex="-1" aria-labelledby="configModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="configForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel">
                        <i class="bi bi-person-gear me-2"></i>Configura√ß√£o de Especialista
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body">
                    
                    <!-- Sele√ß√£o de Especialista -->
                    <div class="mb-4">
                        <label for="specialistSelect" class="form-label">Especialista *</label>
                        <select class="form-select" id="specialistSelect" name="specialist_name" required>
                            <option value="">Selecione um especialista</option>
                        </select>
                        <div class="form-text">Selecione o especialista para configurar</div>
                    </div>
                    
                    <!-- Configura√ß√µes de Jornada -->
                    <h6><i class="bi bi-clock me-2"></i>Jornada de Trabalho</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="dailyHours" class="form-label">Horas por Dia</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="dailyHours" name="daily_work_hours" 
                                       min="1" max="24" step="0.5" value="8.0" required>
                                <span class="input-group-text">horas</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="weeklyDays" class="form-label">Dias por Semana</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="weeklyDays" name="weekly_work_days" 
                                       min="1" max="7" value="5" required>
                                <span class="input-group-text">dias</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dias √öteis -->
                    <h6><i class="bi bi-calendar-week me-2"></i>Dias √öteis</h6>
                    <div class="mb-4">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="monday" name="monday" checked>
                                    <label class="form-check-label" for="monday">Segunda-feira</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="tuesday" name="tuesday" checked>
                                    <label class="form-check-label" for="tuesday">Ter√ßa-feira</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="wednesday" name="wednesday" checked>
                                    <label class="form-check-label" for="wednesday">Quarta-feira</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="thursday" name="thursday" checked>
                                    <label class="form-check-label" for="thursday">Quinta-feira</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="friday" name="friday" checked>
                                    <label class="form-check-label" for="friday">Sexta-feira</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="saturday" name="saturday">
                                    <label class="form-check-label" for="saturday">S√°bado</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sunday" name="sunday">
                                    <label class="form-check-label" for="sunday">Domingo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configura√ß√µes Avan√ßadas -->
                    <h6><i class="bi bi-gear me-2"></i>Configura√ß√µes Avan√ßadas</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="bufferPercentage" class="form-label">Buffer de Tempo</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="bufferPercentage" name="buffer_percentage" 
                                       min="0" max="100" step="5" value="10">
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="form-text">Margem extra aplicada nas estimativas</div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="considerHolidays" 
                                       name="consider_holidays" checked>
                                <label class="form-check-label" for="considerHolidays">
                                    Considerar Feriados
                                </label>
                            </div>
                            <div class="form-text">Feriados brasileiros s√£o automaticamente considerados</div>
                        </div>
                    </div>
                    
                    <!-- Feriados Personalizados -->
                    <div class="mb-3">
                        <label for="customHolidays" class="form-label">Feriados Personalizados</label>
                        <textarea class="form-control" id="customHolidays" name="custom_holidays" rows="3" 
                                  placeholder="Digite datas no formato YYYY-MM-DD, uma por linha"></textarea>
                        <div class="form-text">Adicione feriados espec√≠ficos do especialista (ex: f√©rias, licen√ßas)</div>
                    </div>
                    
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i>Salvar Configura√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5 class="text-light">Processando...</h5>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let currentConfigId = null;
let allSpecialists = [];

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando p√°gina de configura√ß√£o de especialistas...');
    
    // Carrega dados iniciais
    loadConfigurations();
    loadAvailableSpecialists();
    setupFormHandlers();
    
    // For√ßa inicializa√ß√£o dos dropdowns ap√≥s pequeno delay
    setTimeout(() => {
        console.log('üîß Configurando eventos de dropdown...');
        setupDropdownEvents();
        console.log('üéâ Inicializa√ß√£o completa!');
    }, 500);
});

// Fun√ß√£o para configurar events dos dropdowns manualmente
function setupDropdownEvents() {
    console.log('üîß Configurando eventos de dropdown manualmente...');
    
    // Remove todos os listeners anteriores
    const oldButtons = document.querySelectorAll('.dropdown-toggle');
    oldButtons.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
    });
    
    // Adiciona listener em todos os bot√µes dropdown
    const dropdownButtons = document.querySelectorAll('.dropdown-toggle');
    console.log(`üìã Encontrados ${dropdownButtons.length} bot√µes dropdown`);
    
    dropdownButtons.forEach((button, index) => {
        console.log(`üîß Configurando bot√£o ${index + 1}:`, button);
        
        button.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è CLICK DETECTADO no bot√£o dropdown!', this);
            e.preventDefault();
            e.stopPropagation();
            
            // Fecha todos os outros dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // Abre/fecha este dropdown
            const menu = this.nextElementSibling;
            if (menu && menu.classList.contains('dropdown-menu')) {
                console.log('üìã Menu encontrado, toggling...');
                menu.classList.toggle('show');
                
                // Adiciona listener para fechar ao clicar fora
                setTimeout(() => {
                    document.addEventListener('click', function closeDropdown(e) {
                        if (!menu.contains(e.target) && !button.contains(e.target)) {
                            menu.classList.remove('show');
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                }, 10);
            } else {
                console.error('‚ùå Menu n√£o encontrado!');
            }
        });
        
        console.log(`‚úÖ Event listener adicionado ao bot√£o ${index + 1}`);
    });
}

// Carrega configura√ß√µes
async function loadConfigurations() {
    console.log('üöÄ LOAD CONFIGURATIONS iniciado');
    
    try {
        showLoading(true);
        
        console.log('üì° Fazendo requisi√ß√£o para /adminsystem/api/specialist-configuration');
        const response = await fetch('/adminsystem/api/specialist-configuration');
        const result = await response.json();
        
        console.log('üì• Resposta recebida:', result);
        
        if (result.success) {
            console.log(`‚úÖ Sucesso! ${result.configurations.length} configura√ß√µes recebidas`);
            renderConfigurations(result.configurations);
            updateStatistics(result.configurations);
        } else {
            console.error('‚ùå Erro na resposta:', result.error);
            showAlert('Erro ao carregar configura√ß√µes: ' + result.error, 'danger');
        }
        
    } catch (error) {
        console.error('üí• Erro na requisi√ß√£o:', error);
        showAlert('Erro ao carregar configura√ß√µes', 'danger');
    } finally {
        showLoading(false);
        console.log('üèÅ LOAD CONFIGURATIONS finalizado');
    }
}

// Carrega especialistas dispon√≠veis
async function loadAvailableSpecialists() {
    try {
        const response = await fetch('/adminsystem/api/available-specialists');
        const result = await response.json();
        
        if (result.success) {
            allSpecialists = result.all_specialists;
            updateUnconfiguredCount(result.unconfigured_specialists.length);
        }
        
    } catch (error) {
        console.error('Erro ao carregar especialistas:', error);
    }
}

// Renderiza configura√ß√µes
function renderConfigurations(configurations) {
    console.log('üé® RENDER CONFIGURATIONS chamado com:', configurations);
    
    const container = document.getElementById('configurationsContainer');
    if (!container) {
        console.error('‚ùå Container configurationsContainer n√£o encontrado!');
        return;
    }
    
    console.log(`üìä ${configurations.length} configura√ß√µes para renderizar`);
    
    if (configurations.length === 0) {
        console.log('üìù Nenhuma configura√ß√£o, mostrando mensagem padr√£o');
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle me-2"></i>
                    Nenhuma configura√ß√£o encontrada. Clique em "Nova Configura√ß√£o" para come√ßar.
                </div>
            </div>
        `;
        return;
    }
    
    console.log('üîß Gerando HTML para cada configura√ß√£o...');
    
    const htmlContent = configurations.map((config, index) => {
        console.log(`üìù Processando configura√ß√£o ${index + 1}:`, config.specialist_name);
        
        const workDays = config.work_days_config || {};
        const dayLabels = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
        const dayKeys = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
        const cardHtml = `
            <div class="col-lg-6 mb-4">
                <div class="card config-card ${config.is_active ? '' : 'inactive'}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="specialist-name mb-0">${config.specialist_name}</h5>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><button class="dropdown-item" type="button" onclick="editConfiguration(${config.id})">
                                        <i class="bi bi-pencil me-2"></i>Editar
                                    </button></li>
                                    <li><button class="dropdown-item" type="button" onclick="duplicateConfiguration(${config.id})">
                                        <i class="bi bi-files me-2"></i>Duplicar
                                    </button></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><button class="dropdown-item text-danger" type="button" onclick="deleteConfiguration(${config.id})">
                                        <i class="bi bi-trash me-2"></i>Desativar
                                    </button></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="config-detail mb-2">
                            <i class="bi bi-clock me-1"></i>
                            ${config.daily_work_hours}h/dia ‚Ä¢ ${config.weekly_work_days} dias/semana
                        </div>
                        
                        <div class="config-detail mb-2">
                            <i class="bi bi-calendar-check me-1"></i>
                            Feriados: ${config.consider_holidays ? 'Sim' : 'N√£o'} ‚Ä¢ 
                            Buffer: ${config.buffer_percentage}%
                        </div>
                        
                        <div class="work-days-indicator">
                            ${dayKeys.map((key, index) => `
                                <span class="day-badge ${workDays[key] ? 'active' : 'inactive'}" 
                                      title="${getDayName(key)}">
                                    ${dayLabels[index]}
                                </span>
                            `).join('')}
                        </div>
                        
                        ${config.custom_holidays && config.custom_holidays.length > 0 ? `
                            <div class="mt-2">
                                <small class="text-info">
                                    <i class="bi bi-calendar-x me-1"></i>
                                    ${config.custom_holidays.length} feriado(s) personalizado(s)
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        
        console.log(`‚úÖ HTML gerado para ${config.specialist_name}:`, cardHtml.substring(0, 100) + '...');
        return cardHtml;
    }).join('');
    
    console.log(`üìã HTML total gerado (${htmlContent.length} chars):`, htmlContent.substring(0, 200) + '...');
    
    container.innerHTML = htmlContent;
    console.log('‚úÖ HTML inserido no container');
    
    // Reinicializa dropdowns ap√≥s recarregar HTML
    setTimeout(() => {
        console.log('üîÑ Reinicializando dropdowns ap√≥s recarregar configura√ß√µes...');
        setupDropdownEvents();
    }, 200);
}

// Atualiza estat√≠sticas
function updateStatistics(configurations) {
    // Calcula jornada m√©dia
    const totalHours = configurations.reduce((sum, config) => sum + config.daily_work_hours, 0);
    const avgHours = configurations.length > 0 ? (totalHours / configurations.length).toFixed(1) : '8.0';
    document.getElementById('avgHours').textContent = avgHours + 'h';
}

function updateUnconfiguredCount(count) {
    document.getElementById('unconfiguredCount').textContent = count;
}

// Mostra modal para nova configura√ß√£o
function showNewConfigModal() {
    currentConfigId = null;
    document.getElementById('configModalLabel').innerHTML = 
        '<i class="bi bi-person-gear me-2"></i>Nova Configura√ß√£o de Especialista';
    
    // Popula especialistas n√£o configurados
    populateSpecialistSelect();
    
    // Reset form
    document.getElementById('configForm').reset();
    
    // Valores padr√£o
    document.getElementById('dailyHours').value = '8.0';
    document.getElementById('weeklyDays').value = '5';
    document.getElementById('bufferPercentage').value = '10';
    document.getElementById('considerHolidays').checked = true;
    
    // Dias √∫teis padr√£o
    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'].forEach(day => {
        document.getElementById(day).checked = true;
    });
    ['saturday', 'sunday'].forEach(day => {
        document.getElementById(day).checked = false;
    });
    
    const modal = new bootstrap.Modal(document.getElementById('configModal'));
    modal.show();
}

// Popula select de especialistas
async function populateSpecialistSelect() {
    try {
        const response = await fetch('/adminsystem/api/available-specialists');
        const result = await response.json();
        
        if (result.success) {
            const select = document.getElementById('specialistSelect');
            select.innerHTML = '<option value="">Selecione um especialista</option>';
            
            // Para nova configura√ß√£o, mostra apenas n√£o configurados
            const specialists = currentConfigId ? result.all_specialists : result.unconfigured_specialists;
            
            specialists.forEach(specialist => {
                select.innerHTML += `<option value="${specialist}">${specialist}</option>`;
            });
        }
    } catch (error) {
        console.error('Erro ao carregar especialistas:', error);
    }
}

// Edita configura√ß√£o
async function editConfiguration(configId) {
    try {
        const response = await fetch(`/adminsystem/api/specialist-configuration/${configId}`);
        const result = await response.json();
        
        if (result.success) {
            currentConfigId = configId;
            const config = result.configuration;
            
            document.getElementById('configModalLabel').innerHTML = 
                '<i class="bi bi-pencil me-2"></i>Editar Configura√ß√£o - ' + config.specialist_name;
            
            // Popula form
            populateSpecialistSelect();
            
            setTimeout(() => {
                document.getElementById('specialistSelect').value = config.specialist_name;
                document.getElementById('specialistSelect').disabled = true;
                
                document.getElementById('dailyHours').value = config.daily_work_hours;
                document.getElementById('weeklyDays').value = config.weekly_work_days;
                document.getElementById('bufferPercentage').value = config.buffer_percentage;
                document.getElementById('considerHolidays').checked = config.consider_holidays;
                
                // Configura dias √∫teis
                const workDays = config.work_days_config;
                Object.keys(workDays).forEach(day => {
                    const checkbox = document.getElementById(day);
                    if (checkbox) checkbox.checked = workDays[day];
                });
                
                // Feriados personalizados
                if (config.custom_holidays && config.custom_holidays.length > 0) {
                    document.getElementById('customHolidays').value = config.custom_holidays.join('\n');
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('configModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Erro ao carregar configura√ß√£o:', error);
        showAlert('Erro ao carregar configura√ß√£o', 'danger');
    }
}

// Duplica configura√ß√£o
async function duplicateConfiguration(configId) {
    try {
        const response = await fetch(`/adminsystem/api/specialist-configuration/${configId}`);
        const result = await response.json();
        
        if (result.success) {
            currentConfigId = null;
            const config = result.configuration;
            
            document.getElementById('configModalLabel').innerHTML = 
                '<i class="bi bi-files me-2"></i>Duplicar Configura√ß√£o - ' + config.specialist_name;
            
            // Popula especialistas n√£o configurados
            populateSpecialistSelect();
            
            setTimeout(() => {
                // N√£o define o especialista, deixa para escolher
                document.getElementById('specialistSelect').disabled = false;
                
                document.getElementById('dailyHours').value = config.daily_work_hours;
                document.getElementById('weeklyDays').value = config.weekly_work_days;
                document.getElementById('bufferPercentage').value = config.buffer_percentage;
                document.getElementById('considerHolidays').checked = config.consider_holidays;
                
                // Configura dias √∫teis
                const workDays = config.work_days_config;
                Object.keys(workDays).forEach(day => {
                    const checkbox = document.getElementById(day);
                    if (checkbox) checkbox.checked = workDays[day];
                });
                
                // Feriados personalizados
                if (config.custom_holidays && config.custom_holidays.length > 0) {
                    document.getElementById('customHolidays').value = config.custom_holidays.join('\n');
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('configModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Erro ao carregar configura√ß√£o para duplicar:', error);
        showAlert('Erro ao carregar configura√ß√£o', 'danger');
    }
}

// Deleta configura√ß√£o
async function deleteConfiguration(configId) {
    if (!confirm('Tem certeza que deseja desativar esta configura√ß√£o?')) {
        return;
    }
    
    try {
        const response = await fetch(`/adminsystem/api/specialist-configuration/${configId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Configura√ß√£o desativada com sucesso!', 'success');
            loadConfigurations();
            loadAvailableSpecialists();
        } else {
            showAlert('Erro ao desativar configura√ß√£o: ' + result.error, 'danger');
        }
    } catch (error) {
        console.error('Erro ao deletar configura√ß√£o:', error);
        showAlert('Erro ao desativar configura√ß√£o', 'danger');
    }
}

// Configura handlers do form
function setupFormHandlers() {
    document.getElementById('configForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        
        // Campos b√°sicos
        for (let [key, value] of formData.entries()) {
            if (['daily_work_hours', 'buffer_percentage'].includes(key)) {
                data[key] = parseFloat(value);
            } else if (['weekly_work_days'].includes(key)) {
                data[key] = parseInt(value);
            } else if (key === 'consider_holidays') {
                data[key] = true;
            } else {
                data[key] = value;
            }
        }
        
        // Considera holidays se n√£o estiver no formData significa que √© false
        if (!formData.has('consider_holidays')) {
            data.consider_holidays = false;
        }
        
        // Configura dias √∫teis
        const workDaysConfig = {};
        ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
            workDaysConfig[day] = formData.has(day);
        });
        data.work_days_config = workDaysConfig;
        
        // Feriados personalizados
        const customHolidays = document.getElementById('customHolidays').value;
        if (customHolidays.trim()) {
            data.custom_holidays = customHolidays.split('\n')
                .map(line => line.trim())
                .filter(line => line && line.match(/^\d{4}-\d{2}-\d{2}$/));
        } else {
            data.custom_holidays = [];
        }
        
        // Salva configura√ß√£o
        await saveConfiguration(data);
    });
}

// Salva configura√ß√£o
async function saveConfiguration(data) {
    try {
        showLoading(true);
        
        const url = currentConfigId ? 
            `/adminsystem/api/specialist-configuration/${currentConfigId}` : 
            '/adminsystem/api/specialist-configuration';
        
        const method = currentConfigId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            
            // Fecha modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
            modal.hide();
            
            // Recarrega dados
            loadConfigurations();
            loadAvailableSpecialists();
        } else {
            showAlert('Erro ao salvar: ' + result.error, 'danger');
        }
        
    } catch (error) {
        console.error('Erro ao salvar configura√ß√£o:', error);
        showAlert('Erro ao salvar configura√ß√£o', 'danger');
    } finally {
        showLoading(false);
    }
}

// Refresh configura√ß√µes
function refreshConfigurations() {
    loadConfigurations();
    loadAvailableSpecialists();
}

// Fun√ß√µes auxiliares
function getDayName(key) {
    const names = {
        'monday': 'Segunda-feira',
        'tuesday': 'Ter√ßa-feira', 
        'wednesday': 'Quarta-feira',
        'thursday': 'Quinta-feira',
        'friday': 'Sexta-feira',
        'saturday': 'S√°bado',
        'sunday': 'Domingo'
    };
    return names[key] || key;
}

function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

function showAlert(message, type = 'info', duration = 5000) {
    const container = document.getElementById('alertContainer');
    const alertId = 'alert_' + Date.now();
    
    const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
            <strong>${type === 'success' ? 'Sucesso!' : type === 'danger' ? 'Erro!' : 'Info'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    container.innerHTML = alertHTML;
    
    if (duration > 0) {
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) alert.remove();
        }, duration);
    }
}

// Habilita select quando modal fecha
document.getElementById('configModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('specialistSelect').disabled = false;
});
</script>

{% endblock %} 