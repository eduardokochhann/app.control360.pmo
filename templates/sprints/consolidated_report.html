{% extends 'base.html' %}

{% block title %}Relatório Consolidado de Sprints{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .no-print {
            display: none !important;
        }
        .card {
            border: none !important;
            box-shadow: none !important;
        }
        .table {
            font-size: 12px;
        }
    }
    .sprint-section {
        page-break-inside: avoid;
    }
    .specialist-summary {
        page-break-inside: avoid;
    }
    /* Estilos para alinhamento e larguras fixas */
    .w-50px {
        width: 50px !important;
    }
    .w-100px {
        width: 100px !important;
    }
    .w-150px {
        width: 150px !important;
    }
    .w-200px {
        width: 200px !important;
    }
    .w-250px {
        width: 250px !important;
    }
    .w-300px {
        width: 300px !important;
    }
    .task-name {
        min-width: 500px;
        max-width: 500px;
        white-space: normal;
        word-wrap: break-word;
    }
    .specialist-name {
        min-width: 200px;
        max-width: 200px;
        white-space: normal;
    }
    .hours-column {
        width: 100px !important;
        text-align: right !important;
    }
    .status-column {
        width: 120px !important;
        text-align: center !important;
    }
    /* Ajuste para tabelas responsivas */
    .table-fixed {
        table-layout: fixed;
    }
    .table td {
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="bi bi-file-earmark-text me-2"></i>Relatório Consolidado de Sprints
            </h6>
            <div class="no-print">
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="window.print()">
                    <i class="bi bi-printer me-1"></i>Imprimir
                </button>
                <a href="{{ url_for('sprints.consolidated_report_page') }}" class="btn btn-sm btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Voltar
                </a>
            </div>
        </div>
        <div class="card-body">
            {# Resumo Geral #}
            <div class="mb-5">
                <h5 class="mb-3">Resumo Geral</h5>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-fixed">
                            <tbody>
                                <tr>
                                    <th class="w-200px">Total de Sprints:</th>
                                    <td>{{ sprints|length }}</td>
                                </tr>
                                <tr>
                                    <th class="w-200px">Período Total:</th>
                                    <td>{{ start_date.strftime('%d/%m/%Y') }} - {{ end_date.strftime('%d/%m/%Y') }}</td>
                                </tr>
                                <tr>
                                    <th class="w-200px">Total de Tarefas:</th>
                                    <td>{{ total_tasks }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {# Resumo por Especialista #}
            <div class="specialist-summary mb-5">
                <h5 class="mb-3">Capacidade por Especialista</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-hover table-fixed">
                        <thead>
                            <tr>
                                <th class="specialist-name">Especialista</th>
                                <th class="hours-column">Total de Tarefas</th>
                                <th class="hours-column">Horas Estimadas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for specialist in specialist_summary %}
                            <tr>
                                <td class="specialist-name">{{ specialist.name or 'Não Atribuído' }}</td>
                                <td class="hours-column">{{ specialist.total_tasks }}</td>
                                <td class="hours-column">{{ "%.1f"|format(specialist.total_hours) }}h</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {# Detalhes por Sprint #}
            <div class="sprint-details">
                <h5 class="mb-3">Detalhes por Sprint</h5>
                {% for sprint in sprints %}
                <div class="sprint-section mb-4">
                    <div class="card">
                        <div class="card-header py-2">
                            <h6 class="m-0 font-weight-bold">
                                {{ sprint.name }}
                                <small class="text-muted ms-2">
                                    ({{ sprint.start_date.strftime('%d/%m/%Y') }} - {{ sprint.end_date.strftime('%d/%m/%Y') }})
                                </small>
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0 table-fixed">
                                    <thead>
                                        <tr>
                                            <th class="task-name">Tarefa</th>
                                            <th class="specialist-name">Especialista</th>
                                            <th class="hours-column">Horas Est.</th>
                                            <th class="status-column">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for task in sprint.tasks %}
                                        <tr>
                                            <td class="task-name">{{ task.name }}</td>
                                            <td class="specialist-name">{{ task.specialist_name or 'Não Atribuído' }}</td>
                                            <td class="hours-column">{{ "%.1f"|format(task.estimated_hours) if task.estimated_hours else '-' }}h</td>
                                            <td class="status-column">
                                                <span class="badge {% if task.status == 'Concluído' %}bg-success{% else %}bg-secondary{% endif %}">
                                                    {{ task.status }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-light">
                                            <th colspan="2">Total da Sprint:</th>
                                            <th class="hours-column">{{ "%.1f"|format(sprint.total_hours) }}h</th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 