{% extends "base.html" %}

{% block title %}{{ title if title else 'Agenda Técnica' }}{% endblock %}

{% block extra_css %}
{{ super() }}
<!-- Adicionar CSS do FullCalendar e qualquer estilo customizado aqui -->
<!-- <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' /> -->
<!-- <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" /> -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" /> -->

<!-- CSS para Toast UI Calendar e dependências -->
<!-- <link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.css" /> -->
<!-- <link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.css" /> -->
<!-- <link rel="stylesheet" href="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.css" /> -->

<!-- TUI Calendar v1.15.3 e dependências específicas -->
<link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.css" />
<link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.css" />
<link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/tui-calendar/v1.15.3/tui-calendar.css" />

<!-- CSS para Select2 (se formos usar para filtros) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="{{ url_for('static', filename='css/select2-bootstrap-5-theme.min.css') }}" rel="stylesheet">

<style>
    body {
        /* font-family: Arial, Helvetica Neue, Helvetica, sans-serif; */
        /* font-size: 14px; */
    }
    #calendar-container {
        position: relative;
        z-index: 1;
        margin-left: auto;
        margin-right: auto;
        margin-top: 20px;
        margin-bottom: 20px;
        height: 75vh; /* Aplicar altura aqui se 'calendar' não tiver altura própria */
    }
    #calendar {
        max-width: 100%; /* Ocupa toda a largura do pai */
        height: 100%;   /* Ocupa toda a altura do pai (#calendar-container) */
        margin: 0 auto;
    }
    .fc-event {
        cursor: pointer;
    }
    .loading-spinner {
        display: none; /* Hidden by default */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000; /* Ensure it's on top */
    }
    #filters-container {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
    }
    #agendaHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    .calendar-toolbar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .calendar-toolbar button {
        font-size: 0.85rem;
    }
    #calendarRange {
        font-size: 1.2rem;
        font-weight: 500;
    }
    #specialistFilterContainer {
        min-width: 250px; /* Ajuste conforme necessário */
    }

    /* Ajuste para garantir que o modal de detalhes apareça sobre o calendário */
    #taskDetailModal .modal-dialog {
      z-index: 1051; /* Um a mais que o z-index padrão do backdrop do modal (1050) */
    }
    /* Adicionar estilos específicos para o tui-calendar se necessário */
    /* Exemplo: garantir que os pop-ups do tui-calendar (como criação de evento) apareçam corretamente */
    .tui-calendar-floating-layer {
        z-index: 1060 !important; /* Maior que o modal de detalhes */
    }
    .tui-calendar-popup-container {
        z-index: 1060 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-light">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="bi bi-calendar-week me-1"></i>
                {{ title if title else 'Agenda Técnica' }}
                {% if current_project and current_project.name %}
                    <small class="text-muted">- Projeto: {{ current_project.name }}</small>
                {% endif %}
            </h6>
            <a href="{{ url_for('backlog.board_by_project', project_id=current_project_id_for_link) if current_project_id_for_link else url_for('backlog.project_selection') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-kanban"></i> Voltar ao Quadro
            </a>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="calendar-toolbar">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="prevBtn"><i class="bi bi-chevron-left"></i></button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="nextBtn"><i class="bi bi-chevron-right"></i></button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="todayBtn">Hoje</button>
                        <span id="calendarRange" class="ms-3"></span>
                    </div>
                </div>
                <div class="col-md-6 d-flex justify-content-md-end align-items-center">
                     <div class="calendar-toolbar">
                        <div class="btn-group btn-group-sm" role="group" aria-label="View type">
                            <button type="button" class="btn btn-outline-primary" data-view-type="month">Mês</button>
                            <button type="button" class="btn btn-outline-primary active" data-view-type="week">Semana</button>
                            <button type="button" class="btn btn-outline-primary" data-view-type="day">Dia</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                 <div class="col-md-4" id="specialistFilterContainer">
                    <label for="specialistFilter" class="form-label form-label-sm">Filtrar por Especialista:</label>
                    <select class="form-select form-select-sm" id="specialistFilter" multiple>
                        <!-- Opções carregadas via JS -->
                    </select>
                </div>
            </div>

            <div id='calendar-container'>
                <div class="loading-spinner spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <div id='calendar'></div> {# Este é o container real para o TUI Calendar #}
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalhes da Tarefa -->
<div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskDetailModalLabel">Detalhes da Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Título:</strong> <span id="modalTaskTitle"></span></p>
                <p><strong>Especialista:</strong> <span id="modalTaskSpecialist"></span></p>
                <p><strong>Início da Etapa:</strong> <span id="modalTaskStart"></span></p>
                <p><strong>Fim da Etapa:</strong> <span id="modalTaskEnd"></span></p>
                
                <p class="mt-2"><strong>Descrição da Tarefa Principal:</strong></p>
                <div id="modalTaskDescription" style="white-space: pre-wrap; max-height: 120px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px;"></div>

                <!-- NOVO CAMPO PARA DESCRIÇÃO DO SEGMENTO -->
                <p class="mt-2"><strong>Detalhes desta Etapa (Segmento):</strong></p>
                <div id="modalSegmentDescription" style="white-space: pre-wrap; max-height: 100px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px; background-color: #f9f9f9;"></div>
                <!-- FIM NOVO CAMPO -->

                <p class="mt-2"><strong>Status da Tarefa:</strong> <span id="modalTaskState"></span></p>
                <p><strong>Projeto Associado:</strong> <span id="modalTaskProject"></span> (ID: <span id="modalTaskProjectId"></span>)</p>
                <p><strong>Backlog Associado:</strong> <span id="modalTaskBacklog"></span> (ID: <span id="modalTaskBacklogId"></span>)</p>
                <!-- Adicionar mais detalhes conforme necessário -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <!-- <button type="button" class="btn btn-primary">Editar Tarefa</button> -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ super() }}
<!-- Adicionar JS do FullCalendar e o seu script customizado aqui -->
<!-- <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js'></script> -->
<!-- <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales/pt-br.js'></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script> -->

<!-- JS para Toast UI Calendar e dependências -->
<!-- <script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.min.js"></script> -->
<!-- <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script> -->
<!-- <script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script> -->
<!-- <script src="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.min.js"></script> -->

<!-- TUI Calendar v1.15.3 e dependências específicas -->
<script type="text/javascript" src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.min.js"></script>
<script type="text/javascript" src="https://uicdn.toast.com/tui.dom/latest/tui-dom.min.js"></script>
<script type="text/javascript" src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>
<script type="text/javascript" src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>
<script type="text/javascript" src="https://uicdn.toast.com/tui-calendar/v1.15.3/tui-calendar.min.js"></script>

<!-- JS para Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const Calendar = tui.Calendar; // Atalho para o construtor
        const calendarElement = document.getElementById('calendar'); // CORRIGIDO: Usar o 'calendar' div
        const calendarRangeEl = document.getElementById('calendarRange');
        const specialistFilterEl = document.getElementById('specialistFilter');
        const taskDetailModalEl = document.getElementById('taskDetailModal');
        const taskDetailModalInstance = taskDetailModalEl ? new bootstrap.Modal(taskDetailModalEl) : null;

        // Configuração de templates para os eventos (opcional, mas útil para customização)
        const templates = {
            monthDayname: function(dayname) {
                return '<span class="calendar-month-dayname-name">' + dayname.label + '</span>';
            },
            // Você pode adicionar mais templates para customizar a aparência dos eventos
            // title: function(schedule) { // `schedule` é o objeto do evento
            //    return `<span style="color: white; background-color: ${schedule.bgColor}; padding: 2px 5px; border-radius: 3px;">${schedule.title}</span>`;
            // },
            // allday: function(schedule) { // Eventos de dia inteiro
            //    return `[All day] ${schedule.title}`;
            // },
            // time: function(schedule) { // Eventos com hora marcada
            //    return `${schedule.title} (${tui.util.formatTime(schedule.start)} - ${tui.util.formatTime(schedule.end)})`;
            // }
        };
        
        if (!calendarElement) {
            console.error("Elemento #calendar não encontrado. O Toast UI Calendar não pode ser inicializado.");
            return; // Interrompe a execução se o container do calendário não existir
        }

        const calendarInstance = new Calendar(calendarElement, { // CORRIGIDO: Passar calendarElement
            defaultView: 'week', // ou 'month', 'day'
            // taskView: true, 
            // scheduleView: ['time'], 
            useCreationPopup: true, 
            useDetailPopup: true,   
            // template: templates, 
            calendars: [ // Define os "tipos" de calendário/categoria de eventos
                // Calendário padrão para todas as tarefas vindas da API
                {
                    id: 'tasks',
                    name: 'Tarefas', // Nome de exibição para este calendário
                    color: '#ffffff',  // Cor do texto do evento (pode ser sobrescrito pela API por evento)
                    bgColor: '#00a9ff', // Cor de fundo padrão (pode ser sobrescrito pela API por evento)
                    borderColor: '#00a9ff' // Cor da borda padrão (pode ser sobrescrito pela API por evento)
                }
            ],
            timezone: { 
                zones: [
                    {
                        timezoneName: 'America/Sao_Paulo', // Ajuste para seu fuso horário
                        displayLabel: 'Horário de Brasília',
                    },
                ],
                defaultZoneName: 'America/Sao_Paulo' // Define um padrão
            },
            week: {
                showTimezoneCollapseButton: true,
                timezonesCollapsed: false, // Ou true se quiser começar colapsado
                daynames: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                startDayOfWeek: 0, // 0 para Domingo, 1 para Segunda
                // narrowWeekend: true, // Deixa o fim de semana mais estreito
                workweek: false // Destaca apenas dias úteis
            },
            month: {
                daynames: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                startDayOfWeek: 0,
                // narrowWeekend: true
            },
            // Adicionar mais configurações conforme necessário
        });

        // --- Controle de Navegação e Visualização ---
        function updateCalendarRange() {
            if (!calendarRangeEl) return;

            console.log("calendarInstance em updateCalendarRange:", calendarInstance);
            if (!calendarInstance || typeof calendarInstance.getDateRangeStart !== 'function') {
                console.error("TUI Calendar não está pronto ou não tem getDateRangeStart em updateCalendarRange.");
                return; 
            }

            const tzRangeStart = calendarInstance.getDateRangeStart();
            const tzRangeEnd = calendarInstance.getDateRangeEnd();
            
            console.log("tzRangeStart (objeto original):", tzRangeStart, "Tipo:", typeof tzRangeStart, "É Date?", tzRangeStart instanceof Date);
            console.log("tzRangeEnd (objeto original):", tzRangeEnd, "Tipo:", typeof tzRangeEnd, "É Date?", tzRangeEnd instanceof Date);

            // Converter TZDate para Date usando o método .toDate()
            const rangeStart = tzRangeStart && typeof tzRangeStart.toDate === 'function' ? tzRangeStart.toDate() : null;
            const rangeEnd = tzRangeEnd && typeof tzRangeEnd.toDate === 'function' ? tzRangeEnd.toDate() : null;

            // Agora verificar se rangeStart e rangeEnd são objetos Date válidos
            if (!rangeStart || !rangeEnd || !(rangeStart instanceof Date) || !(rangeEnd instanceof Date)) {
                console.error("rangeStart ou rangeEnd não são objetos Date válidos (após tentar .toDate()).", {
                    originalStart: tzRangeStart,
                    originalEnd: tzRangeEnd,
                    convertedStart: rangeStart,
                    convertedEnd: rangeEnd
                });
                console.trace(); 
                calendarRangeEl.textContent = "Carregando..."; 
                return;
            }

            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            let text;

            if (calendarInstance.getViewName() === 'month') {
                text = rangeStart.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });
            } else if (calendarInstance.getViewName() === 'day') {
                text = rangeStart.toLocaleDateString('pt-BR', options);
            } else { // week or custom views
                text = `${rangeStart.toLocaleDateString('pt-BR', options)} - ${rangeEnd.toLocaleDateString('pt-BR', options)}`;
            }
            calendarRangeEl.textContent = text;
        }

        document.getElementById('prevBtn')?.addEventListener('click', () => {
            calendarInstance.prev();
            setTimeout(updateCalendarRange, 0);
            fetchAndRenderSchedules(); // Recarregar eventos ao mudar o range
        });
        document.getElementById('nextBtn')?.addEventListener('click', () => {
            calendarInstance.next();
            setTimeout(updateCalendarRange, 0);
            fetchAndRenderSchedules();
        });
        document.getElementById('todayBtn')?.addEventListener('click', () => {
            calendarInstance.today();
            setTimeout(updateCalendarRange, 0);
            fetchAndRenderSchedules();
        });

        document.querySelectorAll('.btn-group[role="group"] button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.btn-group[role="group"] button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                const viewType = this.dataset.viewType;
                calendarInstance.changeView(viewType);
                setTimeout(updateCalendarRange, 0);
                fetchAndRenderSchedules();
            });
        });
        
        // --- FIM Controle de Navegação e Visualização ---

        // --- Inicialização do Select2 para filtro de especialistas ---
        if ($(specialistFilterEl).length) { // Verifica se o elemento existe
            $(specialistFilterEl).select2({
                theme: "bootstrap-5",
                placeholder: "Todos os Especialistas",
                allowClear: true,
                // ajax: { // Exemplo se fosse carregar via AJAX direto no select2
                //     url: '/backlog/api/specialists',
                //     dataType: 'json',
                //     delay: 250,
                //     processResults: function (data) {
                //         return {
                //             results: data.map(spec => ({ id: spec.id, text: spec.name }))
                //         };
                //     },
                //     cache: true
                // }
            });
             $(specialistFilterEl).on('change', function() {
                fetchAndRenderSchedules(); // Recarrega os eventos quando o filtro muda
                console.log("Filtro de especialista alterado:", $(this).val());
            });
        }


        // --- CARREGAMENTO DE DADOS (ESPECIALISTAS E EVENTOS/TAREFAS) ---
        let allSpecialists = []; // Armazena os especialistas carregados para usar como 'calendars' no tui-calendar

        async function fetchSpecialistsAndConfigureCalendar() {
            console.log("Iniciando fetchSpecialistsAndConfigureCalendar..."); // LOG 1
            try {
                const response = await fetch('/backlog/api/available-specialists');
                console.log("Resposta da API /available-specialists:", response); // LOG 2
                if (!response.ok) {
                    console.error("Falha ao buscar especialistas - Status:", response.status, response.statusText);
                    throw new Error('Falha ao buscar especialistas');
                }
                const specialistsData = await response.json();
                console.log("Dados JSON dos especialistas (specialistsData):", specialistsData); // LOG 3
                console.log("Tipo de specialistsData:", typeof specialistsData, "É Array?", Array.isArray(specialistsData)); // LOG 3.1

                allSpecialists = []; // Limpar antes de popular
                if (Array.isArray(specialistsData)) {
                    // specialistsData AGORA É ESPERADO SER UM ARRAY DE STRINGS (NOMES DOS ESPECIALISTAS)
                    if (specialistsData.length > 0) {
                        console.log("Primeiro item de specialistsData (esperado ser string):", specialistsData[0], "Tipo:", typeof specialistsData[0]); // LOG 3.2
                    }

                    allSpecialists = specialistsData.map((specNameString, index) => {
                        const cleanSpecName = typeof specNameString === 'string' ? specNameString.trim() : 'Especialista Desconhecido';
                        if (!(typeof specNameString === 'string' && specNameString.trim())) {
                            console.warn("Mapeando especialista com nome inválido/faltando (era string?):", specNameString, "Usando fallback:", cleanSpecName);
                        }
                        return {
                            id: cleanSpecName, 
                            name: cleanSpecName,   
                            color: '#ffffff',  
                            bgColor: getRandomColor(index), 
                            borderColor: getRandomColor(index)
                        };
                    });
                }
                console.log("Array allSpecialists (para TUI) APÓS MAP:", allSpecialists); // LOG 4

                if ($(specialistFilterEl).length) {
                    $(specialistFilterEl).empty(); 
                    const allOption = new Option("Todos os Especialistas", "", true, true);
                    $(specialistFilterEl).append(allOption);
                    console.log("Opção 'Todos os Especialistas' adicionada."); // LOG 5

                    if (Array.isArray(specialistsData)) { 
                        specialistsData.forEach(specNameString => {
                            const cleanSpecName = typeof specNameString === 'string' ? specNameString.trim() : null;

                            if (cleanSpecName) { 
                                const option = new Option(cleanSpecName, cleanSpecName, false, false); 
                                $(specialistFilterEl).append(option);
                            } else {
                                console.warn("Item especialista string inválido ou não string (não adicionado ao dropdown):", specNameString);
                            }
                        });
                        console.log("Opções de especialistas potencialmente adicionadas ao dropdown."); // LOG 6
                    } else {
                        console.error("specialistsData não é um array (não tentou popular dropdown):", specialistsData);
                    }
                    $(specialistFilterEl).trigger('change.select2'); 
                    console.log("Select2 atualizado ('change.select2' disparado)."); // LOG 7
                }
                
                if (allSpecialists.length > 0) {
                    calendarInstance.setCalendars(allSpecialists);
                } else {
                     calendarInstance.setCalendars([{ id: 'tasks', name: 'Tarefas', bgColor: '#00a9ff', borderColor: '#00a9ff', color: '#ffffff' }]);
                     console.log("Nenhum especialista retornado, usando calendário 'tasks' padrão para TUI."); // LOG 8
                }
                // console.log("Especialistas configurados como calendários no TUI:", calendarInstance.getCalendars()); // Ainda comentado

                fetchAndRenderSchedules();

            } catch (error) {
                console.error("Erro detalhado em fetchSpecialistsAndConfigureCalendar:", error); // LOG 9
            }
        }

        function getRandomColor(index) {
            // Gera cores pastéis variadas para os especialistas
            const colors = ['#a2d2ff', '#bde0fe', '#ffafcc', '#ffc8dd', '#cdb4db', '#ccd5ae', '#e9edc9', '#fefae0', '#faedcd', '#d4a373'];
            return colors[index % colors.length];
        }


        async function fetchAndRenderSchedules() {
            calendarInstance.clear(); 
            const selectedSpecialistNames = $(specialistFilterEl).val() || []; 
            
            let apiUrl = `/backlog/api/agenda/tasks`; 

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Falha ao buscar tarefas da agenda');
                let tasksFromApi = await response.json();
                console.log("Tarefas recebidas da API:", tasksFromApi);

                // Filtro NO FRONTEND 
                let filteredTasks = tasksFromApi;
                if (selectedSpecialistNames.length > 0 && !selectedSpecialistNames.includes("")) { // Não filtra se "Todos" estiver selecionado
                    filteredTasks = tasksFromApi.filter(task => {
                        // task.calendarId já é o specialist_name vindo da API
                        return selectedSpecialistNames.includes(task.calendarId);
                    });
                    console.log("Tarefas após filtro frontend por especialista:", filteredTasks);
                }
                
                const schedules = filteredTasks.map(task => {
                    return {
                        id: String(task.id), 
                        calendarId: task.calendarId, // <<< USA o calendarId (specialist_name) vindo da API
                        title: task.title,
                        body: task.body, 
                        start: task.start,
                        end: task.end,
                        category: task.category, 
                        isAllDay: task.isAllDay, 
                        
                        // As cores virão da configuração do 'calendarId' (especialista)
                        // Não é mais necessário definir backgroundColor, borderColor, color aqui por tarefa,
                        // A MENOS QUE a API envie cores específicas para sobrescrever o padrão do especialista.
                        // Se a API enviar backgroundColor, ele será usado. Caso contrário, o do especialista.
                        backgroundColor: task.backgroundColor, // Mantém se a API enviar, senão TUI usa a do calendarId
                        borderColor: task.borderColor,       // Mantém se a API enviar
                        color: task.color,                   // Mantém se a API enviar

                        raw: task.raw, // Mantém os dados brutos que a API já envia
                        isReadOnly: true, 
                    };
                });

                calendarInstance.createSchedules(schedules);
                console.log("Eventos criados no tui-calendar:", schedules.length);
                setTimeout(updateCalendarRange, 0); // Chamar com um pequeno atraso
            } catch (error) {
                console.error("Erro ao buscar/renderizar tarefas:", error);
                // Tratar erro
            }
        }
        
        // --- Manipuladores de Eventos do tui-calendar ---
        calendarInstance.on('clickSchedule', function(event) {
            const schedule = event.schedule;
            console.log('Clique no evento (segmento):', schedule);

            if (taskDetailModalInstance && schedule) {
                document.getElementById('modalTaskTitle').textContent = schedule.title || 'N/A'; // title já pode conter desc do segmento
                document.getElementById('modalTaskSpecialist').textContent = schedule.raw?.specialistName || 'N/A';
                document.getElementById('modalTaskStart').textContent = schedule.start ? new Date(schedule.start.toDate ? schedule.start.toDate() : schedule.start).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short'}) : 'N/A';
                document.getElementById('modalTaskEnd').textContent = schedule.end ? new Date(schedule.end.toDate ? schedule.end.toDate() : schedule.end).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short'}) : 'N/A';
                
                // Descrição da Tarefa Principal (do campo 'body' do evento, que mapeamos para task_pai.description)
                document.getElementById('modalTaskDescription').textContent = schedule.body || 'Sem descrição.'; 
                
                // Descrição Específica do Segmento (do campo raw.segmentDescription)
                const segmentDescEl = document.getElementById('modalSegmentDescription');
                if (segmentDescEl) {
                    segmentDescEl.textContent = schedule.raw?.segmentDescription || 'Sem detalhes específicos para esta etapa.';
                    // Oculta ou mostra o bloco de descrição do segmento se houver ou não descrição
                    segmentDescEl.parentElement.style.display = schedule.raw?.segmentDescription ? 'block' : 'none';
                }

                document.getElementById('modalTaskState').textContent = schedule.raw?.taskStatus || 'N/A'; 
                document.getElementById('modalTaskProject').textContent = schedule.raw?.projectName || 'N/A';
                document.getElementById('modalTaskProjectId').textContent = schedule.raw?.projectId || 'N/A';
                document.getElementById('modalTaskBacklog').textContent = schedule.raw?.backlogName || 'N/A'; 
                document.getElementById('modalTaskBacklogId').textContent = schedule.raw?.backlogId || 'N/A';
                
                taskDetailModalInstance.show();
            }
        });

        // Exemplo: Lidar com criação de eventos (se useCreationPopup=true)
        // calendarInstance.on('beforeCreateSchedule', function(event) {
        //     console.log('Tentativa de criar evento:', event);
        //     // Aqui você pode pegar os dados (event.start, event.end, etc.)
        //     // e abrir seu próprio modal de criação, se preferir, ou enviar para API
        //
        //     // Para usar o popup padrão, não precisa fazer nada aqui.
        //     // Para customizar e salvar via API:
        //     // const newSchedule = {
        //     //     id: String(Date.now()), // Gerar ID único
        //     //     calendarId: event.calendarId || allSpecialists[0]?.id || '0', // Associa a um especialista
        //     //     title: event.title || 'Nova Tarefa',
        //     //     category: event.isAllDay ? 'allday' : 'time',
        //     //     start: event.start,
        //     //     end: event.end,
        //     //     // ... outros campos
        //     // };
        //     //
        //     // // Chamar API para salvar `newSchedule`
        //     // // ...
        //     //
        //     // calendarInstance.createSchedules([newSchedule]); // Adiciona ao calendário após salvar
        //     // calendarInstance.clearGridSelections(); // Limpa a seleção no grid
        // });

        // Exemplo: Lidar com atualização de eventos (arrastar/redimensionar)
        // calendarInstance.on('beforeUpdateSchedule', function(event) {
        //     const {schedule, changes} = event;
        //     console.log('Tentativa de atualizar evento ID:', schedule.id, 'Mudanças:', changes);
        //
        //     // Chamar API para salvar `changes` para o `schedule.id`
        //     // ...
        //
        //     calendarInstance.updateSchedule(schedule.id, schedule.calendarId, changes);
        // });

        // Exemplo: Lidar com exclusão de eventos (se useDetailPopup=true e tiver botão delete)
        // calendarInstance.on('beforeDeleteSchedule', function(event) {
        //     const schedule = event.schedule;
        //     console.log('Tentativa de excluir evento ID:', schedule.id);
        //
        //     // Chamar API para deletar `schedule.id`
        //     // ...
        //
        //     calendarInstance.deleteSchedule(schedule.id, schedule.calendarId);
        // });


        // --- Inicialização ---
        fetchSpecialistsAndConfigureCalendar(); // Carrega especialistas e depois as tarefas
        
        console.log("Instância do Toast UI Calendar criada:", calendarInstance);

        // TESTE ISOLADO DO DATEPICKER:
        try {
            console.log("Tentando instanciar tui.DatePicker isoladamente...");
            console.log("Verificando tui.TimePicker antes do teste:", tui && tui.TimePicker); // NOVO LOG

            const testDatePickerContainer = document.createElement('div');
            document.body.appendChild(testDatePickerContainer); 
            
            if (tui && tui.DatePicker && tui.TimePicker) { // Adicionada verificação do TimePicker
                const dpInstance = new tui.DatePicker(testDatePickerContainer, {
                    language: 'pt',
                    timePicker: true // Tentar habilitar explicitamente
                });
                console.log("Instância de tui.DatePicker criada com SUCESSO isoladamente:", dpInstance);
                // testDatePickerContainer.remove(); // Remover após o teste se desejar
            } else {
                console.error("tui.DatePicker ou tui.TimePicker não está definido globalmente para o teste isolado.", {
                    isDatePickerDefined: tui && !!tui.DatePicker,
                    isTimePickerDefined: tui && !!tui.TimePicker
                });
            }
        } catch (e) {
            console.error("ERRO ao instanciar tui.DatePicker isoladamente:", e);
        }

    });
</script>
{% endblock %} 