# This pipeline was generated using azd pipeline config
trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  AZURE_SUBSCRIPTION_ID: '0f5c73b2-4ee9-4ef8-9f89-1eba02be7606'
  AZURE_ENV_NAME: 'app-control360-sou-prd'
  AZURE_RESOURCE_GROUP: 'SOU-RGPRD-APP360-01' 
  AZURE_LOCATION: 'eastus2'
  IDENTITY_PROXY_CLIENT_ID: 'c5b9b4ab-76e8-4f42-abca-bebf57ea1102'

jobs:
  - job: previewInfrastructure
    steps:
    - task: Bash@3
      displayName: Install azd
      inputs:
        targetType: 'inline'
        script: |
          curl -fsSL https://aka.ms/install-azd.sh | bash

    # azd delegate auth to az to use service connection with AzureCLI@2
    - pwsh: |
        azd config set auth.useAzCliAuth "true"
      displayName: Configure AZD to Use AZ CLI Authentication.

    - task: AzureCLI@2
      displayName: Preview Infrastructure
      inputs:
        azureSubscription: arm-mpn-subscription-bernardo-mesko
        scriptType: bash
        scriptLocation: inlineScript
        keepAzSessionActive: true
        inlineScript: |
          azd provision --no-prompt --preview
      env:
        AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
        AZURE_ENV_NAME: $(AZURE_ENV_NAME)
        AZURE_LOCATION: $(AZURE_LOCATION)
        IDENTITY_PROXY_CLIENT_ID: $(IDENTITY_PROXY_CLIENT_ID)
        AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)

  - job: approveInfrastructure
    pool: server
    dependsOn: previewInfrastructure
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: ''
        onTimeout: 'resume'
        timeoutInMinutes: 5

  - job: deploy
    dependsOn: approveInfrastructure
    steps:
    - task: AzureCLI@2
      displayName: Provision Infrastructure
      inputs:
        azureSubscription: arm-mpn-subscription-bernardo-mesko
        scriptType: bash
        scriptLocation: inlineScript
        keepAzSessionActive: true
        inlineScript: |
          azd provision --no-prompt
      env:
        AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
        AZURE_ENV_NAME: $(AZURE_ENV_NAME)
        AZURE_LOCATION: $(AZURE_LOCATION)
        IDENTITY_PROXY_CLIENT_ID: $(IDENTITY_PROXY_CLIENT_ID)
        AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)

    - task: AzureCLI@2
      displayName: Deploy Application
      inputs:
        azureSubscription: arm-mpn-subscription-bernardo-mesko
        scriptType: bash
        scriptLocation: inlineScript
        keepAzSessionActive: true
        inlineScript: |
          azd deploy --no-prompt
      env:
        AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
        AZURE_ENV_NAME: $(AZURE_ENV_NAME)
        AZURE_LOCATION: $(AZURE_LOCATION)
        IDENTITY_PROXY_CLIENT_ID: $(IDENTITY_PROXY_CLIENT_ID)
        AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)