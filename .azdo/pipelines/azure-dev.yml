# This pipeline was generated using azd pipeline config
trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: AZURE_SUBSCRIPTION_ID
    value: '0f5c73b2-4ee9-4ef8-9f89-1eba02be7606'
  - name: AZURE_ENV_NAME
    value: 'app-control360-sou-prd'
  - name: AZURE_RESOURCE_GROUP
    value: 'SOU-RGPRD-APP360-01'
  - name: AZURE_LOCATION
    value: 'eastus2'
  - name: IDENTITY_PROXY_CLIENT_ID
    value: 'c5b9b4ab-76e8-4f42-abca-bebf57ea1102'
  - group: secrets-app-control360-sou-prd # contains IDENTITY_PROXY_CLIENT_SECRET

jobs:
  - job: previewInfrastructure
    steps:
    - task: Bash@3
      displayName: Install azd
      inputs:
        targetType: 'inline'
        script: |
          curl -fsSL https://aka.ms/install-azd.sh | bash

    - pwsh: |
        azd config set auth.useAzCliAuth "true"
      displayName: Configure AZD to Use AZ CLI Authentication.

    - task: AzureCLI@2
      displayName: Preview Infrastructure
      inputs:
        azureSubscription: arm-mpn-subscription-bernardo-mesko
        scriptType: bash
        scriptLocation: inlineScript
        keepAzSessionActive: true
        inlineScript: |
          azd provision --no-prompt --preview
      env:
        AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
        AZURE_ENV_NAME: $(AZURE_ENV_NAME)
        AZURE_LOCATION: $(AZURE_LOCATION)
        IDENTITY_PROXY_CLIENT_ID: $(IDENTITY_PROXY_CLIENT_ID)
        IDENTITY_PROXY_CLIENT_SECRET: $(IDENTITY_PROXY_CLIENT_SECRET)
        AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)

  - job: approveInfrastructure
    pool: server
    dependsOn: previewInfrastructure
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: ''
        onTimeout: 'resume'
        timeoutInMinutes: 5

  - job: deploy
    dependsOn: approveInfrastructure
    steps:
    - task: Bash@3
      displayName: Install azd
      inputs:
        targetType: 'inline'
        script: |
          curl -fsSL https://aka.ms/install-azd.sh | bash

    - pwsh: |
        azd config set auth.useAzCliAuth "true"
      displayName: Configure AZD to Use AZ CLI Authentication.

    - task: AzureCLI@2
      displayName: Provision Infrastructure
      inputs:
        azureSubscription: arm-mpn-subscription-bernardo-mesko
        scriptType: bash
        scriptLocation: inlineScript
        keepAzSessionActive: true
        inlineScript: |
          azd provision --no-prompt
      env:
        AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
        AZURE_ENV_NAME: $(AZURE_ENV_NAME)
        AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)
        AZURE_LOCATION: $(AZURE_LOCATION)
        IDENTITY_PROXY_CLIENT_ID: $(IDENTITY_PROXY_CLIENT_ID)

    - task: AzureCLI@2
      displayName: Deploy Application
      inputs:
        azureSubscription: arm-mpn-subscription-bernardo-mesko
        scriptType: bash
        scriptLocation: inlineScript
        keepAzSessionActive: true
        inlineScript: |
          azd deploy --no-prompt
      env:
        AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
        AZURE_ENV_NAME: $(AZURE_ENV_NAME)
        AZURE_RESOURCE_GROUP: $(AZURE_RESOURCE_GROUP)
        AZURE_LOCATION: $(AZURE_LOCATION)
        IDENTITY_PROXY_CLIENT_ID: $(IDENTITY_PROXY_CLIENT_ID)
        IDENTITY_PROXY_CLIENT_SECRET: $(IDENTITY_PROXY_CLIENT_SECRET)