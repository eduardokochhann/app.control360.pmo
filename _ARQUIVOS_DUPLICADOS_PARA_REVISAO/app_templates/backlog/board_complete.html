{% extends "base.html" %}

{% block title %}Quadro Kanban - {{ current_project.projeto if current_project else 'Backlog' }}{% endblock %}

{% block extra_css %}
<style>
    .kanban-column {
        background-color: #f8f9fa;
        border-radius: 8px;
        min-height: 500px;
        padding: 1rem;
    }
    
    .kanban-header {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background-color: #dee2e6;
        border-radius: 6px;
        text-align: center;
    }
    
    .task-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        cursor: grab;
        transition: box-shadow 0.2s, transform 0.2s;
        position: relative;
    }
    
    .task-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    
    .task-card.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
    }
    
    .task-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
        font-size: 0.95em;
    }
    
    .task-description {
        color: #666;
        font-size: 0.85em;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .task-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8em;
        color: #888;
    }
    
    .task-specialist {
        background-color: #17a2b8;
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
    }
    
    .task-priority {
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
        font-weight: bold;
    }
    
    .priority-alta { background-color: #dc3545; color: white; }
    .priority-media { background-color: #ffc107; color: black; }
    .priority-baixa { background-color: #28a745; color: white; }
    
    .column-count {
        background-color: #6c757d;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8em;
        margin-left: 0.5rem;
    }
    
    .project-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .add-task-btn {
        width: 100%;
        border: 2px dashed #dee2e6;
        background: transparent;
        color: #6c757d;
        padding: 1rem;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .add-task-btn:hover {
        border-color: #007bff;
        color: #007bff;
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .dropzone-active {
        background-color: rgba(0, 123, 255, 0.1);
        border: 2px dashed #007bff;
    }
    
    .task-estimated-hours {
        background-color: #e9ecef;
        color: #495057;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.75em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho do Projeto -->
    {% if current_project %}
    <div class="project-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2">
                    <i class="bi bi-kanban"></i> {{ current_project.projeto }}
                </h1>
                <div class="d-flex gap-3">
                    <span><i class="bi bi-hash"></i> Projeto #{{ current_project.numero }}</span>
                    {% if current_project.squad %}
                    <span><i class="bi bi-people"></i> {{ current_project.squad }}</span>
                    {% endif %}
                    {% if current_project.especialista %}
                    <span><i class="bi bi-person-badge"></i> {{ current_project.especialista }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light" onclick="location.href='/backlog/projetos'">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
                <button class="btn btn-outline-light" onclick="openTaskModal()">
                    <i class="bi bi-plus-circle"></i> Nova Tarefa
                </button>
                <button class="btn btn-outline-light" onclick="location.href='/backlog/agenda'">
                    <i class="bi bi-calendar3"></i> Agenda
                </button>
                <button class="btn btn-outline-light" onclick="toggleProjectTools()" id="toggleProjectToolsBtn">
                    <i class="bi bi-tools"></i> Ferramentas do Projeto
                    <i class="bi bi-chevron-down" id="toolsChevron"></i>
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Informações do Backlog -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-list-task"></i> 
                    {{ current_backlog_name if current_backlog_name else 'Backlog não criado' }}
                </h4>
                {% if current_backlog_id %}
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="importTasks()">
                        <i class="bi bi-file-earmark-excel"></i> Importar Excel
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="exportTasks()">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                </div>
                {% else %}
                <button class="btn btn-primary" onclick="createBacklog()">
                    <i class="bi bi-plus-circle"></i> Criar Backlog
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quadro Kanban -->
    <div class="row" id="kanbanBoard">
        {% for column in columns %}
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
            <div class="kanban-column" data-column-id="{{ column.id }}" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div class="kanban-header">
                    {{ column.name }}
                    <span class="column-count" id="count-{{ column.id }}">0</span>
                </div>
                <div class="task-list" id="column-{{ column.id }}">
                    <!-- Tarefas serão inseridas aqui via JavaScript -->
                </div>
                {% if current_backlog_id %}
                <button class="add-task-btn" onclick="openTaskModal({{ column.id }})">
                    <i class="bi bi-plus"></i> Adicionar Tarefa
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal para Nova/Editar Tarefa -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalTitle">Nova Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId" value="">
                    <input type="hidden" id="taskColumnId" value="">
                    
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Título*</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="taskPriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="taskPriority">
                                <option value="baixa">Baixa</option>
                                <option value="media" selected>Média</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taskEstimatedHours" class="form-label">Horas Estimadas</label>
                            <input type="number" class="form-control" id="taskEstimatedHours" step="0.5" min="0">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskSpecialist" class="form-label">Especialista</label>
                        <input type="text" class="form-control" id="taskSpecialist" 
                               value="{{ current_project.especialista if current_project else '' }}">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteTaskBtn" onclick="deleteTask()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Ferramentas do Projeto -->
<div class="container-fluid mt-4" id="projectToolsSection" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-tools text-primary"></i> Ferramentas do Projeto
                <button class="btn btn-sm btn-outline-secondary float-end" onclick="toggleProjectTools()">
                    <i class="bi bi-x-lg"></i> Fechar
                </button>
            </h5>
        </div>
        <div class="card-body">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" id="toolsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="risks-tab" data-bs-toggle="tab" data-bs-target="#risks-panel" type="button" role="tab">
                        <i class="bi bi-exclamation-triangle text-warning"></i> Riscos
                        <span class="badge bg-danger ms-1" id="risksCount">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="milestones-tab" data-bs-toggle="tab" data-bs-target="#milestones-panel" type="button" role="tab">
                        <i class="bi bi-flag text-success"></i> Marcos
                        <span class="badge bg-primary ms-1" id="milestonesCount">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline-panel" type="button" role="tab">
                        <i class="bi bi-clock-history text-info"></i> Timeline
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes-panel" type="button" role="tab">
                        <i class="bi bi-sticky text-primary"></i> Notas
                        <span class="badge bg-info ms-1" id="notesCount">0</span>
                    </button>
                </li>
            </ul>

            <!-- Tab content -->
            <div class="tab-content mt-3" id="toolsTabContent">
                <!-- Painel de Riscos -->
                <div class="tab-pane fade show active" id="risks-panel" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-warning" onclick="openRiskForm()">
                                <i class="bi bi-plus-circle"></i> Novo Risco
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadRisks()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="risksContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-exclamation-triangle fs-1"></i>
                                    <p>Carregando riscos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Marcos -->
                <div class="tab-pane fade" id="milestones-panel" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-success" onclick="openMilestoneForm()">
                                <i class="bi bi-plus-circle"></i> Novo Marco
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadMilestones()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="milestonesContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-flag fs-1"></i>
                                    <p>Carregando marcos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Timeline -->
                <div class="tab-pane fade" id="timeline-panel" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="timelineDaysBack" class="form-label">Dias para trás:</label>
                            <input type="number" class="form-control" id="timelineDaysBack" value="7" min="1" max="30">
                        </div>
                        <div class="col-md-3">
                            <label for="timelineDaysForward" class="form-label">Dias para frente:</label>
                            <input type="number" class="form-control" id="timelineDaysForward" value="7" min="1" max="30">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-info" onclick="loadTimeline()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar Timeline
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="timelineContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-clock-history fs-1"></i>
                                    <p>Carregando timeline...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Painel de Notas -->
                <div class="tab-pane fade" id="notes-panel" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-primary" onclick="openNoteForm()">
                                <i class="bi bi-plus-circle"></i> Nova Nota
                            </button>
                            <button class="btn btn-outline-secondary ms-2" onclick="loadNotes()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div id="notesContainer">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-sticky fs-1"></i>
                                    <p>Carregando notas...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Riscos -->
<div class="modal fade" id="risksModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i> Gestão de Riscos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="openRiskForm()">
                            <i class="bi bi-plus-circle"></i> Novo Risco
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped" id="risksTable">
                        <thead>
                            <tr>
                                <th>Descrição</th>
                                <th>Impacto</th>
                                <th>Probabilidade</th>
                                <th>Status</th>
                                <th>Responsável</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="risksTableBody">
                            <!-- Riscos serão carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Marcos -->
<div class="modal fade" id="milestonesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-flag text-success"></i> Marcos do Projeto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-success" onclick="openMilestoneForm()">
                            <i class="bi bi-plus-circle"></i> Novo Marco
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped" id="milestonesTable">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Data Planejada</th>
                                <th>Data Real</th>
                                <th>Status</th>
                                <th>Criticidade</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="milestonesTableBody">
                            <!-- Marcos serão carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Timeline -->
<div class="modal fade" id="timelineModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history text-info"></i> Linha do Tempo do Projeto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="timelineDaysBack" class="form-label">Dias para trás:</label>
                        <input type="number" class="form-control" id="timelineDaysBack" value="7" min="1" max="30">
                    </div>
                    <div class="col-md-6">
                        <label for="timelineDaysForward" class="form-label">Dias para frente:</label>
                        <input type="number" class="form-control" id="timelineDaysForward" value="7" min="1" max="30">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-info" onclick="loadTimeline()">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar Timeline
                        </button>
                    </div>
                </div>
                <div id="timelineContent">
                    <!-- Timeline será carregada aqui -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Notas -->
<div class="modal fade" id="notesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-sticky text-primary"></i> Notas do Projeto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-primary" onclick="openNoteForm()">
                            <i class="bi bi-plus-circle"></i> Nova Nota
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div id="notesContainer">
                            <!-- Notas serão carregadas aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Risco -->
<div class="modal fade" id="riskFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="riskFormTitle">Novo Risco</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="riskForm">
                    <input type="hidden" id="riskId" value="">
                    
                    <div class="mb-3">
                        <label for="riskDescription" class="form-label">Descrição*</label>
                        <textarea class="form-control" id="riskDescription" rows="3" required></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="riskImpact" class="form-label">Impacto</label>
                            <select class="form-select" id="riskImpact">
                                <option value="LOW">Baixo</option>
                                <option value="MEDIUM" selected>Médio</option>
                                <option value="HIGH">Alto</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="riskProbability" class="form-label">Probabilidade</label>
                            <select class="form-select" id="riskProbability">
                                <option value="LOW">Baixa</option>
                                <option value="MEDIUM" selected>Média</option>
                                <option value="HIGH">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="riskStatus" class="form-label">Status</label>
                            <select class="form-select" id="riskStatus">
                                <option value="ACTIVE" selected>Ativo</option>
                                <option value="MONITORING">Monitorando</option>
                                <option value="RESOLVED">Resolvido</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="riskResponsible" class="form-label">Responsável</label>
                        <input type="text" class="form-control" id="riskResponsible">
                    </div>
                    
                    <div class="mb-3">
                        <label for="riskMitigation" class="form-label">Plano de Mitigação</label>
                        <textarea class="form-control" id="riskMitigation" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="riskContingency" class="form-label">Plano de Contingência</label>
                        <textarea class="form-control" id="riskContingency" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteRiskBtn" onclick="deleteRisk()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveRisk()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Marco -->
<div class="modal fade" id="milestoneFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="milestoneFormTitle">Novo Marco</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="milestoneForm">
                    <input type="hidden" id="milestoneId" value="">
                    
                    <div class="mb-3">
                        <label for="milestoneName" class="form-label">Nome*</label>
                        <input type="text" class="form-control" id="milestoneName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="milestoneDescription" class="form-label">Descrição</label>
                        <textarea class="form-control" id="milestoneDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="milestonePlannedDate" class="form-label">Data Planejada*</label>
                            <input type="date" class="form-control" id="milestonePlannedDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="milestoneActualDate" class="form-label">Data Real</label>
                            <input type="date" class="form-control" id="milestoneActualDate">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="milestoneStatus" class="form-label">Status</label>
                            <select class="form-select" id="milestoneStatus">
                                <option value="PENDING" selected>Pendente</option>
                                <option value="IN_PROGRESS">Em Progresso</option>
                                <option value="COMPLETED">Concluído</option>
                                <option value="DELAYED">Atrasado</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="milestoneCriticality" class="form-label">Criticidade</label>
                            <select class="form-select" id="milestoneCriticality">
                                <option value="LOW">Baixa</option>
                                <option value="MEDIUM" selected>Média</option>
                                <option value="HIGH">Alta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="milestoneIsCheckpoint">
                            <label class="form-check-label" for="milestoneIsCheckpoint">
                                É um checkpoint crítico
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteMilestoneBtn" onclick="deleteMilestone()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-success" onclick="saveMilestone()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Formulário de Nota -->
<div class="modal fade" id="noteFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteFormTitle">Nova Nota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <input type="hidden" id="noteId" value="">
                    
                    <div class="mb-3">
                        <label for="noteContent" class="form-label">Conteúdo*</label>
                        <textarea class="form-control" id="noteContent" rows="4" required></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="noteCategory" class="form-label">Categoria</label>
                            <select class="form-select" id="noteCategory">
                                <option value="general" selected>Geral</option>
                                <option value="progress">Progresso</option>
                                <option value="issue">Problema</option>
                                <option value="decision">Decisão</option>
                                <option value="meeting">Reunião</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="notePriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="notePriority">
                                <option value="low">Baixa</option>
                                <option value="medium" selected>Média</option>
                                <option value="high">Alta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="noteEventDate" class="form-label">Data do Evento</label>
                            <input type="date" class="form-control" id="noteEventDate">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="noteIncludeInReport" checked>
                            <label class="form-check-label" for="noteIncludeInReport">
                                Incluir no relatório de status
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="noteTags" class="form-label">Tags (separadas por vírgula)</label>
                        <input type="text" class="form-control" id="noteTags" placeholder="tag1, tag2, tag3">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="deleteNoteBtn" onclick="deleteNote()" style="display: none;">
                    <i class="bi bi-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-primary" onclick="saveNote()">
                    <i class="bi bi-check-lg"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Passa dados do Flask para o JavaScript
    window.boardData = {
        currentProjectId: '{{ current_project.numero if current_project else "" }}',
        currentBacklogId: {{ backlog.id if backlog else 'null' }},
        tasks: JSON.parse('{{ tasks_json|safe }}' || '[]')
    };
</script>

<script src="{{ url_for('static', filename='js/backlog_features.js') }}"></script>
<script src="{{ url_for('static', filename='js/board_dnd.js') }}"></script>

<script>
    // Inicialização unificada
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM totalmente carregado. Iniciando todos os scripts...");
        
        // Inicializa o drag-and-drop do quadro
        if (typeof initializeSortable === 'function') {
            console.log("Inicializando o quadro drag-and-drop...");
            initializeSortable();
        } else {
            console.error("Função initializeSortable não encontrada!");
        }
        
        // Inicializa as ferramentas do projeto (Riscos, Marcos, etc.)
        if (typeof initializeProjectTools === 'function') {
            console.log("Inicializando as ferramentas do projeto...");
            initializeProjectTools();
        } else {
            console.error("Função initializeProjectTools não encontrada!");
        }
    });
</script>
{% endblock %} 