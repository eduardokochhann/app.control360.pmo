{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/tui-calendar@1.15.3/dist/tui-calendar.min.css" rel="stylesheet">
<style>
    .calendar-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 1rem;
    }
    
    .calendar-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    .view-selector {
        display: flex;
        gap: 0.5rem;
    }
    
    .view-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .view-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .view-btn:hover {
        background-color: #e9ecef;
    }
    
    .view-btn.active:hover {
        background-color: #0056b3;
    }
    
    .calendar-navigation {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .nav-btn {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }
    
    .nav-btn:hover {
        background-color: #e9ecef;
    }
    
    .current-date {
        font-weight: bold;
        font-size: 1.1em;
        min-width: 200px;
        text-align: center;
    }
    
    .specialist-filters {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .specialist-filter-item {
        display: inline-block;
        margin: 0.25rem;
    }
    
    .specialist-checkbox {
        margin-right: 0.5rem;
    }
    
    .specialist-label {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        background-color: white;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .specialist-label:hover {
        background-color: #e9ecef;
    }
    
    .specialist-checkbox:checked + .specialist-label {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    #calendar {
        height: 600px;
    }
    
    .calendar-legend {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="calendar-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2">
                    <i class="bi bi-calendar3"></i> {{ title }}
                </h1>
                <p class="mb-0 opacity-75">Visualização consolidada dos segmentos de tarefas de todos os especialistas</p>
            </div>
            <div class="d-flex gap-2">
                {% if current_project_id_for_link %}
                <button class="btn btn-light" onclick="location.href='/backlog/board/{{ current_project_id_for_link }}'">
                    <i class="bi bi-arrow-left"></i> Voltar ao Quadro
                </button>
                {% else %}
                <button class="btn btn-light" onclick="location.href='/backlog/projetos'">
                    <i class="bi bi-arrow-left"></i> Voltar aos Projetos
                </button>
                {% endif %}
                <button class="btn btn-outline-light" onclick="refreshCalendar()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros de Especialistas -->
    <div class="specialist-filters">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
                <i class="bi bi-funnel"></i> Filtrar por Especialistas
            </h6>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="selectAllSpecialists()">Todos</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllSpecialists()">Nenhum</button>
            </div>
        </div>
        <div id="specialistFilters">
            <!-- Filtros serão inseridos aqui via JavaScript -->
        </div>
    </div>

    <!-- Controles do Calendário -->
    <div class="calendar-controls">
        <div class="view-selector">
            <button class="view-btn active" data-view="month" onclick="changeView('month')">
                <i class="bi bi-calendar3"></i> Mês
            </button>
            <button class="view-btn" data-view="week" onclick="changeView('week')">
                <i class="bi bi-calendar-week"></i> Semana
            </button>
            <button class="view-btn" data-view="day" onclick="changeView('day')">
                <i class="bi bi-calendar-day"></i> Dia
            </button>
        </div>
        
        <div class="calendar-navigation">
            <button class="nav-btn" onclick="navigateCalendar('prev')" title="Anterior">
                <i class="bi bi-chevron-left"></i>
            </button>
            <div class="current-date" id="currentDate">
                <!-- Data atual será inserida aqui -->
            </div>
            <button class="nav-btn" onclick="navigateCalendar('next')" title="Próximo">
                <i class="bi bi-chevron-right"></i>
            </button>
            <button class="nav-btn" onclick="navigateCalendar('today')" title="Hoje">
                <i class="bi bi-house"></i>
            </button>
        </div>
    </div>

    <!-- Container do Calendário -->
    <div class="calendar-container position-relative">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
        <div id="calendar"></div>
    </div>

    <!-- Legenda -->
    <div class="calendar-legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #007bff;"></div>
            <span>Tarefas Programadas</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #28a745;"></div>
            <span>Tarefas Concluídas</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffc107;"></div>
            <span>Tarefas em Andamento</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #dc3545;"></div>
            <span>Tarefas Atrasadas</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/tui-calendar@1.15.3/dist/tui-calendar.min.js"></script>
<script>
let calendar;
let currentView = 'month';
let allEvents = [];
let selectedSpecialists = new Set();
let availableSpecialists = new Set();

document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    loadAgendaTasks();
});

function initializeCalendar() {
    const calendarContainer = document.getElementById('calendar');
    
    calendar = new tui.Calendar(calendarContainer, {
        defaultView: 'month',
        useCreationPopup: false,
        useDetailPopup: true,
        calendars: [],
        template: {
            monthDayname: function(dayname) {
                return '<span class="calendar-week-dayname-name">' + dayname.label + '</span>';
            }
        },
        week: {
            startDayOfWeek: 1, // Segunda-feira
            daynames: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
            narrowWeekend: true,
            showTimezone: false,
            timezones: [{
                timezoneOffset: -180, // UTC-3 (horário de Brasília)
                displayLabel: 'BRT',
                tooltip: 'Brasília'
            }]
        },
        month: {
            daynames: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
            startDayOfWeek: 1,
            narrowWeekend: true
        }
    });
    
    // Event listeners
    calendar.on('clickEvent', function(event) {
        showEventDetails(event.event);
    });
    
    calendar.on('beforeUpdateEvent', function(event) {
        // Permite rearranjar eventos (drag & drop)
        updateEventPosition(event);
    });
    
    updateCurrentDate();
}

function loadAgendaTasks() {
    showLoading(true);
    
    fetch('/backlog/api/agenda/tasks')
        .then(response => response.json())
        .then(events => {
            console.log('Eventos carregados:', events.length);
            allEvents = events;
            
            // Extrai especialistas únicos
            availableSpecialists.clear();
            events.forEach(event => {
                if (event.calendarId && event.calendarId.trim()) {
                    availableSpecialists.add(event.calendarId.trim());
                }
            });
            
            // Inicializa filtros
            initializeSpecialistFilters();
            
            // Renderiza eventos
            renderEvents();
            showLoading(false);
        })
        .catch(error => {
            console.error('Erro ao carregar tarefas da agenda:', error);
            showLoading(false);
            alert('Erro ao carregar agenda. Verifique a conexão e tente novamente.');
        });
}

function initializeSpecialistFilters() {
    const filtersContainer = document.getElementById('specialistFilters');
    filtersContainer.innerHTML = '';
    
    // Inicialmente todos os especialistas são selecionados
    selectedSpecialists.clear();
    availableSpecialists.forEach(specialist => selectedSpecialists.add(specialist));
    
    // Cria checkboxes para cada especialista
    Array.from(availableSpecialists).sort().forEach(specialist => {
        const filterItem = document.createElement('div');
        filterItem.className = 'specialist-filter-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `specialist-${specialist}`;
        checkbox.className = 'specialist-checkbox';
        checkbox.checked = true;
        checkbox.onchange = () => toggleSpecialist(specialist);
        
        const label = document.createElement('label');
        label.className = 'specialist-label';
        label.htmlFor = `specialist-${specialist}`;
        label.textContent = specialist;
        
        filterItem.appendChild(checkbox);
        filterItem.appendChild(label);
        filtersContainer.appendChild(filterItem);
    });
}

function toggleSpecialist(specialist) {
    if (selectedSpecialists.has(specialist)) {
        selectedSpecialists.delete(specialist);
    } else {
        selectedSpecialists.add(specialist);
    }
    renderEvents();
}

function selectAllSpecialists() {
    selectedSpecialists.clear();
    availableSpecialists.forEach(specialist => selectedSpecialists.add(specialist));
    
    document.querySelectorAll('.specialist-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    
    renderEvents();
}

function deselectAllSpecialists() {
    selectedSpecialists.clear();
    
    document.querySelectorAll('.specialist-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    renderEvents();
}

function renderEvents() {
    // Filtra eventos pelos especialistas selecionados
    const filteredEvents = allEvents.filter(event => {
        return selectedSpecialists.has(event.calendarId);
    });
    
    // Cria calendários dinâmicos (um por especialista)
    const calendars = Array.from(selectedSpecialists).map(specialist => {
        return {
            id: specialist,
            name: specialist,
            color: '#ffffff',
            bgColor: getSpecialistColor(specialist),
            dragBgColor: getSpecialistColor(specialist),
            borderColor: getSpecialistColor(specialist)
        };
    });
    
    calendar.setCalendars(calendars);
    calendar.clear();
    calendar.createEvents(filteredEvents);
    
    console.log(`Renderizados ${filteredEvents.length} eventos de ${selectedSpecialists.size} especialistas`);
}

function getSpecialistColor(specialist) {
    // Gera cores consistentes baseadas no nome do especialista
    const colors = [
        '#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8',
        '#6f42c1', '#e83e8c', '#fd7e14', '#20c997', '#6c757d'
    ];
    
    let hash = 0;
    for (let i = 0; i < specialist.length; i++) {
        hash = specialist.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    return colors[Math.abs(hash) % colors.length];
}

function showEventDetails(event) {
    const details = `
        <strong>Tarefa:</strong> ${event.title}<br>
        <strong>Especialista:</strong> ${event.calendarId}<br>
        <strong>Início:</strong> ${formatDateTime(event.start)}<br>
        <strong>Fim:</strong> ${formatDateTime(event.end)}<br>
        ${event.body ? `<strong>Descrição:</strong> ${event.body}<br>` : ''}
        ${event.raw.projectName ? `<strong>Projeto:</strong> ${event.raw.projectName}<br>` : ''}
        ${event.raw.taskStatus ? `<strong>Status:</strong> ${event.raw.taskStatus}<br>` : ''}
    `;
    
    // Você pode implementar um modal personalizado aqui
    // Por enquanto, usando alert simples
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = details;
    alert(tempDiv.textContent);
}

function formatDateTime(dateTime) {
    if (!dateTime) return 'N/A';
    
    const date = new Date(dateTime);
    return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

function changeView(view) {
    currentView = view;
    calendar.changeView(view, true);
    
    // Atualiza botões ativos
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-view="${view}"]`).classList.add('active');
    
    updateCurrentDate();
}

function navigateCalendar(direction) {
    switch(direction) {
        case 'prev':
            calendar.prev();
            break;
        case 'next':
            calendar.next();
            break;
        case 'today':
            calendar.today();
            break;
    }
    updateCurrentDate();
}

function updateCurrentDate() {
    const date = calendar.getDate();
    const dateStr = date.toLocaleDateString('pt-BR', {
        year: 'numeric',
        month: 'long',
        day: currentView === 'day' ? 'numeric' : undefined
    });
    
    document.getElementById('currentDate').textContent = dateStr;
}

function refreshCalendar() {
    loadAgendaTasks();
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = show ? 'flex' : 'none';
}

function updateEventPosition(event) {
    // TODO: Implementar atualização de posição do evento
    console.log('Event position updated:', event);
}
</script>
{% endblock %} 